<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.1">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.1">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.4.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="一个热爱健身的安全分析师">
<meta property="og:type" content="website">
<meta property="og:title" content="Canon&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Canon&#39;s Blog">
<meta property="og:description" content="一个热爱健身的安全分析师">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Canon&#39;s Blog">
<meta name="twitter:description" content="一个热爱健身的安全分析师">
  <link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.css"><style>
#needsharebutton-postbottom {
  cursor: pointer;
  height: 26px;
  margin-top: 10px;
  position: relative;
}
#needsharebutton-postbottom .btn {
  border: 1px solid $btn-default-border-color;
  border-radius: 3px;
  display: initial;
  padding: 1px 4px;
}
</style>
  <title>Canon's Blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Canon's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="fa fa-search fa-fw"></i>搜索</a>
      </li>
    
  </ul>

    

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/canon88" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/24/Suricata+Lua实现本地情报对接/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/24/Suricata+Lua实现本地情报对接/" class="post-title-link" itemprop="url">Suricata + Lua实现本地情报对接</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-24 21:49:39" itemprop="dateCreated datePublished" datetime="2019-10-24T21:49:39+08:00">2019-10-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-25 17:11:48" itemprop="dateModified" datetime="2019-10-25T17:11:48+08:00">2019-10-25</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>​        由于近期网站遭受恶意攻击, 通过对于登录接口的审计与分析, 现已确定了一批可疑账号。既然之前写过一个登录接口的审计脚本, 那么完全可以通过扩展这个脚本来实现对于可疑账号的比对。主要思路: 通过将可疑账号存进Redis中, 再利用Lua脚本调用Redis接口进行账号的比对。</p>
<p>先说一下<strong>Suricata</strong>默认是存在黑名单机制的, 如下:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># IP Reputation</span></span><br><span class="line"><span class="comment">#reputation-categories-file: /etc/suricata/iprep/categories.txt</span></span><br><span class="line"><span class="comment">#default-reputation-path: /etc/suricata/iprep</span></span><br><span class="line"><span class="comment">#reputation-files:</span></span><br><span class="line"><span class="comment"># - reputation.list</span></span><br></pre></td></tr></table></figure>

<p>在<strong>Suricata 5.0</strong> 版本中更是增加了新的功能<strong><a href="https://suricata.readthedocs.io/en/suricata-5.0.0/rules/datasets.html" target="_blank" rel="noopener">Datasets</a></strong>。大概看了一下, 可以通过在规则中使用<code>dataset</code>和<code>datarep</code>关键字将大量数据与<code>sticky buffer</code>进行匹配。确实是个很赞的功能!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alert http any any -&gt; any any (http.user_agent; dataset:<span class="built_in">set</span>, ua-seen, <span class="built_in">type</span> string, save ua-seen.lst; sid:1;)</span><br><span class="line"></span><br><span class="line">alert dns any any -&gt; any any (dns.query; to_sha256; dataset:<span class="built_in">set</span>, dns-sha256-seen, <span class="built_in">type</span> sha256, save dns-sha256-seen.lst; sid:2;)</span><br><span class="line"></span><br><span class="line">alert http any any -&gt; any any (http.uri; to_md5; dataset:isset, http-uri-md5-seen, <span class="built_in">type</span> md5, load http-uri-md5-seen.lst; sid:3;)</span><br></pre></td></tr></table></figure>

<p><strong>但是</strong>… 这并不适用我现在的场景, 因为在我的场景中, 用户的登录请求存在于POST请求中, 默认的Suricata方法并不能准确定位到我们需要的账号。这个时候我们就只能依赖于<strong>Lua</strong>脚本来扩展。当然这些需求<strong>Zeek</strong>也可以满足, 只是…<strong>Zeek</strong>的脚本真是难写…不忍吐槽~</p>
<h1 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h1><p><strong>安装环境</strong> </p>
<p>​    <strong>OS</strong>: <em>Ubuntu 18.04</em></p>
<p>​    <strong>Suricata</strong>: <em>Suricata 5.0.0 RELEASE</em>        </p>
<ol>
<li>由于Ubuntu默认没有安装<strong><a href="https://luarocks.org/" target="_blank" rel="noopener">LuaRocks</a></strong> (<em>LuaRocks is the package manager for Lua modules</em>), 这里需要我们手动安装。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过apt直接安装, 简单省事儿。</span></span><br><span class="line">$ apt-get install luarocks</span><br></pre></td></tr></table></figure>

<hr>
<ol start="2">
<li>通过<code>luarocks</code>安装我们所需要的<code>lua</code>模块, 这里我们需要用到<code>redis-lua</code>、<code>luasocket</code>这两个模块。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install Modules</span></span><br><span class="line">$ luarocks install luasocket</span><br><span class="line">$ luarocks install redis-lua</span><br><span class="line"></span><br><span class="line">$ ll /usr/<span class="built_in">local</span>/share/lua/5.1/</span><br><span class="line">total 72</span><br><span class="line">drwxr-xr-x 3 root root  4096 Oct 25 03:35 ./</span><br><span class="line">drwxr-xr-x 3 root root  4096 Sep 17 14:14 ../</span><br><span class="line">-rw-r--r-- 1 root root  8331 Oct 25 03:34 ltn12.lua</span><br><span class="line">-rw-r--r-- 1 root root  2487 Oct 25 03:34 mime.lua</span><br><span class="line">-rw-r--r-- 1 root root 35599 Oct 25 03:35 redis.lua</span><br><span class="line">drwxr-xr-x 2 root root  4096 Oct 25 03:34 socket/</span><br><span class="line">-rw-r--r-- 1 root root  4451 Oct 25 03:34 socket.lua</span><br></pre></td></tr></table></figure>

<hr>
<ol start="3">
<li>安装成功后,  可以简单的测试一下。</li>
</ol>
<ul>
<li>利用<strong>Docker</strong>启动<strong>Redis</strong>容器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -ti -d -p 6379:6379 redis</span><br></pre></td></tr></table></figure>

<ul>
<li>测试脚本<code>hello_redis.lua</code></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span> <span class="string">"redis"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> client = redis.connect(<span class="string">"127.0.0.1"</span>, <span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> response = client:ping()</span><br><span class="line"><span class="keyword">if</span> response == <span class="literal">false</span> <span class="keyword">then</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">client:set(<span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> var = client:get(<span class="string">"hello"</span>)</span><br><span class="line"><span class="built_in">print</span>(var)</span><br></pre></td></tr></table></figure>

<ul>
<li>可能会存在环境变量不对导致的报错</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ luajit hello_redis.lua</span><br><span class="line">	luajit: /usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:793: module <span class="string">'socket'</span> not found:</span><br><span class="line">	no field package.preload[<span class="string">'socket'</span>]</span><br><span class="line">	no file <span class="string">'./socket.lua'</span></span><br><span class="line">	no file <span class="string">'/usr/local/share/luajit-2.0.5/socket.lua'</span></span><br><span class="line">	no file <span class="string">'/usr/local/share/lua/5.1/socket.lua'</span></span><br><span class="line">	no file <span class="string">'/usr/local/share/lua/5.1/socket/init.lua'</span></span><br><span class="line">	no file <span class="string">'./socket.so'</span></span><br><span class="line">	no file <span class="string">'/usr/local/lib/lua/5.1/socket.so'</span></span><br><span class="line">	no file <span class="string">'/usr/local/lib/lua/5.1/loadall.so'</span></span><br><span class="line">stack traceback:</span><br><span class="line">	[C]: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">'require'</span></span><br><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:793: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">'create_connection'</span></span><br><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:836: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">'connect'</span></span><br><span class="line">	a.lua:3: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: at 0x56508049e440</span><br></pre></td></tr></table></figure>

<ul>
<li>执行<code>luarocks path --bin</code> 并将结果输入</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ luarocks path --bin</span><br><span class="line">Warning: The directory <span class="string">'/home/canon/.cache/luarocks'</span> or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing /usr/<span class="built_in">local</span>/bin/luarocks with sudo, you may want sudo<span class="string">'s -H flag.</span></span><br><span class="line"><span class="string">export LUA_PATH='</span>/home/canon/.luarocks/share/lua/5.1/?.lua;/home/canon/.luarocks/share/lua/5.1/?/init.lua;/usr/<span class="built_in">local</span>/share/lua/5.1/?.lua;/usr/<span class="built_in">local</span>/share/lua/5.1/?/init.lua;./?.lua;/usr/<span class="built_in">local</span>/share/luajit-2.0.5/?.lua<span class="string">'</span></span><br><span class="line"><span class="string">export LUA_CPATH='</span>/home/canon/.luarocks/lib/lua/5.1/?.so;/usr/<span class="built_in">local</span>/lib/lua/5.1/?.so;./?.so;/usr/<span class="built_in">local</span>/lib/lua/5.1/loadall.so<span class="string">'</span></span><br><span class="line"><span class="string">export PATH='</span>/home/canon/.luarocks/bin:/usr/<span class="built_in">local</span>/bin:/home/canon/anaconda3/bin:/home/canon/anaconda3/condabin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin<span class="string">'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>执行脚本, 将会看到如下输出:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ luajit hello_redis.lua</span><br><span class="line">world</span><br></pre></td></tr></table></figure>

<h1 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h1><p>扩展登录接口审计脚本: <code>http_audit.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line">json = <span class="built_in">require</span> <span class="string">"json"</span></span><br><span class="line">md5 = <span class="built_in">require</span> <span class="string">"md5"</span></span><br><span class="line">redis = <span class="built_in">require</span> <span class="string">"redis"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 登录接口</span></span><br><span class="line">login_url = <span class="string">"/login"</span></span><br><span class="line"><span class="comment">-- 登录错误提示</span></span><br><span class="line">success_code = <span class="number">0</span></span><br><span class="line"><span class="comment">-- event_name</span></span><br><span class="line">event_name = <span class="string">"login_audit"</span></span><br><span class="line"><span class="comment">-- event_type</span></span><br><span class="line">event_type = <span class="string">"lua"</span></span><br><span class="line"><span class="comment">-- logs</span></span><br><span class="line">name = <span class="string">"login_audit.json"</span></span><br><span class="line"><span class="comment">-- 协议</span></span><br><span class="line">proto = <span class="string">"TCP"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- redis_config</span></span><br><span class="line">host = <span class="string">"127.0.0.1"</span></span><br><span class="line">port = <span class="number">6379</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- common_mapping</span></span><br><span class="line">http_common_mapping = <span class="string">'&#123;"accept":"accept","accept-charset":"accept_charset","accept-encoding":"accept_encoding","accept-language":"accept_language","user-agent":"user_agent"&#125;'</span></span><br><span class="line">common_mapping_table = json.decode(http_common_mapping)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- defind functioin</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5Encode</span><span class="params">(args)</span></span></span><br><span class="line">    m = md5.new()</span><br><span class="line">    m:update(args)</span><br><span class="line">    <span class="keyword">return</span> md5.tohex(m:finish())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStr</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    ios = <span class="built_in">string</span>.<span class="built_in">match</span>(args, <span class="string">'canon'</span>)</span><br><span class="line">    <span class="keyword">if</span> ios ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        mail = <span class="string">'email"%s+(.-)%s'</span></span><br><span class="line">        t[<span class="string">'email'</span>] = <span class="built_in">string</span>.<span class="built_in">match</span>(args, mail)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        data = <span class="built_in">string</span>.split(args, <span class="string">'&amp;'</span>)</span><br><span class="line">        <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">            d = <span class="built_in">string</span>.split(v, <span class="string">'='</span>)</span><br><span class="line">            t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.split</span><span class="params">(s, p)</span></span></span><br><span class="line">    rt = &#123;&#125;</span><br><span class="line">    <span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">'[^'</span>..p..<span class="string">']+'</span>, <span class="function"><span class="keyword">function</span><span class="params">(w)</span></span> <span class="built_in">table</span>.<span class="built_in">insert</span>(rt, w) <span class="keyword">end</span> )</span><br><span class="line">    <span class="keyword">return</span> rt</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- default function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(args)</span></span></span><br><span class="line">    <span class="keyword">local</span> needs = &#123;&#125;</span><br><span class="line">    needs[<span class="string">"protocol"</span>] = <span class="string">"http"</span></span><br><span class="line">    <span class="keyword">return</span> needs</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span> <span class="params">(args)</span></span></span><br><span class="line">    filename = SCLogPath() .. <span class="string">"/"</span> .. name</span><br><span class="line">    file = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">"a"</span>))</span><br><span class="line">    SCLogInfo(<span class="string">"app_login_audit filename: "</span> .. filename)</span><br><span class="line">    http = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- Connect Redis Server</span></span><br><span class="line">    SCLogInfo(<span class="string">"Connect Redis Server..."</span>)</span><br><span class="line">    client = redis.connect(host, port)</span><br><span class="line">    response = client:ping()</span><br><span class="line">    <span class="keyword">if</span> response <span class="keyword">then</span></span><br><span class="line">        SCLogInfo(<span class="string">"Redis Server connection succeeded."</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(args)</span></span></span><br><span class="line">    <span class="comment">-- init tables</span></span><br><span class="line">    http_table = &#123;</span><br><span class="line">        hostname = <span class="literal">nil</span>,</span><br><span class="line">        url = <span class="literal">nil</span>,</span><br><span class="line">        url_path = <span class="literal">nil</span>,</span><br><span class="line">        method = <span class="literal">nil</span>,</span><br><span class="line">        <span class="built_in">status</span> = <span class="literal">nil</span>,</span><br><span class="line">        protocol = <span class="literal">nil</span>,</span><br><span class="line">        email = <span class="literal">nil</span>,</span><br><span class="line">        results = <span class="literal">nil</span>,</span><br><span class="line">        results_code = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- ti tables</span></span><br><span class="line">    ti = &#123;</span><br><span class="line">        tags = &#123;&#125;,</span><br><span class="line">        provider = <span class="literal">nil</span>,</span><br><span class="line">        producer = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- init score</span></span><br><span class="line">    score = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_hostname &amp; http_url</span></span><br><span class="line">    http_hostname = HttpGetRequestHost()</span><br><span class="line">    http_url = HttpGetRequestUriNormalized()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- http_method</span></span><br><span class="line">    rl = HttpGetRequestLine()</span><br><span class="line">    <span class="keyword">if</span> rl <span class="keyword">then</span></span><br><span class="line">        http_method = <span class="built_in">string</span>.<span class="built_in">match</span>(rl, <span class="string">"%w+"</span>)</span><br><span class="line">        <span class="keyword">if</span> http_method <span class="keyword">then</span></span><br><span class="line">            http_table[<span class="string">"method"</span>] = http_method</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	</span><br><span class="line">	  <span class="comment">-- 为了保证 Suricata 的性能不受影响, 严格控制过滤条件</span></span><br><span class="line">    <span class="keyword">if</span> http_url == login_url <span class="keyword">and</span> http_method == <span class="string">"POST"</span> <span class="keyword">then</span></span><br><span class="line">        http_table[<span class="string">"hostname"</span>] = http_hostname</span><br><span class="line">        http_table[<span class="string">"url"</span>] = http_url</span><br><span class="line">        http_table[<span class="string">"url_path"</span>] = http_url</span><br><span class="line">        </span><br><span class="line">        <span class="comment">-- http_status &amp; http_protocol</span></span><br><span class="line">        rsl = HttpGetResponseLine()</span><br><span class="line">        <span class="keyword">if</span> rsl <span class="keyword">then</span></span><br><span class="line">            status_code = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"%s(%d+)%s"</span>)</span><br><span class="line">            <span class="keyword">if</span> status_code <span class="keyword">then</span></span><br><span class="line">                http_table[<span class="string">"status"</span>] = <span class="built_in">tonumber</span>(status_code)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            http_protocol = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"(.-)%s"</span>)</span><br><span class="line">            <span class="keyword">if</span> http_protocol <span class="keyword">then</span></span><br><span class="line">                http_table[<span class="string">"protocol"</span>] = http_protocol</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- login_results</span></span><br><span class="line">        a, o, e = HttpGetResponseBody()</span><br><span class="line">        <span class="keyword">if</span> a <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">                body = json.decode(v)</span><br><span class="line">                results_code = <span class="built_in">tonumber</span>(body[<span class="string">"code"</span>])</span><br><span class="line">                <span class="keyword">if</span> results_code == success_code <span class="keyword">then</span></span><br><span class="line">                    http_table[<span class="string">"results"</span>] = <span class="string">"success"</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    http_table[<span class="string">"results"</span>] = <span class="string">"failed"</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            http_table[<span class="string">"results_code"</span>] = results_code</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">--[[</span></span><br><span class="line"><span class="comment">            1. 获取用户登录email 并查询 Redis中是否存在该账号</span></span><br><span class="line"><span class="comment">            2. 根据结果进行相应的打分以及tags标注</span></span><br><span class="line"><span class="comment">        ]]</span></span><br><span class="line">        <span class="comment">-- </span></span><br><span class="line">        a, o, e = HttpGetRequestBody()</span><br><span class="line">        <span class="keyword">if</span> a <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">                res = formatStr(v)</span><br><span class="line">                <span class="keyword">if</span> res[<span class="string">"email"</span>] <span class="keyword">then</span></span><br><span class="line">                    <span class="comment">-- 查询Redis对比黑名单</span></span><br><span class="line">                    black_ioc = client:get(res[<span class="string">"email"</span>])</span><br><span class="line">                    <span class="keyword">if</span> black_ioc <span class="keyword">then</span></span><br><span class="line">                        ti[<span class="string">"provider"</span>] = <span class="string">"Canon"</span></span><br><span class="line">                        ti[<span class="string">"producer"</span>] = <span class="string">"NTA"</span></span><br><span class="line">                        <span class="built_in">table</span>.<span class="built_in">insert</span>(ti[<span class="string">"tags"</span>], <span class="string">"account in blacklist"</span>)</span><br><span class="line">                        score = score + <span class="number">10</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- RequestHeaders</span></span><br><span class="line">        rh = HttpGetRequestHeaders()</span><br><span class="line">        <span class="keyword">if</span> rh <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rh) <span class="keyword">do</span></span><br><span class="line">                key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line">                request_var = request_mapping_table[key]</span><br><span class="line">                <span class="keyword">if</span> request_var <span class="keyword">then</span></span><br><span class="line">                    http_table[request_var] = v</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- ResponseHeaders</span></span><br><span class="line">        rsh = HttpGetResponseHeaders()</span><br><span class="line">        <span class="keyword">if</span> rsh <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rsh) <span class="keyword">do</span></span><br><span class="line">                key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line">                response_var = response_mapping_table[key]</span><br><span class="line">                <span class="keyword">if</span> response_var <span class="keyword">then</span></span><br><span class="line">                    http_table[response_var] = v</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- timestring</span></span><br><span class="line">        sec, usec = SCPacketTimestamp()</span><br><span class="line">        timestring = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">"!%Y-%m-%dT%T"</span>, sec) .. <span class="string">'.'</span> .. usec .. <span class="string">'+0000'</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">-- flow_info</span></span><br><span class="line">        ip_version, src_ip, dst_ip, protocol, src_port, dst_port = SCFlowTuple()</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- flow_id</span></span><br><span class="line">        id = SCFlowId()</span><br><span class="line">        flow_id = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%.0f"</span>, id)</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- true_ip</span></span><br><span class="line">        true_client_ip = HttpGetRequestHeader(<span class="string">"True-Client-IP"</span>)</span><br><span class="line">        <span class="keyword">if</span> true_client_ip ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            src_ip = true_client_ip</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- session_id</span></span><br><span class="line">        tetrad = src_ip .. src_port .. dst_ip .. dst_port</span><br><span class="line">        session_id = md5Encode(tetrad)</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- table</span></span><br><span class="line">        raw_data = &#123;</span><br><span class="line">            timestamp = timestring,</span><br><span class="line">            flow_id = flow_id,</span><br><span class="line">            session_id = session_id,</span><br><span class="line">            src_ip = src_ip,</span><br><span class="line">            src_port = src_port,</span><br><span class="line">            proto = proto,</span><br><span class="line">            dest_ip = dst_ip,</span><br><span class="line">            dest_port = dst_port,</span><br><span class="line">            event_name = event_name,</span><br><span class="line">            event_type = event_type,</span><br><span class="line">            app_type = app_type,</span><br><span class="line">            http = http_table,</span><br><span class="line">            ti = ti,</span><br><span class="line">            score = score</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- json encode</span></span><br><span class="line">        data = json.encode(raw_data)</span><br><span class="line"></span><br><span class="line">        file:<span class="built_in">write</span>(data .. <span class="string">"\n"</span>)</span><br><span class="line">        file:<span class="built_in">flush</span>()</span><br><span class="line"></span><br><span class="line">        http = http + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deinit</span> <span class="params">(args)</span></span></span><br><span class="line">    SCLogInfo (<span class="string">"app_login_audit transactions logged: "</span> .. http);</span><br><span class="line">    file:<span class="built_in">close</span>(file)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>简单说下以上脚本的功能:</strong></p>
<ol>
<li>登录接口的用户名审计(废话…); </li>
<li>通过请求<strong>Redis</strong>比对当前用户是否在黑名单中, 并进行相应的打分、标签处理;</li>
<li>根据自定义的需求获取的http headers, 这个对于业务安全上还是有点用的;</li>
<li>针对<strong>CDN</strong>或者Nginx这种场景下, 可以直接对 xff 或者 true_client_ip 进行四元组的hash, 得到<strong>session_id</strong>, 这样溯源的时候会比较方便。因为在这种场景下传统的四层<strong>flow_id</strong>就不是那么有用了。</li>
<li>后续可以追加一些简单的检测方法, 例如:<ol>
<li>检查请求头中的字段是否完成;</li>
<li>检查请求头中的某个字段长度是否符合合规;</li>
<li>……</li>
</ol>
</li>
</ol>
<p><strong>配置Suricata启用Lua脚本</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- lua:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    scripts-dir:</span> <span class="string">/etc/suricata/lua-output/</span></span><br><span class="line"><span class="attr">    scripts:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">login_audit.lua</span></span><br></pre></td></tr></table></figure>

<p><strong>启用Suricata</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ suricata -vvv --pfring -k none -c /etc/suricata/suricata.yaml</span><br></pre></td></tr></table></figure>

<p><strong><em>注: 这里<code>-vvv</code> 参数建议加上. 如果你的Lua脚本有一些问题, 如果加上了这个参数, 就可以通过这个日志看出。</em></strong></p>
<h1 id="日志样例"><a href="#日志样例" class="headerlink" title="日志样例"></a>日志样例</h1><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">62722</span>,</span><br><span class="line">    <span class="attr">"score"</span>: <span class="number">65</span>,</span><br><span class="line">    <span class="attr">"session_id"</span>: <span class="string">"c863aeb2ef8d1b37f3257f8c210bf440"</span>,</span><br><span class="line">    <span class="attr">"ti"</span>: &#123;</span><br><span class="line">        <span class="attr">"tags"</span>: [</span><br><span class="line">            <span class="string">"account in blacklist"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"provider"</span>: <span class="string">"Canon"</span>,</span><br><span class="line">        <span class="attr">"producer"</span>: <span class="string">"NTA"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"alert"</span>: &#123;</span><br><span class="line">        <span class="attr">"alerted"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"rules"</span>: &#123;</span><br><span class="line">            <span class="attr">"请求头校验"</span>: <span class="string">"dev-id"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="string">"1064295903559076"</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-25T08:33:55.585519+0000"</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"lua"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"1.1.1.1"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">80</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"response_content_length"</span>: <span class="string">"96"</span>,</span><br><span class="line">        <span class="attr">"response_content_type"</span>: <span class="string">"application/json; charset=UTF-8"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">        <span class="attr">"results_code"</span>: <span class="number">400504</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"nginx"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Fri, 25 Oct 2019 08:33:55 GMT"</span>,</span><br><span class="line">        <span class="attr">"app_version"</span>: <span class="string">"6.6.0"</span>,</span><br><span class="line">        <span class="attr">"request_content_type"</span>: <span class="string">"application/x-www-form-urlencoded"</span>,</span><br><span class="line">        <span class="attr">"user_agent"</span>: <span class="string">"okhttp/3.12.0"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/login"</span>,</span><br><span class="line">        <span class="attr">"email"</span>: <span class="string">"canon@gmail.com"</span>,</span><br><span class="line">        <span class="attr">"results"</span>: <span class="string">"failed"</span>,</span><br><span class="line">        "pragma": "no-cache",-</span><br><span class="line">        "cache_control": "no-cache, max-age=0, no-store",</span><br><span class="line">        "connection": "keep-alive",</span><br><span class="line">        "status": 200,</span><br><span class="line">        "protocol": "HTTP/1.1",</span><br><span class="line">        "hostname": "x.x.x.x",</span><br><span class="line">        "url_path": "/login",</span><br><span class="line">        "method": "POST",</span><br><span class="line">        "device": "RMX1920 Android8.0.0",</span><br><span class="line">        "device_type": "Android",</span><br><span class="line">        "request_content_length": "39"</span><br><span class="line">    &#125;,</span><br><span class="line">    "event_name": "login_audit",</span><br><span class="line">    "dest_ip": "2.2.2.2"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/18/Wazuh-Using-CDB-lists/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/18/Wazuh-Using-CDB-lists/" class="post-title-link" itemprop="url">Wazuh - 黑名单匹配告警(CDB list)</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-18 11:28:56 / 修改时间：15:17:46" itemprop="dateCreated datePublished" datetime="2019-10-18T11:28:56+08:00">2019-10-18</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HIDS/" itemprop="url" rel="index"><span itemprop="name">HIDS</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>需求:</strong></p>
<p>​        现有一批高危用户, 需要实时关注该账号的登录情况。由于之前已经写好了一个针对用户登录账号的审计规则, 因此, 这里需要用到<strong><a href="https://documentation.wazuh.com/3.10/user-manual/ruleset/cdb-list.html" target="_blank" rel="noopener">Wazuh CDB list</a></strong>这个功能(<em>此功能主要用例是创建用户，IP或域名的白/黑列表。</em>)消费审计规则数据即可。</p>
<hr>
<ol>
<li><strong>新建列表</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ more blacklist</span><br><span class="line"></span><br><span class="line">admin:</span><br><span class="line">root:</span><br><span class="line">administrator:</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>将列表文件添加到<code>ossec.conf</code></strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ more ossec.conf</span><br><span class="line"></span><br><span class="line">&lt;ossec_config&gt;</span><br><span class="line">	&lt;ruleset&gt;</span><br><span class="line">    &lt;!-- User-defined CDB list --&gt;</span><br><span class="line">    &lt;list&gt;etc/lists/blacklist&lt;/list&gt;</span><br><span class="line">	&lt;/ruleset&gt;</span><br><span class="line">&lt;/ossec_config&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>编译列表</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ /var/ossec/bin/ossec-makelists</span><br><span class="line"></span><br><span class="line"> * File etc/lists/blacklist.cdb needs to be updated</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>重启进程</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl restart wazuh-manager</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><strong>配置规则</strong></li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"local,blacklist,"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Defind blacklist Rules --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ID: 100150 - 100199 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"100163"</span> <span class="attr">level</span>=<span class="string">"12"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_sid</span>&gt;</span>100303<span class="tag">&lt;/<span class="name">if_sid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span> <span class="attr">field</span>=<span class="string">"http.email"</span> <span class="attr">lookup</span>=<span class="string">"match_key"</span>&gt;</span>etc/lists/blacklist<span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Wazuh Rules - High-risk user login detected. $(src_ip) -&gt; $(http.email) -&gt; $(http.hostname) -&gt; $(http.url) = $(http.results).<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span>blacklist,<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li><strong>测试规则</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ./ossec-logtest</span><br><span class="line">2019/10/18 15:06:47 ossec-testrule: INFO: Started (pid: 2184).</span><br><span class="line">ossec-testrule: Type one <span class="built_in">log</span> per line.</span><br><span class="line"></span><br><span class="line">**Phase 3: Completed filtering (rules).</span><br><span class="line">       Rule id: <span class="string">'100163'</span></span><br><span class="line">       Level: <span class="string">'12'</span></span><br><span class="line">       Description: <span class="string">'Wazuh Rules - High-risk user login detected. 1.1.1.1 -&gt; admin -&gt; canon88.github.io -&gt; /user/login = success.'</span></span><br><span class="line">**Alert to be generated.</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/" class="post-title-link" itemprop="url">我在'云'上的日子 - AWS上流量镜像遇到的坑</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-16 17:24:30" itemprop="dateCreated datePublished" datetime="2019-10-16T17:24:30+08:00">2019-10-16</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-18 11:29:55" itemprop="dateModified" datetime="2019-10-18T11:29:55+08:00">2019-10-18</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​    </p>
<p>​        自从AWS在6月份新出了<strong>Traffic Mirroring</strong>功能后, 我也算是第一时间使用了这个功能。与传统的交换机流量镜像不同的是, AWS上是将流量镜像后的数据通过<strong>VXLAN</strong>协议发送至流量分析引擎(<strong>Suricata</strong>、<strong>Zeek</strong>)。正是由于这一点让我碰到了以下几个问题, 这里写出来希望对大家有所帮助。</p>
<ol>
<li>接收流量镜像的目标端, 也就是我们常说的流量分析引擎端是有接收限制的。</li>
</ol>
<p>​       如果你是在一个非专用实例上部署的Suricata、Zeek。那么你只能最多同时接收10个源的流量镜像, 也就是你只能接收10个网卡的数据。很不巧的是我们碰上了这个问题, 解决方案也很简单, 使用专用实例(<strong>Dedicated instance</strong>) 或者 使用AWS的网络负载均衡(<strong>Network Load Balancer</strong>)。前者可以将Limit提升到<strong>100</strong>, 后者将<strong>不受限</strong>。如图:</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016164935291.png" alt="image-20191016164935291"></p>
<hr>
<ol start="2">
<li>C5与C4实例的差异</li>
</ol>
<p>​        就我目前使用的实例而言, 分别测试过C5 与 C4两种实例。他们的网卡驱动有所区别的, 如图:</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016160923628.png" alt="image-20191016160923628"></p>
<p>​        我这使用下来最直观的区别, 在C4实例上若不使用PF_RING捕包模式的话, Suricata丢包率感人, 0.5 Gbps就开始丢包。测试的机器配置: 32C 60G的机器, 切换到PF_RING捕包模式无此问题。反之C5实例就不存在这个问题, AF-PACKET直接上到2 Gbps的纯HTTP流量都没有丢包。硬件配置: 16C 32G的机器。</p>
<hr>
<ol start="3">
<li>超过<strong>MTU: 9001</strong>数据包被截断</li>
</ol>
<p>​      这几天在排查安全事件时, 发现监控的同一台Nginx上解析出的流量(HTTP事件)与日志(HTTP事件)数量相差较大。经过两天的排查终于定位了问题, Suricata kernel 并没有丢包, 所以怀疑是不是Suricata HTTP解析出错导致。最终通过抓包发现导致该问题的”罪魁祸首”就是<strong>VXLAN</strong>, 由于AWS在流量镜像时采用了<strong>VXLAN</strong>协议进行封装, 导致在原有<strong>MTU</strong>的基础上<strong>增加了50个字节</strong>, 造成数据包被截断, 无法还原出HTTP事件。以下截图就是一个无法被正确还原HTTP事件的数据包, 我用Suricata载入数据包后, 只还原出了长度<strong>9015</strong>数据包之前的HTTP信息, 长度<strong>9015</strong>数据包之后的所有事件均无法被还原。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191014095249725.png" alt="image-20191014095249725"></p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191014094741753.png" alt="image-20191014094741753"></p>
<p><strong>官方描述:</strong></p>
<p>​        For example, if an 8996 byte packet is mirrored, and the traffic mirror target MTU value is 9001 bytes, the mirror encapsulation results in the mirrored packet being greater than the MTU value. In this case, the mirror packet is truncated. To prevent mirror packets from being truncated, set the traffic mirror source interface MTU value to 54 bytes less than the traffic mirror target MTU value. For more information about configuring the network MTU value, see Network Maximum Transmission Unit (MTU) for Your EC2 Instance in the <em>Amazon EC2 User Guide for Linux Instances</em>.</p>
<p>​        例如，如果对8996字节的数据包进行了镜像，并且流量镜像目标MTU值为9001字节，则镜像封装会导致镜像的数据包大于MTU值。在这种情况下，镜像数据包将被截断。为防止镜像数据包被截断，请将流量镜像源接口的MTU值设置为比流量镜像目标MTU值小54个字节。有关配置网络MTU值的更多信息，请参阅Amazon EC2 Linux实例用户指南中的EC2实例的网络最大传输单位（MTU）。</p>
<hr>
<p><strong>关于VXLAN导致Suricata无法正常解析数据的问题, 特地进行了测试:</strong></p>
<p>准备工作:</p>
<ul>
<li>新建了<strong>test_files</strong>文件, 该文件只包含内容’<strong>hello, world!</strong>‘;</li>
<li>为了使数据包在传输时满足<strong>MTU: 9001</strong>, 手动生成了一个10MB空文件<strong>10mb_exist_files</strong>. </li>
</ul>
<p>共计访问: 14次</p>
<p>访问顺序:</p>
<ol>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (次)</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (次)</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (次)</li>
</ol>
<p>正常情况:</p>
<ul>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (次) - 正常</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (次) - 正常</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (次) - 正常</li>
</ul>
<p>异常情况:</p>
<ul>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (次) - 正常</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (次) - 异常</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (次) - 丢失</li>
</ul>
<p><strong>MTU: 9001</strong></p>
<ul>
<li>非镜像流量的数据包详情:</li>
</ul>
<p>可以看到从数据包<strong>20</strong>到数据包<strong>6126</strong>之间都是在进行<strong>10MB</strong>文件(<strong>10mb_exist_files</strong>)的传输过程。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016103409831.png" alt="image-20191016103409831"></p>
<hr>
<p>从http数据包中可以看出, 这里请求包与响应包都可以正常被还原出来。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016104502919.png" alt="image-20191016104502919"></p>
<hr>
<p>数据包在Suricata上的解析结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-15T22:52:10.180505+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">415026399241324</span>,</span><br><span class="line">    <span class="attr">"pcap_cnt"</span>: <span class="number">6127</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43418</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"http_content_type"</span>: <span class="string">"text/html"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress"</span>,</span><br><span class="line">        <span class="attr">"content_length"</span>: <span class="string">"41943044"</span>,</span><br><span class="line">        <span class="attr">"content_type"</span>: <span class="string">"text/html; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Tue, 15 Oct 2019 14:52:10 GMT"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"Werkzeug/0.16.0 Python/2.7.16"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">41943044</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>镜像流量的数据包详情:</strong>(也就是<strong>VXLAN</strong>封装后的数据包)</li>
</ul>
<p>同样可以看到从数据包<strong>26</strong>到数据包<strong>6170</strong>之间都是在进行<strong>10MB</strong>文件(<strong>10mb_exist_files</strong>)的传输过程。但是在第<strong>34</strong>个数据包中可以看到, 已经标注了数据超出了最大长度。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016105636906.png" alt="image-20191016105636906"></p>
<hr>
<p>超出长度的数据将会被截断, 标注: <strong>50 bytes missing in capture file</strong>。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016150322620.png" alt="image-20191016150322620"></p>
<p>从HTTP数据包中可以看出, 这里只有请求包, 由于后续的响应包超出了<strong>MTU: 9001</strong>,  因此并没有响应包。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016105948606.png" alt="image-20191016105948606"></p>
<hr>
<p>数据包在Suricata上的解析结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-15T22:52:48.295823+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">1746715371266426</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43420</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>结论:</strong></p>
<p>​        相比非镜像流量的数据包, Suricata 少了后续10条http请求的数据解析。针对访问<strong>10mb_exist_files</strong>的请求, 由于超过了MTU, 数据包被阶段了, http的解析数据也是不完整的。</p>
<p><strong>解决方案:</strong></p>
<p>​        这里直接引用AWS的官方文档描述。如果对8996字节的数据包进行了镜像，并且流量镜像目标MTU值为9001字节，则镜像封装会导致镜像的数据包大于MTU值。在这种情况下，镜像数据包将被截断。为防止镜像数据包被截断，请将流量镜像源接口的MTU值设置为比流量镜像目标MTU值小54个字节。有关配置网络MTU值的更多信息，请参阅Amazon EC2 Linux实例用户指南中的EC2实例的网络最大传输单位（MTU）。</p>
<p>​        一般来说，降低 MTU 的话，有可能发现网路传输效能有下降，这是因为每个封包 size 变小，所以传送同样的资料量，封包数就会变多，造成 overhead 变多。但是对于传输是不会产生错误的状况的。</p>
<hr>
<p><strong>MTU:1500</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br><span class="line"></span><br><span class="line">$ sudo ip link <span class="built_in">set</span> dev eth0 mtu 1500</span><br><span class="line"></span><br><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016154823748.png" alt="image-20191016154823748"></p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016155112376.png" alt="image-20191016155112376"></p>
<p>数据包在Suricata上的解析结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-16T15:14:15.576656+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">1135596924232203</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43554</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"http_content_type"</span>: <span class="string">"text/html"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress\n"</span>,</span><br><span class="line">        <span class="attr">"content_length"</span>: <span class="string">"41943044"</span>,</span><br><span class="line">        <span class="attr">"content_type"</span>: <span class="string">"text/html; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Wed, 16 Oct 2019 07:14:15 GMT"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"Werkzeug/0.16.0 Python/2.7.16"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">41943044</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        结论: <strong>MTU减小到1500时</strong>, 无论从WireShark来查看或者Suricata协议还原的角度来说, 都是可以的。</p>
<hr>
<p>​        写在最后, 说实话AWS提供了在云上的流量镜像确实很不错, 至少比传统在云上每一台机器通过安装agent把流量外发的形式强, 似乎<strong>国内</strong>的云厂商现在也没有这个功能! </p>
<p>​        不过通过VXLAN将数据包封装后导致MTU超过最大值这问题也确实有点坑。你让已经成型的架构去调整MTU值, 虽然理论上是可行, 但实际生产环境中网络的调整都是比较慎重的, 除非企业现在必须得上流量镜像, 否则不太能说服运维的小伙伴去调整, 要是真出了什么问题, 都是大问题。</p>
<p><strong>参考</strong></p>
<ul>
<li><a href="https://docs.aws.amazon.com/vpc/latest/mirroring/vpc-tm.pdf" target="_blank" rel="noopener">Amazon Virtual Private Cloud Traffic Mirroring</a></li>
<li><a href="https://community.emc.com/community/support/chinese/teamblog/blog/2016/05/12/大咖讲网络-mtu导致的悲剧" target="_blank" rel="noopener">大咖讲网络-mtu导致的悲剧</a></li>
<li><a href="https://www.cnblogs.com/sammyliu/p/5079898.html" target="_blank" rel="noopener">Neutron VxLAN + Linux Bridge 环境中的网络 MTU</a></li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/14/Suricata - Lua Output/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/14/Suricata - Lua Output/" class="post-title-link" itemprop="url">Suricata - Lua Output Script</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-14 10:45:12" itemprop="dateCreated datePublished" datetime="2019-10-14T10:45:12+08:00">2019-10-14</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-18 11:29:51" itemprop="dateModified" datetime="2019-10-18T11:29:51+08:00">2019-10-18</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>​    由于近期网站遭受大量撞库攻击, 想监控一下登录接口中的异常行为。通过<strong>alert</strong>并不能起到很好的效果, 所以采用<strong>Lua</strong>脚本进行扩展, 写了一个审计登录接口的脚本。通过登录接口事件, 再配合<strong>Wazuh</strong>进行一些简单的关联告警,  效果还是不错的。</p>
<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><ul>
<li>由于审计内容涉及到用户敏感信息, 因此需要对敏感信息进行<strong>Hash</strong>之后再输出;</li>
<li>除通用<strong>HTTP Header</strong>字段外支持对自定义字段进行选择性输出;</li>
</ul>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line">json = <span class="built_in">require</span> <span class="string">"json"</span></span><br><span class="line">md5 = <span class="built_in">require</span> <span class="string">"md5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 登录接口</span></span><br><span class="line">login_url = <span class="string">"/login"</span></span><br><span class="line"><span class="comment">-- 登录状态码</span></span><br><span class="line">success_code = <span class="number">0</span></span><br><span class="line"><span class="comment">-- event_name</span></span><br><span class="line">event_name = <span class="string">"login_audit"</span></span><br><span class="line"><span class="comment">-- event_type</span></span><br><span class="line">event_type = <span class="string">"lua"</span></span><br><span class="line"><span class="comment">-- app_type</span></span><br><span class="line">app_type = <span class="string">"web"</span></span><br><span class="line"><span class="comment">-- logs</span></span><br><span class="line">name = <span class="string">"web_login_audit.json"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- common_mapping</span></span><br><span class="line">http_common_mapping = <span class="string">'&#123;"accept":"accept","accept-charset":"accept_charset","accept-encoding":"accept_encoding","accept-language":"accept_language","accept-datetime":"accept_datetime","authorization":"authorization","cache-control":"cache_control","from":"from","max-forwards":"max_forwards","origin":"origin","pragma":"pragma","proxy-authorization":"proxy_authorization","via":"via","vary":"vary","x-requested-with":"x_requested_with","x-forwarded-proto":"x_forwarded_proto","accept-range":"accept_range","allow":"allow","connection":"connection","content-encoding":"content_encoding","content-language":"content_language","content-location":"content_location","content-md5":"content_md5","content-range":"content_range","date":"date","last-modified":"last_modified","location":"location","proxy-authenticate":"proxy_authenticate","referrer":"refer","retry-after":"retry_after","server":"server","transfer-encoding":"transfer_encoding","upgrade":"upgrade","www-authenticate":"www_authenticate","x-authenticated-user":"x_authenticated_user","user-agent":"user_agent"&#125;'</span></span><br><span class="line">common_mapping_table = json.decode(http_common_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- request_mapping</span></span><br><span class="line">http_request_mapping = <span class="string">'&#123;"content-length":"request_content_length","content-type":"request_content_type"&#125;'</span></span><br><span class="line">request_mapping_table = json.decode(http_request_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- response_mapping</span></span><br><span class="line">http_response_mapping = <span class="string">'&#123;"content-length":"response_content_length","content-type":"response_content_type"&#125;'</span></span><br><span class="line">response_mapping_table = json.decode(http_response_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- defind functioin</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5Encode</span><span class="params">(args)</span></span></span><br><span class="line">    m = md5.new()</span><br><span class="line">    m:update(args)</span><br><span class="line">    <span class="keyword">return</span> md5.tohex(m:finish())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlDecode</span><span class="params">(args)</span></span></span><br><span class="line">    s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(args, <span class="string">"%%(%x%x)"</span>, <span class="function"><span class="keyword">function</span><span class="params">(h)</span></span> <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="built_in">tonumber</span>(h, <span class="number">16</span>)) <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- email=xxx@yyy.com&amp;password=zzz</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStr</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    data = <span class="built_in">string</span>.split(args, <span class="string">'&amp;'</span>)</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">        d = <span class="built_in">string</span>.split(v, <span class="string">'='</span>)</span><br><span class="line">        t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.split</span><span class="params">(s, p)</span></span></span><br><span class="line">    <span class="keyword">local</span> rt = &#123;&#125;</span><br><span class="line">    <span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">'[^'</span>..p..<span class="string">']+'</span>, <span class="function"><span class="keyword">function</span><span class="params">(w)</span></span> <span class="built_in">table</span>.<span class="built_in">insert</span>(rt, w) <span class="keyword">end</span> )</span><br><span class="line">    <span class="keyword">return</span> rt</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trim</span><span class="params">(s)</span></span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">"^%s*(.-)%s*$"</span>, <span class="string">"%1"</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatCookie</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    data = <span class="built_in">string</span>.split(args, <span class="string">";"</span>)</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">        v = trim(v)</span><br><span class="line">        d = <span class="built_in">string</span>.split(v, <span class="string">"="</span>)</span><br><span class="line">        t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- default function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(args)</span></span></span><br><span class="line">    <span class="keyword">local</span> needs = &#123;&#125;</span><br><span class="line">    needs[<span class="string">"protocol"</span>] = <span class="string">"http"</span></span><br><span class="line">    <span class="keyword">return</span> needs</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span> <span class="params">(args)</span></span></span><br><span class="line">    filename = SCLogPath() .. <span class="string">"/"</span> .. name</span><br><span class="line">    file = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">"a"</span>))</span><br><span class="line">    SCLogInfo(<span class="string">"Web Login Log Filename "</span> .. filename)</span><br><span class="line">    http = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(args)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- init tables</span></span><br><span class="line">    http_table = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_hostname</span></span><br><span class="line">    http_hostname = HttpGetRequestHost()</span><br><span class="line">    http_table[<span class="string">"hostname"</span>] = http_hostname</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_url</span></span><br><span class="line">    http_url = HttpGetRequestUriNormalized()</span><br><span class="line">    <span class="keyword">if</span> http_url ~= login_url <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"url"</span>] = login_url</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_url_path</span></span><br><span class="line">    http_table[<span class="string">"url_path"</span>] = http_url</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_method</span></span><br><span class="line">    rl = HttpGetRequestLine()</span><br><span class="line">    http_method = <span class="built_in">string</span>.<span class="built_in">match</span>(rl, <span class="string">"%w+"</span>)</span><br><span class="line">    http_table[<span class="string">"method"</span>] = http_method</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_status</span></span><br><span class="line">    rsl = HttpGetResponseLine()</span><br><span class="line">    status_code = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"%s(%d+)%s"</span>)</span><br><span class="line">    http_status = <span class="built_in">tonumber</span>(status_code)</span><br><span class="line">    http_table[<span class="string">"status"</span>] = http_status</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_protocol</span></span><br><span class="line">    http_protocol = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"(.-)%s"</span>)</span><br><span class="line">    http_table[<span class="string">"protocol"</span>] = http_protocol</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- request_token</span></span><br><span class="line">    cookie = HttpGetRequestHeader(<span class="string">"Cookie"</span>)</span><br><span class="line">    <span class="keyword">if</span> cookie ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        session_id = <span class="built_in">string</span>.<span class="built_in">match</span>(cookie, <span class="string">"sessionID=(.-);"</span>)</span><br><span class="line">        <span class="keyword">if</span> session_id ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[<span class="string">"request_token"</span>] = md5Encode(session_id)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            http_table[<span class="string">"request_token"</span>]  = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- response_token &amp;&amp; member_id</span></span><br><span class="line">    set_cookie = HttpGetResponseHeader(<span class="string">"Set-Cookie"</span>)</span><br><span class="line">    <span class="keyword">if</span> set_cookie ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        session_id = <span class="built_in">string</span>.<span class="built_in">match</span>(set_cookie, <span class="string">"sessionID=(.-);"</span>)</span><br><span class="line">        http_table[<span class="string">"response_token"</span>]  = md5Encode(session_id)</span><br><span class="line">        member_id = <span class="built_in">string</span>.<span class="built_in">match</span>(set_cookie, <span class="string">"memberId=(.-);"</span>)</span><br><span class="line">        http_table[<span class="string">"member_id"</span>] = <span class="built_in">tonumber</span>(member_id)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- login_results</span></span><br><span class="line">    a, o, e = HttpGetResponseBody()</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        body = json.decode(v)</span><br><span class="line">        results_code = <span class="built_in">tonumber</span>(body[<span class="string">"code"</span>])</span><br><span class="line">        <span class="keyword">if</span> results_code == success_code <span class="keyword">then</span></span><br><span class="line">            results = <span class="string">"success"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            results = <span class="string">"failed"</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"results"</span>] = results</span><br><span class="line">    http_table[<span class="string">"results_code"</span>] = results_code</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- email &amp; password</span></span><br><span class="line">    a, o, e = HttpGetRequestBody()</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        res = formatStr(v)</span><br><span class="line">        mail = urlDecode(res[<span class="string">'email'</span>])</span><br><span class="line">        pass = md5Encode(res[<span class="string">'password'</span>])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"email"</span>] = mail</span><br><span class="line">    http_table[<span class="string">"password"</span>] = pass</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- RequestHeaders</span></span><br><span class="line">    rh = HttpGetRequestHeaders()</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rh) <span class="keyword">do</span></span><br><span class="line">        key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line"></span><br><span class="line">        common_var = common_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> common_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[common_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        request_var = request_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> request_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[request_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- ResponseHeaders</span></span><br><span class="line">    rsh = HttpGetResponseHeaders()</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rsh) <span class="keyword">do</span></span><br><span class="line">        key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line"></span><br><span class="line">        common_var = common_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> common_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[common_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        response_var = response_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> response_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[response_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- timestring = SCPacketTimeString() 2019-09-10T06:08:35.582449+0000</span></span><br><span class="line">    sec, usec = SCPacketTimestamp()</span><br><span class="line">    timestring = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">"!%Y-%m-%dT%T"</span>, sec) .. <span class="string">"."</span> .. usec .. <span class="string">"+0000"</span></span><br><span class="line">    </span><br><span class="line">    ip_version, src_ip, dst_ip, protocol, src_port, dst_port = SCFlowTuple()</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- flow_id</span></span><br><span class="line">    id = SCFlowId()</span><br><span class="line">    flow_id = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%.0f"</span>, id)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- true_ip</span></span><br><span class="line">    true_client_ip = HttpGetRequestHeader(<span class="string">"True-Client-IP"</span>)</span><br><span class="line">    <span class="keyword">if</span> true_client_ip ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        src_ip = true_client_ip</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- table</span></span><br><span class="line">    raw_data = &#123;</span><br><span class="line">        timestamp = timestring,</span><br><span class="line">        flow_id = flow_id,</span><br><span class="line">        src_ip = src_ip,</span><br><span class="line">        src_port = src_port,</span><br><span class="line">        dest_ip = dst_ip,</span><br><span class="line">        dest_port = dst_port,</span><br><span class="line">        event_name = event_name,</span><br><span class="line">        event_type = event_type,</span><br><span class="line">        app_type = app_type,</span><br><span class="line">        http = http_table,</span><br><span class="line">        proto = <span class="string">"TCP"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- json encode</span></span><br><span class="line">    data = json.encode(raw_data)</span><br><span class="line"></span><br><span class="line">    file:<span class="built_in">write</span>(data .. <span class="string">"\n"</span>)</span><br><span class="line">    file:<span class="built_in">flush</span>()</span><br><span class="line"></span><br><span class="line">    http = http + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deinit</span> <span class="params">(args)</span></span></span><br><span class="line">    SCLogInfo (<span class="string">"HTTP transactions logged: "</span> .. http);</span><br><span class="line">    file:<span class="built_in">close</span>(file)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">34963</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"lua"</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="string">"471693756052529"</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-07T13:51:01.560556+0000"</span>,</span><br><span class="line">    <span class="attr">"event_name"</span>: <span class="string">"login_audit"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">3007</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"response_content_length"</span>: <span class="string">"446"</span>,</span><br><span class="line">        <span class="attr">"response_content_type"</span>: <span class="string">"application/json; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"nginx"</span>,</span><br><span class="line">        <span class="attr">"results_code"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"vary"</span>: <span class="string">"Accept-Encoding"</span>,</span><br><span class="line">        <span class="attr">"password"</span>: <span class="string">"420ce28ef813a2dc05e52a7e24eb0d5c"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Mon, 07 Oct 2019 13:51:01 GMT"</span>,</span><br><span class="line">        <span class="attr">"request_content_type"</span>: <span class="string">"application/x-www-form-urlencoded; charset=UTF-8"</span>,</span><br><span class="line">        <span class="attr">"accept_language"</span>: <span class="string">"en-US,en;q=0.9"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/login"</span>,</span><br><span class="line">        <span class="attr">"x_requested_with"</span>: <span class="string">"XMLHttpRequest"</span>,</span><br><span class="line">        <span class="attr">"x_forwarded_proto"</span>: <span class="string">"https"</span>,</span><br><span class="line">        <span class="attr">"user_agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36"</span>,</span><br><span class="line">        <span class="attr">"origin"</span>: <span class="string">"https://www.canon.com"</span>,</span><br><span class="line">        <span class="attr">"response_token"</span>: <span class="string">"4f5f386aec34e877ce63fce7ddd3f15f"</span>,</span><br><span class="line">        <span class="attr">"pragma"</span>: <span class="string">"no-cache"</span>,</span><br><span class="line">        <span class="attr">"connection"</span>: <span class="string">"close"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"www.canon.com"</span>,</span><br><span class="line">        <span class="attr">"url_path"</span>: <span class="string">"/login"</span>,</span><br><span class="line">        <span class="attr">"cache_control"</span>: <span class="string">"no-cache, max-age=0, no-store, must-revalidate"</span>,</span><br><span class="line">        <span class="attr">"method"</span>: <span class="string">"POST"</span>,</span><br><span class="line">        <span class="attr">"email"</span>: <span class="string">"admin@canon.com"</span>,</span><br><span class="line">        <span class="attr">"request_token"</span>: <span class="string">"109464370570b23fa9768078ab1ac8a9"</span>,</span><br><span class="line">        <span class="attr">"member_id"</span>: <span class="number">123456</span>,</span><br><span class="line">        <span class="attr">"results"</span>: <span class="string">"success"</span>,</span><br><span class="line">        <span class="attr">"request_content_length"</span>: <span class="string">"49"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"77.99.22.17"</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"1.1.1.1"</span>,</span><br><span class="line">    <span class="attr">"app_type"</span>: <span class="string">"web"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/14/我在云上的日子 - Zeek部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/14/我在云上的日子 - Zeek部署/" class="post-title-link" itemprop="url">我在'云'上的日子 - Zeek(部署)</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-14 10:32:54" itemprop="dateCreated datePublished" datetime="2019-10-14T10:32:54+08:00">2019-10-14</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-18 11:29:57" itemprop="dateModified" datetime="2019-10-18T11:29:57+08:00">2019-10-18</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://holdmybeersecurity.com/2019/04/03/part-1-install-setup-zeek-pf_ring-on-ubuntu-18-04-on-proxmox-5-3-openvswitch/" target="_blank" rel="noopener"><strong>PART 1: INSTALL/SETUP ZEEK + PF_RING ON UBUNTU 18.04 ON PROXMOX 5.3 + OPENVSWITCH</strong></a></p>
<h1 id="Zeek"><a href="#Zeek" class="headerlink" title="Zeek"></a>Zeek</h1><p><strong>参考:</strong></p>
<ul>
<li><strong><a href="https://docs.zeek.org/en/stable/install/install.html" target="_blank" rel="noopener">Installing Zeek</a></strong></li>
</ul>
<p><strong>Required Dependencies</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install cmake make gcc g++ flex bison libpcap-dev libssl-dev python-dev swig zlib1g-dev</span><br></pre></td></tr></table></figure>

<p><em>If your system uses Python 2.7, then you will also need to install the <code>python-ipaddres</code> package.</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install python-ipaddress</span><br></pre></td></tr></table></figure>

<p><strong>Optional Dependencies</strong></p>
<ul>
<li>libmaxminddb (for geolocating IP addresses)</li>
<li>sendmail (enables Bro and BroControl to send mail)</li>
<li>curl (used by a Bro script that implements active HTTP)</li>
<li>gperftools (tcmalloc is used to improve memory and CPU usage)</li>
<li>jemalloc (<a href="http://www.canonware.com/jemalloc/" target="_blank" rel="noopener">http://www.canonware.com/jemalloc/</a>)</li>
<li>PF_RING (Linux only, see <a href="https://docs.zeek.org/en/stable/configuration/index.html" target="_blank" rel="noopener">Cluster Configuration</a>)</li>
<li>krb5 libraries and headers</li>
<li>ipsumdump (for trace-summary; <a href="http://www.cs.ucla.edu/~kohler/ipsumdump" target="_blank" rel="noopener">http://www.cs.ucla.edu/~kohler/ipsumdump</a>)</li>
</ul>
<p><strong>Installing Bro</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> --recursive https://github.com/zeek/zeek</span><br><span class="line">$ ./configure --with-pcap=/usr/<span class="built_in">local</span>/include --with-geoip=/usr/share/GeoIP</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>Add PATH</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/zeek/bin:<span class="variable">$PATH</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim ~/.bashrc</span><br><span class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/zeek/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p><strong>Enable Json</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ vim /usr/<span class="built_in">local</span>/zeek/share/zeek/site/local.zeek</span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to enable logging of link-layer addresses. Enabling</span></span><br><span class="line"><span class="comment"># this adds the link-layer address for each connection endpoint to the conn.log file.</span></span><br><span class="line"><span class="comment"># @load policy/protocols/conn/mac-logging</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">@load policy/tuning/json-logs.zeek</span><br></pre></td></tr></table></figure>

<p><strong>Using PF_RING</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ vim /usr/<span class="built_in">local</span>/zeek/etc/node.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example ZeekControl node configuration.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This example has a standalone node ready to go except for possibly changing</span></span><br><span class="line"><span class="comment"># the sniffing interface.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is a complete standalone configuration.  Most likely you will</span></span><br><span class="line"><span class="comment"># only need to change the interface.</span></span><br><span class="line"><span class="comment"># [zeek]</span></span><br><span class="line"><span class="comment"># type=standalone</span></span><br><span class="line"><span class="comment"># host=localhost</span></span><br><span class="line"><span class="comment"># interface=ens33</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Below is an example clustered configuration. If you use this,</span></span><br><span class="line"><span class="comment">## remove the [zeek] node above.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[logger]</span></span><br><span class="line"><span class="comment">#type=logger</span></span><br><span class="line"><span class="comment">#host=localhost</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[manager]</span><br><span class="line"><span class="built_in">type</span>=manager</span><br><span class="line">host=localhost</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[proxy-1]</span><br><span class="line"><span class="built_in">type</span>=proxy</span><br><span class="line">host=localhost</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[worker-1]</span><br><span class="line"><span class="built_in">type</span>=worker</span><br><span class="line">host=localhost</span><br><span class="line">interface=ens33</span><br><span class="line">lb_method=pf_ring</span><br><span class="line">lb_procs=1</span><br><span class="line">pin_cpus=1</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#[worker-2]</span></span><br><span class="line"><span class="comment">#type=worker</span></span><br><span class="line"><span class="comment">#host=localhost</span></span><br><span class="line"><span class="comment">#interface=eth0</span></span><br></pre></td></tr></table></figure>

<h1 id="Optional-Dependencies"><a href="#Optional-Dependencies" class="headerlink" title="Optional Dependencies"></a>Optional Dependencies</h1><h2 id="PF-RING"><a href="#PF-RING" class="headerlink" title="PF_RING"></a>PF_RING</h2><p><strong>参考:</strong></p>
<ul>
<li><strong><a href="https://www.zeek.org/documentation/load-balancing.html" target="_blank" rel="noopener">Installing PF_RING</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/ntop/PF_RING.git</span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo insmod ./pf_ring.ko</span><br><span class="line">$ <span class="built_in">cd</span> ../userland</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p><strong>pfring</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/src</span><br><span class="line">$ tar xvzf PF_RING-6.2.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> PF_RING-6.2.0/userland/lib</span><br><span class="line">$ ./configure --prefix=/opt/pfring</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>libpcap</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../libpcap</span><br><span class="line">$ ./configure --prefix=/opt/pfring</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>tcpdump</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../tcpdump</span><br><span class="line">$ ./configure --prefix=/opt/pfring</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../../kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>Load pf_ring at boot</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'pf_ring'</span> &gt;&gt; /etc/modules</span><br><span class="line">$ sudo reboot</span><br><span class="line"></span><br><span class="line">root@ubuntu:~<span class="comment"># lsmod | grep pf_ring</span></span><br><span class="line">pf_ring              1245184  0</span><br></pre></td></tr></table></figure>

<p><em>确保Zeek正确链接到所需的libpcap库:</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/usr/<span class="built_in">local</span>/zeek/etc<span class="comment"># ldd /usr/local/zeek/bin/zeek | grep pcap</span></span><br><span class="line">	libpcap.so.1 =&gt; /opt/pfring/lib/libpcap.so.1 (0x00007fc3c199d000)</span><br></pre></td></tr></table></figure>

<h2 id="GeoLocation"><a href="#GeoLocation" class="headerlink" title="GeoLocation"></a>GeoLocation</h2><p><strong>参考:</strong></p>
<ul>
<li><strong><a href="https://docs.zeek.org/en/stable/frameworks/geoip.html#geolocation" target="_blank" rel="noopener">Installing LibgeoIP</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install libmaxminddb-dev</span><br><span class="line">$ wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz</span><br><span class="line">$ tar zxf GeoLite2-City.tar.gz</span><br><span class="line">$ mkdir -p /usr/share/GeoIP</span><br><span class="line">$ mv GeoLite2-City_20190702/GeoLite2-City.mmdb /usr/share/GeoIP/</span><br></pre></td></tr></table></figure>

<p><strong>Testing</strong></p>
<p><em>如果未找到任何内容或未设置<code>mmdb_dir</code>，则Bro按以下顺序查找位置数据库文件：</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bro -e <span class="string">"print lookup_location(8.8.8.8);"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>/usr/share/GeoIP/GeoLite2-City.mmdb</li>
<li>/var/lib/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/local/share/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/local/var/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/share/GeoIP/GeoLite2-Country.mmdb</li>
<li>/var/lib/GeoIP/GeoLite2-Country.mmdb</li>
<li>/usr/local/share/GeoIP/GeoLite2-Country.mmdb</li>
<li>/usr/local/var/GeoIP/GeoLite2-Country.mmdb</li>
</ul>
<p><em>如果出现 “Bro was not configured for GeoIP support”, 源码安装时需要指定<code>./configure --with-geoip=/usr/share/GeoIP</code></em></p>
<h2 id="Gperftools"><a href="#Gperftools" class="headerlink" title="Gperftools"></a>Gperftools</h2><p><strong>参考:</strong></p>
<ul>
<li><strong><a href="http://pkxpp.github.io/2017/03/30/gperftools%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">Installing Gperftools</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/gperftools/gperftools.git</span><br><span class="line">$ sudo apt-get install libunwind-dev autoconf automake libtool</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<h2 id="IPsumdump"><a href="#IPsumdump" class="headerlink" title="IPsumdump"></a>IPsumdump</h2><p><strong>参考:</strong></p>
<ul>
<li><a href="http://www.read.seas.harvard.edu/~kohler/ipsumdump/" target="_blank" rel="noopener"><strong>Installing IPsumdump</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ curl -O http://www.read.seas.harvard.edu/~kohler/ipsumdump/ipsumdump-1.86.tar.gz</span><br><span class="line">$ tar -xzf ipsumdump-1.86.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> ipsumdump-1.86</span><br><span class="line">$ ./configure --prefix=/usr/</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line">$ sudo make clean</span><br></pre></td></tr></table></figure>

<h2 id="Krb5"><a href="#Krb5" class="headerlink" title="Krb5"></a>Krb5</h2><p><strong>参考:</strong></p>
<ul>
<li><strong><a href="http://computing.help.inf.ed.ac.uk/kerberos-ubuntu" target="_blank" rel="noopener">Installing Krb5</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install krb5-user</span><br></pre></td></tr></table></figure>

<h2 id="Jemalloc"><a href="#Jemalloc" class="headerlink" title="Jemalloc"></a>Jemalloc</h2><p>参考:</p>
<ul>
<li><a href="https://blog.csdn.net/u013224233/article/details/87930772" target="_blank" rel="noopener"><strong>Installing Jemalloc</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/jemalloc/jemalloc.git</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ make -j2</span><br><span class="line">$ sudo make install</span><br><span class="line">$ sudo ldconfig</span><br></pre></td></tr></table></figure>

<h1 id="压测"><a href="#压测" class="headerlink" title="压测"></a>压测</h1><ol>
<li><strong>查看是否丢包</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ zeekctl netstats; date</span><br><span class="line"> worker-1-1: 1565971837.137228 recvd=2834922 dropped=0 link=2834922</span><br><span class="line"> worker-1-2: 1565971837.147334 recvd=2550230 dropped=0 link=2550230</span><br><span class="line"> worker-1-3: 1565971837.162362 recvd=5180417 dropped=0 link=5180417</span><br><span class="line"> worker-1-4: 1565971837.170347 recvd=3235356 dropped=0 link=3235356</span><br><span class="line"> worker-1-5: 1565971837.186545 recvd=1916826 dropped=0 link=1916826</span><br><span class="line"> worker-1-6: 1565971837.201416 recvd=2944762 dropped=0 link=2944762</span><br><span class="line"> worker-1-7: 1565971837.214975 recvd=2279448 dropped=0 link=2279448</span><br><span class="line"> worker-1-8: 1565971837.229167 recvd=1896171 dropped=0 link=1896171</span><br><span class="line"> worker-1-9: 1565971837.249430 recvd=2550968 dropped=0 link=2550968</span><br><span class="line">worker-1-10: 1565971837.246513 recvd=3339864 dropped=0 link=3339864</span><br><span class="line">worker-1-11: 1565971837.260010 recvd=3080981 dropped=0 link=3080981</span><br><span class="line">worker-1-12: 1565971837.274447 recvd=2410030 dropped=0 link=2410030</span><br><span class="line">worker-1-13: 1565971837.282654 recvd=2188787 dropped=0 link=2188787</span><br><span class="line">worker-1-14: 1565971837.294684 recvd=3103014 dropped=0 link=3103014</span><br><span class="line">Fri Aug 16 16:10:37 UTC 2019</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>查看资源占用</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ zeekctl top; date</span><br><span class="line">Name         Type    Host             Pid     VSize  Rss  Cpu   Cmd</span><br><span class="line">logger       logger  localhost        8808      1G    99M   5%  zeek</span><br><span class="line">manager      manager localhost        8855    568M    97M  23%  zeek</span><br><span class="line">proxy-1      proxy   localhost        8901    566M    92M   5%  zeek</span><br><span class="line">worker-1-1   worker  localhost        9086      1G   697M  11%  zeek</span><br><span class="line">worker-1-2   worker  localhost        9093      1G   699M  23%  zeek</span><br><span class="line">worker-1-3   worker  localhost        9105      1G   700M  17%  zeek</span><br><span class="line">worker-1-4   worker  localhost        9111      1G   696M  17%  zeek</span><br><span class="line">worker-1-5   worker  localhost        9114      1G   699M  17%  zeek</span><br><span class="line">worker-1-6   worker  localhost        9120      1G   699M  11%  zeek</span><br><span class="line">worker-1-7   worker  localhost        9121      1G   699M  11%  zeek</span><br><span class="line">worker-1-8   worker  localhost        9132      1G   701M  11%  zeek</span><br><span class="line">worker-1-9   worker  localhost        9140      1G   699M  11%  zeek</span><br><span class="line">worker-1-10  worker  localhost        9142      1G   700M  11%  zeek</span><br><span class="line">worker-1-11  worker  localhost        9151      1G   696M  23%  zeek</span><br><span class="line">worker-1-12  worker  localhost        9155      1G   698M  17%  zeek</span><br><span class="line">worker-1-13  worker  localhost        9154      1G   701M  11%  zeek</span><br><span class="line">worker-1-14  worker  localhost        9157      1G   698M  17%  zeek</span><br><span class="line">Fri Aug 16 16:11:25 UTC 2019</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>查看流量大小(10秒)</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ zeekctl capstats; date</span><br><span class="line">Interface             kpps       mbps       (10s average)</span><br><span class="line">----------------------------------------</span><br><span class="line">localhost/ens5        37.8       375.2</span><br><span class="line">Fri Aug 16 16:12:47 UTC 2019</span><br></pre></td></tr></table></figure>


        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/14/我在云上的日子 - Suricata部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/14/我在云上的日子 - Suricata部署/" class="post-title-link" itemprop="url">我在'云'上的日子 - Suricata(部署)</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-14 09:53:54" itemprop="dateCreated datePublished" datetime="2019-10-14T09:53:54+08:00">2019-10-14</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-18 11:30:00" itemprop="dateModified" datetime="2019-10-18T11:30:00+08:00">2019-10-18</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="PF-RING"><a href="#PF-RING" class="headerlink" title="PF_RING"></a>PF_RING</h2><p><strong>1. pf_ring</strong></p>
<ul>
<li><strong>二进制安装</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 18.04 LTS</span></span><br><span class="line">$ apt-get install software-properties-common wget</span><br><span class="line">$ add-apt-repository universe [ unless you have <span class="keyword">done</span> it previously ]</span><br><span class="line">$ wget http://apt-stable.ntop.org/18.04/all/apt-ntop-stable.deb</span><br><span class="line">$ apt install ./apt-ntop-stable.deb</span><br><span class="line"></span><br><span class="line">$ apt-get clean all</span><br><span class="line">$ apt-get update</span><br><span class="line">$ apt-get install pfring</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>编译安装</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 依赖</span></span><br><span class="line">$ apt install git make gcc libelf-dev build-essential subversion flex libnuma-dev bison pkg-config libtool rustc cargo libjansson-dev ethtool autoconf autogen liblzma-dev libpcre3-dev libyaml-dev libpcap-dev zlib1g-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/ntop/PF_RING.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ cat /proc/net/pf_ring/info</span><br><span class="line">PF_RING Version          : 7.5.0 (dev:8fe7d4ca0398e7c530b6cd583d0891d0d229bf7e)</span><br><span class="line">Total rings              : 0</span><br><span class="line"></span><br><span class="line">Standard (non ZC) Options</span><br><span class="line">Ring slots               : 65536</span><br><span class="line">Slot version             : 17</span><br><span class="line">Capture TX               : Yes [RX+TX]</span><br><span class="line">IP Defragment            : No</span><br><span class="line">Socket Mode              : Standard</span><br><span class="line">Cluster Fragment Queue   : 0</span><br><span class="line">Cluster Fragment Discard : 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ sudo rmmod pf_ring</span><br><span class="line">$ sudo insmod pf_ring.ko min_num_slots=65536 transparent_mode=2 enable_tx_capture=0</span><br><span class="line"></span><br><span class="line">$ cat /proc/net/pf_ring/info</span><br><span class="line">PF_RING Version          : 7.5.0 (dev:8fe7d4ca0398e7c530b6cd583d0891d0d229bf7e)</span><br><span class="line">Total rings              : 0</span><br><span class="line"></span><br><span class="line">Standard (non ZC) Options</span><br><span class="line">Ring slots               : 65536</span><br><span class="line">Slot version             : 17</span><br><span class="line">Capture TX               : No [RX only]</span><br><span class="line">IP Defragment            : No</span><br><span class="line">Socket Mode              : Standard</span><br><span class="line">Cluster Fragment Queue   : 0</span><br><span class="line">Cluster Fragment Discard : 0</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>2. libpfring、libpcap</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> PF_RING/userland/lib</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure &amp;&amp; make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ../libpcap</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure &amp;&amp; make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> PF_RING/userland/examples</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收数据包</span></span><br><span class="line">root@ubuntu:/opt/PF_RING/userland/examples# ./pfcount -i ens33</span><br><span class="line">Using PF_RING v.7.5.0</span><br><span class="line">Capturing from ens33 [mac: 00:0C:29:D5:B9:8F][if_index: 2][speed: 0Mb/s]</span><br><span class="line"><span class="meta">#</span><span class="bash"> Device RX channels: 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Polling threads:    1</span></span><br><span class="line">Dumping statistics on /proc/net/pf_ring/stats/51441-ens33.3</span><br><span class="line">=========================</span><br><span class="line">Absolute Stats: [2 pkts total][0 pkts dropped][0.0% dropped]</span><br><span class="line">[2 pkts rcvd][424 bytes rcvd]</span><br><span class="line">=========================</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送数据包</span></span><br><span class="line">root@ubuntu:/opt/PF_RING/userland/examples# sudo ./pfsend -f 64byte_packets.pcap -n 0 -i ens33 -r 5</span><br><span class="line">Sending packets on ens33</span><br><span class="line">Using PF_RING v.7.5.0</span><br><span class="line">Estimated CPU freq: 2429795000 Hz</span><br><span class="line">Unable to open file 64byte_packets.pcap</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>3. tcpdump</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ <span class="built_in">cd</span> tcpdump-4.9.2/</span><br><span class="line">$ ./configure &amp;&amp; make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>参考:</strong></p>
<ul>
<li><p><strong><a href="https://www.ntop.org/guides/pf_ring/get_started/git_installation.html" target="_blank" rel="noopener">PF_RING</a></strong></p>
</li>
<li><p><a href="http://packages.ntop.org/apt-stable/" target="_blank" rel="noopener">http://packages.ntop.org/apt-stable/</a></p>
</li>
<li><p><a href="https://www.ntop.org/guides/pf_ring/get_started/packages_installation.html" target="_blank" rel="noopener">https://www.ntop.org/guides/pf_ring/get_started/packages_installation.html</a></p>
</li>
<li><p><a href="https://www.ntop.org/guides/pf_ring/thirdparty/suricata.html" target="_blank" rel="noopener">https://www.ntop.org/guides/pf_ring/thirdparty/suricata.html</a></p>
</li>
</ul>
<h2 id="LuaJIT"><a href="#LuaJIT" class="headerlink" title="LuaJIT"></a>LuaJIT</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget http://luajit.org/download/LuaJIT-2.0.5.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -zxf LuaJIT-2.0.5.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> LuaJIT-2.0.5/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make &amp;&amp; make install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig -p | grep lua</span></span><br><span class="line">	liblua5.1.so.0 (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1.so.0</span><br><span class="line">	liblua5.1.so (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1.so</span><br><span class="line">	liblua5.1-c++.so.0 (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1-c++.so.0</span><br><span class="line">	liblua5.1-c++.so (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1-c++.so</span><br></pre></td></tr></table></figure>

<h2 id="Hyperscan"><a href="#Hyperscan" class="headerlink" title="Hyperscan"></a>Hyperscan</h2><p><strong>1. boost</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 依赖</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> apt install cmake</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://dl.bintray.com/boostorg/release/1.69.0/<span class="built_in">source</span>/boost_1_69_0.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -xvf boost_1_69_0.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> boost_1_69_0/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./bootstrap.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ./b2 --with-iostreams --with-random install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig</span></span><br></pre></td></tr></table></figure>

<p><strong>2. ragle</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 依赖</span></span><br><span class="line">$ sudo apt-get install autoconf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ wget http://www.colm.net/files/ragel/ragel-6.10.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ tar zxvf ragel-6.10.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> ragel-6.10</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>

<p><strong>3. hyperscan</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 依赖</span></span><br><span class="line">$ sudo apt install libpcap-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ wget https://github.com/intel/hyperscan/archive/v5.1.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ tar -zxvf hyperscan-5.1.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> hyperscan-5.1.0</span><br><span class="line">$ mkdir cmake-build</span><br><span class="line">$ <span class="built_in">cd</span> cmake-build</span><br><span class="line">$ cmake -DBUILD_SHARED_LIBS=on -DCMAKE_BUILD_TYPE=Release ..</span><br><span class="line">$ make -j8</span><br><span class="line">$ sudo make install</span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>

<p><strong>4. 验证</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ldconfig -p | grep hs</span></span><br><span class="line">	libhs_runtime.so.5 (libc6,x86-64) =&gt; /usr/local/lib/libhs_runtime.so.5</span><br><span class="line">	libhs_runtime.so (libc6,x86-64) =&gt; /usr/local/lib/libhs_runtime.so</span><br><span class="line">	libhs.so.5 (libc6,x86-64) =&gt; /usr/local/lib/libhs.so.5</span><br><span class="line">	libhs.so (libc6,x86-64) =&gt; /usr/local/lib/libhs.so</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>参考:</strong></p>
<ul>
<li><a href="http://www.manongjc.com/article/110977.html" target="_blank" rel="noopener"><strong>Hyperscan - 5.1.0 安装</strong></a></li>
</ul>
<h2 id="Suricata"><a href="#Suricata" class="headerlink" title="Suricata"></a><strong>Suricata</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 依赖</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> apt-get install libpcre3 libpcre3-dbg libpcre3-dev build-essential libpcap-dev   \</span></span><br><span class="line">                libnet1-dev libyaml-0-2 libyaml-dev pkg-config zlib1g zlib1g-dev \</span><br><span class="line">                libcap-ng-dev libcap-ng0 make libmagic-dev libjansson-dev        \</span><br><span class="line">                libnss3-dev libgeoip-dev libhiredis-dev libevent-dev \</span><br><span class="line">                python-yaml rustc cargo libmaxminddb-dev liblzma-dev \</span><br><span class="line">                python3-distutils liblz4-dev</span><br><span class="line">                </span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir suricata</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> suricata</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> git://phalanx.openinfosecfoundation.org/oisf.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> oisf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/OISF/libhtp.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./autogen.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var --<span class="built_in">enable</span>-profiling --<span class="built_in">enable</span>-pfring --with-libpfring-includes=/usr/<span class="built_in">local</span>/include --with-libpfring-libraries=/usr/<span class="built_in">local</span>/lib --<span class="built_in">enable</span>-geoip  --<span class="built_in">enable</span>-luajit --with-libluajit-includes=/usr/<span class="built_in">local</span>/include/luajit-2.0/ --with-libluajit-libraries=/usr/<span class="built_in">local</span>/lib/ --with-libhs-includes=/usr/<span class="built_in">local</span>/include/hs/ --with-libhs-libraries=/usr/<span class="built_in">local</span>/lib/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make &amp;&amp; make install-full</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig</span></span><br></pre></td></tr></table></figure>

<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p><strong>1. PF_RING</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep PF_RING</span></span><br><span class="line">Features: PCAP_SET_BUFF PF_RING AF_PACKET HAVE_PACKET_FANOUT LIBCAP_NG LIBNET1.1 HAVE_HTP_URI_NORMALIZE_HOOK PCRE_JIT HAVE_NSS HAVE_LUA HAVE_LUAJIT HAVE_LIBJANSSON PROFILING TLS MAGIC RUST</span><br><span class="line">  PF_RING support:                         yes</span><br></pre></td></tr></table></figure>

<p><strong>2. LuaJit</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep lua</span></span><br><span class="line">  LUA support:                             yes, through luajit</span><br><span class="line">  libluajit:                               yes</span><br></pre></td></tr></table></figure>

<p><strong>3. Hyperscan</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep Hyperscan</span></span><br><span class="line">  Hyperscan support:                       yes</span><br></pre></td></tr></table></figure>

<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a><strong>启动</strong></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --pfring-int=ens6 --pfring-cluster-id=99 --pfring-cluster-type=cluster_flow -c /etc/suricata/suricata.yaml</span></span><br></pre></td></tr></table></figure>

<h1 id="规则管理"><a href="#规则管理" class="headerlink" title="规则管理"></a>规则管理</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install --upgrade suricata-update</span><br></pre></td></tr></table></figure>

<p><strong>定时更新</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> crontab -l</span></span><br><span class="line">10 0 * * * /usr/bin/suricata-update --no-test &amp;&amp; /usr/bin/suricatasc -c reload-rules</span><br></pre></td></tr></table></figure>

<h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><p><a href="https://www.jianshu.com/p/9348e211a6a2" target="_blank" rel="noopener">https://www.jianshu.com/p/9348e211a6a2</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/08/Scrapy + Splash 实现动态网页爬取/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/08/Scrapy + Splash 实现动态网页爬取/" class="post-title-link" itemprop="url">Scrapy + Splash 实现动态网页爬取</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-08 13:34:51" itemprop="dateCreated datePublished" datetime="2019-10-08T13:34:51+08:00">2019-10-08</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-16 22:19:05" itemprop="dateModified" datetime="2019-10-16T22:19:05+08:00">2019-10-16</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Spider/" itemprop="url" rel="index"><span itemprop="name">Spider</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>​        这是一个撞库事件的后续, 通过之前编写的脚本<strong>Suricata - login_audit</strong>脚本成功审计到了所有登录网站的账号。这里需要对经过分析后存在可疑行为的账号进行反向查询, 主要判断该账号是否已被标记为泄露账号。</p>
<h2 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h2><p>​        由于<strong>Scrapy</strong>没有<strong>JS Eengine</strong>只能爬取静态页面的, 对于JS生成的动态页面是不支持的。但是可以借助<a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener"><strong>Scrapy-Splash</strong></a>来实现动态页面的爬取。</p>
<h1 id="部署方法"><a href="#部署方法" class="headerlink" title="部署方法"></a>部署方法</h1><h2 id="1-Scrapy-Splash"><a href="#1-Scrapy-Splash" class="headerlink" title="1. Scrapy-Splash"></a>1. Scrapy-Splash</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install scrapy-splash --user</span><br></pre></td></tr></table></figure>

<h2 id="2-Splash-Instance"><a href="#2-Splash-Instance" class="headerlink" title="2. Splash Instance"></a>2. Splash Instance</h2><p>由于<strong>Scrapy-Splash</strong>使用的是<strong>Splash HTTP API</strong>， 所以需要一个<strong><a href="https://splash.readthedocs.io/en/stable/install.html" target="_blank" rel="noopener">Splash Instance</a></strong>，一般采用<strong><a href="https://hub.docker.com/r/scrapinghub/splash" target="_blank" rel="noopener">Docker</a></strong>运行<strong>Splash</strong>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ more docker-compose.yml</span><br><span class="line">version: <span class="string">"2.0"</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  splash:</span><br><span class="line">    restart: always</span><br><span class="line">    image: scrapinghub/splash</span><br><span class="line">    tty: <span class="literal">true</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8050:8050"</span></span><br><span class="line">    network_mode: <span class="string">"bridge"</span></span><br><span class="line">    container_name: <span class="string">"Splash"</span></span><br><span class="line">    hostname: <span class="string">"Splash"</span></span><br></pre></td></tr></table></figure>

<h2 id="3-配置Splash服务（以下操作全部在settings-py）"><a href="#3-配置Splash服务（以下操作全部在settings-py）" class="headerlink" title="3. 配置Splash服务（以下操作全部在settings.py）"></a>3. 配置<a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener"><strong>Splash</strong></a>服务（以下操作全部在<strong>settings.py</strong>）</h2><p><strong>3.1    添加Splash服务器地址</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SPLASH_URL = <span class="string">'http://localhost:8050'</span></span><br></pre></td></tr></table></figure>

<p><strong>3.2    启用Splash middleware</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line">    <span class="string">'scrapy_splash.SplashCookiesMiddleware'</span>: 723,</span><br><span class="line">    <span class="string">'scrapy_splash.SplashMiddleware'</span>: 725,</span><br><span class="line">    <span class="string">'scrapy.downloadermiddlewares.httpcompression.HttpCompressionMiddleware'</span>: 810,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>Order 723 is just before HttpProxyMiddleware (750) in default scrapy settings.</em></p>
<p><strong>3.3    启用SplashDeduplicateArgsMiddleware</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SPIDER_MIDDLEWARES = &#123;</span><br><span class="line">    <span class="string">'scrapy_splash.SplashDeduplicateArgsMiddleware'</span>: 100,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.4  自定义 DUPEFILTER_CLASS</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DUPEFILTER_CLASS = <span class="string">'scrapy_splash.SplashAwareDupeFilter'</span></span><br></pre></td></tr></table></figure>

<p><strong>3.5 使用Scrapy HTTP缓存</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTPCACHE_STORAGE = <span class="string">'scrapy_splash.SplashAwareFSCacheStorage'</span></span><br></pre></td></tr></table></figure>

<h2 id="4-代码"><a href="#4-代码" class="headerlink" title="4. 代码"></a>4. 代码</h2><p>注:  当使用<strong>Scrapy-Splash</strong>之后, 将无法直接使用<strong>crawlera middleware</strong>。需要手动引用外部lua脚本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> haveibeenpwned.items <span class="keyword">import</span> feed</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> scrapy_splash <span class="keyword">import</span> SplashRequest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">from redis crawl haveibeenpwned</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">LUA_SOURCE = <span class="string">"""</span></span><br><span class="line"><span class="string">    function main(splash)</span></span><br><span class="line"><span class="string">        local host = "proxy.crawlera.com"</span></span><br><span class="line"><span class="string">        local port = 8010</span></span><br><span class="line"><span class="string">        local user = "api_key"</span></span><br><span class="line"><span class="string">        local password = ""</span></span><br><span class="line"><span class="string">        local session_header = "X-Crawlera-Session"</span></span><br><span class="line"><span class="string">        local session_id = "create"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:on_request(function (request)</span></span><br><span class="line"><span class="string">            request:set_header("X-Crawlera-UA", "desktop")</span></span><br><span class="line"><span class="string">            request:set_header(session_header, session_id)</span></span><br><span class="line"><span class="string">            request:set_proxy&#123;host, port, username=user, password=password&#125;</span></span><br><span class="line"><span class="string">        end)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:on_response_headers(function (response)</span></span><br><span class="line"><span class="string">            if response.headers[session_header] ~= nil then</span></span><br><span class="line"><span class="string">                session_id = response.headers[session_header]</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">        end)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:go(splash.args.url)</span></span><br><span class="line"><span class="string">        return splash:html()</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CheckSpider</span><span class="params">(scrapy.Spider)</span>:</span></span><br><span class="line">    name = <span class="string">'scrapy_demo'</span></span><br><span class="line">    start_urls = <span class="string">'https://httpbin.org/get'</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> SplashRequest(self.start_urls, self.parse, endpoint=<span class="string">'execute'</span>,  args=&#123;<span class="string">'wait'</span>: <span class="number">3</span>, <span class="string">'lua_source'</span>: LUA_SOURCE&#125;)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        print(response.text)</span><br></pre></td></tr></table></figure>

<p>参考:</p>
<ul>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash/issues/117" target="_blank" rel="noopener">https://github.com/scrapy-plugins/scrapy-splash/issues/117</a></li>
</ul>
<p>参考:</p>
<ul>
<li><a href="https://splash.readthedocs.io/en/stable/search.html?q=splash%3Ahtml&check_keywords=yes&area=default" target="_blank" rel="noopener">Splash</a></li>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener">Scrapy-Splash</a></li>
<li><a href="https://doc.scrapinghub.com/crawlera.html#using-crawlera-with-splash" target="_blank" rel="noopener">Scrapinghub API Reference</a></li>
<li><a href="https://stackoverflow.com/questions/43646438/using-proxy-with-scrapy-splash" target="_blank" rel="noopener">using proxy with scrapy-splash</a></li>
<li><a href="http://stackoverflow.com/questions/43090352/proxy-servers-with-scrapy-splash" target="_blank" rel="noopener"><strong>Proxy servers with Scrapy-Splash</strong></a></li>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash/issues/97" target="_blank" rel="noopener">Crawlera integration</a></li>
<li><a href="https://blog.csdn.net/zhengxiangwen/article/details/55227368" target="_blank" rel="noopener"><strong>利用scrapy-splash爬取JS生成的动态页面</strong></a></li>
</ul>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/04/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
            
            <a href="/2019/10/04/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-04 22:38:54" itemprop="dateCreated datePublished" datetime="2019-10-04T22:38:54+08:00">2019-10-04</time>
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </article>
  
  
  

    
  </div>

  



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/avatar.jpeg"
      alt="Canon">
  <p class="site-author-name" itemprop="name">Canon</p>
  <div class="site-description" itemprop="description">一个热爱健身的安全分析师</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/canon88" title="GitHub &rarr; https://github.com/canon88" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="mailto:unsec.monitor@gmail.com" title="E-Mail &rarr; mailto:unsec.monitor@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
    
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Canon</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.4.1</div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script>
<script src="/js/schemes/muse.js?v=7.4.1"></script>

<script src="/js/next-boot.js?v=7.4.1"></script>



  








  <script src="/js/local-search.js?v=7.4.1"></script>














  

  

  

  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-needmoreshare2@1/needsharebutton.min.js"></script>
  <script>
      pbOptions = {};
        pbOptions.iconStyle = "box";
      
        pbOptions.boxForm = "horizontal";
      
        pbOptions.position = "bottomCenter";
      
        pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
  </script>
</body>
</html>
