<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>我在'云'上的日子 - AWS上流量镜像遇到的坑</title>
    <url>/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/</url>
    <content><![CDATA[<p>​    </p>
<p>​        自从AWS在6月份新出了<strong>Traffic Mirroring</strong>功能后, 我也算是第一时间使用了这个功能。与传统的交换机流量镜像不同的是, AWS上是将流量镜像后的数据通过<strong>VXLAN</strong>协议发送至流量分析引擎(<strong>Suricata</strong>、<strong>Zeek</strong>)。正是由于这一点让我碰到了以下几个问题, 这里写出来希望对大家有所帮助。</p>
<ol>
<li>接收流量镜像的目标端, 也就是我们常说的流量分析引擎端是有接收限制的。</li>
</ol>
<p>​       如果你是在一个非专用实例上部署的Suricata、Zeek。那么你只能最多同时接收10个源的流量镜像, 也就是你只能接收10个网卡的数据。很不巧的是我们碰上了这个问题, 解决方案也很简单, 使用专用实例(<strong>Dedicated instance</strong>) 或者 使用AWS的网络负载均衡(<strong>Network Load Balancer</strong>)。前者可以将Limit提升到<strong>100</strong>, 后者将<strong>不受限</strong>。如图:</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016164935291.png" alt="image-20191016164935291"></p>
<hr>
<ol start="2">
<li>C5与C4实例的差异</li>
</ol>
<p>​        就我目前使用的实例而言, 分别测试过C5 与 C4两种实例。他们的网卡驱动有所区别的, 如图:</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016160923628.png" alt="image-20191016160923628"></p>
<p>​        我这使用下来最直观的区别, 在C4实例上若不使用PF_RING捕包模式的话, Suricata丢包率感人, 0.5 Gbps就开始丢包。测试的机器配置: 32C 60G的机器, 切换到PF_RING捕包模式无此问题。反之C5实例就不存在这个问题, AF-PACKET直接上到2 Gbps的纯HTTP流量都没有丢包。硬件配置: 16C 32G的机器。</p>
<hr>
<ol start="3">
<li>超过<strong>MTU: 9001</strong>数据包被截断</li>
</ol>
<p>​      这几天在排查安全事件时, 发现监控的同一台Nginx上解析出的流量(HTTP事件)与日志(HTTP事件)数量相差较大。经过两天的排查终于定位了问题, Suricata kernel 并没有丢包, 所以怀疑是不是Suricata HTTP解析出错导致。最终通过抓包发现导致该问题的”罪魁祸首”就是<strong>VXLAN</strong>, 由于AWS在流量镜像时采用了<strong>VXLAN</strong>协议进行封装, 导致在原有<strong>MTU</strong>的基础上<strong>增加了50个字节</strong>, 造成数据包被截断, 无法还原出HTTP事件。以下截图就是一个无法被正确还原HTTP事件的数据包, 我用Suricata载入数据包后, 只还原出了长度<strong>9015</strong>数据包之前的HTTP信息, 长度<strong>9015</strong>数据包之后的所有事件均无法被还原。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191014095249725.png" alt="image-20191014095249725"></p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191014094741753.png" alt="image-20191014094741753"></p>
<p><strong>官方描述:</strong></p>
<p>​        For example, if an 8996 byte packet is mirrored, and the traffic mirror target MTU value is 9001 bytes, the mirror encapsulation results in the mirrored packet being greater than the MTU value. In this case, the mirror packet is truncated. To prevent mirror packets from being truncated, set the traffic mirror source interface MTU value to 54 bytes less than the traffic mirror target MTU value. For more information about configuring the network MTU value, see Network Maximum Transmission Unit (MTU) for Your EC2 Instance in the <em>Amazon EC2 User Guide for Linux Instances</em>.</p>
<p>​        例如，如果对8996字节的数据包进行了镜像，并且流量镜像目标MTU值为9001字节，则镜像封装会导致镜像的数据包大于MTU值。在这种情况下，镜像数据包将被截断。为防止镜像数据包被截断，请将流量镜像源接口的MTU值设置为比流量镜像目标MTU值小54个字节。有关配置网络MTU值的更多信息，请参阅Amazon EC2 Linux实例用户指南中的EC2实例的网络最大传输单位（MTU）。</p>
<hr>
<p><strong>关于VXLAN导致Suricata无法正常解析数据的问题, 特地进行了复现:</strong></p>
<p>准备工作:</p>
<ul>
<li>新建了<strong>test_files</strong>文件, 该文件只包含内容’<strong>hello, world!</strong>‘;</li>
<li>为了使数据包在传输时满足<strong>MTU: 9001</strong>, 手动生成了一个10MB空文件<strong>10mb_exist_files</strong>. </li>
</ul>
<p>共计访问: 14次</p>
<p>访问顺序:</p>
<ol>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (次)</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (次)</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (次)</li>
</ol>
<p>正常情况:</p>
<ul>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (次) - 正常</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (次) - 正常</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (次) - 正常</li>
</ul>
<p>异常情况:</p>
<ul>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (次) - 正常</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (次) - 异常</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (次) - 丢失</li>
</ul>
<p><strong>MTU: 9001</strong></p>
<ul>
<li>非镜像流量的数据包详情:</li>
</ul>
<p>可以看到从数据包<strong>20</strong>到数据包<strong>6126</strong>之间都是在进行<strong>10MB</strong>文件(<strong>10mb_exist_files</strong>)的传输过程。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016103409831.png" alt="image-20191016103409831"></p>
<hr>
<p>从http数据包中可以看出, 这里请求包与响应包都可以正常被还原出来。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016104502919.png" alt="image-20191016104502919"></p>
<hr>
<p>数据包在Suricata上的解析结果:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-15T22:52:10.180505+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">415026399241324</span>,</span><br><span class="line">    <span class="attr">"pcap_cnt"</span>: <span class="number">6127</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43418</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"http_content_type"</span>: <span class="string">"text/html"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress"</span>,</span><br><span class="line">        <span class="attr">"content_length"</span>: <span class="string">"41943044"</span>,</span><br><span class="line">        <span class="attr">"content_type"</span>: <span class="string">"text/html; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Tue, 15 Oct 2019 14:52:10 GMT"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"Werkzeug/0.16.0 Python/2.7.16"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">41943044</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>镜像流量的数据包详情:</strong>(也就是<strong>VXLAN</strong>封装后的数据包)</li>
</ul>
<p>同样可以看到从数据包<strong>26</strong>到数据包<strong>6170</strong>之间都是在进行<strong>10MB</strong>文件(<strong>10mb_exist_files</strong>)的传输过程。但是在第<strong>34</strong>个数据包中可以看到, 已经标注了数据超出了最大长度。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016105636906.png" alt="image-20191016105636906"></p>
<hr>
<p>超出长度的数据将会被截断, 标注: <strong>50 bytes missing in capture file</strong>。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016150322620.png" alt="image-20191016150322620"></p>
<p>从HTTP数据包中可以看出, 这里只有请求包, 由于后续的响应包超出了<strong>MTU: 9001</strong>,  因此并没有响应包。</p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016105948606.png" alt="image-20191016105948606"></p>
<hr>
<p>数据包在Suricata上的解析结果:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-15T22:52:48.295823+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">1746715371266426</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43420</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>结论:</strong></p>
<p>​        相比非镜像流量的数据包, Suricata 少了后续10条http请求的数据解析。针对访问<strong>10mb_exist_files</strong>的请求, 由于超过了MTU, 数据包被阶段了, http的解析数据也是不完整的。</p>
<p><strong>解决方案:</strong></p>
<p>​        这里直接引用AWS的官方文档描述。如果对8996字节的数据包进行了镜像，并且流量镜像目标MTU值为9001字节，则镜像封装会导致镜像的数据包大于MTU值。在这种情况下，镜像数据包将被截断。为防止镜像数据包被截断，请将流量镜像源接口的MTU值设置为比流量镜像目标MTU值小54个字节。有关配置网络MTU值的更多信息，请参阅Amazon EC2 Linux实例用户指南中的EC2实例的网络最大传输单位（MTU）。</p>
<p>​        一般来说，降低 MTU 的话，有可能发现网路传输效能有下降，这是因为每个封包 size 变小，所以传送同样的资料量，封包数就会变多，造成 overhead 变多。但是对于传输是不会产生错误的状况的。</p>
<hr>
<p>为了验证我分别测试了两个MTU值大小。 <strong>MTU:8500、MTU:1500</strong></p>
<p><strong>修改 MTU: 8500</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br><span class="line"></span><br><span class="line">$ sudo ip link <span class="built_in">set</span> dev eth0 mtu 8500</span><br><span class="line"></span><br><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 8500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<hr>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016153028228.png" alt="image-20191016153028228"></p>
<hr>
<p>数据包在Suricata上的解析结果:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-16T15:21:35.351737+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">1895604300629003</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43556</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"http_content_type"</span>: <span class="string">"text/html"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress\n"</span>,</span><br><span class="line">        <span class="attr">"content_length"</span>: <span class="string">"41943044"</span>,</span><br><span class="line">        <span class="attr">"content_type"</span>: <span class="string">"text/html; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Wed, 16 Oct 2019 07:21:30 GMT"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"Werkzeug/0.16.0 Python/2.7.16"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">1773936</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        结论: 按照AWS提及的方式, 在EC2源端<strong>减小54字节</strong>(此处我选择减少了<strong>501个字节</strong>), 虽然没有报数据包超出长度, 但是从WireShark还原整个HTTP会话来看, 依旧可以看出数据包有问题, 没有HTTP的响应数据。并且通过Suricata读取数据包后, 也未达到预期效果。为什么<strong>MTU:8500</strong>不行? 希望有大佬给我解惑。</p>
<p><strong>修改 MTU: 1500</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br><span class="line"></span><br><span class="line">$ sudo ip link <span class="built_in">set</span> dev eth0 mtu 1500</span><br><span class="line"></span><br><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016154823748.png" alt="image-20191016154823748"></p>
<p><img src="/2019/10/16/我在云上的日子-AWS上流量镜像遇到的坑/image-20191016155112376.png" alt="image-20191016155112376"></p>
<p>数据包在Suricata上的解析结果:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-16T15:14:15.576656+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">1135596924232203</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43554</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"http_content_type"</span>: <span class="string">"text/html"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress\n"</span>,</span><br><span class="line">        <span class="attr">"content_length"</span>: <span class="string">"41943044"</span>,</span><br><span class="line">        <span class="attr">"content_type"</span>: <span class="string">"text/html; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Wed, 16 Oct 2019 07:14:15 GMT"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"Werkzeug/0.16.0 Python/2.7.16"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">41943044</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        结论: <strong>MTU减小到1500时</strong>, 无论从WireShark来查看或者Suricata协议还原的角度来说, 都是可以的。</p>
<hr>
<p>​        写在最后, 说实话AWS提供了在云上的流量镜像确实很不错, 至少比传统在云上每一台机器通过安装agent把流量外发的形式强, 似乎<strong>国内</strong>的云厂商现在也没有这个功能! </p>
<p>​        不过通过VXLAN将数据包封装后导致MTU超过最大值这问题也确实有点坑。你让已经成型的架构去调整MTU值, 虽然理论上是可行, 但实际生产环境中网络的调整都是比较慎重的, 除非企业现在必须得上流量镜像, 否则不太能说服运维的小伙伴去调整, 要是真出了什么问题, 都是大问题。</p>
<p><strong>参考</strong></p>
<ul>
<li><a href="https://docs.aws.amazon.com/vpc/latest/mirroring/vpc-tm.pdf" target="_blank" rel="noopener">Amazon Virtual Private Cloud Traffic Mirroring</a></li>
<li><a href="https://community.emc.com/community/support/chinese/teamblog/blog/2016/05/12/大咖讲网络-mtu导致的悲剧" target="_blank" rel="noopener">大咖讲网络-mtu导致的悲剧</a></li>
<li><a href="https://www.cnblogs.com/sammyliu/p/5079898.html" target="_blank" rel="noopener">Neutron VxLAN + Linux Bridge 环境中的网络 MTU</a></li>
</ul>
]]></content>
      <categories>
        <category>NSM</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>Suricata - Lua Output Script</title>
    <url>/2019/10/14/Suricata%20-%20Lua%20Output/</url>
    <content><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>​    由于近期网站遭受大量撞库攻击, 想监控一下登录接口中的异常行为。通过<strong>alert</strong>并不能起到很好的效果, 所以采用<strong>Lua</strong>脚本进行扩展, 写了一个审计登录接口的脚本。通过登录接口事件, 再配合<strong>Wazuh</strong>进行一些简单的关联告警,  效果还是不错的。</p>
<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><ul>
<li>由于审计内容涉及到用户敏感信息, 因此需要对敏感信息进行<strong>Hash</strong>之后再输出;</li>
<li>除通用<strong>HTTP Header</strong>字段外支持对自定义字段进行选择性输出;</li>
</ul>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">json = <span class="built_in">require</span> <span class="string">"json"</span></span><br><span class="line">md5 = <span class="built_in">require</span> <span class="string">"md5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 登录接口</span></span><br><span class="line">login_url = <span class="string">"/login"</span></span><br><span class="line"><span class="comment">-- 登录状态码</span></span><br><span class="line">success_code = <span class="number">0</span></span><br><span class="line"><span class="comment">-- event_name</span></span><br><span class="line">event_name = <span class="string">"login_audit"</span></span><br><span class="line"><span class="comment">-- event_type</span></span><br><span class="line">event_type = <span class="string">"lua"</span></span><br><span class="line"><span class="comment">-- app_type</span></span><br><span class="line">app_type = <span class="string">"web"</span></span><br><span class="line"><span class="comment">-- logs</span></span><br><span class="line">name = <span class="string">"web_login_audit.json"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- common_mapping</span></span><br><span class="line">http_common_mapping = <span class="string">'&#123;"accept":"accept","accept-charset":"accept_charset","accept-encoding":"accept_encoding","accept-language":"accept_language","accept-datetime":"accept_datetime","authorization":"authorization","cache-control":"cache_control","from":"from","max-forwards":"max_forwards","origin":"origin","pragma":"pragma","proxy-authorization":"proxy_authorization","via":"via","vary":"vary","x-requested-with":"x_requested_with","x-forwarded-proto":"x_forwarded_proto","accept-range":"accept_range","allow":"allow","connection":"connection","content-encoding":"content_encoding","content-language":"content_language","content-location":"content_location","content-md5":"content_md5","content-range":"content_range","date":"date","last-modified":"last_modified","location":"location","proxy-authenticate":"proxy_authenticate","referrer":"refer","retry-after":"retry_after","server":"server","transfer-encoding":"transfer_encoding","upgrade":"upgrade","www-authenticate":"www_authenticate","x-authenticated-user":"x_authenticated_user","user-agent":"user_agent"&#125;'</span></span><br><span class="line">common_mapping_table = json.decode(http_common_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- request_mapping</span></span><br><span class="line">http_request_mapping = <span class="string">'&#123;"content-length":"request_content_length","content-type":"request_content_type"&#125;'</span></span><br><span class="line">request_mapping_table = json.decode(http_request_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- response_mapping</span></span><br><span class="line">http_response_mapping = <span class="string">'&#123;"content-length":"response_content_length","content-type":"response_content_type"&#125;'</span></span><br><span class="line">response_mapping_table = json.decode(http_response_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- defind functioin</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5Encode</span><span class="params">(args)</span></span></span><br><span class="line">    m = md5.new()</span><br><span class="line">    m:update(args)</span><br><span class="line">    <span class="keyword">return</span> md5.tohex(m:finish())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlDecode</span><span class="params">(args)</span></span></span><br><span class="line">    s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(args, <span class="string">"%%(%x%x)"</span>, <span class="function"><span class="keyword">function</span><span class="params">(h)</span></span> <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="built_in">tonumber</span>(h, <span class="number">16</span>)) <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- email=xxx@yyy.com&amp;password=zzz</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStr</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    data = <span class="built_in">string</span>.split(args, <span class="string">'&amp;'</span>)</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">        d = <span class="built_in">string</span>.split(v, <span class="string">'='</span>)</span><br><span class="line">        t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.split</span><span class="params">(s, p)</span></span></span><br><span class="line">    <span class="keyword">local</span> rt = &#123;&#125;</span><br><span class="line">    <span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">'[^'</span>..p..<span class="string">']+'</span>, <span class="function"><span class="keyword">function</span><span class="params">(w)</span></span> <span class="built_in">table</span>.<span class="built_in">insert</span>(rt, w) <span class="keyword">end</span> )</span><br><span class="line">    <span class="keyword">return</span> rt</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trim</span><span class="params">(s)</span></span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">"^%s*(.-)%s*$"</span>, <span class="string">"%1"</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatCookie</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    data = <span class="built_in">string</span>.split(args, <span class="string">";"</span>)</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">        v = trim(v)</span><br><span class="line">        d = <span class="built_in">string</span>.split(v, <span class="string">"="</span>)</span><br><span class="line">        t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- default function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(args)</span></span></span><br><span class="line">    <span class="keyword">local</span> needs = &#123;&#125;</span><br><span class="line">    needs[<span class="string">"protocol"</span>] = <span class="string">"http"</span></span><br><span class="line">    <span class="keyword">return</span> needs</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span> <span class="params">(args)</span></span></span><br><span class="line">    filename = SCLogPath() .. <span class="string">"/"</span> .. name</span><br><span class="line">    file = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">"a"</span>))</span><br><span class="line">    SCLogInfo(<span class="string">"Web Login Log Filename "</span> .. filename)</span><br><span class="line">    http = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(args)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- init tables</span></span><br><span class="line">    http_table = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_hostname</span></span><br><span class="line">    http_hostname = HttpGetRequestHost()</span><br><span class="line">    http_table[<span class="string">"hostname"</span>] = http_hostname</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_url</span></span><br><span class="line">    http_url = HttpGetRequestUriNormalized()</span><br><span class="line">    <span class="keyword">if</span> http_url ~= login_url <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"url"</span>] = login_url</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_url_path</span></span><br><span class="line">    http_table[<span class="string">"url_path"</span>] = http_url</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_method</span></span><br><span class="line">    rl = HttpGetRequestLine()</span><br><span class="line">    http_method = <span class="built_in">string</span>.<span class="built_in">match</span>(rl, <span class="string">"%w+"</span>)</span><br><span class="line">    http_table[<span class="string">"method"</span>] = http_method</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_status</span></span><br><span class="line">    rsl = HttpGetResponseLine()</span><br><span class="line">    status_code = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"%s(%d+)%s"</span>)</span><br><span class="line">    http_status = <span class="built_in">tonumber</span>(status_code)</span><br><span class="line">    http_table[<span class="string">"status"</span>] = http_status</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_protocol</span></span><br><span class="line">    http_protocol = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"(.-)%s"</span>)</span><br><span class="line">    http_table[<span class="string">"protocol"</span>] = http_protocol</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- request_token</span></span><br><span class="line">    cookie = HttpGetRequestHeader(<span class="string">"Cookie"</span>)</span><br><span class="line">    <span class="keyword">if</span> cookie ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        session_id = <span class="built_in">string</span>.<span class="built_in">match</span>(cookie, <span class="string">"sessionID=(.-);"</span>)</span><br><span class="line">        <span class="keyword">if</span> session_id ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[<span class="string">"request_token"</span>] = md5Encode(session_id)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            http_table[<span class="string">"request_token"</span>]  = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- response_token &amp;&amp; member_id</span></span><br><span class="line">    set_cookie = HttpGetResponseHeader(<span class="string">"Set-Cookie"</span>)</span><br><span class="line">    <span class="keyword">if</span> set_cookie ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        session_id = <span class="built_in">string</span>.<span class="built_in">match</span>(set_cookie, <span class="string">"sessionID=(.-);"</span>)</span><br><span class="line">        http_table[<span class="string">"response_token"</span>]  = md5Encode(session_id)</span><br><span class="line">        member_id = <span class="built_in">string</span>.<span class="built_in">match</span>(set_cookie, <span class="string">"memberId=(.-);"</span>)</span><br><span class="line">        http_table[<span class="string">"member_id"</span>] = <span class="built_in">tonumber</span>(member_id)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- login_results</span></span><br><span class="line">    a, o, e = HttpGetResponseBody()</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        body = json.decode(v)</span><br><span class="line">        results_code = <span class="built_in">tonumber</span>(body[<span class="string">"code"</span>])</span><br><span class="line">        <span class="keyword">if</span> results_code == success_code <span class="keyword">then</span></span><br><span class="line">            results = <span class="string">"success"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            results = <span class="string">"failed"</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"results"</span>] = results</span><br><span class="line">    http_table[<span class="string">"results_code"</span>] = results_code</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- email &amp; password</span></span><br><span class="line">    a, o, e = HttpGetRequestBody()</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        res = formatStr(v)</span><br><span class="line">        mail = urlDecode(res[<span class="string">'email'</span>])</span><br><span class="line">        pass = md5Encode(res[<span class="string">'password'</span>])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"email"</span>] = mail</span><br><span class="line">    http_table[<span class="string">"password"</span>] = pass</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- RequestHeaders</span></span><br><span class="line">    rh = HttpGetRequestHeaders()</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rh) <span class="keyword">do</span></span><br><span class="line">        key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line"></span><br><span class="line">        common_var = common_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> common_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[common_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        request_var = request_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> request_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[request_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- ResponseHeaders</span></span><br><span class="line">    rsh = HttpGetResponseHeaders()</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rsh) <span class="keyword">do</span></span><br><span class="line">        key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line"></span><br><span class="line">        common_var = common_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> common_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[common_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        response_var = response_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> response_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[response_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- timestring = SCPacketTimeString() 2019-09-10T06:08:35.582449+0000</span></span><br><span class="line">    sec, usec = SCPacketTimestamp()</span><br><span class="line">    timestring = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">"!%Y-%m-%dT%T"</span>, sec) .. <span class="string">"."</span> .. usec .. <span class="string">"+0000"</span></span><br><span class="line">    </span><br><span class="line">    ip_version, src_ip, dst_ip, protocol, src_port, dst_port = SCFlowTuple()</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- flow_id</span></span><br><span class="line">    id = SCFlowId()</span><br><span class="line">    flow_id = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%.0f"</span>, id)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- true_ip</span></span><br><span class="line">    true_client_ip = HttpGetRequestHeader(<span class="string">"True-Client-IP"</span>)</span><br><span class="line">    <span class="keyword">if</span> true_client_ip ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        src_ip = true_client_ip</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- table</span></span><br><span class="line">    raw_data = &#123;</span><br><span class="line">        timestamp = timestring,</span><br><span class="line">        flow_id = flow_id,</span><br><span class="line">        src_ip = src_ip,</span><br><span class="line">        src_port = src_port,</span><br><span class="line">        dest_ip = dst_ip,</span><br><span class="line">        dest_port = dst_port,</span><br><span class="line">        event_name = event_name,</span><br><span class="line">        event_type = event_type,</span><br><span class="line">        app_type = app_type,</span><br><span class="line">        http = http_table,</span><br><span class="line">        proto = <span class="string">"TCP"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- json encode</span></span><br><span class="line">    data = json.encode(raw_data)</span><br><span class="line"></span><br><span class="line">    file:<span class="built_in">write</span>(data .. <span class="string">"\n"</span>)</span><br><span class="line">    file:<span class="built_in">flush</span>()</span><br><span class="line"></span><br><span class="line">    http = http + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deinit</span> <span class="params">(args)</span></span></span><br><span class="line">    SCLogInfo (<span class="string">"HTTP transactions logged: "</span> .. http);</span><br><span class="line">    file:<span class="built_in">close</span>(file)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">34963</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"lua"</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="string">"471693756052529"</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-07T13:51:01.560556+0000"</span>,</span><br><span class="line">    <span class="attr">"event_name"</span>: <span class="string">"login_audit"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">3007</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"response_content_length"</span>: <span class="string">"446"</span>,</span><br><span class="line">        <span class="attr">"response_content_type"</span>: <span class="string">"application/json; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"nginx"</span>,</span><br><span class="line">        <span class="attr">"results_code"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"vary"</span>: <span class="string">"Accept-Encoding"</span>,</span><br><span class="line">        <span class="attr">"password"</span>: <span class="string">"420ce28ef813a2dc05e52a7e24eb0d5c"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Mon, 07 Oct 2019 13:51:01 GMT"</span>,</span><br><span class="line">        <span class="attr">"request_content_type"</span>: <span class="string">"application/x-www-form-urlencoded; charset=UTF-8"</span>,</span><br><span class="line">        <span class="attr">"accept_language"</span>: <span class="string">"en-US,en;q=0.9"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/login"</span>,</span><br><span class="line">        <span class="attr">"x_requested_with"</span>: <span class="string">"XMLHttpRequest"</span>,</span><br><span class="line">        <span class="attr">"x_forwarded_proto"</span>: <span class="string">"https"</span>,</span><br><span class="line">        <span class="attr">"user_agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36"</span>,</span><br><span class="line">        <span class="attr">"origin"</span>: <span class="string">"https://www.canon.com"</span>,</span><br><span class="line">        <span class="attr">"response_token"</span>: <span class="string">"4f5f386aec34e877ce63fce7ddd3f15f"</span>,</span><br><span class="line">        <span class="attr">"pragma"</span>: <span class="string">"no-cache"</span>,</span><br><span class="line">        <span class="attr">"connection"</span>: <span class="string">"close"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"www.canon.com"</span>,</span><br><span class="line">        <span class="attr">"url_path"</span>: <span class="string">"/login"</span>,</span><br><span class="line">        <span class="attr">"cache_control"</span>: <span class="string">"no-cache, max-age=0, no-store, must-revalidate"</span>,</span><br><span class="line">        <span class="attr">"method"</span>: <span class="string">"POST"</span>,</span><br><span class="line">        <span class="attr">"email"</span>: <span class="string">"admin@canon.com"</span>,</span><br><span class="line">        <span class="attr">"request_token"</span>: <span class="string">"109464370570b23fa9768078ab1ac8a9"</span>,</span><br><span class="line">        <span class="attr">"member_id"</span>: <span class="number">123456</span>,</span><br><span class="line">        <span class="attr">"results"</span>: <span class="string">"success"</span>,</span><br><span class="line">        <span class="attr">"request_content_length"</span>: <span class="string">"49"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"77.99.22.17"</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"1.1.1.1"</span>,</span><br><span class="line">    <span class="attr">"app_type"</span>: <span class="string">"web"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>NSM</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>我在'云'上的日子 - Zeek(部署)</title>
    <url>/2019/10/14/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90%20-%20Zeek%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<p><a href="https://holdmybeersecurity.com/2019/04/03/part-1-install-setup-zeek-pf_ring-on-ubuntu-18-04-on-proxmox-5-3-openvswitch/" target="_blank" rel="noopener"><strong>PART 1: INSTALL/SETUP ZEEK + PF_RING ON UBUNTU 18.04 ON PROXMOX 5.3 + OPENVSWITCH</strong></a></p>
<h1 id="Zeek"><a href="#Zeek" class="headerlink" title="Zeek"></a>Zeek</h1><p><strong>参考:</strong></p>
<ul>
<li><strong><a href="https://docs.zeek.org/en/stable/install/install.html" target="_blank" rel="noopener">Installing Zeek</a></strong></li>
</ul>
<p><strong>Required Dependencies</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install cmake make gcc g++ flex bison libpcap-dev libssl-dev python-dev swig zlib1g-dev</span><br></pre></td></tr></table></figure>

<p><em>If your system uses Python 2.7, then you will also need to install the <code>python-ipaddres</code> package.</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install python-ipaddress</span><br></pre></td></tr></table></figure>

<p><strong>Optional Dependencies</strong></p>
<ul>
<li>libmaxminddb (for geolocating IP addresses)</li>
<li>sendmail (enables Bro and BroControl to send mail)</li>
<li>curl (used by a Bro script that implements active HTTP)</li>
<li>gperftools (tcmalloc is used to improve memory and CPU usage)</li>
<li>jemalloc (<a href="http://www.canonware.com/jemalloc/" target="_blank" rel="noopener">http://www.canonware.com/jemalloc/</a>)</li>
<li>PF_RING (Linux only, see <a href="https://docs.zeek.org/en/stable/configuration/index.html" target="_blank" rel="noopener">Cluster Configuration</a>)</li>
<li>krb5 libraries and headers</li>
<li>ipsumdump (for trace-summary; <a href="http://www.cs.ucla.edu/~kohler/ipsumdump" target="_blank" rel="noopener">http://www.cs.ucla.edu/~kohler/ipsumdump</a>)</li>
</ul>
<p><strong>Installing Bro</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> --recursive https://github.com/zeek/zeek</span><br><span class="line">$ ./configure --with-pcap=/usr/<span class="built_in">local</span>/include --with-geoip=/usr/share/GeoIP</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>Add PATH</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/zeek/bin:<span class="variable">$PATH</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo vim ~/.bashrc</span><br><span class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/zeek/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p><strong>Enable Json</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /usr/<span class="built_in">local</span>/zeek/share/zeek/site/local.zeek</span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to enable logging of link-layer addresses. Enabling</span></span><br><span class="line"><span class="comment"># this adds the link-layer address for each connection endpoint to the conn.log file.</span></span><br><span class="line"><span class="comment"># @load policy/protocols/conn/mac-logging</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">@load policy/tuning/json-logs.zeek</span><br></pre></td></tr></table></figure>

<p><strong>Using PF_RING</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /usr/<span class="built_in">local</span>/zeek/etc/node.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example ZeekControl node configuration.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This example has a standalone node ready to go except for possibly changing</span></span><br><span class="line"><span class="comment"># the sniffing interface.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is a complete standalone configuration.  Most likely you will</span></span><br><span class="line"><span class="comment"># only need to change the interface.</span></span><br><span class="line"><span class="comment"># [zeek]</span></span><br><span class="line"><span class="comment"># type=standalone</span></span><br><span class="line"><span class="comment"># host=localhost</span></span><br><span class="line"><span class="comment"># interface=ens33</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Below is an example clustered configuration. If you use this,</span></span><br><span class="line"><span class="comment">## remove the [zeek] node above.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[logger]</span></span><br><span class="line"><span class="comment">#type=logger</span></span><br><span class="line"><span class="comment">#host=localhost</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[manager]</span><br><span class="line"><span class="built_in">type</span>=manager</span><br><span class="line">host=localhost</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[proxy-1]</span><br><span class="line"><span class="built_in">type</span>=proxy</span><br><span class="line">host=localhost</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[worker-1]</span><br><span class="line"><span class="built_in">type</span>=worker</span><br><span class="line">host=localhost</span><br><span class="line">interface=ens33</span><br><span class="line">lb_method=pf_ring</span><br><span class="line">lb_procs=1</span><br><span class="line">pin_cpus=1</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#[worker-2]</span></span><br><span class="line"><span class="comment">#type=worker</span></span><br><span class="line"><span class="comment">#host=localhost</span></span><br><span class="line"><span class="comment">#interface=eth0</span></span><br></pre></td></tr></table></figure>

<h1 id="Optional-Dependencies"><a href="#Optional-Dependencies" class="headerlink" title="Optional Dependencies"></a>Optional Dependencies</h1><h2 id="PF-RING"><a href="#PF-RING" class="headerlink" title="PF_RING"></a>PF_RING</h2><p><strong>参考:</strong></p>
<ul>
<li><strong><a href="https://www.zeek.org/documentation/load-balancing.html" target="_blank" rel="noopener">Installing PF_RING</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/ntop/PF_RING.git</span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo insmod ./pf_ring.ko</span><br><span class="line">$ <span class="built_in">cd</span> ../userland</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p><strong>pfring</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/src</span><br><span class="line">$ tar xvzf PF_RING-6.2.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> PF_RING-6.2.0/userland/lib</span><br><span class="line">$ ./configure --prefix=/opt/pfring</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>libpcap</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../libpcap</span><br><span class="line">$ ./configure --prefix=/opt/pfring</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>tcpdump</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../tcpdump</span><br><span class="line">$ ./configure --prefix=/opt/pfring</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../../kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>Load pf_ring at boot</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'pf_ring'</span> &gt;&gt; /etc/modules</span><br><span class="line">$ sudo reboot</span><br><span class="line"></span><br><span class="line">root@ubuntu:~<span class="comment"># lsmod | grep pf_ring</span></span><br><span class="line">pf_ring              1245184  0</span><br></pre></td></tr></table></figure>

<p><em>确保Zeek正确链接到所需的libpcap库:</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:/usr/<span class="built_in">local</span>/zeek/etc<span class="comment"># ldd /usr/local/zeek/bin/zeek | grep pcap</span></span><br><span class="line">	libpcap.so.1 =&gt; /opt/pfring/lib/libpcap.so.1 (0x00007fc3c199d000)</span><br></pre></td></tr></table></figure>

<h2 id="GeoLocation"><a href="#GeoLocation" class="headerlink" title="GeoLocation"></a>GeoLocation</h2><p><strong>参考:</strong></p>
<ul>
<li><strong><a href="https://docs.zeek.org/en/stable/frameworks/geoip.html#geolocation" target="_blank" rel="noopener">Installing LibgeoIP</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install libmaxminddb-dev</span><br><span class="line">$ wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz</span><br><span class="line">$ tar zxf GeoLite2-City.tar.gz</span><br><span class="line">$ mkdir -p /usr/share/GeoIP</span><br><span class="line">$ mv GeoLite2-City_20190702/GeoLite2-City.mmdb /usr/share/GeoIP/</span><br></pre></td></tr></table></figure>

<p><strong>Testing</strong></p>
<p><em>如果未找到任何内容或未设置<code>mmdb_dir</code>，则Bro按以下顺序查找位置数据库文件：</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ bro -e <span class="string">"print lookup_location(8.8.8.8);"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>/usr/share/GeoIP/GeoLite2-City.mmdb</li>
<li>/var/lib/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/local/share/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/local/var/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/share/GeoIP/GeoLite2-Country.mmdb</li>
<li>/var/lib/GeoIP/GeoLite2-Country.mmdb</li>
<li>/usr/local/share/GeoIP/GeoLite2-Country.mmdb</li>
<li>/usr/local/var/GeoIP/GeoLite2-Country.mmdb</li>
</ul>
<p><em>如果出现 “Bro was not configured for GeoIP support”, 源码安装时需要指定<code>./configure --with-geoip=/usr/share/GeoIP</code></em></p>
<h2 id="Gperftools"><a href="#Gperftools" class="headerlink" title="Gperftools"></a>Gperftools</h2><p><strong>参考:</strong></p>
<ul>
<li><strong><a href="http://pkxpp.github.io/2017/03/30/gperftools%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">Installing Gperftools</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/gperftools/gperftools.git</span><br><span class="line">$ sudo apt-get install libunwind-dev autoconf automake libtool</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<h2 id="IPsumdump"><a href="#IPsumdump" class="headerlink" title="IPsumdump"></a>IPsumdump</h2><p><strong>参考:</strong></p>
<ul>
<li><a href="http://www.read.seas.harvard.edu/~kohler/ipsumdump/" target="_blank" rel="noopener"><strong>Installing IPsumdump</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -O http://www.read.seas.harvard.edu/~kohler/ipsumdump/ipsumdump-1.86.tar.gz</span><br><span class="line">$ tar -xzf ipsumdump-1.86.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> ipsumdump-1.86</span><br><span class="line">$ ./configure --prefix=/usr/</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line">$ sudo make clean</span><br></pre></td></tr></table></figure>

<h2 id="Krb5"><a href="#Krb5" class="headerlink" title="Krb5"></a>Krb5</h2><p><strong>参考:</strong></p>
<ul>
<li><strong><a href="http://computing.help.inf.ed.ac.uk/kerberos-ubuntu" target="_blank" rel="noopener">Installing Krb5</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install krb5-user</span><br></pre></td></tr></table></figure>

<h2 id="Jemalloc"><a href="#Jemalloc" class="headerlink" title="Jemalloc"></a>Jemalloc</h2><p>参考:</p>
<ul>
<li><a href="https://blog.csdn.net/u013224233/article/details/87930772" target="_blank" rel="noopener"><strong>Installing Jemalloc</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/jemalloc/jemalloc.git</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ make -j2</span><br><span class="line">$ sudo make install</span><br><span class="line">$ sudo ldconfig</span><br></pre></td></tr></table></figure>

<h1 id="压测"><a href="#压测" class="headerlink" title="压测"></a>压测</h1><ol>
<li><strong>查看是否丢包</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ zeekctl netstats; date</span><br><span class="line"> worker-1-1: 1565971837.137228 recvd=2834922 dropped=0 link=2834922</span><br><span class="line"> worker-1-2: 1565971837.147334 recvd=2550230 dropped=0 link=2550230</span><br><span class="line"> worker-1-3: 1565971837.162362 recvd=5180417 dropped=0 link=5180417</span><br><span class="line"> worker-1-4: 1565971837.170347 recvd=3235356 dropped=0 link=3235356</span><br><span class="line"> worker-1-5: 1565971837.186545 recvd=1916826 dropped=0 link=1916826</span><br><span class="line"> worker-1-6: 1565971837.201416 recvd=2944762 dropped=0 link=2944762</span><br><span class="line"> worker-1-7: 1565971837.214975 recvd=2279448 dropped=0 link=2279448</span><br><span class="line"> worker-1-8: 1565971837.229167 recvd=1896171 dropped=0 link=1896171</span><br><span class="line"> worker-1-9: 1565971837.249430 recvd=2550968 dropped=0 link=2550968</span><br><span class="line">worker-1-10: 1565971837.246513 recvd=3339864 dropped=0 link=3339864</span><br><span class="line">worker-1-11: 1565971837.260010 recvd=3080981 dropped=0 link=3080981</span><br><span class="line">worker-1-12: 1565971837.274447 recvd=2410030 dropped=0 link=2410030</span><br><span class="line">worker-1-13: 1565971837.282654 recvd=2188787 dropped=0 link=2188787</span><br><span class="line">worker-1-14: 1565971837.294684 recvd=3103014 dropped=0 link=3103014</span><br><span class="line">Fri Aug 16 16:10:37 UTC 2019</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>查看资源占用</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ zeekctl top; date</span><br><span class="line">Name         Type    Host             Pid     VSize  Rss  Cpu   Cmd</span><br><span class="line">logger       logger  localhost        8808      1G    99M   5%  zeek</span><br><span class="line">manager      manager localhost        8855    568M    97M  23%  zeek</span><br><span class="line">proxy-1      proxy   localhost        8901    566M    92M   5%  zeek</span><br><span class="line">worker-1-1   worker  localhost        9086      1G   697M  11%  zeek</span><br><span class="line">worker-1-2   worker  localhost        9093      1G   699M  23%  zeek</span><br><span class="line">worker-1-3   worker  localhost        9105      1G   700M  17%  zeek</span><br><span class="line">worker-1-4   worker  localhost        9111      1G   696M  17%  zeek</span><br><span class="line">worker-1-5   worker  localhost        9114      1G   699M  17%  zeek</span><br><span class="line">worker-1-6   worker  localhost        9120      1G   699M  11%  zeek</span><br><span class="line">worker-1-7   worker  localhost        9121      1G   699M  11%  zeek</span><br><span class="line">worker-1-8   worker  localhost        9132      1G   701M  11%  zeek</span><br><span class="line">worker-1-9   worker  localhost        9140      1G   699M  11%  zeek</span><br><span class="line">worker-1-10  worker  localhost        9142      1G   700M  11%  zeek</span><br><span class="line">worker-1-11  worker  localhost        9151      1G   696M  23%  zeek</span><br><span class="line">worker-1-12  worker  localhost        9155      1G   698M  17%  zeek</span><br><span class="line">worker-1-13  worker  localhost        9154      1G   701M  11%  zeek</span><br><span class="line">worker-1-14  worker  localhost        9157      1G   698M  17%  zeek</span><br><span class="line">Fri Aug 16 16:11:25 UTC 2019</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>查看流量大小(10秒)</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ zeekctl capstats; date</span><br><span class="line">Interface             kpps       mbps       (10s average)</span><br><span class="line">----------------------------------------</span><br><span class="line">localhost/ens5        37.8       375.2</span><br><span class="line">Fri Aug 16 16:12:47 UTC 2019</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>NSM</category>
      </categories>
      <tags>
        <tag>Zeek</tag>
      </tags>
  </entry>
  <entry>
    <title>我在'云'上的日子 - Suricata(优化)</title>
    <url>/2019/10/14/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90%20-%20Suricata%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<p>​        由于是云环境, 很多优化网卡的操作都没有办法进行, 以下是能够执行的一些操作。</p>
<p>参考:</p>
<ul>
<li><a href="https://paper.seebug.org/1054/" target="_blank" rel="noopener">https://paper.seebug.org/1054/</a></li>
</ul>
<h2 id="设置Ring-Buffer"><a href="#设置Ring-Buffer" class="headerlink" title="设置Ring Buffer"></a>设置Ring Buffer</h2><p><strong>1. 查看当前 Ring Buffer 大小</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ethtool -g ens3</span><br><span class="line">Ring parameters <span class="keyword">for</span> ens3:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		4096</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		1024	<span class="comment"># 看到 RX 和 TX 最大是 4096，当前RX值为 1024。</span></span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		1024</span><br></pre></td></tr></table></figure>

<p><strong>网卡ring buffer 的值并非越大越好, 这里将原来1024降到512。队列越大丢包的可能越小，但数据延迟会增加!</strong></p>
<hr>
<p><strong>2. 设置 RX 队列大小</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ethtool -G ens3 rx 512</span><br><span class="line">$ ethtool -g ens3</span><br><span class="line">Ring parameters <span class="keyword">for</span> ens3:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		4096</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		512</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		1024</span><br></pre></td></tr></table></figure>

<h2 id="设置最大传输单元"><a href="#设置最大传输单元" class="headerlink" title="设置最大传输单元"></a>设置最大传输单元</h2><p><strong><em>巨型帧 将最大传输单元增加到9000, 默认1500。数据包越小产生的CPU中断越多</em></strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ifconfig ens4 mtu 9000</span><br></pre></td></tr></table></figure>

<h2 id="设置网卡卸载"><a href="#设置网卡卸载" class="headerlink" title="设置网卡卸载"></a>设置网卡卸载</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 官方建议</span></span><br><span class="line">$ ethtool -K ens4 tso off gro off lro off gso off rx off tx off sg off rxhash off txvlan off rxvlan off ntuple off</span><br></pre></td></tr></table></figure>

<p><strong>参考:</strong></p>
<ul>
<li><a href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/File_Extraction" target="_blank" rel="noopener">https://redmine.openinfosecfoundation.org/projects/suricata/wiki/File_Extraction</a></li>
</ul>
<h2 id="设置PF-Ring"><a href="#设置PF-Ring" class="headerlink" title="设置PF_Ring"></a>设置PF_Ring</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ sudo rmmod pf_ring</span><br><span class="line">$ sudo insmod pf_ring.ko min_num_slots=65536 transparent_mode=0 enable_tx_capture=0</span><br><span class="line"></span><br><span class="line">$ cat /proc/net/pf_ring/info</span><br><span class="line">PF_RING Version          : 7.4.0 (7.4.0-stable:9cedf7ba27dd9798812906809ac54aa3c17ff346)</span><br><span class="line">Total rings              : 36</span><br><span class="line"></span><br><span class="line">Standard (non ZC) Options</span><br><span class="line">Ring slots               : 65536</span><br><span class="line">Slot version             : 17</span><br><span class="line">Capture TX               : No [RX only]</span><br><span class="line">IP Defragment            : No</span><br><span class="line">Socket Mode              : Standard</span><br><span class="line">Cluster Fragment Queue   : 0</span><br><span class="line">Cluster Fragment Discard : 0</span><br></pre></td></tr></table></figure>

<h2 id="内核优化"><a href="#内核优化" class="headerlink" title="内核优化"></a>内核优化</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo sysctl net.core.rmem_default=73400320</span><br><span class="line">sudo sysctl net.core.wmem_max=134217728</span><br><span class="line">sudo sysctl net.core.rmem_max=134217728</span><br><span class="line">sudo sysctl net.core.netdev_max_backlog=300000</span><br><span class="line">sudo sysctl net.ipv4.tcp_no_metrics_save=1</span><br><span class="line">sudo sysctl net.ipv4.tcp_congestion_control=htcp</span><br><span class="line">sudo sysctl net.ipv4.tcp_mtu_probing=1</span><br><span class="line">sudo sysctl net.ipv4.tcp_rmem=<span class="string">"100000000 100000000 100000000"</span></span><br><span class="line">sudo sysctl net.ipv4.tcp_wmem=<span class="string">"100000000 100000000 100000000"</span></span><br><span class="line">sudo sysctl net.ipv4.tcp_mem=<span class="string">"100000000 100000000 100000000"</span></span><br><span class="line">sudo sysctl net.core.netdev_budget=3000</span><br><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure>

<h2 id="配置文件优化"><a href="#配置文件优化" class="headerlink" title="配置文件优化"></a>配置文件优化</h2><p><strong>Suricata 5.0 rc-1 60G 36C</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">%YAML</span> <span class="number">1.1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">vars:</span></span><br><span class="line">  <span class="comment"># more specific is better for alert accuracy and performance</span></span><br><span class="line"><span class="attr">  address-groups:</span></span><br><span class="line"><span class="attr">    HOME_NET:</span> <span class="string">"[192.168.0.0/16,10.0.0.0/8,172.16.0.0/12]"</span></span><br><span class="line">    <span class="comment">#HOME_NET: "any"</span></span><br><span class="line">    <span class="comment">#EXTERNAL_NET: "!$HOME_NET"</span></span><br><span class="line"><span class="attr">    EXTERNAL_NET:</span> <span class="string">"any"</span></span><br><span class="line"><span class="attr">    HTTP_SERVERS:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">    SMTP_SERVERS:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">    SQL_SERVERS:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">    DNS_SERVERS:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">    TELNET_SERVERS:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">    AIM_SERVERS:</span> <span class="string">"$EXTERNAL_NET"</span></span><br><span class="line"><span class="attr">    DC_SERVERS:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">    DNP3_SERVER:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">    DNP3_CLIENT:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">    MODBUS_CLIENT:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">    MODBUS_SERVER:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">    ENIP_CLIENT:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">    ENIP_SERVER:</span> <span class="string">"$HOME_NET"</span></span><br><span class="line"><span class="attr">  port-groups:</span></span><br><span class="line"><span class="attr">    HTTP_PORTS:</span> <span class="string">"80"</span></span><br><span class="line"><span class="attr">    SHELLCODE_PORTS:</span> <span class="string">"!80"</span></span><br><span class="line"><span class="attr">    ORACLE_PORTS:</span> <span class="number">1521</span></span><br><span class="line"><span class="attr">    SSH_PORTS:</span> <span class="number">22</span></span><br><span class="line"><span class="attr">    DNP3_PORTS:</span> <span class="number">20000</span></span><br><span class="line"><span class="attr">    MODBUS_PORTS:</span> <span class="number">502</span></span><br><span class="line"><span class="attr">    FILE_DATA_PORTS:</span> <span class="string">"[$HTTP_PORTS,110,143]"</span></span><br><span class="line"><span class="attr">    FTP_PORTS:</span> <span class="number">21</span></span><br><span class="line"><span class="attr">    VXLAN_PORTS:</span> <span class="number">4789</span></span><br><span class="line"><span class="attr">default-log-dir:</span> <span class="string">/data/logs/suricata/</span></span><br><span class="line"><span class="attr">stats:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="comment"># The interval field (in seconds) controls at what interval</span></span><br><span class="line">  <span class="comment"># the loggers are invoked.</span></span><br><span class="line"><span class="attr">  interval:</span> <span class="number">60</span></span><br><span class="line">  <span class="comment"># Add decode events as stats.</span></span><br><span class="line">  <span class="comment">#decoder-events: true</span></span><br><span class="line">  <span class="comment"># Decoder event prefix in stats. Has been 'decoder' before, but that leads</span></span><br><span class="line">  <span class="comment"># to missing events in the eve.stats records. See issue #2225.</span></span><br><span class="line"><span class="attr">  decoder-events-prefix:</span> <span class="string">"decoder.event"</span></span><br><span class="line">  <span class="comment"># Add stream events as stats.</span></span><br><span class="line">  <span class="comment">#stream-events: false</span></span><br><span class="line"><span class="attr">outputs:</span></span><br><span class="line">  <span class="comment"># a line based alerts log similar to Snort's fast.log</span></span><br><span class="line"><span class="attr">  - fast:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="comment"># filename: fast.log</span></span><br><span class="line"><span class="attr">      append:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment"># 'regular', 'unix_stream' or 'unix_dgram'</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">fast-%Y-%m-%d.log</span></span><br><span class="line">  <span class="comment"># Extensible Event Format (nicknamed EVE) event log in JSON format</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">alert-%Y-%m-%d.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="string">day</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">      xff:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">        mode:</span> <span class="string">overwrite</span></span><br><span class="line"><span class="attr">        deployment:</span> <span class="string">forward</span></span><br><span class="line"><span class="attr">        header:</span> <span class="literal">True</span><span class="bullet">-Client-IP</span></span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line"><span class="attr">        - alert:</span></span><br><span class="line"><span class="attr">            payload-printable:</span> <span class="literal">yes</span>   <span class="comment"># enable dumping payload in printable (lossy) format</span></span><br><span class="line"><span class="attr">            http-body-printable:</span> <span class="literal">yes</span> <span class="comment"># enable dumping of http body in printable format</span></span><br><span class="line"><span class="attr">            tagged-packets:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">            payload-buffer-size:</span> <span class="number">30</span><span class="string">kb</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">http-%Y-%m-%d-%H:%M.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="number">30</span><span class="string">m</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      xff:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="comment">#mode: overwrite</span></span><br><span class="line"><span class="attr">        mode:</span> <span class="string">extra-data</span></span><br><span class="line"><span class="attr">        deployment:</span> <span class="string">forward</span></span><br><span class="line">        <span class="comment">#header: X-Forwarded-For</span></span><br><span class="line"><span class="attr">        header:</span> <span class="literal">True</span><span class="bullet">-Client-IP</span></span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line"><span class="attr">        - http:</span></span><br><span class="line"><span class="attr">            extended:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">            custom:</span> <span class="string">[accept,</span> <span class="string">accept-charset,</span> <span class="string">accept-encoding,</span> <span class="string">accept-language,accept-datetime,</span> <span class="string">authorization,</span> <span class="string">cache-control,</span> <span class="string">cookie,</span> <span class="string">from,</span> <span class="string">max-forwards,</span> <span class="string">origin,</span> <span class="string">pragma,</span> <span class="string">proxy-authorization,</span> <span class="string">range,</span> <span class="string">te,</span> <span class="string">via,</span> <span class="string">x-requested-with,</span> <span class="string">dnt,</span> <span class="string">x-forwarded-proto,</span> <span class="string">accept-range,</span> <span class="string">age,</span> <span class="string">allow,</span> <span class="string">connection,</span> <span class="string">content-encoding,</span> <span class="string">content-language,</span> <span class="string">content-length,</span> <span class="string">content-location,</span> <span class="string">content-md5,</span> <span class="string">content-range,</span> <span class="string">content-type,</span> <span class="string">date,</span> <span class="string">etags,</span> <span class="string">last-modified,</span> <span class="string">link,</span> <span class="string">location,</span> <span class="string">proxy-authenticate,</span> <span class="string">referrer,</span> <span class="string">refresh,</span> <span class="string">retry-after,</span> <span class="string">server,</span> <span class="string">set-cookie,</span> <span class="string">trailer,</span> <span class="string">transfer-encoding,</span> <span class="string">upgrade,</span> <span class="string">vary,</span> <span class="string">warning,</span> <span class="string">www-authenticate,</span> <span class="string">x-flash-version,</span> <span class="string">x-authenticated-user,</span> <span class="literal">true</span><span class="bullet">-client-ip]</span></span><br><span class="line">            <span class="comment"># dump-all-headers: requests # requests/responses/both</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">dns-%Y-%m-%d.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="string">day</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line"><span class="attr">        - dns:</span></span><br><span class="line"><span class="attr">            version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">smtp-%Y-%m-%d.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="string">day</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line"><span class="attr">        - smtp:</span></span><br><span class="line"><span class="attr">            extended:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">            custom:</span> <span class="string">[user-agent,</span> <span class="string">received,</span> <span class="string">x-mailer,</span> <span class="string">x-originating-ip,</span> <span class="string">relays,</span> <span class="string">reply-to,</span> <span class="string">bcc]</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">ssh-%Y-%m-%d.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="string">day</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">ftp-%Y-%m-%d.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="string">day</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">ftp</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">tls-%Y-%m-%d.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="string">day</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line"><span class="attr">        - tls:</span></span><br><span class="line"><span class="attr">            extended:</span> <span class="literal">yes</span></span><br><span class="line">            <span class="comment"># output TLS transaction where the session is resumed using a session id</span></span><br><span class="line">            <span class="comment">#session-resumption: no</span></span><br><span class="line">            <span class="comment">#custom: [subject, issuer, session_resumed, serial, fingerprint, sni, version, not_before, not_after, certificate, chain, ja3, ja3s]</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span>  <span class="literal">no</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">smb-%Y-%m-%d.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="string">day</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">smb</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">rdp-%Y-%m-%d.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="string">day</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">rdp</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">flow-%Y-%m-%d-%H:%M.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="number">30</span><span class="string">m</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">flow</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">stats-%Y-%m-%d.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="string">day</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line"><span class="attr">        - stats:</span></span><br><span class="line"><span class="attr">            totals:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">            threads:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">            deltas:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  - eve-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filetype:</span> <span class="string">regular</span> <span class="comment">#regular|syslog|unix_dgram|unix_stream|redis</span></span><br><span class="line"><span class="attr">      filemode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">eve-%Y-%m-%d.json</span></span><br><span class="line"><span class="attr">      rotate-interval:</span> <span class="string">day</span></span><br><span class="line"><span class="attr">      pcap-file:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      types:</span></span><br><span class="line">        <span class="comment"># - dnp3</span></span><br><span class="line">        <span class="comment"># - nfs</span></span><br><span class="line">        <span class="comment"># - tftp</span></span><br><span class="line">        <span class="comment"># - ikev2</span></span><br><span class="line">        <span class="comment"># - krb5</span></span><br><span class="line">        <span class="comment"># - snmp</span></span><br><span class="line">        <span class="comment"># - sip</span></span><br><span class="line">        <span class="comment"># - dhcp:</span></span><br><span class="line"><span class="attr">            enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">            extended:</span> <span class="literal">no</span></span><br><span class="line">        <span class="comment"># - metadata</span></span><br><span class="line">  <span class="comment"># alert output for use with Barnyard2</span></span><br><span class="line"><span class="attr">  - unified2-alert:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">unified2.alert</span></span><br><span class="line">      <span class="comment"># File size limit.  Can be specified in kb, mb, gb.  Just a number</span></span><br><span class="line">      <span class="comment"># is parsed as bytes.</span></span><br><span class="line">      <span class="comment">#limit: 32mb</span></span><br><span class="line">      <span class="comment"># By default unified2 log files have the file creation time (in</span></span><br><span class="line">      <span class="comment"># unix epoch format) appended to the filename. Set this to yes to</span></span><br><span class="line">      <span class="comment"># disable this behaviour.</span></span><br><span class="line">      <span class="comment">#nostamp: no</span></span><br><span class="line">      <span class="comment"># Sensor ID field of unified2 alerts.</span></span><br><span class="line">      <span class="comment">#sensor-id: 0</span></span><br><span class="line">      <span class="comment"># Include payload of packets related to alerts. Defaults to true, set to</span></span><br><span class="line">      <span class="comment"># false if payload is not required.</span></span><br><span class="line">      <span class="comment">#payload: yes</span></span><br><span class="line">      <span class="comment"># HTTP X-Forwarded-For support by adding the unified2 extra header or</span></span><br><span class="line">      <span class="comment"># overwriting the source or destination IP address (depending on flow</span></span><br><span class="line">      <span class="comment"># direction) with the one reported in the X-Forwarded-For HTTP header.</span></span><br><span class="line">      <span class="comment"># This is helpful when reviewing alerts for traffic that is being reverse</span></span><br><span class="line">      <span class="comment"># or forward proxied.</span></span><br><span class="line"><span class="attr">      xff:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">no</span></span><br><span class="line">        <span class="comment"># Two operation modes are available, "extra-data" and "overwrite". Note</span></span><br><span class="line">        <span class="comment"># that in the "overwrite" mode, if the reported IP address in the HTTP</span></span><br><span class="line">        <span class="comment"># X-Forwarded-For header is of a different version of the packet</span></span><br><span class="line">        <span class="comment"># received, it will fall-back to "extra-data" mode.</span></span><br><span class="line"><span class="attr">        mode:</span> <span class="string">extra-data</span></span><br><span class="line">        <span class="comment"># Two proxy deployments are supported, "reverse" and "forward". In</span></span><br><span class="line">        <span class="comment"># a "reverse" deployment the IP address used is the last one, in a</span></span><br><span class="line">        <span class="comment"># "forward" deployment the first IP address is used.</span></span><br><span class="line"><span class="attr">        deployment:</span> <span class="string">reverse</span></span><br><span class="line">        <span class="comment"># Header name where the actual IP address will be reported, if more</span></span><br><span class="line">        <span class="comment"># than one IP address is present, the last IP address will be the</span></span><br><span class="line">        <span class="comment"># one taken into consideration.</span></span><br><span class="line"><span class="attr">        header:</span> <span class="string">X-Forwarded-For</span></span><br><span class="line">  <span class="comment"># a line based log of HTTP requests (no alerts)</span></span><br><span class="line"><span class="attr">  - http-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">http.log</span></span><br><span class="line"><span class="attr">      append:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="comment">#extended: yes     # enable this for extended logging information</span></span><br><span class="line">      <span class="comment">#custom: yes       # enabled the custom logging format (defined by customformat)</span></span><br><span class="line">      <span class="comment">#customformat: "%&#123;%D-%H:%M:%S&#125;t.%z %&#123;X-Forwarded-For&#125;i %H %m %h %u %s %B %a:%p -&gt; %A:%P"</span></span><br><span class="line">      <span class="comment">#filetype: regular # 'regular', 'unix_stream' or 'unix_dgram'</span></span><br><span class="line">  <span class="comment"># a line based log of TLS handshake parameters (no alerts)</span></span><br><span class="line"><span class="attr">  - tls-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span>  <span class="comment"># Log TLS connections.</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">tls.log</span> <span class="comment"># File to store TLS logs.</span></span><br><span class="line"><span class="attr">      append:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="comment">#extended: yes     # Log extended information like fingerprint</span></span><br><span class="line">      <span class="comment">#custom: yes       # enabled the custom logging format (defined by customformat)</span></span><br><span class="line">      <span class="comment">#customformat: "%&#123;%D-%H:%M:%S&#125;t.%z %a:%p -&gt; %A:%P %v %n %d %D"</span></span><br><span class="line">      <span class="comment">#filetype: regular # 'regular', 'unix_stream' or 'unix_dgram'</span></span><br><span class="line">      <span class="comment"># output TLS transaction where the session is resumed using a</span></span><br><span class="line">      <span class="comment"># session id</span></span><br><span class="line">      <span class="comment">#session-resumption: no</span></span><br><span class="line">  <span class="comment"># output module to store certificates chain to disk</span></span><br><span class="line"><span class="attr">  - tls-store:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line">      <span class="comment">#certs-log-dir: certs # directory to store the certificates files</span></span><br><span class="line">  <span class="comment"># Packet log... log packets in pcap format. 3 modes of operation: "normal"</span></span><br><span class="line">  <span class="comment"># "multi" and "sguil".</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># In normal mode a pcap file "filename" is created in the default-log-dir,</span></span><br><span class="line">  <span class="comment"># or are as specified by "dir".</span></span><br><span class="line">  <span class="comment"># In multi mode, a file is created per thread. This will perform much</span></span><br><span class="line">  <span class="comment"># better, but will create multiple files where 'normal' would create one.</span></span><br><span class="line">  <span class="comment"># In multi mode the filename takes a few special variables:</span></span><br><span class="line">  <span class="comment"># - %n -- thread number</span></span><br><span class="line">  <span class="comment"># - %i -- thread id</span></span><br><span class="line">  <span class="comment"># - %t -- timestamp (secs or secs.usecs based on 'ts-format'</span></span><br><span class="line">  <span class="comment"># E.g. filename: pcap.%n.%t</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Note that it's possible to use directories, but the directories are not</span></span><br><span class="line">  <span class="comment"># created by Suricata. E.g. filename: pcaps/%n/log.%s will log into the</span></span><br><span class="line">  <span class="comment"># per thread directory.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Also note that the limit and max-files settings are enforced per thread.</span></span><br><span class="line">  <span class="comment"># So the size limit when using 8 threads with 1000mb files and 2000 files</span></span><br><span class="line">  <span class="comment"># is: 8*1000*2000 ~ 16TiB.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># In Sguil mode "dir" indicates the base directory. In this base dir the</span></span><br><span class="line">  <span class="comment"># pcaps are created in th directory structure Sguil expects:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># $sguil-base-dir/YYYY-MM-DD/$filename.&lt;timestamp&gt;</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># By default all packets are logged except:</span></span><br><span class="line">  <span class="comment"># - TCP streams beyond stream.reassembly.depth</span></span><br><span class="line">  <span class="comment"># - encrypted streams after the key exchange</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"><span class="attr">  - pcap-log:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">log.pcap</span></span><br><span class="line">      <span class="comment"># File size limit.  Can be specified in kb, mb, gb.  Just a number</span></span><br><span class="line">      <span class="comment"># is parsed as bytes.</span></span><br><span class="line"><span class="attr">      limit:</span> <span class="number">1000</span><span class="string">mb</span></span><br><span class="line">      <span class="comment"># If set to a value will enable ring buffer mode. Will keep Maximum of "max-files" of size "limit"</span></span><br><span class="line"><span class="attr">      max-files:</span> <span class="number">2000</span></span><br><span class="line">      <span class="comment"># Compression algorithm for pcap files. Possible values: none, lz4.</span></span><br><span class="line">      <span class="comment"># Enabling compression is incompatible with the sguil mode. Note also</span></span><br><span class="line">      <span class="comment"># that on Windows, enabling compression will *increase* disk I/O.</span></span><br><span class="line"><span class="attr">      compression:</span> <span class="string">none</span></span><br><span class="line">      <span class="comment"># Further options for lz4 compression. The compression level can be set</span></span><br><span class="line">      <span class="comment"># to a value between 0 and 16, where higher values result in higher</span></span><br><span class="line">      <span class="comment"># compression.</span></span><br><span class="line">      <span class="comment">#lz4-checksum: no</span></span><br><span class="line">      <span class="comment">#lz4-level: 0</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="string">normal</span> <span class="comment"># normal, multi or sguil.</span></span><br><span class="line">      <span class="comment"># Directory to place pcap files. If not provided the default log</span></span><br><span class="line">      <span class="comment"># directory will be used. Required for "sguil" mode.</span></span><br><span class="line">      <span class="comment">#dir: /nsm_data/</span></span><br><span class="line">      <span class="comment">#ts-format: usec # sec or usec second format (default) is filename.sec usec is filename.sec.usec</span></span><br><span class="line"><span class="attr">      use-stream-depth:</span> <span class="literal">no</span> <span class="comment">#If set to "yes" packets seen after reaching stream inspection depth are ignored. "no" logs all packets</span></span><br><span class="line"><span class="attr">      honor-pass-rules:</span> <span class="literal">no</span> <span class="comment"># If set to "yes", flows in which a pass rule matched will stopped being logged.</span></span><br><span class="line">  <span class="comment"># a full alerts log containing much information for signature writers</span></span><br><span class="line">  <span class="comment"># or for investigating suspected false positives.</span></span><br><span class="line"><span class="attr">  - alert-debug:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">alert-debug.log</span></span><br><span class="line"><span class="attr">      append:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="comment">#filetype: regular # 'regular', 'unix_stream' or 'unix_dgram'</span></span><br><span class="line">  <span class="comment"># alert output to prelude (https://www.prelude-siem.org/) only</span></span><br><span class="line">  <span class="comment"># available if Suricata has been compiled with --enable-prelude</span></span><br><span class="line"><span class="attr">  - alert-prelude:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      profile:</span> <span class="string">suricata</span></span><br><span class="line"><span class="attr">      log-packet-content:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      log-packet-header:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="comment"># Stats.log contains data from various counters of the Suricata engine.</span></span><br><span class="line"><span class="attr">  - stats:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">stats.log</span></span><br><span class="line"><span class="attr">      append:</span> <span class="literal">yes</span>       <span class="comment"># append to file (yes) or overwrite it (no)</span></span><br><span class="line"><span class="attr">      totals:</span> <span class="literal">yes</span>       <span class="comment"># stats for all threads merged together</span></span><br><span class="line"><span class="attr">      threads:</span> <span class="literal">no</span>       <span class="comment"># per thread stats</span></span><br><span class="line">      <span class="comment">#null-values: yes  # print counters that have value 0</span></span><br><span class="line">  <span class="comment"># a line based alerts log similar to fast.log into syslog</span></span><br><span class="line"><span class="attr">  - syslog:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line">      <span class="comment"># reported identity to syslog. If ommited the program name (usually</span></span><br><span class="line">      <span class="comment"># suricata) will be used.</span></span><br><span class="line">      <span class="comment">#identity: "suricata"</span></span><br><span class="line"><span class="attr">      facility:</span> <span class="string">local5</span></span><br><span class="line">      <span class="comment">#level: Info ## possible levels: Emergency, Alert, Critical,</span></span><br><span class="line">                   <span class="comment">## Error, Warning, Notice, Info, Debug</span></span><br><span class="line">  <span class="comment"># a line based information for dropped packets in IPS mode</span></span><br><span class="line"><span class="attr">  - drop:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">drop.log</span></span><br><span class="line"><span class="attr">      append:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="comment">#filetype: regular # 'regular', 'unix_stream' or 'unix_dgram'</span></span><br><span class="line">  <span class="comment"># Output module for storing files on disk. Files are stored in a</span></span><br><span class="line">  <span class="comment"># directory names consisting of the first 2 characters of the</span></span><br><span class="line">  <span class="comment"># SHA256 of the file. Each file is given its SHA256 as a filename.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># When a duplicate file is found, the existing file is touched to</span></span><br><span class="line">  <span class="comment"># have its timestamps updated.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Unlike the older filestore, metadata is not written out by default</span></span><br><span class="line">  <span class="comment"># as each file should already have a "fileinfo" record in the</span></span><br><span class="line">  <span class="comment"># eve.log. If write-fileinfo is set to yes, the each file will have</span></span><br><span class="line">  <span class="comment"># one more associated .json files that consists of the fileinfo</span></span><br><span class="line">  <span class="comment"># record. A fileinfo file will be written for each occurrence of the</span></span><br><span class="line">  <span class="comment"># file seen using a filename suffix to ensure uniqueness.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># To prune the filestore directory see the "suricatactl filestore</span></span><br><span class="line">  <span class="comment"># prune" command which can delete files over a certain age.</span></span><br><span class="line"><span class="attr">  - file-store:</span></span><br><span class="line"><span class="attr">      version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line">      <span class="comment"># Set the directory for the filestore. If the path is not</span></span><br><span class="line">      <span class="comment"># absolute will be be relative to the default-log-dir.</span></span><br><span class="line">      <span class="comment">#dir: filestore</span></span><br><span class="line">      <span class="comment"># Write out a fileinfo record for each occurrence of a</span></span><br><span class="line">      <span class="comment"># file. Disabled by default as each occurrence is already logged</span></span><br><span class="line">      <span class="comment"># as a fileinfo record to the main eve-log.</span></span><br><span class="line">      <span class="comment">#write-fileinfo: yes</span></span><br><span class="line">      <span class="comment"># Force storing of all files. Default: no.</span></span><br><span class="line">      <span class="comment">#force-filestore: yes</span></span><br><span class="line">      <span class="comment"># Override the global stream-depth for sessions in which we want</span></span><br><span class="line">      <span class="comment"># to perform file extraction. Set to 0 for unlimited.</span></span><br><span class="line">      <span class="comment">#stream-depth: 0</span></span><br><span class="line">      <span class="comment"># Uncomment the following variable to define how many files can</span></span><br><span class="line">      <span class="comment"># remain open for filestore by Suricata. Default value is 0 which</span></span><br><span class="line">      <span class="comment"># means files get closed after each write</span></span><br><span class="line">      <span class="comment">#max-open-files: 1000</span></span><br><span class="line">      <span class="comment"># Force logging of checksums, available hash functions are md5,</span></span><br><span class="line">      <span class="comment"># sha1 and sha256. Note that SHA256 is automatically forced by</span></span><br><span class="line">      <span class="comment"># the use of this output module as it uses the SHA256 as the</span></span><br><span class="line">      <span class="comment"># file naming scheme.</span></span><br><span class="line">      <span class="comment">#force-hash: [sha1, md5]</span></span><br><span class="line">      <span class="comment"># <span class="doctag">NOTE:</span> X-Forwarded configuration is ignored if write-fileinfo is disabled</span></span><br><span class="line">      <span class="comment"># HTTP X-Forwarded-For support by adding an extra field or overwriting</span></span><br><span class="line">      <span class="comment"># the source or destination IP address (depending on flow direction)</span></span><br><span class="line">      <span class="comment"># with the one reported in the X-Forwarded-For HTTP header. This is</span></span><br><span class="line">      <span class="comment"># helpful when reviewing alerts for traffic that is being reverse</span></span><br><span class="line">      <span class="comment"># or forward proxied.</span></span><br><span class="line"><span class="attr">      xff:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">no</span></span><br><span class="line">        <span class="comment"># Two operation modes are available, "extra-data" and "overwrite".</span></span><br><span class="line"><span class="attr">        mode:</span> <span class="string">extra-data</span></span><br><span class="line">        <span class="comment"># Two proxy deployments are supported, "reverse" and "forward". In</span></span><br><span class="line">        <span class="comment"># a "reverse" deployment the IP address used is the last one, in a</span></span><br><span class="line">        <span class="comment"># "forward" deployment the first IP address is used.</span></span><br><span class="line"><span class="attr">        deployment:</span> <span class="string">reverse</span></span><br><span class="line">        <span class="comment"># Header name where the actual IP address will be reported, if more</span></span><br><span class="line">        <span class="comment"># than one IP address is present, the last IP address will be the</span></span><br><span class="line">        <span class="comment"># one taken into consideration.</span></span><br><span class="line"><span class="attr">        header:</span> <span class="string">X-Forwarded-For</span></span><br><span class="line">  <span class="comment"># output module to store extracted files to disk (old style, deprecated)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># The files are stored to the log-dir in a format "file.&lt;id&gt;" where &lt;id&gt; is</span></span><br><span class="line">  <span class="comment"># an incrementing number starting at 1. For each file "file.&lt;id&gt;" a meta</span></span><br><span class="line">  <span class="comment"># file "file.&lt;id&gt;.meta" is created. Before they are finalized, they will</span></span><br><span class="line">  <span class="comment"># have a ".tmp" suffix to indicate that they are still being processed.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># If include-pid is yes, then the files are instead "file.&lt;pid&gt;.&lt;id&gt;", with</span></span><br><span class="line">  <span class="comment"># meta files named as "file.&lt;pid&gt;.&lt;id&gt;.meta"</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># File extraction depends on a lot of things to be fully done:</span></span><br><span class="line">  <span class="comment"># - file-store stream-depth. For optimal results, set this to 0 (unlimited)</span></span><br><span class="line">  <span class="comment"># - http request / response body sizes. Again set to 0 for optimal results.</span></span><br><span class="line">  <span class="comment"># - rules that contain the "filestore" keyword.</span></span><br><span class="line"><span class="attr">  - file-store:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span>       <span class="comment"># set to yes to enable</span></span><br><span class="line"><span class="attr">      log-dir:</span> <span class="string">files</span>    <span class="comment"># directory to store the files</span></span><br><span class="line"><span class="attr">      force-magic:</span> <span class="literal">no</span>   <span class="comment"># force logging magic on all stored files</span></span><br><span class="line">      <span class="comment"># force logging of checksums, available hash functions are md5,</span></span><br><span class="line">      <span class="comment"># sha1 and sha256</span></span><br><span class="line">      <span class="comment">#force-hash: [md5]</span></span><br><span class="line"><span class="attr">      force-filestore:</span> <span class="literal">no</span> <span class="comment"># force storing of all files</span></span><br><span class="line">      <span class="comment"># override global stream-depth for sessions in which we want to</span></span><br><span class="line">      <span class="comment"># perform file extraction. Set to 0 for unlimited.</span></span><br><span class="line">      <span class="comment">#stream-depth: 0</span></span><br><span class="line">      <span class="comment">#waldo: file.waldo # waldo file to store the file_id across runs</span></span><br><span class="line">      <span class="comment"># uncomment to disable meta file writing</span></span><br><span class="line">      <span class="comment">#write-meta: no</span></span><br><span class="line">      <span class="comment"># uncomment the following variable to define how many files can</span></span><br><span class="line">      <span class="comment"># remain open for filestore by Suricata. Default value is 0 which</span></span><br><span class="line">      <span class="comment"># means files get closed after each write</span></span><br><span class="line">      <span class="comment">#max-open-files: 1000</span></span><br><span class="line"><span class="attr">      include-pid:</span> <span class="literal">no</span> <span class="comment"># set to yes to include pid in file names</span></span><br><span class="line">  <span class="comment"># Log TCP data after stream normalization</span></span><br><span class="line">  <span class="comment"># 2 types: file or dir. File logs into a single logfile. Dir creates</span></span><br><span class="line">  <span class="comment"># 2 files per TCP session and stores the raw TCP data into them.</span></span><br><span class="line">  <span class="comment"># Using 'both' will enable both file and dir modes.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Note: limited by stream.depth</span></span><br><span class="line"><span class="attr">  - tcp-data:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">tcp-data.log</span></span><br><span class="line">  <span class="comment"># Log HTTP body data after normalization, dechunking and unzipping.</span></span><br><span class="line">  <span class="comment"># 2 types: file or dir. File logs into a single logfile. Dir creates</span></span><br><span class="line">  <span class="comment"># 2 files per HTTP session and stores the normalized data into them.</span></span><br><span class="line">  <span class="comment"># Using 'both' will enable both file and dir modes.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Note: limited by the body limit settings</span></span><br><span class="line"><span class="attr">  - http-body-data:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">http-data.log</span></span><br><span class="line">  <span class="comment"># Lua Output Support - execute lua script to generate alert and event</span></span><br><span class="line">  <span class="comment"># output.</span></span><br><span class="line">  <span class="comment"># Documented at:</span></span><br><span class="line">  <span class="comment"># https://suricata.readthedocs.io/en/latest/output/lua-output.html</span></span><br><span class="line"><span class="attr">  - lua:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      scripts-dir:</span> <span class="string">/etc/suricata/lua-output/</span></span><br><span class="line"><span class="attr">      scripts:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">web_login_audit.lua</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">app_login_audit.lua</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">web_forget_password_audit.lua</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">check_member_email_exists.lua</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">app_wallet_audit.lua</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="comment"># The default log level, can be overridden in an output section.</span></span><br><span class="line">  <span class="comment"># Note that debug level logging will only be emitted if Suricata was</span></span><br><span class="line">  <span class="comment"># compiled with the --enable-debug configure option.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This value is overridden by the SC_LOG_LEVEL env var.</span></span><br><span class="line"><span class="attr">  default-log-level:</span> <span class="string">notice</span></span><br><span class="line">  <span class="comment"># The default output format.  Optional parameter, should default to</span></span><br><span class="line">  <span class="comment"># something reasonable if not provided.  Can be overridden in an</span></span><br><span class="line">  <span class="comment"># output section.  You can leave this out to get the default.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This value is overridden by the SC_LOG_FORMAT env var.</span></span><br><span class="line">  <span class="comment">#default-log-format: "[%i] %t - (%f:%l) &lt;%d&gt; (%n) -- "</span></span><br><span class="line">  <span class="comment"># A regex to filter output.  Can be overridden in an output section.</span></span><br><span class="line">  <span class="comment"># Defaults to empty (no filter).</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This value is overridden by the SC_LOG_OP_FILTER env var.</span></span><br><span class="line"><span class="attr">  default-output-filter:</span></span><br><span class="line">  <span class="comment"># Define your logging outputs.  If none are defined, or they are all</span></span><br><span class="line">  <span class="comment"># disabled you will get the default - console output.</span></span><br><span class="line"><span class="attr">  outputs:</span></span><br><span class="line"><span class="attr">  - console:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="comment"># type: json</span></span><br><span class="line"><span class="attr">  - file:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      level:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">suricata.log</span></span><br><span class="line">      <span class="comment"># type: json</span></span><br><span class="line"><span class="attr">  - syslog:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      facility:</span> <span class="string">local5</span></span><br><span class="line"><span class="attr">      format:</span> <span class="string">"[%i] &lt;%d&gt; -- "</span></span><br><span class="line">      <span class="comment"># type: json</span></span><br><span class="line"><span class="attr">af-packet:</span></span><br><span class="line"><span class="attr">  - interface:</span> <span class="string">ens4</span></span><br><span class="line">    <span class="comment"># Number of receive threads. "auto" uses the number of cores</span></span><br><span class="line"><span class="attr">    threads:</span> <span class="string">auto</span></span><br><span class="line">    <span class="comment"># Default clusterid. AF_PACKET will load balance packets based on flow.</span></span><br><span class="line"><span class="attr">    cluster-id:</span> <span class="number">99</span></span><br><span class="line">    <span class="comment"># Default AF_PACKET cluster type. AF_PACKET can load balance per flow or per hash.</span></span><br><span class="line">    <span class="comment"># This is only supported for Linux kernel &gt; 3.1</span></span><br><span class="line">    <span class="comment"># possible value are:</span></span><br><span class="line">    <span class="comment">#  * cluster_flow: all packets of a given flow are send to the same socket</span></span><br><span class="line">    <span class="comment">#  * cluster_cpu: all packets treated in kernel by a CPU are send to the same socket</span></span><br><span class="line">    <span class="comment">#  * cluster_qm: all packets linked by network card to a RSS queue are sent to the same</span></span><br><span class="line">    <span class="comment">#  socket. Requires at least Linux 3.14.</span></span><br><span class="line">    <span class="comment">#  * cluster_ebpf: eBPF file load balancing. See doc/userguide/capture-hardware/ebpf-xdp.rst for</span></span><br><span class="line">    <span class="comment">#  more info.</span></span><br><span class="line">    <span class="comment"># Recommended modes are cluster_flow on most boxes and cluster_cpu or cluster_qm on system</span></span><br><span class="line">    <span class="comment"># with capture card using RSS (require cpu affinity tuning and system irq tuning)</span></span><br><span class="line"><span class="attr">    cluster-type:</span> <span class="string">cluster_flow</span></span><br><span class="line">    <span class="comment"># In some fragmentation case, the hash can not be computed. If "defrag" is set</span></span><br><span class="line">    <span class="comment"># to yes, the kernel will do the needed defragmentation before sending the packets.</span></span><br><span class="line"><span class="attr">    defrag:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="comment"># To use the ring feature of AF_PACKET, set 'use-mmap' to yes</span></span><br><span class="line">    <span class="comment">#use-mmap: yes</span></span><br><span class="line">    <span class="comment"># Lock memory map to avoid it goes to swap. Be careful that over subscribing could lock</span></span><br><span class="line">    <span class="comment"># your system</span></span><br><span class="line">    <span class="comment">#mmap-locked: yes</span></span><br><span class="line">    <span class="comment"># Use tpacket_v3 capture mode, only active if use-mmap is true</span></span><br><span class="line">    <span class="comment"># Don't use it in IPS or TAP mode as it causes severe latency</span></span><br><span class="line"><span class="attr">    tpacket-v3:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="comment"># Ring size will be computed with respect to max_pending_packets and number</span></span><br><span class="line">    <span class="comment"># of threads. You can set manually the ring size in number of packets by setting</span></span><br><span class="line">    <span class="comment"># the following value. If you are using flow cluster-type and have really network</span></span><br><span class="line">    <span class="comment"># intensive single-flow you could want to set the ring-size independently of the number</span></span><br><span class="line">    <span class="comment"># of threads:</span></span><br><span class="line">    <span class="comment">#ring-size: 2048</span></span><br><span class="line">    <span class="comment"># Block size is used by tpacket_v3 only. It should set to a value high enough to contain</span></span><br><span class="line">    <span class="comment"># a decent number of packets. Size is in bytes so please consider your MTU. It should be</span></span><br><span class="line">    <span class="comment"># a power of 2 and it must be multiple of page size (usually 4096).</span></span><br><span class="line">    <span class="comment">#block-size: 32768</span></span><br><span class="line">    <span class="comment"># tpacket_v3 block timeout: an open block is passed to userspace if it is not</span></span><br><span class="line">    <span class="comment"># filled after block-timeout milliseconds.</span></span><br><span class="line">    <span class="comment">#block-timeout: 10</span></span><br><span class="line">    <span class="comment"># On busy system, this could help to set it to yes to recover from a packet drop</span></span><br><span class="line">    <span class="comment"># phase. This will result in some packets (at max a ring flush) being non treated.</span></span><br><span class="line">    <span class="comment">#use-emergency-flush: yes</span></span><br><span class="line">    <span class="comment"># recv buffer size, increase value could improve performance</span></span><br><span class="line">    <span class="comment"># buffer-size: 32768</span></span><br><span class="line">    <span class="comment"># Set to yes to disable promiscuous mode</span></span><br><span class="line">    <span class="comment"># disable-promisc: no</span></span><br><span class="line">    <span class="comment"># Choose checksum verification mode for the interface. At the moment</span></span><br><span class="line">    <span class="comment"># of the capture, some packets may be with an invalid checksum due to</span></span><br><span class="line">    <span class="comment"># offloading to the network card of the checksum computation.</span></span><br><span class="line">    <span class="comment"># Possible values are:</span></span><br><span class="line">    <span class="comment">#  - kernel: use indication sent by kernel for each packet (default)</span></span><br><span class="line">    <span class="comment">#  - yes: checksum validation is forced</span></span><br><span class="line">    <span class="comment">#  - no: checksum validation is disabled</span></span><br><span class="line">    <span class="comment">#  - auto: suricata uses a statistical approach to detect when</span></span><br><span class="line">    <span class="comment">#  checksum off-loading is used.</span></span><br><span class="line">    <span class="comment"># Warning: 'checksum-validation' must be set to yes to have any validation</span></span><br><span class="line">    <span class="comment">#checksum-checks: kernel</span></span><br><span class="line">    <span class="comment"># BPF filter to apply to this interface. The pcap filter syntax apply here.</span></span><br><span class="line">    <span class="comment">#bpf-filter: port 80 or udp</span></span><br><span class="line">    <span class="comment"># You can use the following variables to activate AF_PACKET tap or IPS mode.</span></span><br><span class="line">    <span class="comment"># If copy-mode is set to ips or tap, the traffic coming to the current</span></span><br><span class="line">    <span class="comment"># interface will be copied to the copy-iface interface. If 'tap' is set, the</span></span><br><span class="line">    <span class="comment"># copy is complete. If 'ips' is set, the packet matching a 'drop' action</span></span><br><span class="line">    <span class="comment"># will not be copied.</span></span><br><span class="line">    <span class="comment">#copy-mode: ips</span></span><br><span class="line">    <span class="comment">#copy-iface: eth1</span></span><br><span class="line">    <span class="comment">#  For eBPF and XDP setup including bypass, filter and load balancing, please</span></span><br><span class="line">    <span class="comment">#  see doc/userguide/capture-hardware/ebpf-xdp.rst for more info.</span></span><br><span class="line">  <span class="comment"># Put default values here. These will be used for an interface that is not</span></span><br><span class="line">  <span class="comment"># in the list above.</span></span><br><span class="line"><span class="attr">  - interface:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    threads:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">    use-mmap:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    tpacket-v3:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">pcap:</span></span><br><span class="line"><span class="attr">  - interface:</span> <span class="string">eth0</span></span><br><span class="line">    <span class="comment"># On Linux, pcap will try to use mmaped capture and will use buffer-size</span></span><br><span class="line">    <span class="comment"># as total of memory used by the ring. So set this to something bigger</span></span><br><span class="line">    <span class="comment"># than 1% of your bandwidth.</span></span><br><span class="line">    <span class="comment">#buffer-size: 16777216</span></span><br><span class="line">    <span class="comment">#bpf-filter: "tcp and port 25"</span></span><br><span class="line">    <span class="comment"># Choose checksum verification mode for the interface. At the moment</span></span><br><span class="line">    <span class="comment"># of the capture, some packets may be with an invalid checksum due to</span></span><br><span class="line">    <span class="comment"># offloading to the network card of the checksum computation.</span></span><br><span class="line">    <span class="comment"># Possible values are:</span></span><br><span class="line">    <span class="comment">#  - yes: checksum validation is forced</span></span><br><span class="line">    <span class="comment">#  - no: checksum validation is disabled</span></span><br><span class="line">    <span class="comment">#  - auto: Suricata uses a statistical approach to detect when</span></span><br><span class="line">    <span class="comment">#  checksum off-loading is used. (default)</span></span><br><span class="line">    <span class="comment"># Warning: 'checksum-validation' must be set to yes to have any validation</span></span><br><span class="line">    <span class="comment">#checksum-checks: auto</span></span><br><span class="line">    <span class="comment"># With some accelerator cards using a modified libpcap (like myricom), you</span></span><br><span class="line">    <span class="comment"># may want to have the same number of capture threads as the number of capture</span></span><br><span class="line">    <span class="comment"># rings. In this case, set up the threads variable to N to start N threads</span></span><br><span class="line">    <span class="comment"># listening on the same interface.</span></span><br><span class="line">    <span class="comment">#threads: 16</span></span><br><span class="line">    <span class="comment"># set to no to disable promiscuous mode:</span></span><br><span class="line">    <span class="comment">#promisc: no</span></span><br><span class="line">    <span class="comment"># set snaplen, if not set it defaults to MTU if MTU can be known</span></span><br><span class="line">    <span class="comment"># via ioctl call and to full capture if not.</span></span><br><span class="line">    <span class="comment">#snaplen: 1518</span></span><br><span class="line">  <span class="comment"># Put default values here</span></span><br><span class="line"><span class="attr">  - interface:</span> <span class="string">default</span></span><br><span class="line">    <span class="comment">#checksum-checks: auto</span></span><br><span class="line"><span class="attr">pcap-file:</span></span><br><span class="line">  <span class="comment"># Possible values are:</span></span><br><span class="line">  <span class="comment">#  - yes: checksum validation is forced</span></span><br><span class="line">  <span class="comment">#  - no: checksum validation is disabled</span></span><br><span class="line">  <span class="comment">#  - auto: Suricata uses a statistical approach to detect when</span></span><br><span class="line">  <span class="comment">#  checksum off-loading is used. (default)</span></span><br><span class="line">  <span class="comment"># Warning: 'checksum-validation' must be set to yes to have checksum tested</span></span><br><span class="line"><span class="attr">  checksum-checks:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">app-layer:</span></span><br><span class="line"><span class="attr">  protocols:</span></span><br><span class="line"><span class="attr">    krb5:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    snmp:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    ikev2:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    tls:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      detection-ports:</span></span><br><span class="line"><span class="attr">        dp:</span> <span class="number">443</span></span><br><span class="line">      <span class="comment"># Generate JA3 fingerprint from client hello</span></span><br><span class="line"><span class="attr">      ja3-fingerprints:</span> <span class="literal">no</span></span><br><span class="line">      <span class="comment"># What to do when the encrypted communications start:</span></span><br><span class="line">      <span class="comment"># - default: keep tracking TLS session, check for protocol anomalies,</span></span><br><span class="line">      <span class="comment">#            inspect tls_* keywords. Disables inspection of unmodified</span></span><br><span class="line">      <span class="comment">#            'content' signatures.</span></span><br><span class="line">      <span class="comment"># - bypass:  stop processing this flow as much as possible. No further</span></span><br><span class="line">      <span class="comment">#            TLS parsing and inspection. Offload flow bypass to kernel</span></span><br><span class="line">      <span class="comment">#            or hardware if possible.</span></span><br><span class="line">      <span class="comment"># - full:    keep tracking and inspection as normal. Unmodified content</span></span><br><span class="line">      <span class="comment">#            keyword signatures are inspected as well.</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># For best performance, select 'bypass'.</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment">#encryption-handling: default</span></span><br><span class="line"><span class="attr">    dcerpc:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    ftp:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      memcap:</span> <span class="number">64</span><span class="string">mb</span></span><br><span class="line">    <span class="comment"># RDP, disabled by default.</span></span><br><span class="line"><span class="attr">    rdp:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    ssh:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    smtp:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      raw-extraction:</span> <span class="literal">no</span></span><br><span class="line">      <span class="comment"># Configure SMTP-MIME Decoder</span></span><br><span class="line"><span class="attr">      mime:</span></span><br><span class="line">        <span class="comment"># Decode MIME messages from SMTP transactions</span></span><br><span class="line">        <span class="comment"># (may be resource intensive)</span></span><br><span class="line">        <span class="comment"># This field supercedes all others because it turns the entire</span></span><br><span class="line">        <span class="comment"># process on or off</span></span><br><span class="line"><span class="attr">        decode-mime:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="comment"># Decode MIME entity bodies (ie. base64, quoted-printable, etc.)</span></span><br><span class="line"><span class="attr">        decode-base64:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">        decode-quoted-printable:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="comment"># Maximum bytes per header data value stored in the data structure</span></span><br><span class="line">        <span class="comment"># (default is 2000)</span></span><br><span class="line"><span class="attr">        header-value-depth:</span> <span class="number">2000</span></span><br><span class="line">        <span class="comment"># Extract URLs and save in state data structure</span></span><br><span class="line"><span class="attr">        extract-urls:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="comment"># Set to yes to compute the md5 of the mail body. You will then</span></span><br><span class="line">        <span class="comment"># be able to journalize it.</span></span><br><span class="line"><span class="attr">        body-md5:</span> <span class="literal">no</span></span><br><span class="line">      <span class="comment"># Configure inspected-tracker for file_data keyword</span></span><br><span class="line"><span class="attr">      inspected-tracker:</span></span><br><span class="line"><span class="attr">        content-limit:</span> <span class="number">100000</span></span><br><span class="line"><span class="attr">        content-inspect-min-size:</span> <span class="number">32768</span></span><br><span class="line"><span class="attr">        content-inspect-window:</span> <span class="number">4096</span></span><br><span class="line"><span class="attr">    imap:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    msn:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    smb:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      detection-ports:</span></span><br><span class="line"><span class="attr">        dp:</span> <span class="number">139</span><span class="string">,</span> <span class="number">445</span></span><br><span class="line">      <span class="comment"># Stream reassembly size for SMB streams. By default track it completely.</span></span><br><span class="line">      <span class="comment">#stream-depth: 0</span></span><br><span class="line"><span class="attr">    nfs:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    tftp:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    dns:</span></span><br><span class="line">      <span class="comment"># memcaps. Globally and per flow/state.</span></span><br><span class="line">      <span class="comment">#global-memcap: 16mb</span></span><br><span class="line">      <span class="comment">#state-memcap: 512kb</span></span><br><span class="line">      <span class="comment"># How many unreplied DNS requests are considered a flood.</span></span><br><span class="line">      <span class="comment"># If the limit is reached, app-layer-event:dns.flooded; will match.</span></span><br><span class="line">      <span class="comment">#request-flood: 500</span></span><br><span class="line"><span class="attr">      tcp:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">        detection-ports:</span></span><br><span class="line"><span class="attr">          dp:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">      udp:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">        detection-ports:</span></span><br><span class="line"><span class="attr">          dp:</span> <span class="number">53</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      memcap:</span> <span class="number">16</span><span class="string">gb</span></span><br><span class="line">      <span class="comment"># default-config:           Used when no server-config matches</span></span><br><span class="line">      <span class="comment">#   personality:            List of personalities used by default</span></span><br><span class="line">      <span class="comment">#   request-body-limit:     Limit reassembly of request body for inspection</span></span><br><span class="line">      <span class="comment">#                           by http_client_body &amp; pcre /P option.</span></span><br><span class="line">      <span class="comment">#   response-body-limit:    Limit reassembly of response body for inspection</span></span><br><span class="line">      <span class="comment">#                           by file_data, http_server_body &amp; pcre /Q option.</span></span><br><span class="line">      <span class="comment">#   double-decode-path:     Double decode path section of the URI</span></span><br><span class="line">      <span class="comment">#   double-decode-query:    Double decode query section of the URI</span></span><br><span class="line">      <span class="comment">#   response-body-decompress-layer-limit:</span></span><br><span class="line">      <span class="comment">#                           Limit to how many layers of compression will be</span></span><br><span class="line">      <span class="comment">#                           decompressed. Defaults to 2.</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># server-config:            List of server configurations to use if address matches</span></span><br><span class="line">      <span class="comment">#   address:                List of IP addresses or networks for this block</span></span><br><span class="line">      <span class="comment">#   personalitiy:           List of personalities used by this block</span></span><br><span class="line">      <span class="comment">#   request-body-limit:     Limit reassembly of request body for inspection</span></span><br><span class="line">      <span class="comment">#                           by http_client_body &amp; pcre /P option.</span></span><br><span class="line">      <span class="comment">#   response-body-limit:    Limit reassembly of response body for inspection</span></span><br><span class="line">      <span class="comment">#                           by file_data, http_server_body &amp; pcre /Q option.</span></span><br><span class="line">      <span class="comment">#   double-decode-path:     Double decode path section of the URI</span></span><br><span class="line">      <span class="comment">#   double-decode-query:    Double decode query section of the URI</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment">#   uri-include-all:        Include all parts of the URI. By default the</span></span><br><span class="line">      <span class="comment">#                           'scheme', username/password, hostname and port</span></span><br><span class="line">      <span class="comment">#                           are excluded. Setting this option to true adds</span></span><br><span class="line">      <span class="comment">#                           all of them to the normalized uri as inspected</span></span><br><span class="line">      <span class="comment">#                           by http_uri, urilen, pcre with /U and the other</span></span><br><span class="line">      <span class="comment">#                           keywords that inspect the normalized uri.</span></span><br><span class="line">      <span class="comment">#                           Note that this does not affect http_raw_uri.</span></span><br><span class="line">      <span class="comment">#                           Also, note that including all was the default in</span></span><br><span class="line">      <span class="comment">#                           1.4 and 2.0beta1.</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment">#   meta-field-limit:       Hard size limit for request and response size</span></span><br><span class="line">      <span class="comment">#                           limits. Applies to request line and headers,</span></span><br><span class="line">      <span class="comment">#                           response line and headers. Does not apply to</span></span><br><span class="line">      <span class="comment">#                           request or response bodies. Default is 18k.</span></span><br><span class="line">      <span class="comment">#                           If this limit is reached an event is raised.</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># Currently Available Personalities:</span></span><br><span class="line">      <span class="comment">#   Minimal, Generic, IDS (default), IIS_4_0, IIS_5_0, IIS_5_1, IIS_6_0,</span></span><br><span class="line">      <span class="comment">#   IIS_7_0, IIS_7_5, Apache_2</span></span><br><span class="line"><span class="attr">      libhtp:</span></span><br><span class="line"><span class="attr">         default-config:</span></span><br><span class="line"><span class="attr">           personality:</span> <span class="string">IDS</span></span><br><span class="line">           <span class="comment"># Can be specified in kb, mb, gb.  Just a number indicates</span></span><br><span class="line">           <span class="comment"># it's in bytes.</span></span><br><span class="line"><span class="attr">           request-body-limit:</span> <span class="number">30</span><span class="string">mb</span></span><br><span class="line"><span class="attr">           response-body-limit:</span> <span class="number">30</span><span class="string">mb</span></span><br><span class="line">           <span class="comment"># inspection limits</span></span><br><span class="line"><span class="attr">           request-body-minimal-inspect-size:</span> <span class="number">32</span><span class="string">kb</span></span><br><span class="line"><span class="attr">           request-body-inspect-window:</span> <span class="number">4</span><span class="string">kb</span></span><br><span class="line"><span class="attr">           response-body-minimal-inspect-size:</span> <span class="number">40</span><span class="string">kb</span></span><br><span class="line"><span class="attr">           response-body-inspect-window:</span> <span class="number">16</span><span class="string">kb</span></span><br><span class="line">           <span class="comment"># response body decompression (0 disables)</span></span><br><span class="line"><span class="attr">           response-body-decompress-layer-limit:</span> <span class="number">2</span></span><br><span class="line">           <span class="comment"># auto will use http-body-inline mode in IPS mode, yes or no set it statically</span></span><br><span class="line"><span class="attr">           http-body-inline:</span> <span class="literal">no</span></span><br><span class="line">           <span class="comment"># Decompress SWF files.</span></span><br><span class="line">           <span class="comment"># 2 types: 'deflate', 'lzma', 'both' will decompress deflate and lzma</span></span><br><span class="line">           <span class="comment"># compress-depth:</span></span><br><span class="line">           <span class="comment"># Specifies the maximum amount of data to decompress,</span></span><br><span class="line">           <span class="comment"># set 0 for unlimited.</span></span><br><span class="line">           <span class="comment"># decompress-depth:</span></span><br><span class="line">           <span class="comment"># Specifies the maximum amount of decompressed data to obtain,</span></span><br><span class="line">           <span class="comment"># set 0 for unlimited.</span></span><br><span class="line"><span class="attr">           swf-decompression:</span></span><br><span class="line"><span class="attr">             enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">             type:</span> <span class="string">both</span></span><br><span class="line"><span class="attr">             compress-depth:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">             decompress-depth:</span> <span class="number">0</span></span><br><span class="line">           <span class="comment"># Take a random value for inspection sizes around the specified value.</span></span><br><span class="line">           <span class="comment"># This lower the risk of some evasion technics but could lead</span></span><br><span class="line">           <span class="comment"># detection change between runs. It is set to 'yes' by default.</span></span><br><span class="line">           <span class="comment">#randomize-inspection-sizes: yes</span></span><br><span class="line">           <span class="comment"># If randomize-inspection-sizes is active, the value of various</span></span><br><span class="line">           <span class="comment"># inspection size will be choosen in the [1 - range%, 1 + range%]</span></span><br><span class="line">           <span class="comment"># range</span></span><br><span class="line">           <span class="comment"># Default value of randomize-inspection-range is 10.</span></span><br><span class="line">           <span class="comment">#randomize-inspection-range: 10</span></span><br><span class="line">           <span class="comment"># decoding</span></span><br><span class="line"><span class="attr">           double-decode-path:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">           double-decode-query:</span> <span class="literal">no</span></span><br><span class="line">           <span class="comment">#lzma-enabled: yes</span></span><br><span class="line">           <span class="comment"># LZMA decompression memory limit.</span></span><br><span class="line">           <span class="comment">#lzma-memlimit: 1 Mb</span></span><br><span class="line">           <span class="comment"># Compression bomb output limit.</span></span><br><span class="line">           <span class="comment">#compression-bomb-limit: 1 Mb</span></span><br><span class="line"><span class="attr">         server-config:</span></span><br><span class="line">           <span class="comment">#- apache:</span></span><br><span class="line">           <span class="comment">#    address: [192.168.1.0/24, 127.0.0.0/8, "::1"]</span></span><br><span class="line">           <span class="comment">#    personality: Apache_2</span></span><br><span class="line">           <span class="comment">#    # Can be specified in kb, mb, gb.  Just a number indicates</span></span><br><span class="line">           <span class="comment">#    # it's in bytes.</span></span><br><span class="line">           <span class="comment">#    request-body-limit: 4096</span></span><br><span class="line">           <span class="comment">#    response-body-limit: 4096</span></span><br><span class="line">           <span class="comment">#    double-decode-path: no</span></span><br><span class="line">           <span class="comment">#    double-decode-query: no</span></span><br><span class="line">           <span class="comment">#- iis7:</span></span><br><span class="line">           <span class="comment">#    address:</span></span><br><span class="line">           <span class="comment">#      - 192.168.0.0/24</span></span><br><span class="line">           <span class="comment">#      - 192.168.10.0/24</span></span><br><span class="line">           <span class="comment">#    personality: IIS_7_0</span></span><br><span class="line">           <span class="comment">#    # Can be specified in kb, mb, gb.  Just a number indicates</span></span><br><span class="line">           <span class="comment">#    # it's in bytes.</span></span><br><span class="line">           <span class="comment">#    request-body-limit: 4096</span></span><br><span class="line">           <span class="comment">#    response-body-limit: 4096</span></span><br><span class="line">           <span class="comment">#    double-decode-path: no</span></span><br><span class="line">           <span class="comment">#    double-decode-query: no</span></span><br><span class="line">    <span class="comment"># Note: Modbus probe parser is minimalist due to the poor significant field</span></span><br><span class="line">    <span class="comment"># Only Modbus message length (greater than Modbus header length)</span></span><br><span class="line">    <span class="comment"># And Protocol ID (equal to 0) are checked in probing parser</span></span><br><span class="line">    <span class="comment"># It is important to enable detection port and define Modbus port</span></span><br><span class="line">    <span class="comment"># to avoid false positive</span></span><br><span class="line"><span class="attr">    modbus:</span></span><br><span class="line">      <span class="comment"># How many unreplied Modbus requests are considered a flood.</span></span><br><span class="line">      <span class="comment"># If the limit is reached, app-layer-event:modbus.flooded; will match.</span></span><br><span class="line">      <span class="comment">#request-flood: 500</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      detection-ports:</span></span><br><span class="line"><span class="attr">        dp:</span> <span class="number">502</span></span><br><span class="line">      <span class="comment"># According to MODBUS Messaging on TCP/IP Implementation Guide V1.0b, it</span></span><br><span class="line">      <span class="comment"># is recommended to keep the TCP connection opened with a remote device</span></span><br><span class="line">      <span class="comment"># and not to open and close it for each MODBUS/TCP transaction. In that</span></span><br><span class="line">      <span class="comment"># case, it is important to set the depth of the stream reassembling as</span></span><br><span class="line">      <span class="comment"># unlimited (stream.reassembly.depth: 0)</span></span><br><span class="line">      <span class="comment"># Stream reassembly size for modbus. By default track it completely.</span></span><br><span class="line"><span class="attr">      stream-depth:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># DNP3</span></span><br><span class="line"><span class="attr">    dnp3:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      detection-ports:</span></span><br><span class="line"><span class="attr">        dp:</span> <span class="number">20000</span></span><br><span class="line">    <span class="comment"># SCADA EtherNet/IP and CIP protocol support</span></span><br><span class="line"><span class="attr">    enip:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      detection-ports:</span></span><br><span class="line"><span class="attr">        dp:</span> <span class="number">44818</span></span><br><span class="line"><span class="attr">        sp:</span> <span class="number">44818</span></span><br><span class="line"><span class="attr">    ntp:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    dhcp:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line">    <span class="comment"># SIP, disabled by default.</span></span><br><span class="line"><span class="attr">    sip:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">asn1-max-frames:</span> <span class="number">256</span></span><br><span class="line"><span class="attr">coredump:</span></span><br><span class="line"><span class="attr">  max-dump:</span> <span class="string">unlimited</span></span><br><span class="line"><span class="attr">host-mode:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">max-pending-packets:</span> <span class="number">8192</span></span><br><span class="line"><span class="attr">runmode:</span> <span class="string">workers</span></span><br><span class="line"><span class="attr">default-packet-size:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">unix-command:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="string">auto</span></span><br><span class="line">  <span class="comment">#filename: custom.socket</span></span><br><span class="line"><span class="attr">legacy:</span></span><br><span class="line"><span class="attr">  uricontent:</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">engine-analysis:</span></span><br><span class="line">  <span class="comment"># enables printing reports for fast-pattern for every rule.</span></span><br><span class="line"><span class="attr">  rules-fast-pattern:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="comment"># enables printing reports for each rule</span></span><br><span class="line"><span class="attr">  rules:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">pcre:</span></span><br><span class="line"><span class="attr">  match-limit:</span> <span class="number">3500</span></span><br><span class="line"><span class="attr">  match-limit-recursion:</span> <span class="number">1500</span></span><br><span class="line"><span class="attr">host-os-policy:</span></span><br><span class="line">  <span class="comment"># Make the default policy windows.</span></span><br><span class="line"><span class="attr">  windows:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  bsd:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  bsd-right:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  old-linux:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  linux:</span> <span class="string">[0.0.0.0/0]</span></span><br><span class="line"><span class="attr">  old-solaris:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  solaris:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  hpux10:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  hpux11:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  irix:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  macos:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  vista:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  windows2k3:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">defrag:</span></span><br><span class="line"><span class="attr">  memcap:</span> <span class="number">16</span><span class="string">gb</span></span><br><span class="line"><span class="attr">  hash-size:</span> <span class="number">65536</span></span><br><span class="line"><span class="attr">  trackers:</span> <span class="number">65535</span> <span class="comment"># number of defragmented flows to follow</span></span><br><span class="line"><span class="attr">  max-frags:</span> <span class="number">65535</span> <span class="comment"># number of fragments to keep (higher than trackers)</span></span><br><span class="line"><span class="attr">  prealloc:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  timeout:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">flow:</span></span><br><span class="line"><span class="attr">  memcap:</span> <span class="number">8</span><span class="string">gb</span></span><br><span class="line"><span class="attr">  hash-size:</span> <span class="number">1048576</span></span><br><span class="line"><span class="attr">  prealloc:</span> <span class="number">1048576</span></span><br><span class="line"><span class="attr">  emergency-recovery:</span> <span class="number">30</span></span><br><span class="line">  <span class="comment">#managers: 1 # default to one flow manager</span></span><br><span class="line">  <span class="comment">#recyclers: 1 # default to one flow recycler thread</span></span><br><span class="line"><span class="attr">vlan:</span></span><br><span class="line"><span class="attr">  use-for-tracking:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">flow-timeouts:</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    new:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    established:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">    closed:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    bypassed:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">    emergency-new:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">    emergency-established:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">    emergency-closed:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    emergency-bypassed:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">  tcp:</span></span><br><span class="line"><span class="attr">    new:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    established:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">    closed:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    bypassed:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">    emergency-new:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">    emergency-established:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">    emergency-closed:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    emergency-bypassed:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">  udp:</span></span><br><span class="line"><span class="attr">    new:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    established:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">    bypassed:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">    emergency-new:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">    emergency-established:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">    emergency-bypassed:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">  icmp:</span></span><br><span class="line"><span class="attr">    new:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    established:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">    bypassed:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">    emergency-new:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">    emergency-established:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">    emergency-bypassed:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">stream:</span></span><br><span class="line"><span class="attr">  memcap:</span> <span class="number">16</span><span class="string">gb</span></span><br><span class="line"><span class="attr">  checksum-validation:</span> <span class="literal">no</span>      <span class="comment"># reject wrong csums</span></span><br><span class="line"><span class="attr">  inline:</span> <span class="literal">no</span>                  <span class="comment"># auto will use inline mode in IPS mode, yes or no set it statically</span></span><br><span class="line"><span class="attr">  bypass:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  midstream:</span> <span class="literal">true</span>    <span class="comment"># 若flow中存在被截断的数据包, 可保证截断之前的数据包正常被解析</span></span><br><span class="line"><span class="attr">  reassembly:</span></span><br><span class="line"><span class="attr">    memcap:</span> <span class="number">32</span><span class="string">gb</span></span><br><span class="line"><span class="attr">    depth:</span> <span class="number">10</span><span class="string">mb</span>                  <span class="comment"># reassemble 1mb into a stream</span></span><br><span class="line"><span class="attr">    toserver-chunk-size:</span> <span class="number">2560</span></span><br><span class="line"><span class="attr">    toclient-chunk-size:</span> <span class="number">2560</span></span><br><span class="line"><span class="attr">    randomize-chunk-size:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="comment">#randomize-chunk-range: 10</span></span><br><span class="line">    <span class="comment">#raw: yes</span></span><br><span class="line">    <span class="comment">#segment-prealloc: 2048</span></span><br><span class="line">    <span class="comment">#check-overlap-different-data: true</span></span><br><span class="line"><span class="attr">host:</span></span><br><span class="line"><span class="attr">  hash-size:</span> <span class="number">4096</span></span><br><span class="line"><span class="attr">  prealloc:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">  memcap:</span> <span class="number">32</span><span class="string">mb</span></span><br><span class="line"><span class="attr">decoder:</span></span><br><span class="line">  <span class="comment"># Teredo decoder is known to not be completely accurate</span></span><br><span class="line">  <span class="comment"># as it will sometimes detect non-teredo as teredo.</span></span><br><span class="line"><span class="attr">  teredo:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># VXLAN decoder is assigned to up to 4 UDP ports. By default only the</span></span><br><span class="line">  <span class="comment"># IANA assigned port 4789 is enabled.</span></span><br><span class="line"><span class="attr">  vxlan:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    ports:</span> <span class="string">$VXLAN_PORTS</span> <span class="comment"># syntax: '8472, 4789'</span></span><br><span class="line"><span class="attr">detect:</span></span><br><span class="line"><span class="attr">  profile:</span> <span class="string">custom</span></span><br><span class="line"><span class="attr">  custom-values:</span></span><br><span class="line"><span class="attr">    toclient-groups:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">    toserver-groups:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  sgh-mpm-context:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">  inspection-recursion-limit:</span> <span class="number">3000</span></span><br><span class="line">  <span class="comment"># If set to yes, the loading of signatures will be made after the capture</span></span><br><span class="line">  <span class="comment"># is started. This will limit the downtime in IPS mode.</span></span><br><span class="line">  <span class="comment">#delayed-detect: yes</span></span><br><span class="line"><span class="attr">  prefilter:</span></span><br><span class="line">    <span class="comment"># default prefiltering setting. "mpm" only creates MPM/fast_pattern</span></span><br><span class="line">    <span class="comment"># engines. "auto" also sets up prefilter engines for other keywords.</span></span><br><span class="line">    <span class="comment"># Use --list-keywords=all to see which keywords support prefiltering.</span></span><br><span class="line"><span class="attr">    default:</span> <span class="string">mpm</span></span><br><span class="line">  <span class="comment"># the grouping values above control how many groups are created per</span></span><br><span class="line">  <span class="comment"># direction. Port whitelisting forces that port to get it's own group.</span></span><br><span class="line">  <span class="comment"># Very common ports will benefit, as well as ports with many expensive</span></span><br><span class="line">  <span class="comment"># rules.</span></span><br><span class="line"><span class="attr">  grouping:</span></span><br><span class="line">    <span class="comment">#tcp-whitelist: 53, 80, 139, 443, 445, 1433, 3306, 3389, 6666, 6667, 8080</span></span><br><span class="line">    <span class="comment">#udp-whitelist: 53, 135, 5060</span></span><br><span class="line"><span class="attr">  profiling:</span></span><br><span class="line">    <span class="comment"># Log the rules that made it past the prefilter stage, per packet</span></span><br><span class="line">    <span class="comment"># default is off. The threshold setting determines how many rules</span></span><br><span class="line">    <span class="comment"># must have made it past pre-filter for that rule to trigger the</span></span><br><span class="line">    <span class="comment"># logging.</span></span><br><span class="line">    <span class="comment">#inspect-logging-threshold: 200</span></span><br><span class="line"><span class="attr">    grouping:</span></span><br><span class="line"><span class="attr">      dump-to-disk:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      include-rules:</span> <span class="literal">false</span>      <span class="comment"># very verbose</span></span><br><span class="line"><span class="attr">      include-mpm-stats:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">mpm-algo:</span> <span class="string">hs</span></span><br><span class="line"><span class="attr">spm-algo:</span> <span class="string">hs</span></span><br><span class="line"><span class="attr">threading:</span></span><br><span class="line"><span class="attr">  set-cpu-affinity:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="comment"># Tune cpu affinity of threads. Each family of threads can be bound</span></span><br><span class="line">  <span class="comment"># on specific CPUs.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># These 2 apply to the all runmodes:</span></span><br><span class="line">  <span class="comment"># management-cpu-set is used for flow timeout handling, counters</span></span><br><span class="line">  <span class="comment"># worker-cpu-set is used for 'worker' threads</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Additionally, for autofp these apply:</span></span><br><span class="line">  <span class="comment"># receive-cpu-set is used for capture threads</span></span><br><span class="line">  <span class="comment"># verdict-cpu-set is used for IPS verdict threads</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"><span class="attr">  cpu-affinity:</span></span><br><span class="line"><span class="attr">    - management-cpu-set:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="string">[</span> <span class="string">"0-1"</span> <span class="string">]</span>  <span class="comment"># include only these CPUs in affinity settings</span></span><br><span class="line"><span class="attr">        mode:</span> <span class="string">"balanced"</span></span><br><span class="line"><span class="attr">        prio:</span></span><br><span class="line"><span class="attr">          default:</span> <span class="string">"medium"</span></span><br><span class="line"><span class="attr">    - worker-cpu-set:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="string">[</span> <span class="string">"2-35"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">        mode:</span> <span class="string">"exclusive"</span></span><br><span class="line"><span class="attr">        prio:</span></span><br><span class="line"><span class="attr">          default:</span> <span class="string">"high"</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># By default Suricata creates one "detect" thread per available CPU/CPU core.</span></span><br><span class="line">  <span class="comment"># This setting allows controlling this behaviour. A ratio setting of 2 will</span></span><br><span class="line">  <span class="comment"># create 2 detect threads for each CPU/CPU core. So for a dual core CPU this</span></span><br><span class="line">  <span class="comment"># will result in 4 detect threads. If values below 1 are used, less threads</span></span><br><span class="line">  <span class="comment"># are created. So on a dual core CPU a setting of 0.5 results in 1 detect</span></span><br><span class="line">  <span class="comment"># thread being created. Regardless of the setting at a minimum 1 detect</span></span><br><span class="line">  <span class="comment"># thread will always be created.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"><span class="attr">  detect-thread-ratio:</span> <span class="number">1.0</span></span><br><span class="line"><span class="attr">luajit:</span></span><br><span class="line"><span class="attr">  states:</span> <span class="number">128</span></span><br><span class="line"><span class="attr">profiling:</span></span><br><span class="line">  <span class="comment"># Run profiling for every xth packet. The default is 1, which means we</span></span><br><span class="line">  <span class="comment"># profile every packet. If set to 1000, one packet is profiled for every</span></span><br><span class="line">  <span class="comment"># 1000 received.</span></span><br><span class="line">  <span class="comment">#sample-rate: 1000</span></span><br><span class="line">  <span class="comment"># rule profiling</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line">    <span class="comment"># Profiling can be disabled here, but it will still have a</span></span><br><span class="line">    <span class="comment"># performance impact if compiled in.</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    filename:</span> <span class="string">rule_perf.log</span></span><br><span class="line"><span class="attr">    append:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="comment"># Sort options: ticks, avgticks, checks, matches, maxticks</span></span><br><span class="line">    <span class="comment"># If commented out all the sort options will be used.</span></span><br><span class="line">    <span class="comment">#sort: avgticks</span></span><br><span class="line">    <span class="comment"># Limit the number of sids for which stats are shown at exit (per sort).</span></span><br><span class="line"><span class="attr">    limit:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># output to json</span></span><br><span class="line"><span class="attr">    json:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="comment"># per keyword profiling</span></span><br><span class="line"><span class="attr">  keywords:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    filename:</span> <span class="string">keyword_perf.log</span></span><br><span class="line"><span class="attr">    append:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  prefilter:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    filename:</span> <span class="string">prefilter_perf.log</span></span><br><span class="line"><span class="attr">    append:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="comment"># per rulegroup profiling</span></span><br><span class="line"><span class="attr">  rulegroups:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    filename:</span> <span class="string">rule_group_perf.log</span></span><br><span class="line"><span class="attr">    append:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="comment"># packet profiling</span></span><br><span class="line"><span class="attr">  packets:</span></span><br><span class="line">    <span class="comment"># Profiling can be disabled here, but it will still have a</span></span><br><span class="line">    <span class="comment"># performance impact if compiled in.</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    filename:</span> <span class="string">packet_stats.log</span></span><br><span class="line"><span class="attr">    append:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="comment"># per packet csv output</span></span><br><span class="line"><span class="attr">    csv:</span></span><br><span class="line">      <span class="comment"># Output can be disabled here, but it will still have a</span></span><br><span class="line">      <span class="comment"># performance impact if compiled in.</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">      filename:</span> <span class="string">packet_stats.csv</span></span><br><span class="line">  <span class="comment"># profiling of locking. Only available when Suricata was built with</span></span><br><span class="line">  <span class="comment"># --enable-profiling-locks.</span></span><br><span class="line"><span class="attr">  locks:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    filename:</span> <span class="string">lock_stats.log</span></span><br><span class="line"><span class="attr">    append:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  pcap-log:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">    filename:</span> <span class="string">pcaplog_stats.log</span></span><br><span class="line"><span class="attr">    append:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">nfq:</span></span><br><span class="line"><span class="attr">nflog:</span></span><br><span class="line">    <span class="comment"># netlink multicast group</span></span><br><span class="line">    <span class="comment"># (the same as the iptables --nflog-group param)</span></span><br><span class="line">    <span class="comment"># Group 0 is used by the kernel, so you can't use it</span></span><br><span class="line"><span class="attr">  - group:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment"># netlink buffer size</span></span><br><span class="line"><span class="attr">    buffer-size:</span> <span class="number">18432</span></span><br><span class="line">    <span class="comment"># put default value here</span></span><br><span class="line"><span class="attr">  - group:</span> <span class="string">default</span></span><br><span class="line">    <span class="comment"># set number of packet to queue inside kernel</span></span><br><span class="line"><span class="attr">    qthreshold:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># set the delay before flushing packet in the queue inside kernel</span></span><br><span class="line"><span class="attr">    qtimeout:</span> <span class="number">100</span></span><br><span class="line">    <span class="comment"># netlink max buffer size</span></span><br><span class="line"><span class="attr">    max-size:</span> <span class="number">20000</span></span><br><span class="line"><span class="attr">capture:</span></span><br><span class="line">  <span class="comment"># disable NIC offloading. It's restored when Suricata exits.</span></span><br><span class="line">  <span class="comment"># Enabled by default.</span></span><br><span class="line">  <span class="comment">#disable-offloading: false</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># disable checksum validation. Same as setting '-k none' on the</span></span><br><span class="line">  <span class="comment"># commandline.</span></span><br><span class="line">  <span class="comment">#checksum-validation: none</span></span><br><span class="line"><span class="attr">netmap:</span></span><br><span class="line">   <span class="comment"># To specify OS endpoint add plus sign at the end (e.g. "eth0+")</span></span><br><span class="line"><span class="attr"> - interface:</span> <span class="string">eth2</span></span><br><span class="line">   <span class="comment"># Number of capture threads. "auto" uses number of RSS queues on interface.</span></span><br><span class="line">   <span class="comment"># Warning: unless the RSS hashing is symmetrical, this will lead to</span></span><br><span class="line">   <span class="comment"># accuracy issues.</span></span><br><span class="line">   <span class="comment">#threads: auto</span></span><br><span class="line">   <span class="comment"># You can use the following variables to activate netmap tap or IPS mode.</span></span><br><span class="line">   <span class="comment"># If copy-mode is set to ips or tap, the traffic coming to the current</span></span><br><span class="line">   <span class="comment"># interface will be copied to the copy-iface interface. If 'tap' is set, the</span></span><br><span class="line">   <span class="comment"># copy is complete. If 'ips' is set, the packet matching a 'drop' action</span></span><br><span class="line">   <span class="comment"># will not be copied.</span></span><br><span class="line">   <span class="comment"># To specify the OS as the copy-iface (so the OS can route packets, or forward</span></span><br><span class="line">   <span class="comment"># to a service running on the same machine) add a plus sign at the end</span></span><br><span class="line">   <span class="comment"># (e.g. "copy-iface: eth0+"). Don't forget to set up a symmetrical eth0+ -&gt; eth0</span></span><br><span class="line">   <span class="comment"># for return packets. Hardware checksumming must be *off* on the interface if</span></span><br><span class="line">   <span class="comment"># using an OS endpoint (e.g. 'ifconfig eth0 -rxcsum -txcsum -rxcsum6 -txcsum6' for FreeBSD</span></span><br><span class="line">   <span class="comment"># or 'ethtool -K eth0 tx off rx off' for Linux).</span></span><br><span class="line">   <span class="comment">#copy-mode: tap</span></span><br><span class="line">   <span class="comment">#copy-iface: eth3</span></span><br><span class="line">   <span class="comment"># Set to yes to disable promiscuous mode</span></span><br><span class="line">   <span class="comment"># disable-promisc: no</span></span><br><span class="line">   <span class="comment"># Choose checksum verification mode for the interface. At the moment</span></span><br><span class="line">   <span class="comment"># of the capture, some packets may be with an invalid checksum due to</span></span><br><span class="line">   <span class="comment"># offloading to the network card of the checksum computation.</span></span><br><span class="line">   <span class="comment"># Possible values are:</span></span><br><span class="line">   <span class="comment">#  - yes: checksum validation is forced</span></span><br><span class="line">   <span class="comment">#  - no: checksum validation is disabled</span></span><br><span class="line">   <span class="comment">#  - auto: Suricata uses a statistical approach to detect when</span></span><br><span class="line">   <span class="comment">#  checksum off-loading is used.</span></span><br><span class="line">   <span class="comment"># Warning: 'checksum-validation' must be set to yes to have any validation</span></span><br><span class="line">   <span class="comment">#checksum-checks: auto</span></span><br><span class="line">   <span class="comment"># BPF filter to apply to this interface. The pcap filter syntax apply here.</span></span><br><span class="line">   <span class="comment">#bpf-filter: port 80 or udp</span></span><br><span class="line"> <span class="comment">#- interface: eth3</span></span><br><span class="line">   <span class="comment">#threads: auto</span></span><br><span class="line">   <span class="comment">#copy-mode: tap</span></span><br><span class="line">   <span class="comment">#copy-iface: eth2</span></span><br><span class="line">   <span class="comment"># Put default values here</span></span><br><span class="line"><span class="attr"> - interface:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">pfring:</span></span><br><span class="line"><span class="attr">  - interface:</span> <span class="string">ens4</span></span><br><span class="line">    <span class="comment"># Number of receive threads. If set to 'auto' Suricata will first try</span></span><br><span class="line">    <span class="comment"># to use CPU (core) count and otherwise RSS queue count.</span></span><br><span class="line"><span class="attr">    threads:</span> <span class="string">auto</span></span><br><span class="line">    <span class="comment"># Default clusterid.  PF_RING will load balance packets based on flow.</span></span><br><span class="line">    <span class="comment"># All threads/processes that will participate need to have the same</span></span><br><span class="line">    <span class="comment"># clusterid.</span></span><br><span class="line"><span class="attr">    cluster-id:</span> <span class="number">99</span></span><br><span class="line">    <span class="comment"># Default PF_RING cluster type. PF_RING can load balance per flow.</span></span><br><span class="line">    <span class="comment"># Possible values are cluster_flow or cluster_round_robin.</span></span><br><span class="line"><span class="attr">    cluster-type:</span> <span class="string">cluster_flow</span></span><br><span class="line">    <span class="comment"># bpf filter for this interface</span></span><br><span class="line">    <span class="comment">#bpf-filter: tcp</span></span><br><span class="line">    <span class="comment"># If bypass is set then the PF_RING hw bypass is activated, when supported</span></span><br><span class="line">    <span class="comment"># by the interface in use. Suricata will instruct the interface to bypass</span></span><br><span class="line">    <span class="comment"># all future packets for a flow that need to be bypassed.</span></span><br><span class="line"><span class="attr">    bypass:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="comment"># Choose checksum verification mode for the interface. At the moment</span></span><br><span class="line">    <span class="comment"># of the capture, some packets may be with an invalid checksum due to</span></span><br><span class="line">    <span class="comment"># offloading to the network card of the checksum computation.</span></span><br><span class="line">    <span class="comment"># Possible values are:</span></span><br><span class="line">    <span class="comment">#  - rxonly: only compute checksum for packets received by network card.</span></span><br><span class="line">    <span class="comment">#  - yes: checksum validation is forced</span></span><br><span class="line">    <span class="comment">#  - no: checksum validation is disabled</span></span><br><span class="line">    <span class="comment">#  - auto: Suricata uses a statistical approach to detect when</span></span><br><span class="line">    <span class="comment">#  checksum off-loading is used. (default)</span></span><br><span class="line">    <span class="comment"># Warning: 'checksum-validation' must be set to yes to have any validation</span></span><br><span class="line">    <span class="comment">#checksum-checks: auto</span></span><br><span class="line">  <span class="comment"># Second interface</span></span><br><span class="line">  <span class="comment">#- interface: eth1</span></span><br><span class="line">  <span class="comment">#  threads: 3</span></span><br><span class="line">  <span class="comment">#  cluster-id: 93</span></span><br><span class="line">  <span class="comment">#  cluster-type: cluster_flow</span></span><br><span class="line">  <span class="comment"># Put default values here</span></span><br><span class="line"><span class="attr">  - interface:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    threads:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">ipfw:</span></span><br><span class="line">  <span class="comment"># Reinject packets at the specified ipfw rule number.  This config</span></span><br><span class="line">  <span class="comment"># option is the ipfw rule number AT WHICH rule processing continues</span></span><br><span class="line">  <span class="comment"># in the ipfw processing system after the engine has finished</span></span><br><span class="line">  <span class="comment"># inspecting the packet for acceptance.  If no rule number is specified,</span></span><br><span class="line">  <span class="comment"># accepted packets are reinjected at the divert rule which they entered</span></span><br><span class="line">  <span class="comment"># and IPFW rule processing continues.  No check is done to verify</span></span><br><span class="line">  <span class="comment"># this will rule makes sense so care must be taken to avoid loops in ipfw.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">## The following example tells the engine to reinject packets</span></span><br><span class="line">  <span class="comment"># back into the ipfw firewall AT rule number 5500:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># ipfw-reinjection-rule-number: 5500</span></span><br><span class="line"><span class="attr">napatech:</span></span><br><span class="line">    <span class="comment"># The Host Buffer Allowance for all streams</span></span><br><span class="line">    <span class="comment"># (-1 = OFF, 1 - 100 = percentage of the host buffer that can be held back)</span></span><br><span class="line">    <span class="comment"># This may be enabled when sharing streams with another application.</span></span><br><span class="line">    <span class="comment"># Otherwise, it should be turned off.</span></span><br><span class="line">    <span class="comment">#hba: -1</span></span><br><span class="line">    <span class="comment"># When use_all_streams is set to "yes" the initialization code will query</span></span><br><span class="line">    <span class="comment"># the Napatech service for all configured streams and listen on all of them.</span></span><br><span class="line">    <span class="comment"># When set to "no" the streams config array will be used.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># This option necessitates running the appropriate NTPL commands to create</span></span><br><span class="line">    <span class="comment"># the desired streams prior to running suricata.</span></span><br><span class="line">    <span class="comment">#use-all-streams: no</span></span><br><span class="line">    <span class="comment"># The streams to listen on when auto-config is disabled or when and threading</span></span><br><span class="line">    <span class="comment"># cpu-affinity is disabled.  This can be either:</span></span><br><span class="line">    <span class="comment">#   an individual stream (e.g. streams: [0])</span></span><br><span class="line">    <span class="comment"># or</span></span><br><span class="line">    <span class="comment">#   a range of streams (e.g. streams: ["0-3"])</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"><span class="attr">    streams:</span> <span class="string">["0-3"]</span></span><br><span class="line">    <span class="comment"># When auto-config is enabled the streams will be created and assigned</span></span><br><span class="line">    <span class="comment"># automatically to the NUMA node where the thread resides.  If cpu-affinity</span></span><br><span class="line">    <span class="comment"># is enabled in the threading section.  Then the streams will be created</span></span><br><span class="line">    <span class="comment"># according to the number of worker threads specified in the worker cpu set.</span></span><br><span class="line">    <span class="comment"># Otherwise, the streams array is used to define the streams.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># This option cannot be used simultaneous with "use-all-streams".</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"><span class="attr">    auto-config:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="comment"># Ports indicates which napatech ports are to be used in auto-config mode.</span></span><br><span class="line">    <span class="comment"># these are the port ID's of the ports that will be merged prior to the</span></span><br><span class="line">    <span class="comment"># traffic being distributed to the streams.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># This can be specified in any of the following ways:</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#   a list of individual ports (e.g. ports: [0,1,2,3])</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#   a range of ports (e.g. ports: [0-3])</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#   "all" to indicate that all ports are to be merged together</span></span><br><span class="line">    <span class="comment">#   (e.g. ports: [all])</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># This has no effect if auto-config is disabled.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"><span class="attr">    ports:</span> <span class="string">[all]</span></span><br><span class="line">    <span class="comment"># When auto-config is enabled the hashmode specifies the algorithm for</span></span><br><span class="line">    <span class="comment"># determining to which stream a given packet is to be delivered.</span></span><br><span class="line">    <span class="comment"># This can be any valid Napatech NTPL hashmode command.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># The most common hashmode commands are:  hash2tuple, hash2tuplesorted,</span></span><br><span class="line">    <span class="comment"># hash5tuple, hash5tuplesorted and roundrobin.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># See Napatech NTPL documentation other hashmodes and details on their use.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># This has no effect if auto-config is disabled.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line"><span class="attr">    hashmode:</span> <span class="string">hash5tuplesorted</span></span><br><span class="line"><span class="attr">classification-file:</span> <span class="string">/etc/suricata/classification.config</span></span><br><span class="line"><span class="attr">reference-config-file:</span> <span class="string">/etc/suricata/reference.config</span></span><br><span class="line"><span class="attr">threshold-file:</span> <span class="string">/etc/suricata/threshold.config</span></span><br><span class="line"><span class="attr">include:</span> <span class="string">rule-files.yaml</span></span><br></pre></td></tr></table></figure>

<p><strong><em>修改配置文件后不重启程序重新加载</em></strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo <span class="built_in">kill</span> -USR2 pid</span><br></pre></td></tr></table></figure>

<h2 id="设置CPU亲和"><a href="#设置CPU亲和" class="headerlink" title="设置CPU亲和"></a>设置CPU亲和</h2><p><strong>set_irq_affinity.sh</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat set_irq_affinity.sh</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># setting up irq affinity according to /proc/interrupts</span></span><br><span class="line"><span class="comment"># 2008-11-25 Robert Olsson</span></span><br><span class="line"><span class="comment"># 2009-02-19 updated by Jesse Brandeburg</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># &gt; Dave Miller:</span></span><br><span class="line"><span class="comment"># (To get consistent naming in /proc/interrups)</span></span><br><span class="line"><span class="comment"># I would suggest that people use something like:</span></span><br><span class="line"><span class="comment">#       char buf[IFNAMSIZ+6];</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#       sprintf(buf, "%s-%s-%d",</span></span><br><span class="line"><span class="comment">#               netdev-&gt;name,</span></span><br><span class="line"><span class="comment">#               (RX_INTERRUPT ? "rx" : "tx"),</span></span><br><span class="line"><span class="comment">#               queue-&gt;index);</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Assuming a device with two RX and TX queues.</span></span><br><span class="line"><span class="comment">#  This script will assign:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#       eth0-rx-0  CPU0</span></span><br><span class="line"><span class="comment">#       eth0-rx-1  CPU1</span></span><br><span class="line"><span class="comment">#       eth0-tx-0  CPU0</span></span><br><span class="line"><span class="comment">#       eth0-tx-1  CPU1</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"> </span><br><span class="line">set_affinity()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$VEC</span> -ge 32 ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">                MASK_FILL=<span class="string">""</span></span><br><span class="line">                MASK_ZERO=<span class="string">"00000000"</span></span><br><span class="line">                <span class="built_in">let</span> <span class="string">"IDX = <span class="variable">$VEC</span> / 32"</span></span><br><span class="line">                <span class="keyword">for</span> ((i=1; i&lt;=<span class="variable">$IDX</span>;i++))</span><br><span class="line">                <span class="keyword">do</span></span><br><span class="line">                        MASK_FILL=<span class="string">"<span class="variable">$&#123;MASK_FILL&#125;</span>,<span class="variable">$&#123;MASK_ZERO&#125;</span>"</span></span><br><span class="line">                <span class="keyword">done</span></span><br><span class="line"> </span><br><span class="line">                <span class="built_in">let</span> <span class="string">"VEC -= 32 * <span class="variable">$IDX</span>"</span></span><br><span class="line">                MASK_TMP=$((1&lt;&lt;<span class="variable">$VEC</span>))</span><br><span class="line">                MASK=`<span class="built_in">printf</span> <span class="string">"%X%s"</span> <span class="variable">$MASK_TMP</span> <span class="variable">$MASK_FILL</span>`</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                MASK_TMP=$((1&lt;&lt;(`expr <span class="variable">$VEC</span> + <span class="variable">$CORE</span>`)))</span><br><span class="line">                MASK=`<span class="built_in">printf</span> <span class="string">"%X"</span> <span class="variable">$MASK_TMP</span>`</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"%s mask=%s for /proc/irq/%d/smp_affinity\n"</span> <span class="variable">$DEV</span> <span class="variable">$MASK</span> <span class="variable">$IRQ</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"%s"</span> <span class="variable">$MASK</span> &gt; /proc/irq/<span class="variable">$IRQ</span>/smp_affinity</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -ne 2 ] ; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Description:"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"    This script attempts to bind each queue of a multi-queue NIC"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"    to the same numbered core, ie tx0|rx0 --&gt; cpu0, tx1|rx1 --&gt; cpu1"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"usage:"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"    <span class="variable">$0</span> core eth0 [eth1 eth2 eth3]"</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line">CORE=<span class="variable">$1</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># check for irqbalance running</span></span><br><span class="line">IRQBALANCE_ON=`ps ax | grep -v grep | grep -q irqbalance; <span class="built_in">echo</span> $?`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$IRQBALANCE_ON</span>"</span> == <span class="string">"0"</span> ] ; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">" WARNING: irqbalance is running and will"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"          likely override this script's affinitization."</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"          Please stop the irqbalance service and/or execute"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"          'killall irqbalance'"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set up the desired devices.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">shift</span> 1</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> DEV <span class="keyword">in</span> $*</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">for</span> DIR <span class="keyword">in</span> rx tx TxRx</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">     MAX=`grep <span class="variable">$DEV</span>-<span class="variable">$DIR</span> /proc/interrupts | wc -l`</span><br><span class="line">     <span class="keyword">if</span> [ <span class="string">"<span class="variable">$MAX</span>"</span> == <span class="string">"0"</span> ] ; <span class="keyword">then</span></span><br><span class="line">       MAX=`egrep -i <span class="string">"<span class="variable">$DEV</span>:.*<span class="variable">$DIR</span>"</span> /proc/interrupts | wc -l`</span><br><span class="line">     <span class="keyword">fi</span></span><br><span class="line">     <span class="keyword">if</span> [ <span class="string">"<span class="variable">$MAX</span>"</span> == <span class="string">"0"</span> ] ; <span class="keyword">then</span></span><br><span class="line">       <span class="built_in">echo</span> no <span class="variable">$DIR</span> vectors found on <span class="variable">$DEV</span></span><br><span class="line">       <span class="built_in">continue</span></span><br><span class="line">     <span class="keyword">fi</span></span><br><span class="line">     <span class="keyword">for</span> VEC <span class="keyword">in</span> `seq 0 1 <span class="variable">$MAX</span>`</span><br><span class="line">     <span class="keyword">do</span></span><br><span class="line">        IRQ=`cat /proc/interrupts | grep -i <span class="variable">$DEV</span>-<span class="variable">$DIR</span>-<span class="variable">$VEC</span><span class="string">"$"</span>  | cut  -d:  -f1 | sed <span class="string">"s/ //g"</span>`</span><br><span class="line">        <span class="keyword">if</span> [ -n  <span class="string">"<span class="variable">$IRQ</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">          set_affinity</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">           IRQ=`cat /proc/interrupts | egrep -i <span class="variable">$DEV</span>:v<span class="variable">$VEC</span>-<span class="variable">$DIR</span><span class="string">"$"</span>  | cut  -d:  -f1 | sed <span class="string">"s/ //g"</span>`</span><br><span class="line">           <span class="keyword">if</span> [ -n  <span class="string">"<span class="variable">$IRQ</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">             set_affinity</span><br><span class="line">           <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">     <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>脚本参数是： <strong><em>set_irq_affinity.sh core eth0 [eth1 eth2 eth3]</em></strong></p>
<p>可以一次设置多个网卡，core的意思是从这个号开始递增。</p>
<p><strong>示例:</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#./set_irq_affinity.sh 0 em1</span></span><br><span class="line">no rx vectors found on em1</span><br><span class="line">no tx vectors found on em1</span><br><span class="line">em1 mask=1 <span class="keyword">for</span> /proc/irq/109/smp_affinity</span><br><span class="line">em1 mask=2 <span class="keyword">for</span> /proc/irq/110/smp_affinity</span><br><span class="line">em1 mask=4 <span class="keyword">for</span> /proc/irq/111/smp_affinity</span><br><span class="line">em1 mask=8 <span class="keyword">for</span> /proc/irq/112/smp_affinity</span><br><span class="line">em1 mask=10 <span class="keyword">for</span> /proc/irq/113/smp_affinity</span><br><span class="line">em1 mask=20 <span class="keyword">for</span> /proc/irq/114/smp_affinity</span><br><span class="line">em1 mask=40 <span class="keyword">for</span> /proc/irq/115/smp_affinity</span><br><span class="line">em1 mask=80 <span class="keyword">for</span> /proc/irq/116/smp_affinity</span><br><span class="line"> </span><br><span class="line"><span class="comment">#./set_irq_affinity.sh 8 em2</span></span><br><span class="line">no rx vectors found on em2</span><br><span class="line">no tx vectors found on em2</span><br><span class="line">em2 mask=100 <span class="keyword">for</span> /proc/irq/118/smp_affinity</span><br><span class="line">em2 mask=200 <span class="keyword">for</span> /proc/irq/119/smp_affinity</span><br><span class="line">em2 mask=400 <span class="keyword">for</span> /proc/irq/120/smp_affinity</span><br><span class="line">em2 mask=800 <span class="keyword">for</span> /proc/irq/121/smp_affinity</span><br><span class="line">em2 mask=1000 <span class="keyword">for</span> /proc/irq/122/smp_affinity</span><br><span class="line">em2 mask=2000 <span class="keyword">for</span> /proc/irq/123/smp_affinity</span><br><span class="line">em2 mask=4000 <span class="keyword">for</span> /proc/irq/124/smp_affinity</span><br><span class="line">em2 mask=8000 <span class="keyword">for</span> /proc/irq/125/smp_affinity</span><br></pre></td></tr></table></figure>

<p><strong>参考:</strong></p>
<ul>
<li><strong><a href="https://blog.csdn.net/shen1936/article/details/39548859" target="_blank" rel="noopener">MYSQL数据库网卡软中断不平衡问题及解决方案</a></strong></li>
</ul>
]]></content>
      <categories>
        <category>NSM</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>我在'云'上的日子 - Suricata(部署)</title>
    <url>/2019/10/14/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90%20-%20Suricata%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="PF-RING"><a href="#PF-RING" class="headerlink" title="PF_RING"></a>PF_RING</h2><p><strong>1. pf_ring</strong></p>
<ul>
<li><strong>二进制安装</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 18.04 LTS</span></span><br><span class="line">$ apt-get install software-properties-common wget</span><br><span class="line">$ add-apt-repository universe [ unless you have <span class="keyword">done</span> it previously ]</span><br><span class="line">$ wget http://apt-stable.ntop.org/18.04/all/apt-ntop-stable.deb</span><br><span class="line">$ apt install ./apt-ntop-stable.deb</span><br><span class="line"></span><br><span class="line">$ apt-get clean all</span><br><span class="line">$ apt-get update</span><br><span class="line">$ apt-get install pfring</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>编译安装</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 依赖</span></span><br><span class="line">$ apt install git make gcc libelf-dev build-essential subversion flex libnuma-dev bison pkg-config libtool rustc cargo libjansson-dev ethtool autoconf autogen liblzma-dev libpcre3-dev libyaml-dev libpcap-dev zlib1g-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/ntop/PF_RING.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">$ cat /proc/net/pf_ring/info</span><br><span class="line">PF_RING Version          : 7.5.0 (dev:8fe7d4ca0398e7c530b6cd583d0891d0d229bf7e)</span><br><span class="line">Total rings              : 0</span><br><span class="line"></span><br><span class="line">Standard (non ZC) Options</span><br><span class="line">Ring slots               : 65536</span><br><span class="line">Slot version             : 17</span><br><span class="line">Capture TX               : Yes [RX+TX]</span><br><span class="line">IP Defragment            : No</span><br><span class="line">Socket Mode              : Standard</span><br><span class="line">Cluster Fragment Queue   : 0</span><br><span class="line">Cluster Fragment Discard : 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ sudo rmmod pf_ring</span><br><span class="line">$ sudo insmod pf_ring.ko min_num_slots=65536 transparent_mode=2 enable_tx_capture=0</span><br><span class="line"></span><br><span class="line">$ cat /proc/net/pf_ring/info</span><br><span class="line">PF_RING Version          : 7.5.0 (dev:8fe7d4ca0398e7c530b6cd583d0891d0d229bf7e)</span><br><span class="line">Total rings              : 0</span><br><span class="line"></span><br><span class="line">Standard (non ZC) Options</span><br><span class="line">Ring slots               : 65536</span><br><span class="line">Slot version             : 17</span><br><span class="line">Capture TX               : No [RX only]</span><br><span class="line">IP Defragment            : No</span><br><span class="line">Socket Mode              : Standard</span><br><span class="line">Cluster Fragment Queue   : 0</span><br><span class="line">Cluster Fragment Discard : 0</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>2. libpfring、libpcap</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> PF_RING/userland/lib</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure &amp;&amp; make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ../libpcap</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure &amp;&amp; make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> PF_RING/userland/examples</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收数据包</span></span><br><span class="line">root@ubuntu:/opt/PF_RING/userland/examples# ./pfcount -i ens33</span><br><span class="line">Using PF_RING v.7.5.0</span><br><span class="line">Capturing from ens33 [mac: 00:0C:29:D5:B9:8F][if_index: 2][speed: 0Mb/s]</span><br><span class="line"><span class="meta">#</span><span class="bash"> Device RX channels: 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Polling threads:    1</span></span><br><span class="line">Dumping statistics on /proc/net/pf_ring/stats/51441-ens33.3</span><br><span class="line">=========================</span><br><span class="line">Absolute Stats: [2 pkts total][0 pkts dropped][0.0% dropped]</span><br><span class="line">[2 pkts rcvd][424 bytes rcvd]</span><br><span class="line">=========================</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送数据包</span></span><br><span class="line">root@ubuntu:/opt/PF_RING/userland/examples# sudo ./pfsend -f 64byte_packets.pcap -n 0 -i ens33 -r 5</span><br><span class="line">Sending packets on ens33</span><br><span class="line">Using PF_RING v.7.5.0</span><br><span class="line">Estimated CPU freq: 2429795000 Hz</span><br><span class="line">Unable to open file 64byte_packets.pcap</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>3. tcpdump</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ <span class="built_in">cd</span> tcpdump-4.9.2/</span><br><span class="line">$ ./configure &amp;&amp; make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>参考:</strong></p>
<ul>
<li><p><strong><a href="https://www.ntop.org/guides/pf_ring/get_started/git_installation.html" target="_blank" rel="noopener">PF_RING</a></strong></p>
</li>
<li><p><a href="http://packages.ntop.org/apt-stable/" target="_blank" rel="noopener">http://packages.ntop.org/apt-stable/</a></p>
</li>
<li><p><a href="https://www.ntop.org/guides/pf_ring/get_started/packages_installation.html" target="_blank" rel="noopener">https://www.ntop.org/guides/pf_ring/get_started/packages_installation.html</a></p>
</li>
<li><p><a href="https://www.ntop.org/guides/pf_ring/thirdparty/suricata.html" target="_blank" rel="noopener">https://www.ntop.org/guides/pf_ring/thirdparty/suricata.html</a></p>
</li>
</ul>
<h2 id="LuaJIT"><a href="#LuaJIT" class="headerlink" title="LuaJIT"></a>LuaJIT</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget http://luajit.org/download/LuaJIT-2.0.5.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -zxf LuaJIT-2.0.5.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> LuaJIT-2.0.5/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make &amp;&amp; make install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig -p | grep lua</span></span><br><span class="line">	liblua5.1.so.0 (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1.so.0</span><br><span class="line">	liblua5.1.so (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1.so</span><br><span class="line">	liblua5.1-c++.so.0 (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1-c++.so.0</span><br><span class="line">	liblua5.1-c++.so (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1-c++.so</span><br></pre></td></tr></table></figure>

<h2 id="Hyperscan"><a href="#Hyperscan" class="headerlink" title="Hyperscan"></a>Hyperscan</h2><p><strong>1. boost</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 依赖</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> apt install cmake</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://dl.bintray.com/boostorg/release/1.69.0/<span class="built_in">source</span>/boost_1_69_0.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -xvf boost_1_69_0.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> boost_1_69_0/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./bootstrap.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ./b2 --with-iostreams --with-random install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig</span></span><br></pre></td></tr></table></figure>

<p><strong>2. ragle</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 依赖</span></span><br><span class="line">$ sudo apt-get install autoconf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ wget http://www.colm.net/files/ragel/ragel-6.10.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ tar zxvf ragel-6.10.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> ragel-6.10</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>

<p><strong>3. hyperscan</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 依赖</span></span><br><span class="line">$ sudo apt install libpcap-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ wget https://github.com/intel/hyperscan/archive/v5.1.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">$ tar -zxvf hyperscan-5.1.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> hyperscan-5.1.0</span><br><span class="line">$ mkdir cmake-build</span><br><span class="line">$ <span class="built_in">cd</span> cmake-build</span><br><span class="line">$ cmake -DBUILD_SHARED_LIBS=on -DCMAKE_BUILD_TYPE=Release ..</span><br><span class="line">$ make -j8</span><br><span class="line">$ sudo make install</span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>

<p><strong>4. 验证</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ldconfig -p | grep hs</span></span><br><span class="line">	libhs_runtime.so.5 (libc6,x86-64) =&gt; /usr/local/lib/libhs_runtime.so.5</span><br><span class="line">	libhs_runtime.so (libc6,x86-64) =&gt; /usr/local/lib/libhs_runtime.so</span><br><span class="line">	libhs.so.5 (libc6,x86-64) =&gt; /usr/local/lib/libhs.so.5</span><br><span class="line">	libhs.so (libc6,x86-64) =&gt; /usr/local/lib/libhs.so</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>参考:</strong></p>
<ul>
<li><a href="http://www.manongjc.com/article/110977.html" target="_blank" rel="noopener"><strong>Hyperscan - 5.1.0 安装</strong></a></li>
</ul>
<h2 id="Suricata"><a href="#Suricata" class="headerlink" title="Suricata"></a><strong>Suricata</strong></h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 依赖</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> apt-get install libpcre3 libpcre3-dbg libpcre3-dev build-essential libpcap-dev   \</span></span><br><span class="line">                libnet1-dev libyaml-0-2 libyaml-dev pkg-config zlib1g zlib1g-dev \</span><br><span class="line">                libcap-ng-dev libcap-ng0 make libmagic-dev libjansson-dev        \</span><br><span class="line">                libnss3-dev libgeoip-dev libhiredis-dev libevent-dev \</span><br><span class="line">                python-yaml rustc cargo libmaxminddb-dev liblzma-dev \</span><br><span class="line">                python3-distutils liblz4-dev</span><br><span class="line">                </span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir suricata</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> suricata</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> git://phalanx.openinfosecfoundation.org/oisf.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> oisf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/OISF/libhtp.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./autogen.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var --<span class="built_in">enable</span>-profiling --<span class="built_in">enable</span>-pfring --with-libpfring-includes=/usr/<span class="built_in">local</span>/include --with-libpfring-libraries=/usr/<span class="built_in">local</span>/lib --<span class="built_in">enable</span>-geoip  --<span class="built_in">enable</span>-luajit --with-libluajit-includes=/usr/<span class="built_in">local</span>/include/luajit-2.0/ --with-libluajit-libraries=/usr/<span class="built_in">local</span>/lib/ --with-libhs-includes=/usr/<span class="built_in">local</span>/include/hs/ --with-libhs-libraries=/usr/<span class="built_in">local</span>/lib/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make &amp;&amp; make install-full</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig</span></span><br></pre></td></tr></table></figure>

<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p><strong>1. PF_RING</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep PF_RING</span></span><br><span class="line">Features: PCAP_SET_BUFF PF_RING AF_PACKET HAVE_PACKET_FANOUT LIBCAP_NG LIBNET1.1 HAVE_HTP_URI_NORMALIZE_HOOK PCRE_JIT HAVE_NSS HAVE_LUA HAVE_LUAJIT HAVE_LIBJANSSON PROFILING TLS MAGIC RUST</span><br><span class="line">  PF_RING support:                         yes</span><br></pre></td></tr></table></figure>

<p><strong>2. LuaJit</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep lua</span></span><br><span class="line">  LUA support:                             yes, through luajit</span><br><span class="line">  libluajit:                               yes</span><br></pre></td></tr></table></figure>

<p><strong>3. Hyperscan</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep Hyperscan</span></span><br><span class="line">  Hyperscan support:                       yes</span><br></pre></td></tr></table></figure>

<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a><strong>启动</strong></h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --pfring-int=ens6 --pfring-cluster-id=99 --pfring-cluster-type=cluster_flow -c /etc/suricata/suricata.yaml</span></span><br></pre></td></tr></table></figure>

<h1 id="规则管理"><a href="#规则管理" class="headerlink" title="规则管理"></a>规则管理</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install --upgrade suricata-update</span><br></pre></td></tr></table></figure>

<p><strong>定时更新</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> crontab -l</span></span><br><span class="line">10 0 * * * /usr/bin/suricata-update --no-test &amp;&amp; /usr/bin/suricatasc -c reload-rules</span><br></pre></td></tr></table></figure>

<h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><p><a href="https://www.jianshu.com/p/9348e211a6a2" target="_blank" rel="noopener">https://www.jianshu.com/p/9348e211a6a2</a></p>
]]></content>
      <categories>
        <category>NSM</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>Scrapy + Splash 实现动态网页爬取</title>
    <url>/2019/10/08/Scrapy%20-%20haveibeenpwned/</url>
    <content><![CDATA[<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>​        这是一个撞库事件的后续, 通过之前编写的脚本<strong>Suricata - login_audit</strong>脚本成功审计到了所有登录网站的账号。这里需要对经过分析后存在可疑行为的账号进行反向查询, 主要判断该账号是否已被标记为泄露账号。</p>
<h2 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h2><p>​        由于<strong>Scrapy</strong>没有<strong>JS Eengine</strong>只能爬取静态页面的, 对于JS生成的动态页面是不支持的。但是可以借助<a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener"><strong>Scrapy-Splash</strong></a>来实现动态页面的爬取。</p>
<h1 id="部署方法"><a href="#部署方法" class="headerlink" title="部署方法"></a>部署方法</h1><h2 id="1-Scrapy-Splash"><a href="#1-Scrapy-Splash" class="headerlink" title="1. Scrapy-Splash"></a>1. Scrapy-Splash</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install scrapy-splash --user</span><br></pre></td></tr></table></figure>

<h2 id="2-Splash-Instance"><a href="#2-Splash-Instance" class="headerlink" title="2. Splash Instance"></a>2. Splash Instance</h2><p>由于<strong>Scrapy-Splash</strong>使用的是<strong>Splash HTTP API</strong>， 所以需要一个<strong><a href="https://splash.readthedocs.io/en/stable/install.html" target="_blank" rel="noopener">Splash Instance</a></strong>，一般采用<strong><a href="https://hub.docker.com/r/scrapinghub/splash" target="_blank" rel="noopener">Docker</a></strong>运行<strong>Splash</strong>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ more docker-compose.yml</span><br><span class="line">version: <span class="string">"2.0"</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  splash:</span><br><span class="line">    restart: always</span><br><span class="line">    image: scrapinghub/splash</span><br><span class="line">    tty: <span class="literal">true</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8050:8050"</span></span><br><span class="line">    network_mode: <span class="string">"bridge"</span></span><br><span class="line">    container_name: <span class="string">"Splash"</span></span><br><span class="line">    hostname: <span class="string">"Splash"</span></span><br></pre></td></tr></table></figure>

<h2 id="3-配置Splash服务（以下操作全部在settings-py）"><a href="#3-配置Splash服务（以下操作全部在settings-py）" class="headerlink" title="3. 配置Splash服务（以下操作全部在settings.py）"></a>3. 配置<a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener"><strong>Splash</strong></a>服务（以下操作全部在<strong>settings.py</strong>）</h2><p><strong>3.1    添加Splash服务器地址</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SPLASH_URL = <span class="string">'http://localhost:8050'</span></span><br></pre></td></tr></table></figure>

<p><strong>3.2    启用Splash middleware</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line">    <span class="string">'scrapy_splash.SplashCookiesMiddleware'</span>: 723,</span><br><span class="line">    <span class="string">'scrapy_splash.SplashMiddleware'</span>: 725,</span><br><span class="line">    <span class="string">'scrapy.downloadermiddlewares.httpcompression.HttpCompressionMiddleware'</span>: 810,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>Order 723 is just before HttpProxyMiddleware (750) in default scrapy settings.</em></p>
<p><strong>3.3    启用SplashDeduplicateArgsMiddleware</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SPIDER_MIDDLEWARES = &#123;</span><br><span class="line">    <span class="string">'scrapy_splash.SplashDeduplicateArgsMiddleware'</span>: 100,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.4  自定义 DUPEFILTER_CLASS</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DUPEFILTER_CLASS = <span class="string">'scrapy_splash.SplashAwareDupeFilter'</span></span><br></pre></td></tr></table></figure>

<p><strong>3.5 使用Scrapy HTTP缓存</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HTTPCACHE_STORAGE = <span class="string">'scrapy_splash.SplashAwareFSCacheStorage'</span></span><br></pre></td></tr></table></figure>

<h2 id="4-代码"><a href="#4-代码" class="headerlink" title="4. 代码"></a>4. 代码</h2><p>注:  当使用<strong>Scrapy-Splash</strong>之后, 将无法直接使用<strong>crawlera middleware</strong>。需要手动引用外部lua脚本。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> haveibeenpwned.items <span class="keyword">import</span> feed</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> scrapy_splash <span class="keyword">import</span> SplashRequest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">from redis crawl haveibeenpwned</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">LUA_SOURCE = <span class="string">"""</span></span><br><span class="line"><span class="string">    function main(splash)</span></span><br><span class="line"><span class="string">        local host = "proxy.crawlera.com"</span></span><br><span class="line"><span class="string">        local port = 8010</span></span><br><span class="line"><span class="string">        local user = "api_key"</span></span><br><span class="line"><span class="string">        local password = ""</span></span><br><span class="line"><span class="string">        local session_header = "X-Crawlera-Session"</span></span><br><span class="line"><span class="string">        local session_id = "create"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:on_request(function (request)</span></span><br><span class="line"><span class="string">            request:set_header("X-Crawlera-UA", "desktop")</span></span><br><span class="line"><span class="string">            request:set_header(session_header, session_id)</span></span><br><span class="line"><span class="string">            request:set_proxy&#123;host, port, username=user, password=password&#125;</span></span><br><span class="line"><span class="string">        end)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:on_response_headers(function (response)</span></span><br><span class="line"><span class="string">            if response.headers[session_header] ~= nil then</span></span><br><span class="line"><span class="string">                session_id = response.headers[session_header]</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">        end)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:go(splash.args.url)</span></span><br><span class="line"><span class="string">        return splash:html()</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CheckSpider</span><span class="params">(scrapy.Spider)</span>:</span></span><br><span class="line">    name = <span class="string">'scrapy_demo'</span></span><br><span class="line">    start_urls = <span class="string">'https://httpbin.org/get'</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> SplashRequest(self.start_urls, self.parse, endpoint=<span class="string">'execute'</span>,  args=&#123;<span class="string">'wait'</span>: <span class="number">3</span>, <span class="string">'lua_source'</span>: LUA_SOURCE&#125;)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        print(response.text)</span><br></pre></td></tr></table></figure>

<p>参考:</p>
<ul>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash/issues/117" target="_blank" rel="noopener">https://github.com/scrapy-plugins/scrapy-splash/issues/117</a></li>
</ul>
<p>参考:</p>
<ul>
<li><a href="https://splash.readthedocs.io/en/stable/search.html?q=splash%3Ahtml&check_keywords=yes&area=default" target="_blank" rel="noopener">Splash</a></li>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener">Scrapy-Splash</a></li>
<li><a href="https://doc.scrapinghub.com/crawlera.html#using-crawlera-with-splash" target="_blank" rel="noopener">Scrapinghub API Reference</a></li>
<li><a href="https://stackoverflow.com/questions/43646438/using-proxy-with-scrapy-splash" target="_blank" rel="noopener">using proxy with scrapy-splash</a></li>
<li><a href="http://stackoverflow.com/questions/43090352/proxy-servers-with-scrapy-splash" target="_blank" rel="noopener"><strong>Proxy servers with Scrapy-Splash</strong></a></li>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash/issues/97" target="_blank" rel="noopener">Crawlera integration</a></li>
<li><a href="https://blog.csdn.net/zhengxiangwen/article/details/55227368" target="_blank" rel="noopener"><strong>利用scrapy-splash爬取JS生成的动态页面</strong></a></li>
</ul>
]]></content>
      <categories>
        <category>Spider</category>
      </categories>
      <tags>
        <tag>Scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2019/10/04/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
  </entry>
</search>
