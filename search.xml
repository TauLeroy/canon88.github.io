<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰</title>
    <url>/2021/02/02/%E8%87%B4%E6%88%91%E5%BF%83%E4%B8%AD%E7%9A%84%20%E2%80%9C%E6%95%A3%E8%A3%85%E2%80%9D%EF%BC%88%E5%BC%80%E6%BA%90%EF%BC%89SIEM%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>â€‹        ç”±äºå·¥ä½œæ¯”è¾ƒå¿™ï¼Œæœ‰æ®µæ—¶é—´æ²¡æœ‰æ›´äº†ï¼Œå¿«åˆ°å¹´åº•äº†ï¼Œå°±å½“æ˜¯æ€»ç»“äº†ã€‚ä»Šå¹´ä¸»è¦ç²¾åŠ›éƒ½æ˜¯åœ¨å›´ç»•ç€å®‰å…¨è¿è¥è¿™ä¸€å—çš„å·¥ä½œï¼Œéšç€å·¥ä½œçš„å¼€å±•å‘ç°è‡ªå·±<strong>â€œç»„è£…â€</strong>çš„SIEMç”¨èµ·æ¥ä¸æ˜¯å¾ˆâ€œ<strong>èˆ’æœ</strong>â€ã€‚è¿™æ˜¯æˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡ã€Š<a href="https://canon88.github.io/2020/02/25/Wazuh-%E5%A6%82%E4%BD%95%E5%AF%B9%E5%BC%82%E6%9E%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%E5%91%8A%E8%AD%A6/" target="_blank" rel="noopener"><strong>Wazuh-å¦‚ä½•å¯¹å¼‚æ„æ•°æ®è¿›è¡Œå…³è”å‘Šè­¦</strong></a>ã€‹çš„æ–‡ç« ï¼Œå½“æ—¶è§„åˆ’çš„æ•°æ®æµçš„Workflowå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/image-20200303215020561.png" alt="image-20200303215020561"></p>
<p>â€‹        <strong>â€œæ•£è£…â€SIEM</strong>ä¸»è¦æ˜¯å»ºç«‹åœ¨ELKçš„æ¡†æ¶ä¹‹ä¸Šï¼Œå‘Šè­¦æ¨¡å—åˆ†åˆ«é‡‡ç”¨äº†Wazuhä¸Elastalertã€‚æ—©æœŸä¸ºäº†ä½¿Wazuhèƒ½å¤Ÿæ¶ˆè´¹å¼‚æ„æ•°æ®<strong>ï¼ˆWAFã€NTAã€EDRï¼‰</strong>å¹¶è¿›è¡Œå…³è”å‘Šè­¦ï¼Œæˆ‘åœ¨æ•°æ®å…¥åº“ä¹‹å‰åˆ©ç”¨Logstashå¯¹å¼‚æ„æ•°æ®è¿›è¡Œäº†æ ‡å‡†åŒ–ï¼ŒåŒæ—¶Wazuhå¯¹æ ‡å‡†åŒ–åçš„æ•°æ®è¿›è¡Œå…³è”ã€‚ä¾‹å¦‚ï¼šSuricataé€šè¿‡Filebeatå°†å‘Šè­¦äº‹ä»¶å‘å‡ºï¼Œç”±Logstashç»Ÿä¸€è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†å¹¶åŒæ—¶è¾“å‡ºåˆ°Elasticä»¥åŠWazuhã€‚å…¶ä¸­Elasticä¸ºå‘Šè­¦çš„å…ƒæ•°æ®ï¼Œæ¨é€åˆ°Wazuhä¸Šçš„ä¸ºæ ‡å‡†åŒ–åçš„å®‰å…¨äº‹ä»¶ã€‚</p>
<hr>
<h1 id="â€œæ•£è£…â€SIEM-v0-1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½"><a href="#â€œæ•£è£…â€SIEM-v0-1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½" class="headerlink" title="â€œæ•£è£…â€SIEM v0.1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½"></a>â€œæ•£è£…â€SIEM v0.1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½</h1><h2 id="1-æ•°æ®æ ‡å‡†åŒ–"><a href="#1-æ•°æ®æ ‡å‡†åŒ–" class="headerlink" title="1. æ•°æ®æ ‡å‡†åŒ–"></a>1. æ•°æ®æ ‡å‡†åŒ–</h2><p>â€‹        ç”±äºå‰æœŸçš„æ ‡å‡†åŒ–æœªé‡‡ç”¨<strong><a href="https://www.elastic.co/guide/en/ecs/current/ecs-reference.html" target="_blank" rel="noopener">ECS</a></strong>(<strong>Elastic Common Schema</strong>)ï¼Œå¯¼è‡´åæœŸæ²¿ç”¨Elasticç”Ÿæ€çš„æ—¶å€™å‡ºç°äº†ä½¿ç”¨ä¸Šçš„ä¸ä¾¿ã€‚å¤§å®¶éƒ½çŸ¥é“ESåœ¨7.Xçš„ç‰ˆæœ¬æ¨å‡ºäº†SIEMè¿™ä¸ªåŠŸèƒ½ï¼Œå¦‚æœæƒ³ä½¿ç”¨Elastic SIEMè¿›è¡Œåˆ†æçš„è¯ï¼Œé‚£ä¹ˆECSæ˜¯é¦–é€‰ã€‚è¿™é‡Œä¸ºäº†åæœŸä¸å¼€æºç”Ÿæ€æ›´å¥½çš„è¿›è¡Œèåˆï¼Œéœ€è¦å°†åŸå…ˆçš„æ ‡å‡†åŒ–è½¬ä¸ºECSçš„æ ¼å¼ã€‚</p>
<h2 id="2-å‘Šè­¦ä¸°å¯ŒåŒ–"><a href="#2-å‘Šè­¦ä¸°å¯ŒåŒ–" class="headerlink" title="2. å‘Šè­¦ä¸°å¯ŒåŒ–"></a>2. å‘Šè­¦ä¸°å¯ŒåŒ–</h2><p>ä¸ºäº†æ›´æœ‰æ•ˆçš„æå‡å‘Šè­¦è´¨é‡ï¼Œæé«˜å®‰å…¨åˆ†æçš„æ•ˆç‡ã€‚éœ€è¦å¯¹å…¥åº“çš„å®‰å…¨äº‹ä»¶ä»¥åŠäº§ç”Ÿçš„å‘Šè­¦è¿›è¡Œå¿…è¦çš„ä¸°å¯ŒåŒ–ã€‚</p>
<ul>
<li><p>åˆ©ç”¨CMDBå¹³å°çš„æ•°æ®å¯¹å†…éƒ¨èµ„äº§è¿›è¡Œä¸°å¯ŒåŒ–ã€‚ä¾‹å¦‚å¢åŠ ï¼šéƒ¨é—¨ã€ä¸šåŠ¡ã€åº”ç”¨ç±»å‹ã€è´Ÿè´£äººç­‰å­—æ®µã€‚</p>
</li>
<li><p>å¯¹æ¥å¨èƒæƒ…æŠ¥æ•°æ®ï¼ŒSIEMä¼šå¯¹å‘Šè­¦äº‹ä»¶çš„æ”»å‡»IPè¿›è¡Œæƒ…æŠ¥ä¾§æ•°æ®çš„ä¸°å¯ŒåŒ–ï¼›</p>
<ul>
<li>æœ¬åœ°å¨èƒæƒ…æŠ¥ï¼ˆæ›¾ç»æ”»å‡»è¿‡æˆ‘ä»¬çš„IPåœ°å€ï¼‰</li>
<li>ç¬¬ä¸‰æ–¹å¨èƒæƒ…æŠ¥<ul>
<li>å¼€æº</li>
<li>å•†ä¸š</li>
</ul>
</li>
</ul>
</li>
<li><p>æ•æ„Ÿæ¥å£ç›‘æ§ï¼ˆå¦‚ï¼šç™»å½•æ¥å£ã€æ”¯ä»˜æ¥å£ã€é’±åŒ…æ¥å£ï¼‰ã€‚åˆ©ç”¨ç¬¬ä¸‰æ–¹æ•°æ®å¯¹IPåœ°å€è¿›è¡ŒProxyæ ‡è®°ï¼Œä¸ºåæœŸé£æ§çš„ç ”åˆ¤æä¾›ä¸€äº›æ•°æ®æ”¯æ’‘ï¼›</p>
</li>
<li><p>ä¸ºå®‰å…¨äº‹ä»¶å¢åŠ æ–¹å‘ä¸åŒºåŸŸçš„å­—æ®µã€‚ä¾¿äºåˆ†æäººå‘˜ç¬¬ä¸€æ—¶é—´è¯†åˆ«<strong>å†…å¯¹å†…</strong>ä»¥åŠ<strong>å†…å¯¹å¤–</strong>çš„å‘Šè­¦ã€‚ä¹Ÿå¯é’ˆå¯¹æ–¹å‘è¿›è¡Œå‘Šè­¦çº§åˆ«çš„æƒé‡è°ƒæ•´ï¼›</p>
</li>
</ul>
<h2 id="3-æå‡æ£€æµ‹èƒ½åŠ›"><a href="#3-æå‡æ£€æµ‹èƒ½åŠ›" class="headerlink" title="3. æå‡æ£€æµ‹èƒ½åŠ›"></a>3. æå‡æ£€æµ‹èƒ½åŠ›</h2><p>åº•å±‚å®‰å…¨è®¾å¤‡çš„æ£€æµ‹èƒ½åŠ›ä¸å®‰å…¨äº‹ä»¶çš„å¯ä¿¡åº¦ï¼Œæ˜¯ç›´æ¥å½±å“SIEMå‘Šè­¦çš„å…³é”®å› ç´ ã€‚</p>
<ul>
<li>æ¥å…¥Imperva WAFçš„å‘Šè­¦æ•°æ®ï¼Œä¸Suricataè¿›è¡Œè‡ªåŠ¨åŒ–å…³è”ï¼Œå®šæœŸå°†ç»•è¿‡çš„è§„åˆ™â€œç§»æ¤â€åˆ°å‰ç«¯çš„Imperva WAFä¸Šï¼ŒåŠ å¼ºè¾¹ç•Œçš„å®‰å…¨é˜²æŠ¤èƒ½åŠ›ï¼›</li>
<li>â€œæ¶ˆè´¹â€AWS VPC FLOWæ•°æ®ï¼Œå¢åŠ <strong>å†…å¯¹å¤–</strong>çš„å¼‚å¸¸è¿æ¥æ£€æµ‹èƒ½åŠ›ã€‚ç”±äºæ˜¯å››å±‚æ•°æ®èƒ½å¤Ÿè¢«<strong>â€œæ¶ˆè´¹â€</strong>çš„ç»´åº¦å®åœ¨ä¸å¤šã€‚ä¸»è¦å®ç°äº†ä»¥ä¸‹å‡ ç§å‘Šè­¦ï¼š<ul>
<li>å‘¨æœŸæ€§è¿æ¥å‘Šè­¦</li>
<li>å¨èƒæƒ…æŠ¥ç±»å‘Šè­¦</li>
<li>ç«¯å£æ‰«æç±»å‘Šè­¦<ul>
<li>çŸ­æ—¶é—´å†…ï¼Œå†…ç½‘ä¸»æœºè¯·æ±‚ç›¸åŒç›®çš„IPçš„å¤šä¸ªç«¯å£</li>
<li>çŸ­æ—¶é—´å†…ï¼Œå†…ç½‘ä¸»æœºè¯·æ±‚å¤šä¸ªIPçš„ç›¸åŒç›®çš„ç«¯å£</li>
</ul>
</li>
<li>æ•æ„Ÿç«¯å£è¯·æ±‚å‘Šè­¦</li>
</ul>
</li>
</ul>
<h2 id="4-æº¯æºåˆ†æ"><a href="#4-æº¯æºåˆ†æ" class="headerlink" title="4. æº¯æºåˆ†æ"></a>4. æº¯æºåˆ†æ</h2><p>ç›®å‰SIEMäº§ç”Ÿçš„å‘Šè­¦ï¼Œå¹¶ä¸ä¼šæºå¸¦åŸå§‹çš„å®‰å…¨äº‹ä»¶ï¼Œè¿™å¯¹äºåˆ†æå°ä¼™ä¼´æ¥è¯´å¹¶ä¸å‹å¥½ï¼Œç‰¹åˆ«æ˜¯å‘Šè­¦é‡æ¯”è¾ƒå¤šçš„æ—¶å€™ã€‚</p>
<ul>
<li>ç°å·²ä¸ºæ¯ä¸€ä¸ªå‘Šè­¦å¢åŠ äº†<strong>â€œHuntingâ€</strong>çš„å­—æ®µï¼Œé€šè¿‡è¯¥å­—æ®µå¯ç›´æ¥æº¯æºåˆ°åº•å±‚çš„å®‰å…¨äº‹ä»¶ï¼›</li>
<li>å¢åŠ äº†æ›´é€‚ç”¨äºå®‰å…¨åˆ†æäººå‘˜ä½¿ç”¨çš„ä»ªè¡¨ç›˜ï¼›</li>
<li>ç¼–å†™äº†ä¸€ä¸ª<strong>è‡ªè®¤ä¸º</strong>æ¯”è¾ƒè´´åˆåˆ†æäººå‘˜ä½¿ç”¨çš„å·¥å…·ï¼š<strong>HappyHunting</strong>ï¼›</li>
</ul>
<h2 id="5-å…¶ä»–æ”¹è¿›"><a href="#5-å…¶ä»–æ”¹è¿›" class="headerlink" title="5. å…¶ä»–æ”¹è¿›"></a>5. å…¶ä»–æ”¹è¿›</h2><ul>
<li><p>è§£å†³äº†SIEMè”åŠ¨CDN WAF APIå“åº”æ—¶é—´è¿‡é•¿ï¼ˆ15-20åˆ†é’Ÿ ğŸ˜…ï¼‰çš„é—®é¢˜ã€‚ç›®å‰ä¸Imperva WAF APIè”åŠ¨å·²åšåˆ°äº†å‡†å®æ—¶ã€‚</p>
</li>
<li><p>ä¼˜åŒ–NTA login_auditä»£ç ï¼Œæå‡NTAæ€§èƒ½ã€‚ä¹‹å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ã€Š<strong><a href="https://canon88.github.io/2019/10/24/Suricata+Lua%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E6%83%85%E6%8A%A5%E5%AF%B9%E6%8E%A5/" target="_blank" rel="noopener">Suricata + Luaå®ç°æœ¬åœ°æƒ…æŠ¥å¯¹æ¥</a></strong>ã€‹ï¼Œä¸»è¦åˆ©ç”¨äº†Luaè„šæœ¬å¯¹â€œæ•æ„Ÿâ€æ¥å£è¿›è¡Œç™»å½•å®¡è®¡å¹¶åˆ©ç”¨æƒ…æŠ¥è¿›è¡Œé«˜å±è´¦å·æ£€æµ‹ã€‚ç°å·²å°†è¿™éƒ¨åˆ†åŠŸèƒ½ç§»æ¤åˆ°Logstash + Rubyä¸Šï¼›</p>
</li>
<li><p>ä¹‹å‰çš„è‡ªåŠ¨åŒ–è”åŠ¨è§„åˆ™éƒ½æ˜¯é€šè¿‡æ‰‹åŠ¨ä¿®æ”¹è„šæœ¬è°ƒæ•´<strong>rule.id</strong>æ¥å®ç°ï¼Œè¿™ç§æ–¹å¼åœ¨åˆæœŸè¿˜èƒ½å‹‰å¼ºè¿è¡Œã€‚ä½†åœ¨åæœŸè¿è¡Œä¸­æš´éœ²å‡ºäº†ä¸è¶³ï¼Œæ—¢ä¸ä¾¿äºç®¡ç†ä¹Ÿå¢åŠ äº†ç»´æŠ¤çš„æˆæœ¬ã€‚æ‰€ä»¥ä¸ºäº†ç»´æŠ¤SIEMçš„è§„åˆ™ï¼Œè¿™é‡Œé‡‡ç”¨äº†Redisæ¥è¿›è¡Œè§„åˆ™çš„ç»Ÿä¸€ç®¡ç†ã€‚åæœŸåªéœ€è¦å°†éœ€è¦é˜»æ–­çš„<strong>rule.id</strong>æ¨é€è‡³Rediså³å¯ã€‚åŒæ—¶ä¹Ÿåœ¨è¾“å‡ºçš„å‘Šè­¦ä¸­é€šè¿‡<strong>event.action</strong>å­—æ®µæ ‡å‡†è¯¥å‘Šè­¦çš„å“åº”æ–¹å¼ï¼›</p>
</li>
</ul>
<hr>
<h1 id="è§£å†³æ–¹æ¡ˆ-â€œæ•£è£…â€SIEM-v0-2"><a href="#è§£å†³æ–¹æ¡ˆ-â€œæ•£è£…â€SIEM-v0-2" class="headerlink" title="è§£å†³æ–¹æ¡ˆ - â€œæ•£è£…â€SIEM v0.2"></a>è§£å†³æ–¹æ¡ˆ - â€œæ•£è£…â€SIEM v0.2</h1><h2 id="1-Workflow"><a href="#1-Workflow" class="headerlink" title="1. Workflow"></a>1. Workflow</h2><p>â€‹        è¿™æ˜¯é‡æ–°è°ƒæ•´ä¹‹åçš„<strong>â€œæ•£è£…â€SIEM v0.2</strong>çš„workflowğŸ˜ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ•°æ®æºé‡‡é›†ç«¯è¿™é‡Œå°±ä¸å±•å¼€æ¥è¯´äº†ï¼Œéƒ½æ˜¯ç°æˆçš„å·¥å…·å‘å°±å®Œäº‹å„¿äº†ã€‚ä¸‹é¢ä¸»è¦è¯´ä¸€ä¸‹Logstashä¸­å¯¹æ•°æ®å¤„ç†çš„éƒ¨åˆ†ï¼š</p>
<p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/SIEM-v0.2.jpg" alt="SIEM-v0.2"></p>
<hr>
<h2 id="2-æ•°æ®å¤„ç†"><a href="#2-æ•°æ®å¤„ç†" class="headerlink" title="2. æ•°æ®å¤„ç†"></a>2. æ•°æ®å¤„ç†</h2><h3 id="1-Normalized"><a href="#1-Normalized" class="headerlink" title="1. Normalized"></a>1. Normalized</h3><p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/normalized-04.png" alt="image-20201208110506481"></p>
<hr>
<h4 id="1-1-normalized-alert-to-siem"><a href="#1-1-normalized-alert-to-siem" class="headerlink" title="1.1 normalized-alert_to_siem"></a>1.1 normalized-alert_to_siem</h4><p>â€‹        é’ˆå¯¹alertäº‹ä»¶è¿›è¡Œæ ‡å‡†åŒ–ï¼Œä¹Ÿå°±æ˜¯å®‰å…¨è®¾å¤‡å‘å‡ºçš„æ•°æ®ã€‚å‚è€ƒä¸Šå›¾ä¸­è“è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<p>â€‹        å®˜æ–¹å·²æ”¯æŒSuricataæ•°æ®çš„ECSï¼Œæˆ‘ä»¬å¯ç›´æ¥å¯ç”¨filebeatçš„Suricataæ¨¡å—ã€‚<strong>ä½†æ˜¯</strong>ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œé»˜è®¤Suricataçš„æ¨¡å—ä¸­æœ‰ä¸€äº›æ ‡å‡†åŒ–æ˜¯äº¤ç”±Elasticæ¥åšçš„ã€‚ç”±äºæˆ‘ä»¬éœ€è¦åˆ©ç”¨Logstashåšåç»­çš„ETLéƒ¨åˆ†ï¼Œæ‰€ä»¥ç°åœ¨çš„æ•´ä¸ªæ•°æ®æµæ˜¯ï¼š<strong>Filebeat -&gt; Logstash -&gt; Elastic</strong>ã€‚é‚£ä¹ˆï¼Œè¿™ä¸€éƒ¨åˆ†çš„æ ‡å‡†åŒ–ï¼Œéœ€è¦æˆ‘ä»¬åœ¨Logstashå±‚é¢æ¥å®ç°ã€‚å…·ä½“æ¶‰åŠåˆ°çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<h5 id="1-1-1-normalized-suricata"><a href="#1-1-1-normalized-suricata" class="headerlink" title="1.1.1 normalized-suricata"></a>1.1.1 normalized-suricata</h5><p>â€‹    é€šç”¨Suricataäº‹ä»¶æ ‡å‡†åŒ–é…ç½®ã€‚</p>
<ul>
<li>åˆ é™¤ä¸€äº›filebeatè‡ªå¸¦çš„å­—æ®µã€‚</li>
<li>å¢åŠ <code>provider</code>ã€<code>product</code>ã€<code>sensor</code>ç­‰å­—æ®µï¼Œä¸ºäº†åæœŸåŒºåˆ†ä¸åŒçš„æ•°æ®æºç±»å‹ï¼Œï¼ˆä¾‹ï¼š<strong>NTAã€WAFã€EDR</strong>ï¼‰ï¼Œä»¥åŠä¸åŒçš„NTAäº§å“ï¼ˆä¾‹ï¼š<strong>Suricataã€Zeek</strong>ï¼‰</li>
</ul>
<h6 id="Logstash-Config"><a href="#Logstash-Config" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/59_normalized-suricata.conf" target="_blank" rel="noopener">normalized-suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">"application"</span>, <span class="string">"type"</span>, <span class="string">"agent"</span>, <span class="string">"@version"</span>, <span class="string">"[event][original]"</span> ]</span><br><span class="line">        add_field =&gt; &#123;</span><br><span class="line">            <span class="string">"provider"</span> =&gt; <span class="string">"Suricata"</span></span><br><span class="line">            <span class="string">"product"</span> =&gt; <span class="string">"IDS"</span></span><br><span class="line">            <span class="string">"sensor"</span> =&gt; <span class="string">"%&#123;[host][name]&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">        lowercase =&gt; [ <span class="string">"[network][transport]"</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">    uuid &#123;</span><br><span class="line">        target =&gt; <span class="string">"[event][id]"</span></span><br><span class="line">        overwrite =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-2-normalized-alert-for-suricata"><a href="#1-1-2-normalized-alert-for-suricata" class="headerlink" title="1.1.2 normalized-alert_for_suricata"></a>1.1.2 normalized-alert_for_suricata</h5><h6 id="Logstash-Config-1"><a href="#Logstash-Config-1" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-alert.conf" target="_blank" rel="noopener">normalized-alert_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">"[suricata][eve][alert][category]"</span> =&gt; <span class="string">"[rule][category]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][alert][signature_id]"</span> =&gt; <span class="string">"[rule][id]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][alert][signature]"</span> =&gt; <span class="string">"[rule][name]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][alert][rule]"</span> =&gt; <span class="string">"[rule][description]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            convert =&gt; &#123;</span><br><span class="line">                <span class="string">"[rule][id]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line">            &#125;</span><br><span class="line">            copy =&gt; &#123;</span><br><span class="line">                <span class="string">"[rule][category]"</span> =&gt; <span class="string">"message"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [suricata][eve][alert][action] == <span class="string">"blocked"</span> &#123;</span><br><span class="line">            mutate &#123;</span><br><span class="line">                update =&gt; &#123;</span><br><span class="line">                    <span class="string">"[suricata][eve][alert][action]"</span> =&gt; <span class="string">"denied"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [suricata][eve][alert][action] &#123;</span><br><span class="line">            ruby &#123;</span><br><span class="line">                code =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">                    action = event.get('[suricata][eve][alert][action]')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    event_type = event.get('[event][type]')</span></span><br><span class="line"><span class="string">                    if event_type then</span></span><br><span class="line"><span class="string">                        event_type = event.get('[event][type]').push(action)</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                        event_type = [action]</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                    event.set('[event][type]', event_type)</span></span><br><span class="line"><span class="string">                    event.remove('[suricata][eve][alert][action]')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    event.set('[event][action]', action)</span></span><br><span class="line"><span class="string">                "</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">"[suricata][eve][alert][severity]"</span> =&gt; <span class="string">"[event][severity]"</span> </span><br><span class="line">                <span class="string">"[suricata][eve][payload_printable]"</span> =&gt; <span class="string">"[rule][payload]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][http][http_request_body_printable]"</span> =&gt; <span class="string">"[http][request][body][content]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][http][http_response_body_printable]"</span> =&gt; <span class="string">"[http][response][body][content]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">                rule_id = event.get('[rule][id]')</span></span><br><span class="line"><span class="string">                rule_name = event.get('[rule][name]')</span></span><br><span class="line"><span class="string">                event_id = event.get('[event][id]')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                event.set('[related][rule][id]', [rule_id])</span></span><br><span class="line"><span class="string">                event.set('[related][rule][name]', [rule_name])</span></span><br><span class="line"><span class="string">                event.set('[related][event][id]', [event_id])</span></span><br><span class="line"><span class="string">            "</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-3-normalized-fileinfo-for-suricata"><a href="#1-1-3-normalized-fileinfo-for-suricata" class="headerlink" title="1.1.3 normalized-fileinfo_for_suricata"></a>1.1.3 normalized-fileinfo_for_suricata</h5><h6 id="Logstash-Config-2"><a href="#Logstash-Config-2" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-fileinfo.conf" target="_blank" rel="noopener">normalized-fileinfo_for_suricatra.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][fileinfo] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">"[suricata][eve][fileinfo][filename]"</span> =&gt; <span class="string">"[file][path]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][fileinfo][size]"</span> =&gt; <span class="string">"[file][size]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-4-normalized-flow-for-suricata"><a href="#1-1-4-normalized-flow-for-suricata" class="headerlink" title="1.1.4 normalized-flow_for_suricata"></a>1.1.4 normalized-flow_for_suricata</h5><h6 id="Logstash-Config-3"><a href="#Logstash-Config-3" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-flow.conf" target="_blank" rel="noopener">normalized-flow_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][flow] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123; </span><br><span class="line">                <span class="string">"[suricata][eve][flow][pkts_toclient]"</span> =&gt; <span class="string">"[destination][packets]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][flow][pkts_toserver]"</span> =&gt; <span class="string">"[source][packets]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][flow][bytes_toclient]"</span> =&gt; <span class="string">"[destination][bytes]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][flow][bytes_toserver]"</span> =&gt; <span class="string">"[source][bytes]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            init =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">                @sb = 0</span></span><br><span class="line"><span class="string">                @sp = 0</span></span><br><span class="line"><span class="string">                @db = 0</span></span><br><span class="line"><span class="string">                @dp = 0</span></span><br><span class="line"><span class="string">            "</span></span><br><span class="line"></span><br><span class="line">            code =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">                events = event.to_hash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if events.has_key?('source') then</span></span><br><span class="line"><span class="string">                    @sb = events['source'].fetch('bytes', 0)</span></span><br><span class="line"><span class="string">                    @sp = events['source'].fetch('packets', 0)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if events.has_key?('destination') then</span></span><br><span class="line"><span class="string">                    @db = events['destination'].fetch('bytes', 0)</span></span><br><span class="line"><span class="string">                    @dp = events['destination'].fetch('packets', 0)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if (@sb+@db+@sp+@dp &gt; 0) then</span></span><br><span class="line"><span class="string">                    if (@sb+@db &gt; 0) then</span></span><br><span class="line"><span class="string">                        event.set('[network][bytes]', @sb+@db)</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                    if (@sp+@dp &gt; 0) then</span></span><br><span class="line"><span class="string">                        event.set('[network][packets]', @sp+@dp)</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">            "</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        date &#123;</span><br><span class="line">            match =&gt; [ <span class="string">"[suricata][eve][flow][start]"</span>, <span class="string">"ISO8601"</span> ]</span><br><span class="line">            target =&gt; <span class="string">"[event][start]"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        date &#123;</span><br><span class="line">            match =&gt; [ <span class="string">"[suricata][eve][flow][end]"</span>, <span class="string">"ISO8601"</span> ]</span><br><span class="line">            target =&gt; <span class="string">"[event][end]"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123; </span><br><span class="line">                <span class="string">"[suricata][eve][flow][age]"</span> =&gt; <span class="string">"[event][duration]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            remove_field =&gt; [</span><br><span class="line">                <span class="string">"[suricata][eve][flow][start]"</span>,</span><br><span class="line">                <span class="string">"[suricata][eve][flow][end]"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-5-normalized-http-for-suricata"><a href="#1-1-5-normalized-http-for-suricata" class="headerlink" title="1.1.5 normalized-http_for_suricata"></a>1.1.5 normalized-http_for_suricata</h5><h6 id="Logstash-Config-4"><a href="#Logstash-Config-4" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-http.conf" target="_blank" rel="noopener">normalized-http_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][http] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">"[suricata][eve][http][http_method]"</span> =&gt; <span class="string">"[http][request][method]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][http][status]"</span> =&gt; <span class="string">"[http][response][status_code]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][http][hostname]"</span> =&gt; <span class="string">"[destination][domain]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [destination][domain] and [network][protocol] == <span class="string">"http"</span> &#123;</span><br><span class="line">            mutate &#123;</span><br><span class="line">                copy =&gt; &#123; <span class="string">"[destination][domain]"</span> =&gt; <span class="string">"[url][domain]"</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            init =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">                @pattern = /(?&lt;path&gt;[^?#]*)(?:\?(?&lt;query&gt;[^#]*))?(?:#(?&lt;fragment&gt;.*))?/</span></span><br><span class="line"><span class="string">            "</span></span><br><span class="line">            code =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">                url = event.get('[suricata][eve][http][url]')</span></span><br><span class="line"><span class="string">                res = @pattern.match(url)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if res['path'] then</span></span><br><span class="line"><span class="string">                    event.set('[url][path]', res['path'])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">                if res['query'] then</span></span><br><span class="line"><span class="string">                    event.set('[url][query]', res['query'])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">                if res['fragment'] then</span></span><br><span class="line"><span class="string">                    event.set('[url][fragment]', res['fragment'])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">            "</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">"[suricata][eve][http][url]"</span> =&gt; <span class="string">"[url][original]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][http][http_refer]"</span> =&gt; <span class="string">"[http][request][referrer]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][http][length]"</span> =&gt; <span class="string">"[http][response][body][bytes]"</span></span><br><span class="line">                <span class="string">"[suricata][eve][http][http_user_agent]"</span> =&gt; <span class="string">"[user_agent][original]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-6-normalized-http-headers-for-suricata"><a href="#1-1-6-normalized-http-headers-for-suricata" class="headerlink" title="1.1.6 normalized_http_headers_for_suricata"></a>1.1.6 normalized_http_headers_for_suricata</h5><p>â€‹        å½“<strong>Suricata</strong>è®¾ç½®<code>dump-all-headers:both</code>æ—¶ï¼Œä¼šå°†HTTPå¤´å…¨éƒ¨è¾“å‡ºã€‚å¯¹äºhttp_auditè¿™ä¸ªéœ€æ±‚è€Œè¨€æ˜¯ä¸ªå¾ˆå¥½çš„åŠŸèƒ½ï¼Œåªä¸è¿‡è¾“å‡ºçš„æ ¼å¼æœ‰ç‚¹å‘ğŸ˜‚ğŸ˜‚ğŸ˜‚ã€‚ä¸ºäº†æ›´æ–¹ä¾¿çš„åœ¨Kibanaä¸Šè¿›è¡Œç­›é€‰ï¼Œæˆ‘å¯¹è¿™éƒ¨åˆ†æ•°æ®è¿›è¡Œäº†æ ‡å‡†åŒ–ã€‚ğŸ˜</p>
<h6 id="Logstash-Config-5"><a href="#Logstash-Config-5" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-http.conf" target="_blank" rel="noopener">normalized_http_headers_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][http] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">"/etc/logstash/scripts/normalized_http_headers.rb"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code"><a href="#Ruby-Code" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/normalized_http_headers.rb" target="_blank" rel="noopener">normalized_http_headers_for_suricata.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    request = &#123;&#125;</span><br><span class="line">    response = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    request_headers = event.get(<span class="string">"[suricata][eve][http][request_headers]"</span>)</span><br><span class="line">    response_headers = event.get(<span class="string">"[suricata][eve][http][response_headers]"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request_headers <span class="keyword">then</span></span><br><span class="line">        request_headers.each <span class="keyword">do</span> <span class="params">|headers|</span></span><br><span class="line">            name = headers[<span class="string">'name'</span>].downcase</span><br><span class="line">            value = headers[<span class="string">'value'</span>]</span><br><span class="line">            request[name] = value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response_headers <span class="keyword">then</span></span><br><span class="line">        response_headers.each <span class="keyword">do</span> <span class="params">|headers|</span></span><br><span class="line">            name = headers[<span class="string">'name'</span>].downcase</span><br><span class="line">            value = headers[<span class="string">'value'</span>]</span><br><span class="line">            response[name] = value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.remove(<span class="string">"[suricata][eve][http][request_headers]"</span>)</span><br><span class="line">    event.remove(<span class="string">"[suricata][eve][http][response_headers]"</span>)</span><br><span class="line">    event.set(<span class="string">"[suricata][eve][http][request]"</span>, request)</span><br><span class="line">    event.set(<span class="string">"[suricata][eve][http][response]"</span>, response)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><ul>
<li>æ ‡å‡†åŒ–ä¹‹å‰çš„æ•°æ®ï¼š</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"request_headers"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"Connection"</span>,</span><br><span class="line">            <span class="attr">"value"</span>: <span class="string">"Keep-Alive"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"response_headers"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"Server"</span>,</span><br><span class="line">            <span class="attr">"value"</span>: <span class="string">"NWS_TCloud_S11"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ ‡å‡†åŒ–ä¹‹åçš„æ•°æ®ï¼š</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"request"</span>: &#123;</span><br><span class="line">            <span class="attr">"host"</span>: <span class="string">"192.168.199.1:25782"</span>,</span><br><span class="line">            <span class="attr">"connection"</span>: <span class="string">"Close"</span>,</span><br><span class="line">            <span class="attr">"cache-control"</span>: <span class="string">"no-cache"</span>,</span><br><span class="line">            <span class="attr">"pragma"</span>: <span class="string">"no-cache"</span>,</span><br><span class="line">            <span class="attr">"user-agent"</span>: <span class="string">"Microsoft-Windows/10.0 UPnP/1.0"</span>,</span><br><span class="line">            <span class="attr">"accept"</span>: <span class="string">"text/xml, application/xml"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"response"</span>: &#123;</span><br><span class="line">            <span class="attr">"ext"</span>: <span class="string">""</span>,</span><br><span class="line">            <span class="attr">"content-length"</span>: <span class="string">"2645"</span>,</span><br><span class="line">            <span class="attr">"server"</span>: <span class="string">"RT-N56U/3.4.3.9 UPnP/1.1 MiniUPnPd/2.0"</span>,</span><br><span class="line">            <span class="attr">"content-type"</span>: <span class="string">"text/xml; charset=\"utf-8\""</span>,</span><br><span class="line">            <span class="attr">"connection"</span>: <span class="string">"close"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-7-normalized-tls-for-suricata"><a href="#1-1-7-normalized-tls-for-suricata" class="headerlink" title="1.1.7 normalized-tls_for_suricata"></a>1.1.7 normalized-tls_for_suricata</h5><h6 id="Logstash-Config-6"><a href="#Logstash-Config-6" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-tls.conf" target="_blank" rel="noopener">normalized-tls_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][tls] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            uppercase =&gt; [</span><br><span class="line">                <span class="string">"[tls][server][hash][sha1]"</span></span><br><span class="line">            ]</span><br><span class="line">            split =&gt; &#123; </span><br><span class="line">                <span class="string">"[tls][server][hash][sha1]"</span> =&gt; <span class="string">":"</span></span><br><span class="line">            &#125;</span><br><span class="line">            join =&gt; &#123;</span><br><span class="line">                <span class="string">"[tls][server][hash][sha1]"</span> =&gt; <span class="string">""</span></span><br><span class="line">            &#125;</span><br><span class="line">            copy =&gt; &#123;</span><br><span class="line">                <span class="string">"[tls][server][hash][sha1]"</span> =&gt; <span class="string">"[related][hash]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="1-2-normalized-alarm-from-siem"><a href="#1-2-normalized-alarm-from-siem" class="headerlink" title="1.2 normalized-alarm_from_siem"></a>1.2 normalized-alarm_from_siem</h4><p>â€‹        é’ˆå¯¹alarmäº‹ä»¶è¿›è¡Œæ ‡å‡†åŒ–ï¼Œä¹Ÿå°±æ˜¯SIEMå‘å‡ºçš„æ•°æ®ã€‚å‚è€ƒä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<h5 id="1-2-1-normalized-alarm"><a href="#1-2-1-normalized-alarm" class="headerlink" title="1.2.1 normalized-alarm"></a>1.2.1 normalized-alarm</h5><p>â€‹        é€šç”¨alarmäº‹ä»¶æ ‡å‡†åŒ–é…ç½®ã€‚</p>
<h6 id="Logstash-Config-7"><a href="#Logstash-Config-7" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/70_normalized-siem.conf" target="_blank" rel="noopener">normalized-alarm.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    date &#123;</span><br><span class="line">        match =&gt; [<span class="string">"timestamp"</span>, <span class="string">"ISO8601"</span>]</span><br><span class="line">        target =&gt; <span class="string">"timestamp"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        rename =&gt; &#123;</span><br><span class="line">            <span class="string">"[data][source]"</span> =&gt; <span class="string">"source"</span></span><br><span class="line">            <span class="string">"[data][destination]"</span> =&gt; <span class="string">"destination"</span></span><br><span class="line">            <span class="string">"[data][network]"</span> =&gt; <span class="string">"network"</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">"[data][event]"</span> =&gt; <span class="string">"event"</span></span><br><span class="line">            <span class="string">"[data][fileset]"</span> =&gt; <span class="string">"fileset"</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">"[data][http]"</span> =&gt; <span class="string">"http"</span></span><br><span class="line">            <span class="string">"[data][url]"</span> =&gt; <span class="string">"url"</span></span><br><span class="line">            <span class="string">"[data][user_agent]"</span> =&gt; <span class="string">"user_agent"</span></span><br><span class="line"></span><br><span class="line">            <span class="string">"[data][related]"</span> =&gt; <span class="string">"related"</span></span><br><span class="line">            <span class="string">"[data][threat]"</span> =&gt; <span class="string">"threat"</span></span><br><span class="line"></span><br><span class="line">            <span class="string">"[rule][groups]"</span> =&gt; <span class="string">"[rule][ruleset]"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        convert =&gt; &#123;</span><br><span class="line">            <span class="comment">#"[agent][id]" =&gt; "integer"</span></span><br><span class="line"></span><br><span class="line">            <span class="string">"[event][severity]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line"></span><br><span class="line">            <span class="string">"[rule][id]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line"></span><br><span class="line">            <span class="string">"[related][rule][id]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line"></span><br><span class="line">            <span class="string">"[network][bytes]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line">            <span class="string">"[network][packets]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line"></span><br><span class="line">            <span class="string">"[source][port]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line">            <span class="string">"[source][bytes]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line">            <span class="string">"[source][packets]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line"></span><br><span class="line">            <span class="string">"[destination][port]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line">            <span class="string">"[destination][bytes]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line">            <span class="string">"[destination][packets]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line"></span><br><span class="line">            <span class="string">"[http][response][status_code]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line">            <span class="string">"[http][response][body][bytes]"</span> =&gt; <span class="string">"integer"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        remove_field =&gt; [</span><br><span class="line">            <span class="string">"beat"</span>, <span class="string">"input_type"</span>, <span class="string">"tags"</span>, <span class="string">"count"</span>, <span class="string">"@version"</span>,</span><br><span class="line">            <span class="string">"ecs"</span>, <span class="string">"log"</span>, <span class="string">"offset"</span>, <span class="string">"type"</span>, <span class="string">"host"</span>, <span class="string">"predecoder"</span>,</span><br><span class="line">            <span class="string">"decoder"</span>, <span class="string">"[data][rule]"</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        copy =&gt; &#123;</span><br><span class="line">            <span class="string">"[rule][description]"</span> =&gt; <span class="string">"[rule][name]"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">"alarm"</span> &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">"previous_output"</span> =&gt; <span class="string">"[related][event][log]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">                src_ip = event.get('[source][ip]')</span></span><br><span class="line"><span class="string">                dst_ip = event.get('[destination][ip]')</span></span><br><span class="line"><span class="string">                src_port = event.get('[source][port]').to_s</span></span><br><span class="line"><span class="string">                dst_port = event.get('[destination][port]').to_s</span></span><br><span class="line"><span class="string">                rule_name = event.get('[related][rule][name]')[0].to_s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                rule_description = src_ip + ':' + src_port + ' -&gt; ' + dst_ip + ':' + dst_port + ' -&gt; ' + rule_name</span></span><br><span class="line"><span class="string">                event.set('[rule][description]', rule_description)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if event.get('[related][rule][id]') then</span></span><br><span class="line"><span class="string">                    sid = event.get('[related][rule][id]')[0]</span></span><br><span class="line"><span class="string">                    event.set('[rule][uuid]', sid)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                event.set('[rule][category]', 'Frequency')</span></span><br><span class="line"><span class="string">            "</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-Enrichment"><a href="#2-Enrichment" class="headerlink" title="2. Enrichment"></a>2. Enrichment</h3><p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/enrichment-0.1.png" alt="image-20201208110506481"></p>
<hr>
<h4 id="2-1-enrichment-alert-to-siem"><a href="#2-1-enrichment-alert-to-siem" class="headerlink" title="2.1 enrichment_alert_to_siem"></a>2.1 enrichment_alert_to_siem</h4><p>â€‹        é’ˆå¯¹alertäº‹ä»¶è¿›è¡Œä¸°å¯ŒåŒ–ï¼Œä¹Ÿå°±æ˜¯å®‰å…¨è®¾å¤‡å‘å‡ºçš„åŸå§‹å®‰å…¨äº‹ä»¶ã€‚å‚è€ƒä¸Šå›¾ä¸­è“è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<h5 id="2-1-1-enrichment-alert-direction-for-suricata"><a href="#2-1-1-enrichment-alert-direction-for-suricata" class="headerlink" title="2.1.1 enrichment-alert_direction_for_suricata"></a>2.1.1 enrichment-alert_direction_for_suricata</h5><p>â€‹        ç”±äºä¸€äº›ç‰¹æ®ŠåŸå› ï¼Œæˆ‘ä¸å¾—ä¸å°†<strong>suricata.yaml</strong>é…ç½®æ–‡ä»¶ä¸­çš„<code>EXTERNAL_NET = any</code>ã€‚è¿™ä¹Ÿå¯¼è‡´äº†éƒ¨åˆ†Suricataå‘Šè­¦çš„è¯¯æŠ¥ï¼Œæ¯•ç«Ÿæ”¾å¼€äº†è§„åˆ™çš„æ–¹å‘è¿™ä¸ªæ”¶æ•›æ¡ä»¶ã€‚æ‰€ä»¥ï¼Œæˆ‘åˆ©ç”¨äº†Logstash åœ¨æ•°æ®å…¥åº“åˆ°SIEMä¹‹å‰åšäº†ä¸€å±‚è¿‡æ»¤ã€‚</p>
<h6 id="Logstash-Config-8"><a href="#Logstash-Config-8" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/72_enrichment-alert_direction.conf" target="_blank" rel="noopener">enrichment-alert_direction_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [rule][description] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">"/etc/logstash/scripts/add_direction.rb"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-1"><a href="#Ruby-Code-1" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/add_direction.rb" target="_blank" rel="noopener">enrichment-alert_direction_for_suricata.rb</a></strong><ul>
<li><em>è¿‡æ»¤è§¦å‘è§„åˆ™çš„IPä¸è§„åˆ™æ–¹å‘ä¸åŒ¹é…çš„å®‰å…¨äº‹ä»¶</em></li>
<li><em>å¢åŠ æ–¹å‘ä¸åŒºåŸŸçš„å­—æ®µï¼Œä¾¿äºåˆ†æäººå‘˜ç¬¬ä¸€æ—¶é—´è¯†åˆ«<strong>å†…å¯¹å†…</strong>ä»¥åŠ<strong>å†…å¯¹å¤–</strong>çš„å‘Šè­¦ã€‚</em></li>
</ul>
</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">"ipaddr"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">"[source][ip]"</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">"[destination][ip]"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> src_ip <span class="keyword">or</span> <span class="keyword">not</span> dst_ip <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    ipaddr_src = IPAddr.new src_ip</span><br><span class="line">    ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Sample: alert http $EXTERNAL_NET any -&gt; $HOME_NET any</span></span><br><span class="line">    rule = event.get(<span class="string">"[rule][description]"</span>)</span><br><span class="line">    src_direction = rule.split(<span class="string">" "</span>)[<span class="number">2</span>]</span><br><span class="line">    dst_direction = rule.split(<span class="string">" "</span>)[<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">    src_private = ipaddr_src.private?()</span><br><span class="line">    dst_private = ipaddr_dst.private?()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> event.get(<span class="string">"provider"</span>) == <span class="string">"Suricata"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> ( src_private ) <span class="keyword">and</span> ( src_direction == <span class="string">"$EXTERNAL_NET"</span> ) <span class="keyword">then</span></span><br><span class="line">            event.cancel</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( dst_private ) <span class="keyword">and</span> ( dst_direction == <span class="string">"$EXTERNAL_NET"</span> ) <span class="keyword">then</span></span><br><span class="line">            event.cancel</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> src_private <span class="keyword">and</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">"outbound"</span></span><br><span class="line">        zone = <span class="string">"internal"</span></span><br><span class="line">    <span class="keyword">elsif</span> src_private <span class="keyword">and</span> <span class="keyword">not</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">"outbound"</span></span><br><span class="line">        zone = <span class="string">"internal"</span></span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> src_private <span class="keyword">and</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">"inbound"</span></span><br><span class="line">        zone = <span class="string">"external"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        direction = <span class="string">"inbound"</span></span><br><span class="line">        zone = <span class="string">"external"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.set(<span class="string">"[network][direction]"</span>, direction)</span><br><span class="line">    event.set(<span class="string">"[network][zone]"</span>, zone)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-2-enrichment-related-domain-for-suricata"><a href="#2-1-2-enrichment-related-domain-for-suricata" class="headerlink" title="2.1.2 enrichment_related_domain_for_suricata"></a>2.1.2 enrichment_related_domain_for_suricata</h5><p>â€‹        ä¸ºäº†ä¾¿äºåæœŸåšå…³è”åˆ†æï¼Œå¢åŠ äº†æ”»å‡»è€…ä¸åŸŸåçš„å…³è”å­—æ®µã€‚</p>
<h6 id="Logstash-Config-9"><a href="#Logstash-Config-9" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/72_enrichment-related_domain.conf" target="_blank" rel="noopener">enrichment_related_domain_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [url][domain] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">                source_ip = event.get('[source][ip]')</span></span><br><span class="line"><span class="string">                url_domain = event.get('[url][domain]')</span></span><br><span class="line"><span class="string">                event.set('[related][domain]', [source_ip, url_domain])</span></span><br><span class="line"><span class="string">            "</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-3-add-geo-private-ip"><a href="#2-1-3-add-geo-private-ip" class="headerlink" title="2.1.3 add_geo-private_ip"></a>2.1.3 add_geo-private_ip</h5><p>â€‹        ä¸ºå†…ç½‘IPå¢åŠ åœ°ç†ä½ç½®æ ‡ç¤ºï¼Œä¸»è¦æ˜¯ä¸ºäº†<strong>Dashboard</strong>å±•ç¤ºçš„æ—¶å€™å¯ä»¥çœ‹åˆ°èµ„äº§åœ¨åœ°å›¾ä¸Šçš„åæ ‡ã€‚<strong>åœ°å›¾ç‚®ï¼ŸBIUBIUBIUï¼Ÿ</strong>ğŸ˜‚ã€‚ç”±äºä¸æ˜¯å¤–ç½‘IPæ²¡åŠæ³•åŠ è½½GeoIPè¿›è¡ŒåŒ¹é…ï¼Œè¿™é‡Œä½¿ç”¨äº†<strong>Translate</strong>è¿™ä¸ªæ’ä»¶æ¥è¿›è¡Œé…ç½®ã€‚</p>
<h6 id="Logstash-Conifg"><a href="#Logstash-Conifg" class="headerlink" title="Logstash Conifg"></a><strong>Logstash Conifg</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/70_enrichment-geo_private_ip.conf" target="_blank" rel="noopener">add-geo_private_ip.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">"/etc/logstash/scripts/private_ip_geo.yml"</span></span><br><span class="line">        field =&gt; <span class="string">"[source][ip]"</span></span><br><span class="line">        destination =&gt; <span class="string">"translation_geo"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">"translation_geo"</span></span><br><span class="line">        target =&gt; <span class="string">"[source][geo]"</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">"/etc/logstash/scripts/private_ip_asn.yml"</span></span><br><span class="line">        field =&gt; <span class="string">"[source][ip]"</span></span><br><span class="line">        destination =&gt; <span class="string">"translation_as"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">"translation_as"</span></span><br><span class="line">        target =&gt; <span class="string">"[source][as]"</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">"translation_geo"</span>, <span class="string">"translation_as"</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">"/etc/logstash/scripts/private_ip_geo.yml"</span></span><br><span class="line">        field =&gt; <span class="string">"[destination][ip]"</span></span><br><span class="line">        destination =&gt; <span class="string">"translation_geo"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">"translation_geo"</span></span><br><span class="line">        target =&gt; <span class="string">"[destination][geo]"</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">"/etc/logstash/scripts/private_ip_asn.yml"</span></span><br><span class="line">        field =&gt; <span class="string">"[destination][ip]"</span></span><br><span class="line">        destination =&gt; <span class="string">"translation_as"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">"translation_as"</span></span><br><span class="line">        target =&gt; <span class="string">"[destination][as]"</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">"translation_geo"</span>, <span class="string">"translation_as"</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Yaml"><a href="#Yaml" class="headerlink" title="Yaml"></a><strong>Yaml</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/private_ip_geo.yml" target="_blank" rel="noopener">private_ip_geo.yml</a></strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">'192.168.199.\d+'</span><span class="string">:</span> <span class="string">'&#123;"location":&#123;"lat":45.8491,"lon":-119.7143&#125;,"country_name":"China","country_iso_code":"CN","region_name":"Jiangsu","region_iso_code":"JS","city_name":"Nanjing"&#125;'</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/private_ip_asn.yml" target="_blank" rel="noopener">private_ip_asn.yml</a></strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">'192.168.199.\d+'</span><span class="string">:</span> <span class="string">'&#123;"number":4134,"organization.name":"CHINANET-BACKBONE"&#125;'</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/add-geo_ip-2.png" alt="image-20201209110617996"></p>
<p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/add-geo_ip-1.png" alt="image-20201208153642680"></p>
<hr>
<h5 id="2-1-4-add-geo-public-ip"><a href="#2-1-4-add-geo-public-ip" class="headerlink" title="2.1.4 add_geo-public_ip"></a>2.1.4 add_geo-public_ip</h5><p>â€‹    å¤–ç½‘IPå°±æ¯”è¾ƒå¥½æå®šäº†ç›´æ¥åŠ è½½GeoIPæ•°æ®å³å¯ã€‚</p>
<h6 id="Logstash-Conifg-1"><a href="#Logstash-Conifg-1" class="headerlink" title="Logstash Conifg"></a><strong>Logstash Conifg</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/71_enrichment-geo_public_ip.conf" target="_blank" rel="noopener">add-geo_public_ip.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> ! [<span class="built_in">source</span>][geo] &#123;</span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">"[source][ip]"</span></span><br><span class="line">            target =&gt; <span class="string">"[source][geo]"</span></span><br><span class="line">            fields =&gt; [<span class="string">"city_name"</span>, <span class="string">"country_name"</span>, <span class="string">"country_code2"</span>, <span class="string">"region_name"</span>, <span class="string">"region_code"</span>, <span class="string">"location"</span>]</span><br><span class="line">            database =&gt; <span class="string">"/etc/logstash/GeoLite2-City.mmdb"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">"[source][ip]"</span></span><br><span class="line">            target =&gt; <span class="string">"[source][as]"</span></span><br><span class="line">            fields =&gt; [<span class="string">"autonomous_system_organization"</span>, <span class="string">"autonomous_system_number"</span>]</span><br><span class="line">            database =&gt; <span class="string">"/etc/logstash/GeoLite2-ASN.mmdb"</span></span><br><span class="line">            default_database_type =&gt; <span class="string">"ASN"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> ! [destination][geo] &#123;</span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">"[destination][ip]"</span></span><br><span class="line">            target =&gt; <span class="string">"[destination][geo]"</span></span><br><span class="line">            fields =&gt; [<span class="string">"city_name"</span>, <span class="string">"country_name"</span>, <span class="string">"country_code2"</span>, <span class="string">"region_name"</span>, <span class="string">"region_code"</span>, <span class="string">"location"</span>]</span><br><span class="line">            database =&gt; <span class="string">"/etc/logstash/GeoLite2-City.mmdb"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">"[destination][ip]"</span></span><br><span class="line">            target =&gt; <span class="string">"[destination][as]"</span></span><br><span class="line">            fields =&gt; [<span class="string">"autonomous_system_organization"</span>, <span class="string">"autonomous_system_number"</span>]</span><br><span class="line">            database =&gt; <span class="string">"/etc/logstash/GeoLite2-ASN.mmdb"</span></span><br><span class="line">            default_database_type =&gt; <span class="string">"ASN"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        rename =&gt; [<span class="string">"[source][geo][country_code2]"</span>, <span class="string">"[source][geo][country_iso_code]"</span>]</span><br><span class="line">        rename =&gt; [<span class="string">"[source][geo][region_code]"</span>, <span class="string">"[source][geo][region_iso_code]"</span>]</span><br><span class="line">        rename =&gt; [<span class="string">"[source][as][asn]"</span>, <span class="string">"[source][as][number]"</span>]</span><br><span class="line">        rename =&gt; [<span class="string">"[source][as][as_org]"</span>, <span class="string">"[source][as][organization.name]"</span>]</span><br><span class="line">        rename =&gt; [<span class="string">"[destination][geo][country_code2]"</span>, <span class="string">"[destination][geo][country_iso_code]"</span>]</span><br><span class="line">        rename =&gt; [<span class="string">"[destination][geo][region_code]"</span>, <span class="string">"[destination][geo][region_iso_code]"</span>]</span><br><span class="line">        rename =&gt; [<span class="string">"[destination][as][asn]"</span>, <span class="string">"[destination][as][number]"</span>]</span><br><span class="line">        rename =&gt; [<span class="string">"[destination][as][as_org]"</span>, <span class="string">"[destination][as][organization.name]"</span>]</span><br><span class="line"></span><br><span class="line">        remove_tag =&gt; [ <span class="string">"_geoip_lookup_failure"</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="2-2-enrichment-alarm-from-siem"><a href="#2-2-enrichment-alarm-from-siem" class="headerlink" title="2.2 enrichment-alarm_from_siem"></a>2.2 enrichment-alarm_from_siem</h4><p>â€‹        é’ˆå¯¹alarmäº‹ä»¶è¿›è¡Œä¸°å¯ŒåŒ–ï¼Œä¹Ÿå°±æ˜¯SIEMå‘å‡ºçš„æ•°æ®ã€‚ä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<h5 id="2-2-1-enrichment-related-event-id-for-wazuh"><a href="#2-2-1-enrichment-related-event-id-for-wazuh" class="headerlink" title="2.2.1 enrichment-related_event_id_for_wazuh"></a>2.2.1 enrichment-related_event_id_for_wazuh</h5><p>â€‹    ä¸ºSIEMå‘Šè­¦å¢åŠ äº†<strong>Hunting</strong>çš„åŠŸèƒ½ï¼Œé€šè¿‡è¯¥åŠŸèƒ½å¯ç›´æ¥æº¯æºåˆ°è§¦å‘alarmçš„æ‰€æœ‰alertäº‹ä»¶ã€‚</p>
<h6 id="Logstash-Config-10"><a href="#Logstash-Config-10" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-related.conf" target="_blank" rel="noopener"><strong>enrichment-related_event_id_for_wazuh.conf</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">"alarm"</span> and [related][event][<span class="built_in">log</span>] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">"/etc/logstash/scripts/add_related_event_id.rb"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-2"><a href="#Ruby-Code-2" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/add_related_event_id.rb" target="_blank" rel="noopener">enrichment-related_event_id_for_wazuh.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">"json"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    @pattern = <span class="regexp">/(?:\\n)?\w+ \d+ \d+:\d+:\d+ logstash NORMALIZED\[-\]: /</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    event_id = []</span><br><span class="line">    rule_id = []</span><br><span class="line">    rule_name = []</span><br><span class="line">    event_log = event.get(<span class="string">'[related][event][log]'</span>)</span><br><span class="line"></span><br><span class="line">    atomic_rules = event_log.split(@pattern)[<span class="number">1</span> .. -<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> atomic <span class="keyword">in</span> atomic_rules <span class="keyword">do</span></span><br><span class="line">        e_id = JSON.parse(atomic)[<span class="string">'event'</span>][<span class="string">'id'</span>]</span><br><span class="line">        r_id = JSON.parse(atomic)[<span class="string">'rule'</span>][<span class="string">'id'</span>]</span><br><span class="line">        r_name = JSON.parse(atomic)[<span class="string">'rule'</span>][<span class="string">'name'</span>]</span><br><span class="line"></span><br><span class="line">        event_id.push(e_id)</span><br><span class="line">        rule_id.push(r_id)</span><br><span class="line">        rule_name.push(r_name)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    event.set(<span class="string">'[related][event][id]'</span>, event_id)</span><br><span class="line">    event.set(<span class="string">'[related][rule][id]'</span>, rule_id)</span><br><span class="line">    event.set(<span class="string">'[related][rule][name]'</span>, rule_name)</span><br><span class="line">    event.remove(<span class="string">'[related][event][log]'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><p>â€‹        ä»¥ä¸‹æ˜¯ä¸€ä¸ªWazuhèšåˆå‘Šè­¦ï¼Œåˆ†æäººå‘˜é€šè¿‡ç‚¹å‡»<code>threat.hunting.event.id</code>å­—æ®µå³å¯æº¯æºå‡ºè§¦å‘è¯¥èšåˆè§„åˆ™çš„åº•å±‚alertäº‹ä»¶ã€‚</p>
<p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/canon/Documents/Blog/source/_posts/2020-%E6%80%BB%E7%BB%93/hunting-alarm.png" alt="image-20201204175051910"></p>
<p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/hunting-alert.png" alt="image-20201204175244182"></p>
<hr>
<h3 id="3-Threat-Intelligence"><a href="#3-Threat-Intelligence" class="headerlink" title="3. Threat Intelligence"></a>3. Threat Intelligence</h3><p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/threat-intelligence-0.3.png" alt="image-20201207111416997"></p>
<h4 id="3-1-threatIntel-alert-to-siem"><a href="#3-1-threatIntel-alert-to-siem" class="headerlink" title="3.1 threatIntel_alert_to_siem"></a>3.1 threatIntel_alert_to_siem</h4><p>â€‹        é€šè¿‡LogstashåŠ è½½Rubyè„šæœ¬ï¼Œå°†IoCæ¨é€è‡³Redisã€‚ä¸ºäº†é¿å…é‡å¤æ¨é€ï¼Œæ¯ä¸ªIoCéƒ½ä¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤7å¤©ï¼‰ã€‚å¦‚ä¸Šå›¾ä¸­è“è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†ï¼›</p>
<h5 id="3-1-1-add-ti-shodan"><a href="#3-1-1-add-ti-shodan" class="headerlink" title="3.1.1 add-ti_shodan"></a>3.1.1 add-ti_shodan</h5><p>â€‹        å¯¹äºæ”»å‡»è¿‡æˆ‘ä»¬çš„IPåœ°å€æˆ‘ä»¬éƒ½ä¼šåˆ©ç”¨<strong>Shodan</strong>è¿›è¡Œåå‘æ¢æµ‹ï¼Œæ”¶é›†ä¸€æ³¢æ”»å‡»è€…ï¼ˆè‚‰é¸¡ï¼‰çš„èµ„äº§ä¿¡æ¯ï¼Œç•™ç»™åé¢åˆ†æäººå‘˜ç”¨ã€‚ç”±äºå·²ç»è®¾ç½®äº†IoCè¶…æ—¶æ—¶é—´ï¼Œæ‰€ä»¥åœ¨è¶…æ—¶ä¹‹å‰IoCä¸ä¼šé‡å¤æ¨é€ã€‚å½“ç„¶ï¼Œå•ä¸ªKeyè°ƒç”¨APIé¢‘ç‡è¿˜æ˜¯è¦æ§åˆ¶ä¸€ä¸‹çš„ï¼Œä¸è¿‡ä½ å¯ä»¥é€‰æ‹©å¤šä¸ªKeyå“¦ã€‚<strong>ä½ æ‡‚çš„</strong>ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</p>
<h6 id="Logstash-Config-11"><a href="#Logstash-Config-11" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-ti_shodan.conf" target="_blank" rel="noopener">add-ti_shodan.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">"siem_events"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"siem_events"</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">"/etc/logstash/scripts/siem-ti_shodan.rb"</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">"host"</span> =&gt; <span class="string">"127.0.0.1"</span></span><br><span class="line">                <span class="string">"port"</span> =&gt; 6379</span><br><span class="line">                <span class="string">"password"</span> =&gt; <span class="string">"HelloWorld"</span></span><br><span class="line"></span><br><span class="line">                <span class="string">"ti_db"</span> =&gt; 1</span><br><span class="line">                <span class="string">"alert_prefix"</span> =&gt; <span class="string">"alert:"</span></span><br><span class="line">                <span class="string">"expire"</span> =&gt; 86400</span><br><span class="line"></span><br><span class="line">                <span class="string">"spider_db"</span> =&gt; 5</span><br><span class="line">                <span class="string">"spider_key"</span> =&gt; <span class="string">"spider:shodan:ioc"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-3"><a href="#Ruby-Code-3" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-ti_shodan.rb" target="_blank" rel="noopener">add-ti_shodan.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">"json"</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"redis"</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"ipaddr"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    @expire = params[<span class="string">"expire"</span>]</span><br><span class="line">    @alert = params[<span class="string">"alert_prefix"</span>]</span><br><span class="line">    @alarm = params[<span class="string">"alarm_prefix"</span>]</span><br><span class="line">    @spider_key = params[<span class="string">"spider_key"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># connect to redis</span></span><br><span class="line">    @ti_redis = Redis.new(<span class="symbol">host:</span>params[<span class="string">"host"</span>], <span class="symbol">port:</span>params[<span class="string">"port"</span>], <span class="symbol">password:</span>params[<span class="string">"password"</span>], <span class="symbol">db:</span>params[<span class="string">"ti_db"</span>])</span><br><span class="line">    @spider_redis = Redis.new(<span class="symbol">host:</span>params[<span class="string">"host"</span>], <span class="symbol">port:</span>params[<span class="string">"port"</span>], <span class="symbol">password:</span>params[<span class="string">"password"</span>], <span class="symbol">db:</span>params[<span class="string">"spider_db"</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">"[source][ip]"</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">"[destination][ip]"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        ipaddr_src = IPAddr.new src_ip</span><br><span class="line">        ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line">    <span class="keyword">rescue</span> Exception =&gt; e</span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ipaddr_src.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = src_ip</span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> ipaddr_dst.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = dst_ip</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> [event]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> event.get(<span class="string">"[event][kind]"</span>) == <span class="string">"alert"</span> <span class="keyword">then</span></span><br><span class="line">        alert_ioc = @alert + ioc</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> @ti_redis.exists?(alert_ioc) <span class="keyword">then</span></span><br><span class="line">            @ti_redis.setex(alert_ioc, @expire, <span class="literal">true</span>)</span><br><span class="line">            @spider_redis.lpush(@spider_key, ioc)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="3-2-threatIntel-alarm-from-siem"><a href="#3-2-threatIntel-alarm-from-siem" class="headerlink" title="3.2 threatIntel_alarm_from_siem"></a>3.2 threatIntel_alarm_from_siem</h4><p>â€‹        é€šè¿‡Logstashè¿›è¡Œå¨èƒæƒ…æŠ¥æ•°æ®çš„ä¸°å¯ŒåŒ–ã€‚å¦‚ä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†ï¼›</p>
<h5 id="3-2-1-add-ti-tags-from-shodan"><a href="#3-2-1-add-ti-tags-from-shodan" class="headerlink" title="3.2.1 add-ti_tags_from_shodan"></a>3.2.1 add-ti_tags_from_shodan</h5><p>â€‹        å°†Shodan IoCæƒ…æŠ¥æ•°æ®ä¸°å¯ŒåŒ–è‡³alarmã€‚</p>
<h6 id="Logstash-Config-12"><a href="#Logstash-Config-12" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-ti_shodan.conf" target="_blank" rel="noopener">add-ti_tags_from_shodan.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">"alarm"</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">"/etc/logstash/scripts/ti_shodan.rb"</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">"host"</span> =&gt; <span class="string">"127.0.0.1"</span></span><br><span class="line">                <span class="string">"port"</span> =&gt; 6379</span><br><span class="line">                <span class="string">"password"</span> =&gt; <span class="string">"HelloWorld"</span></span><br><span class="line">                <span class="string">"ti_db"</span> =&gt; 1</span><br><span class="line">                <span class="string">"alarm_prefix"</span> =&gt; <span class="string">"alarm:"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-4"><a href="#Ruby-Code-4" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-ti_shodan.rb" target="_blank" rel="noopener">add-ti_tags_from_shodan.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">"json"</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"redis"</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"ipaddr"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    @alarm = params[<span class="string">"alarm_prefix"</span>]</span><br><span class="line">    <span class="comment"># connect to redis</span></span><br><span class="line">    @ti_redis = Redis.new(<span class="symbol">host:</span>params[<span class="string">"host"</span>], <span class="symbol">port:</span>params[<span class="string">"port"</span>], <span class="symbol">password:</span>params[<span class="string">"password"</span>], <span class="symbol">db:</span>params[<span class="string">"ti_db"</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">"[source][ip]"</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">"[destination][ip]"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        ipaddr_src = IPAddr.new src_ip</span><br><span class="line">        ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line">    <span class="keyword">rescue</span> Exception =&gt; e</span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ipaddr_src.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = src_ip</span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> ipaddr_dst.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = dst_ip</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> [event]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    raw_data = @ti_redis.get(@alarm + ioc)</span><br><span class="line">    <span class="keyword">if</span> raw_data <span class="keyword">then</span></span><br><span class="line">        data = JSON.parse(raw_data)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">then</span></span><br><span class="line">            event.set(<span class="string">"[threat][hunting][services]"</span>, data[<span class="string">"services"</span>])</span><br><span class="line">            event.set(<span class="string">"[threat][hunting][vulns]"</span>, data[<span class="string">"vulns"</span>])</span><br><span class="line">            event.set(<span class="string">"[threat][hunting][ports]"</span>, data[<span class="string">"ports"</span>])</span><br><span class="line">            event.set(<span class="string">"[threat][hunting][hostnames]"</span>, data[<span class="string">"hostnames"</span>])</span><br><span class="line">            event.set(<span class="string">"[threat][hunting][domains]"</span>, data[<span class="string">"domains"</span>])</span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">"details"</span>] <span class="keyword">then</span></span><br><span class="line">                details = data[<span class="string">"details"</span>].to_json</span><br><span class="line">                event.set(<span class="string">"[threat][hunting][details]"</span>, details)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"threat"</span>: &#123;</span><br><span class="line">        <span class="attr">"hunting"</span>: &#123;</span><br><span class="line">            <span class="attr">"vulns"</span>: [</span><br><span class="line">                <span class="string">"CVE-2019-0220"</span>,</span><br><span class="line">                <span class="string">"CVE-2019-0197"</span>,</span><br><span class="line">                <span class="string">"CVE-2019-0196"</span>,</span><br><span class="line">                <span class="string">"CVE-2018-1302"</span>,</span><br><span class="line">                <span class="string">"CVE-2019-0211"</span>,</span><br><span class="line">                <span class="string">"CVE-2017-15710"</span>,</span><br><span class="line">                <span class="string">"CVE-2018-1301"</span>,</span><br><span class="line">                <span class="string">"CVE-2018-1283"</span>,</span><br><span class="line">                <span class="string">"CVE-2018-1303"</span>,</span><br><span class="line">                <span class="string">"CVE-2017-15715"</span>,</span><br><span class="line">                <span class="string">"CVE-2018-1333"</span>,</span><br><span class="line">                <span class="string">"CVE-2018-17199"</span>,</span><br><span class="line">                <span class="string">"CVE-2018-11763"</span>,</span><br><span class="line">                <span class="string">"CVE-2018-1312"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"domains"</span>: [],</span><br><span class="line">            <span class="attr">"ports"</span>: [</span><br><span class="line">                <span class="number">8888</span>,</span><br><span class="line">                <span class="number">80</span>,</span><br><span class="line">                <span class="number">8080</span>,</span><br><span class="line">                <span class="number">8090</span>,</span><br><span class="line">                <span class="number">22</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"details"</span>: <span class="string">"&#123;\"tcp\":[&#123;\"http-simple-new\":8888,\"Apache httpd\":\"2.4.29\"&#125;,&#123;\"http\":80,\"Apache httpd\":\"2.4.29\"&#125;,&#123;\"http\":8080,\"Apache httpd\":\"2.4.29\"&#125;,&#123;\"http-simple-new\":8090&#125;,&#123;\"ssh\":22,\"OpenSSH\":\"7.6p1 Ubuntu-4ubuntu0.3\"&#125;],\"udp\":[]&#125;"</span>,</span><br><span class="line">            <span class="attr">"hostnames"</span>: [],</span><br><span class="line">            <span class="attr">"services"</span>: [</span><br><span class="line">                <span class="string">"http-simple-new"</span>,</span><br><span class="line">                <span class="string">"ssh"</span>,</span><br><span class="line">                <span class="string">"http"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/threat.hunting.shodan-1.png" alt="image-20201205151011258"></p>
<p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/threat.hunting.shodan-2.png" alt="image-20201205150744102"></p>
<h5 id="3-2-2-add-ti-tags"><a href="#3-2-2-add-ti-tags" class="headerlink" title="3.2.2 add-ti_tags"></a>3.2.2 add-ti_tags</h5><p>â€‹    è¿™éƒ¨åˆ†é€šå¸¸æ˜¯å¯¹æ¥çš„è‡ªæœ‰æƒ…æŠ¥ï¼ˆ<em>æˆ‘ä»¬ä¼šæ”¶é›†æ”»å‡»è¿‡æˆ‘ä»¬çš„IPï¼Œå»ºç«‹é€‚ç”¨äºè‡ªå·±çš„å†…éƒ¨æƒ…æŠ¥ã€‚</em>ï¼‰ä»¥åŠå¼€æºæƒ…æŠ¥ã€‚åŸåˆ™ä¸ŠSIEMäº§ç”Ÿçš„alarmäº‹ä»¶å¹¶ä¸ä¼šå¾ˆå¤šï¼Œæ‰€ä»¥è¿™è¾¹ç›´æ¥ä»Elasticè·å–äº†æƒ…æŠ¥æ•°æ®è¿›è¡Œå‘Šè­¦çš„ä¸°å¯ŒåŒ–ã€‚å¦‚æœalarmäº‹ä»¶å¾ˆå¤šçš„è¯ï¼Œå»ºè®®ä¹Ÿæ˜¯æ”¾åœ¨Redisæˆ–è€…å†è€ƒè™‘å…¶ä»–æ–¹æ¡ˆã€‚è¿‘æœŸå‡†å¤‡é‡‡è´­å•†ä¸šæƒ…æŠ¥ï¼ŒåæœŸå°†ä¼šæœ‰ä¸€ä¸ªå•†ä¸šæƒ…æŠ¥çš„å¯¹æ¥è¿‡ç¨‹ã€‚</p>
<h6 id="Logstash-Config-13"><a href="#Logstash-Config-13" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-ti_tags.conf" target="_blank" rel="noopener">add-ti_tags.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">"alarm"</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">"/etc/logstash/scripts/siem-ti_tags.rb"</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">"index"</span> =&gt; <span class="string">"ecs-ti-*"</span></span><br><span class="line">                <span class="string">"urls"</span> =&gt; <span class="string">"https://elastic:HelloWorld@127.0.0.1:9200"</span></span><br><span class="line">                <span class="string">"ca"</span> =&gt; <span class="string">"ca.crt"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-5"><a href="#Ruby-Code-5" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/ti_tags.rb" target="_blank" rel="noopener">add-ti_tags.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'json'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'elasticsearch'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    @urls = params[<span class="string">"urls"</span>]</span><br><span class="line">    @index = params[<span class="string">"index"</span>]</span><br><span class="line">    @ca = params[<span class="string">"ca"</span>]</span><br><span class="line">    @client = Elasticsearch::Client.new <span class="symbol">urls:</span> @urls, <span class="symbol">transport_options:</span> &#123; <span class="symbol">ssl:</span> &#123; <span class="symbol">ca_file:</span> @ca &#125; &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    ioc = event.get(<span class="string">'[source][ip]'</span>)</span><br><span class="line">    query = &#123;</span><br><span class="line">        <span class="string">"_source"</span>: &#123;</span><br><span class="line">            <span class="string">"includes"</span>: [</span><br><span class="line">                <span class="string">"threat.tags"</span>,</span><br><span class="line">                <span class="string">"threat.provider"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"query"</span>: &#123;</span><br><span class="line">            <span class="string">"bool"</span>: &#123;</span><br><span class="line">                <span class="string">"must"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"terms"</span>: &#123;</span><br><span class="line">                            <span class="string">"threat.type"</span>: [</span><br><span class="line">                                <span class="string">"ipv4"</span>,</span><br><span class="line">                                <span class="string">"ip"</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"term"</span>: &#123;</span><br><span class="line">                            <span class="string">"threat.ioc"</span>: ioc</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"filter"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"range"</span>: &#123;</span><br><span class="line">                            <span class="string">"threat.creation_time"</span>: &#123;</span><br><span class="line">                                <span class="string">"gte"</span>: <span class="string">"now-7d"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"size"</span>: <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = @client.search <span class="symbol">index:</span> @index, <span class="symbol">body:</span> query.to_json</span><br><span class="line"></span><br><span class="line">    tags = []</span><br><span class="line">    providers = []</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> response[<span class="string">'hits'</span>][<span class="string">'hits'</span>].empty? <span class="keyword">then</span></span><br><span class="line">        response[<span class="string">'hits'</span>][<span class="string">'hits'</span>].each <span class="keyword">do</span> <span class="params">|result|</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> providers.<span class="keyword">include</span>?(result[<span class="string">"_source"</span>][<span class="string">"threat"</span>][<span class="string">"provider"</span>])</span><br><span class="line">                providers.push(result[<span class="string">"_source"</span>][<span class="string">"threat"</span>][<span class="string">"provider"</span>])</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            tags = tags - result[<span class="string">"_source"</span>][<span class="string">"threat"</span>][<span class="string">"tags"</span>]</span><br><span class="line">            tags = tags + result[<span class="string">"_source"</span>][<span class="string">"threat"</span>][<span class="string">"tags"</span>]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.set(<span class="string">'[threat][intelligence][tags]'</span>, tags)</span><br><span class="line">    event.set(<span class="string">'[threat][intelligence][providers]'</span>, providers)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-4"><a href="#ç¤ºä¾‹-4" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/canon/Documents/Blog/source/_posts/2020-%E6%80%BB%E7%BB%93/threat.hunting.shodan-3.png" alt="image-20201208144650226"></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"threat"</span>: &#123;</span><br><span class="line">        <span class="attr">"intelligence"</span>: &#123;</span><br><span class="line">            <span class="attr">"providers"</span>: [</span><br><span class="line">                <span class="string">"NTA"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"tags"</span>: [</span><br><span class="line">                <span class="string">"WebAttack"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Filter"><a href="#4-Filter" class="headerlink" title="4. Filter"></a>4. Filter</h3><p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/blacklist-1.png" alt="image-20201207153152332"></p>
<h4 id="4-1-alert-to-siem"><a href="#4-1-alert-to-siem" class="headerlink" title="4.1 alert_to_siem"></a>4.1 alert_to_siem</h4><h5 id="4-1-1-filter-ip-from-alert"><a href="#4-1-1-filter-ip-from-alert" class="headerlink" title="4.1.1 filter_ip_from_alert"></a>4.1.1 filter_ip_from_alert</h5><p>â€‹        å®é™…ä½¿ç”¨åœºæ™¯ä¸­éœ€è¦å¯¹ä¸€äº›ç™½åå•IPã€ç‰¹å®šç­¾åè§„åˆ™è¿›è¡Œè¿‡æ»¤ã€‚è¿™ä¹ˆåšä¹Ÿæ˜¯ä¸ºäº†ä¿è¯SIEMçš„æ€§èƒ½ä»¥åŠå‘Šè­¦çš„å¯é æ€§ã€‚è¿™éƒ¨åˆ†æ•°æ®ä¾æ—§ä¼šå‘é€åˆ°Elasticä½œä¸ºå†å²æ•°æ®ç•™å­˜ï¼Œä½†ä¸ä¼šè¢«SIEMæ¶ˆè´¹å¹¶äº§ç”Ÿå‘Šè­¦ã€‚</p>
<h6 id="Logstash-Config-14"><a href="#Logstash-Config-14" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><p>â€‹    åˆ©ç”¨<strong>Clone</strong>æ’ä»¶ï¼Œå°†éœ€è¦è¢«SIEMæ¶ˆè´¹çš„æ•°æ®ç»ç”±è„šæœ¬è¿‡æ»¤ã€‚</p>
<ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-siem_events.conf" target="_blank" rel="noopener">filter_ip_from_alert.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">"siem_events"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"siem_events"</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">"/etc/logstash/scripts/siem-filter_ip.rb"</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">"host"</span> =&gt; <span class="string">"127.0.0.1"</span></span><br><span class="line">                <span class="string">"port"</span> =&gt; 6379</span><br><span class="line">                <span class="string">"password"</span> =&gt; <span class="string">"HelloWorld"</span></span><br><span class="line">                <span class="string">"cdn_db"</span> =&gt; 3</span><br><span class="line">                <span class="string">"scan_db"</span> =&gt; 4</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-6"><a href="#Ruby-Code-6" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-filter_ip.rb" target="_blank" rel="noopener">filter_ip_from_alert.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">"redis"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        @cdn_db = Redis.new(<span class="symbol">host:</span>params[<span class="string">"host"</span>], <span class="symbol">port:</span>params[<span class="string">"port"</span>], <span class="symbol">password:</span>params[<span class="string">"password"</span>], <span class="symbol">db:</span>params[<span class="string">"cdn_db"</span>])</span><br><span class="line">        @scan_db = Redis.new(<span class="symbol">host:</span>params[<span class="string">"host"</span>], <span class="symbol">port:</span>params[<span class="string">"port"</span>], <span class="symbol">password:</span>params[<span class="string">"password"</span>], <span class="symbol">db:</span>params[<span class="string">"scan_db"</span>])</span><br><span class="line">    <span class="keyword">rescue</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">"[source][ip]"</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">"[destination][ip]"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> @cdn_db.exists?(src_ip) <span class="params">||</span> @cdn_db.exists?(dst_ip) <span class="params">||</span> @scan_db.exists?(src_ip) <span class="params">||</span> @scan_db.exists?(dst_ip) <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="4-1-2-filter-sid-from-alert"><a href="#4-1-2-filter-sid-from-alert" class="headerlink" title="4.1.2 filter_sid_from_alert"></a>4.1.2 filter_sid_from_alert</h5><h6 id="Logstash-Config-15"><a href="#Logstash-Config-15" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-siem_events.conf" target="_blank" rel="noopener">filter_sid_from_alert.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">"siem_events"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"siem_events"</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">"/etc/logstash/scripts/siem-filter_sid.rb"</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">"host"</span> =&gt; <span class="string">"127.0.0.1"</span></span><br><span class="line">                <span class="string">"port"</span> =&gt; 6379</span><br><span class="line">                <span class="string">"password"</span> =&gt; <span class="string">"HelloWorld"</span></span><br><span class="line">                <span class="string">"sid_db"</span> =&gt; 2</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-7"><a href="#Ruby-Code-7" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-filter_sid.rb" target="_blank" rel="noopener">filter_sid_from_alert.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">"redis"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    @signature_id = Redis.new(<span class="symbol">host:</span>params[<span class="string">"host"</span>], <span class="symbol">port:</span>params[<span class="string">"port"</span>], <span class="symbol">password:</span>params[<span class="string">"password"</span>], <span class="symbol">db:</span>params[<span class="string">"sid_db"</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    sid = event.get(<span class="string">"[rule][id]"</span>)</span><br><span class="line">    <span class="keyword">if</span> @signature_id.exists?(sid) <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="4-2-alarm-from-siem"><a href="#4-2-alarm-from-siem" class="headerlink" title="4.2 alarm_from_siem"></a>4.2 alarm_from_siem</h4><h5 id="4-2-1-update-action-from-alarm"><a href="#4-2-1-update-action-from-alarm" class="headerlink" title="4.2.1 update_action_from_alarm"></a>4.2.1 update_action_from_alarm</h5><p>â€‹        æ›´æ–°åŒ¹é…åˆ°çš„<code>rule.id</code>äº‹ä»¶ï¼Œå°†<code>event.action</code>å€¼æ›´æ–°ä¸ºï¼š<code>block</code>ã€‚ä¾¿äºåæœŸè¢«SIEMè”åŠ¨æ¨¡å—â€œæ¶ˆè´¹â€ã€‚å¦‚ä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†ã€‚ä¸»è¦æ˜¯ä¸ºäº†é€šè¿‡<code>event.action</code>å­—æ®µæ¥åŒºåˆ†SIEMåšçš„è‡ªåŠ¨åŒ–æ“ä½œã€‚</p>
<h6 id="Logstash-Config-16"><a href="#Logstash-Config-16" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_update-siem_action.conf" target="_blank" rel="noopener">update-action_from_alarm.conf</a></strong></li>
</ul>
<p>â€‹    é’ˆå¯¹æŒ‡å®š<code>rule.id</code>äº‹ä»¶ï¼Œå°†<code>allowed</code>å€¼æ›´æ–°ä¸ºï¼š<code>block</code>ã€‚ä¾¿äºåæœŸè¢«è”åŠ¨æ¨¡å—â€œæ¶ˆè´¹â€ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        update =&gt; &#123;</span><br><span class="line">            <span class="string">"[event][action]"</span> =&gt; <span class="string">"allowed"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ruby &#123;</span><br><span class="line">        path =&gt; <span class="string">"/etc/logstash/scripts/siem-update_action.rb"</span></span><br><span class="line">        script_params =&gt; &#123;</span><br><span class="line">            <span class="string">"host"</span> =&gt; <span class="string">"127.0.0.1"</span></span><br><span class="line">            <span class="string">"port"</span> =&gt; 6379</span><br><span class="line">            <span class="string">"password"</span> =&gt; <span class="string">"HelloWorld"</span></span><br><span class="line">            <span class="string">"siem_action_db"</span> =&gt; 7</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-8"><a href="#Ruby-Code-8" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-update_action.rb" target="_blank" rel="noopener">update_action_from_alarm.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">"redis"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        @siem_action_db = Redis.new(<span class="symbol">host:</span>params[<span class="string">"host"</span>], <span class="symbol">port:</span>params[<span class="string">"port"</span>], <span class="symbol">password:</span>params[<span class="string">"password"</span>], <span class="symbol">db:</span>params[<span class="string">"siem_action_db"</span>])</span><br><span class="line">    <span class="keyword">rescue</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    rule_id = event.get(<span class="string">"[rule][id]"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> @siem_action_db.exists?(rule_id) <span class="keyword">then</span></span><br><span class="line">        event.set(<span class="string">"[event][action]"</span>, <span class="string">"block"</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹ï¼š"><a href="#ç¤ºä¾‹ï¼š" class="headerlink" title="ç¤ºä¾‹ï¼š"></a><strong>ç¤ºä¾‹ï¼š</strong></h6><p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/update_action-0.1.png" alt="image-20201207111416997"></p>
<hr>
<h2 id="3-ä»ªè¡¨ç›˜"><a href="#3-ä»ªè¡¨ç›˜" class="headerlink" title="3. ä»ªè¡¨ç›˜"></a>3. ä»ªè¡¨ç›˜</h2><h3 id="SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜"><a href="#SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜" class="headerlink" title="SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜"></a>SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜</h3><p>![image-20201209162914285](./2020-æ€»ç»“/Dashboard SIEM Alarm ECS.png)</p>
<h3 id="å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜-å®‰å…¨æº¯æº"><a href="#å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜-å®‰å…¨æº¯æº" class="headerlink" title="å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜ (å®‰å…¨æº¯æº)"></a>å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜ (å®‰å…¨æº¯æº)</h3><p>![ä¼ä¸šå¾®ä¿¡æˆªå›¾_d52ab85a-1ddc-4294-8d2a-0c5075d06ac3(/Users/canon/Documents/Blog/source/_posts/2020-æ€»ç»“/Dashboard SIEM Alert ECS.png)](./2020-æ€»ç»“/Dashboard SIEM Alert ECS.png)</p>
<h3 id="æ•æ„Ÿæ¥å£ç›‘æ§"><a href="#æ•æ„Ÿæ¥å£ç›‘æ§" class="headerlink" title="æ•æ„Ÿæ¥å£ç›‘æ§"></a>æ•æ„Ÿæ¥å£ç›‘æ§</h3><p><img src="/2021/02/02/è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰/login_audit.png" alt="image-20201214112856076"></p>
]]></content>
      <categories>
        <category>SIEM</category>
      </categories>
      <tags>
        <tag>SIEM</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸º Elastalert å¢åŠ  å‚æ•°éå†ã€å‘¨æœŸæ€§æ£€æµ‹è§„åˆ™</title>
    <url>/2020/06/02/Elastalert-%E6%96%B0%E5%A2%9E%E5%91%A8%E6%9C%9F%E6%80%A7%E6%A3%80%E6%B5%8B%E8%A7%84%E5%88%99/</url>
    <content><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>â€‹        ç”±äºAWSæµé‡é•œåƒçš„ç‰¹æ®Šæ€§ï¼Œç°é˜¶æ®µç”Ÿäº§ç½‘çš„æ¶æ„ä¸­åªæ¥å…¥äº†<strong>HTTP</strong>ä¸<strong>DNS</strong>æµé‡ï¼Œåˆ†åˆ«é‡‡ç”¨äº†<strong>Zeek</strong>ä¸<strong>Suricata</strong>å¯¹ç°æœ‰æµé‡è¿›è¡Œåˆ†æä¸é¢„è­¦ã€‚<strong>Suricata</strong>è´Ÿè´£åŸºäºç­¾åçš„ç‰¹å¾æ£€æµ‹ï¼Œ<strong>Zeek</strong>è´Ÿè´£å®šåˆ¶åŒ–äº‹ä»¶çš„è„šæœ¬æ£€æµ‹ï¼Œä¹Ÿç®—æ˜¯â€œå„å¸å…¶èŒâ€ã€‚è¿‘å‡ æ—¥ï¼ŒæŸä¸ªä¸šåŠ¡æ¥å£å‡ºç°äº†Pindomå‘Šè­¦ï¼Œç»è¿‡åˆ†æå‘ç°éƒ¨åˆ†IPå°è¯•å¯¹è¯¥æ¥å£çš„å‚æ•°è¿›è¡Œéå†ã€‚ç”±äºéå†å‚æ•°å¯¹åº”çš„å€¼è®¾ç½®çš„éƒ½æ¯”è¾ƒå¤§ï¼Œä¸”åå°å¹¶æœªå¯¹è¯¥å‚æ•°è¿›è¡Œæ·±åº¦çš„é™åˆ¶ï¼Œå¯¼è‡´äº†æœåŠ¡å™¨ä¼šä¸æ–­çš„è¿›è¡Œè®¡ç®—ï¼Œæœ€ç»ˆå¯¼è‡´æ¥å£æ— å“åº”ã€‚</p>
<h4 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h4><ul>
<li>æ£€æµ‹<strong>å‚æ•°éå†</strong>è¡Œä¸ºï¼›</li>
<li>è®¿é—®æ˜¯å¦å­˜åœ¨<strong>å‘¨æœŸæ€§</strong>ï¼›</li>
<li>unique user_agent ç»Ÿè®¡ï¼›</li>
<li>threat intelligence ç ”åˆ¤ï¼›</li>
</ul>
<h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><p>â€‹        é€šè¿‡æ‰©å±•<strong><a href="https://github.com/Yelp/elastalert" target="_blank" rel="noopener">ElastAlert</a></strong>å‘Šè­¦æ¡†æ¶çš„å‘Šè­¦æ¨¡å‹ï¼Œæ¥å®ç°ä»¥ä¸Šéœ€æ±‚ã€‚</p>
<h5 id="å‚æ•°éå†"><a href="#å‚æ•°éå†" class="headerlink" title="å‚æ•°éå†"></a>å‚æ•°éå†</h5><ul>
<li><h6 id="æ–°å¢è§„åˆ™-Spider-py"><a href="#æ–°å¢è§„åˆ™-Spider-py" class="headerlink" title="æ–°å¢è§„åˆ™ - Spider.py"></a>æ–°å¢è§„åˆ™ - Spider.py</h6></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> html</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, JoinableQueue, Lock, Manager</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> elastalert.ruletypes <span class="keyword">import</span> RuleType</span><br><span class="line"><span class="keyword">from</span> elastalert.util <span class="keyword">import</span> elastalert_logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    print(<span class="string">"Please make sure you have pandas installed. pip install pandas"</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    print(<span class="string">"Please make sure you have tqdm module installed. pip install tqdm"</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conn</span><span class="params">(host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, password=None, db=<span class="number">0</span>)</span>:</span></span><br><span class="line">    pool = redis.ConnectionPool(host=host, port=port, password=password, db=db)</span><br><span class="line">    conn = redis.Redis(connection_pool=pool)</span><br><span class="line">    <span class="keyword">return</span> conn</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put_data</span><span class="params">(conn, q, data)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> conn.pipeline() <span class="keyword">as</span> pipe:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">            pipe.lpush(q, i)</span><br><span class="line">        pipe.execute()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpiderRule</span><span class="params">(RuleType)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, rules, args=None)</span>:</span></span><br><span class="line">        super(SpiderRule, self).__init__(rules, args=<span class="literal">None</span>)</span><br><span class="line">        self.MAX_ARGS_LENGTH = int(self.rules[<span class="string">'beacon'</span>][<span class="string">'max_args_length'</span>])</span><br><span class="line">        self.MIN_HITS = int(self.rules[<span class="string">'beacon'</span>][<span class="string">'min_hits'</span>])</span><br><span class="line">        self.MAX_UNIQUE_ARGS = int(self.rules[<span class="string">'beacon'</span>][<span class="string">'max_unique_args'</span>])</span><br><span class="line">        self.THRESHOLD_PERCENT = int(self.rules[<span class="string">'beacon'</span>][<span class="string">'threshold_percent'</span>])</span><br><span class="line">        self.NUM_PROCESSES = int(self.rules[<span class="string">'beacon'</span>][<span class="string">'threads'</span>])</span><br><span class="line">        self.UA_PROCESSES = int(self.rules[<span class="string">'beacon'</span>][<span class="string">'user_agent'</span>])</span><br><span class="line"></span><br><span class="line">        self.TIMESTAMP = <span class="string">'@timestamp'</span></span><br><span class="line">        self.FORMAT_TIMESTAMP = self.rules[<span class="string">'timestamp'</span>].get(<span class="string">'format'</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        self.beacon_module = self.rules[<span class="string">'beacon'</span>][<span class="string">'beacon_module'</span>]</span><br><span class="line">        self.WINDOW = int(self.rules[<span class="string">'beacon'</span>][<span class="string">'window'</span>])</span><br><span class="line">        self.MIN_INTERVAL = int(self.rules[<span class="string">'beacon'</span>][<span class="string">'min_interval'</span>])</span><br><span class="line">        buffer_time = str(self.rules[<span class="string">'buffer_time'</span>])</span><br><span class="line">        self.PERIOD = <span class="string">':'</span>.join(buffer_time.split(<span class="string">':'</span>)[:<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">        self.fields = self.normalized_field(self.rules[<span class="string">'field'</span>])</span><br><span class="line">        self.src_ip = self.fields[<span class="string">'aliases'</span>][<span class="string">'src_ip'</span>]</span><br><span class="line">        self.url = self.fields[<span class="string">'aliases'</span>][<span class="string">'url'</span>]</span><br><span class="line">        self.url_path = self.fields[<span class="string">'aliases'</span>][<span class="string">'url_path'</span>]</span><br><span class="line">        self.http_host = self.fields[<span class="string">'aliases'</span>][<span class="string">'http_host'</span>]</span><br><span class="line">        self.user_agent = self.fields[<span class="string">'aliases'</span>][<span class="string">'user_agent'</span>]</span><br><span class="line"></span><br><span class="line">        self.json = self.rules[<span class="string">'output'</span>][<span class="string">'json'</span>].get(<span class="string">'enable'</span>, <span class="literal">None</span>)</span><br><span class="line">        self.redis = self.rules[<span class="string">'output'</span>][<span class="string">'redis'</span>].get(<span class="string">'enable'</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        self.q_job = JoinableQueue()</span><br><span class="line">        self.l_df = Lock()</span><br><span class="line">        self.l_list = Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">normalized_field</span><span class="params">(self, d)</span>:</span></span><br><span class="line">        fields = &#123;<span class="string">'hash'</span>: [], <span class="string">'output'</span>: [], <span class="string">'aliases'</span>: &#123;&#125;&#125;</span><br><span class="line">        <span class="keyword">for</span> field, info <span class="keyword">in</span> d.items():</span><br><span class="line">            alias = info[<span class="string">'alias'</span>]</span><br><span class="line">            fields[<span class="string">'aliases'</span>][alias] = field</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> info.get(<span class="string">'type'</span>, []):</span><br><span class="line">                fields[i].append(field)</span><br><span class="line">        <span class="keyword">return</span> fields</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_data</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="comment"># Detection of spider crawlers</span></span><br><span class="line">        self.df = pd.json_normalize(data)</span><br><span class="line">        results = self.find_spiders()</span><br><span class="line"></span><br><span class="line">        d = results.to_dict(orient=<span class="string">"records"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Output to local files</span></span><br><span class="line">        <span class="keyword">if</span> self.json:</span><br><span class="line">            json_path = self.rules[<span class="string">'output'</span>][<span class="string">'json'</span>][<span class="string">'path'</span>]</span><br><span class="line">            <span class="keyword">with</span> open(json_path, <span class="string">'a'</span>) <span class="keyword">as</span> out_file:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> d:</span><br><span class="line">                    out_file.write(json.dumps(i) + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Output to Redis Server</span></span><br><span class="line">        <span class="keyword">if</span> self.redis:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                host = self.rules[<span class="string">'output'</span>][<span class="string">'redis'</span>][<span class="string">'host'</span>]</span><br><span class="line">                port = self.rules[<span class="string">'output'</span>][<span class="string">'redis'</span>][<span class="string">'port'</span>]</span><br><span class="line">                password = self.rules[<span class="string">'output'</span>][<span class="string">'redis'</span>][<span class="string">'password'</span>]</span><br><span class="line">                db = self.rules[<span class="string">'output'</span>][<span class="string">'redis'</span>][<span class="string">'db'</span>]</span><br><span class="line">                key = self.rules[<span class="string">'output'</span>][<span class="string">'redis'</span>][<span class="string">'key'</span>]</span><br><span class="line">                ioc = self.rules[<span class="string">'output'</span>][<span class="string">'redis'</span>][<span class="string">'field'</span>]</span><br><span class="line"></span><br><span class="line">                redis_conn = conn(host=host, port=port,</span><br><span class="line">                                  password=password, db=db)</span><br><span class="line">                IoC = results[ioc].unique().tolist()</span><br><span class="line">                put_data(redis_conn, key, IoC)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                elastalert_logger.error(<span class="string">"Output Redis configuration errors."</span>)</span><br><span class="line">        self.add_match(d)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The results of get_match_str will appear in the alert text</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_match_str</span><span class="params">(self, match)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> json.dumps(match)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_match</span><span class="params">(self, results)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            super(SpiderRule, self).add_match(result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_args_hash</span><span class="params">(self, args, session_id)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> hash(tuple(args + [session_id]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_query_str</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        query = request.split(<span class="string">'?'</span>)[<span class="number">-1</span>]</span><br><span class="line">        query_str = dict([i.split(<span class="string">"="</span>, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> query.split(</span><br><span class="line">            <span class="string">"&amp;"</span>) <span class="keyword">if</span> i <span class="keyword">if</span> len(i.split(<span class="string">"="</span>, <span class="number">1</span>)) == <span class="number">2</span>])</span><br><span class="line">        query_str[<span class="string">'args_list'</span>] = list(query_str.keys())</span><br><span class="line">        query_str[<span class="string">'max_length'</span>] = len(query_str)</span><br><span class="line">        query_str[<span class="string">'url_sample'</span>] = request</span><br><span class="line">        <span class="keyword">return</span> query_str</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">percent_grouping</span><span class="params">(self, d, total)</span>:</span></span><br><span class="line">        interval = <span class="number">0</span></span><br><span class="line">        <span class="comment"># Finding the key with the largest value (interval with most events)</span></span><br><span class="line">        mx_key = int(max(iter(list(d.keys())), key=(<span class="keyword">lambda</span> key: d[key])))</span><br><span class="line">        mx_percent = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(mx_key - self.WINDOW, mx_key + <span class="number">1</span>):</span><br><span class="line">            current = <span class="number">0</span></span><br><span class="line">            <span class="comment"># Finding center of current window</span></span><br><span class="line">            curr_interval = i + int(self.WINDOW / <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(i, i + self.WINDOW):</span><br><span class="line">                <span class="keyword">if</span> j <span class="keyword">in</span> d:</span><br><span class="line">                    current += d[j]</span><br><span class="line"></span><br><span class="line">            percent = float(current) / total * <span class="number">100</span></span><br><span class="line">            <span class="keyword">if</span> percent &gt; mx_percent:</span><br><span class="line">                mx_percent = percent</span><br><span class="line">                interval = curr_interval</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> interval, mx_percent</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_beacon</span><span class="params">(self, session_data)</span>:</span></span><br><span class="line">        beacon = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.FORMAT_TIMESTAMP:</span><br><span class="line">            session_data[self.TIMESTAMP] = pd.to_datetime(</span><br><span class="line">                session_data[self.TIMESTAMP])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session_data[self.TIMESTAMP] = pd.to_datetime(</span><br><span class="line">                session_data[self.TIMESTAMP], format=self.FORMAT_TIMESTAMP)</span><br><span class="line">        session_data[self.TIMESTAMP] = (</span><br><span class="line">            session_data[self.TIMESTAMP].astype(int) / <span class="number">1000000000</span>).astype(int)</span><br><span class="line"></span><br><span class="line">        session_data = session_data.sort_values([self.TIMESTAMP])</span><br><span class="line">        session_data[<span class="string">'delta'</span>] = (</span><br><span class="line">            session_data[self.TIMESTAMP] - session_data[self.TIMESTAMP].shift()).fillna(<span class="number">0</span>)</span><br><span class="line">        session_data = session_data[<span class="number">1</span>:]</span><br><span class="line">        d = dict(session_data.delta.value_counts())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> list(d.keys()):</span><br><span class="line">            <span class="keyword">if</span> key &lt; self.MIN_INTERVAL:</span><br><span class="line">                <span class="keyword">del</span> d[key]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Finding the total number of events</span></span><br><span class="line">        total = sum(d.values())</span><br><span class="line">        <span class="keyword">if</span> d <span class="keyword">and</span> total &gt; self.MIN_HITS:</span><br><span class="line">            window, percent = self.percent_grouping(d, total)</span><br><span class="line">            <span class="keyword">if</span> percent &gt; self.THRESHOLD_PERCENT <span class="keyword">and</span> total &gt; self.MIN_HITS:</span><br><span class="line">                beacon = &#123;</span><br><span class="line">                    <span class="string">'percent'</span>: int(percent),</span><br><span class="line">                    <span class="string">'interval'</span>: int(window),</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> beacon</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_spider</span><span class="params">(self, q_job, spider_list)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> q_job.empty():</span><br><span class="line">            session_id = q_job.get()</span><br><span class="line">            self.l_df.acquire()</span><br><span class="line">            session_data = self.df[self.df[<span class="string">'session_id'</span>]</span><br><span class="line">                                   == session_id]</span><br><span class="line">            self.l_df.release()</span><br><span class="line"></span><br><span class="line">            query_str = session_data[self.url].apply(</span><br><span class="line">                <span class="keyword">lambda</span> req: self.get_query_str(req)).tolist()</span><br><span class="line">            query_data = pd.DataFrame(query_str)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># get args_hash</span></span><br><span class="line">            query_data[<span class="string">'args_hash'</span>] = query_data[<span class="string">'args_list'</span>].apply(</span><br><span class="line">                <span class="keyword">lambda</span> args: self.get_args_hash(args, session_id))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> query_data[<span class="string">'args_hash'</span>].unique():</span><br><span class="line">                result = &#123;</span><br><span class="line">                    <span class="string">"detail"</span>: &#123;</span><br><span class="line">                        <span class="string">'percent'</span>: &#123;&#125;,</span><br><span class="line">                        <span class="string">'unique'</span>: &#123;&#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">"tags"</span>: [],</span><br><span class="line">                    <span class="string">"src_ip"</span>: session_data[self.src_ip].tolist()[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">"url_path"</span>: session_data[self.url_path].tolist()[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">"http_host"</span>: session_data[self.http_host].tolist()[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">"unique_ua"</span>: session_data[self.user_agent].unique().shape[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">"alert"</span>: <span class="literal">False</span>,</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                df = query_data[query_data[<span class="string">'args_hash'</span>] == i]</span><br><span class="line">                count_args_length = df[<span class="string">'max_length'</span>].iloc[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> count_args_length &gt; self.MAX_ARGS_LENGTH:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                total_hits = df.shape[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> total_hits &lt; self.MIN_HITS:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                args_list = df[<span class="string">'args_list'</span>].iloc[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> args_list:</span><br><span class="line">                    unique_args = len(df[i].unique())</span><br><span class="line">                    <span class="keyword">if</span> unique_args == <span class="number">1</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Calculate the percentage based on the number of changes in the parameters</span></span><br><span class="line">                    current_percent = int((unique_args / total_hits) * <span class="number">100</span>)</span><br><span class="line">                    <span class="keyword">if</span> current_percent &lt; self.THRESHOLD_PERCENT:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    result[<span class="string">'detail'</span>][<span class="string">'percent'</span>][i] = current_percent</span><br><span class="line">                    result[<span class="string">'detail'</span>][<span class="string">'unique'</span>][i] = unique_args</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Number of parameters with changes</span></span><br><span class="line">                    count_unique_args = len(result[<span class="string">'detail'</span>][<span class="string">'unique'</span>])</span><br><span class="line">                    <span class="keyword">if</span> count_unique_args &lt;= self.MAX_UNIQUE_ARGS:</span><br><span class="line">                        result[<span class="string">'alert'</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> result[<span class="string">'detail'</span>][<span class="string">'unique'</span>]:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># Beacon analysis</span></span><br><span class="line">                <span class="keyword">if</span> self.beacon_module:</span><br><span class="line">                    result[<span class="string">'beacon'</span>] = self.find_beacon(</span><br><span class="line">                        session_data.reset_index(drop=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line">                result[<span class="string">'args_list'</span>] = args_list</span><br><span class="line">                result[<span class="string">'total_hits'</span>] = total_hits</span><br><span class="line">                result[<span class="string">'url_sample'</span>] = df[<span class="string">'url_sample'</span>].iloc[<span class="number">0</span>]</span><br><span class="line">                result[<span class="string">'period'</span>] = self.PERIOD</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> result[<span class="string">'alert'</span>]:</span><br><span class="line">                    result[<span class="string">'tags'</span>].append(<span class="string">'enumerate'</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> result[<span class="string">'beacon'</span>]:</span><br><span class="line">                    result[<span class="string">'tags'</span>].append(<span class="string">'beacon'</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> result[<span class="string">'unique_ua'</span>] &gt;= self.UA_PROCESSES:</span><br><span class="line">                    result[<span class="string">'tags'</span>].append(<span class="string">'suspicious-ua'</span>)</span><br><span class="line"></span><br><span class="line">                self.l_list.acquire()</span><br><span class="line">                spider_list.append(result)</span><br><span class="line">                self.l_list.release()</span><br><span class="line">            q_job.task_done()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_spiders</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.df.empty:</span><br><span class="line">            <span class="keyword">raise</span> Exception(</span><br><span class="line">                <span class="string">"Elasticsearch did not retrieve any data. Please ensure your settings are correct inside the config file."</span>)</span><br><span class="line"></span><br><span class="line">        tqdm.pandas(desc=<span class="string">"Detection of Spider Crawlers."</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># get url_path</span></span><br><span class="line">        self.df[self.url_path] = self.df[self.url].str.split(<span class="string">'?'</span>).str.get(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add session_id from hash fields</span></span><br><span class="line">        self.df[<span class="string">'session_id'</span>] = self.df[self.fields[<span class="string">'hash'</span>]</span><br><span class="line">                                        ].progress_apply(<span class="keyword">lambda</span> row: hash(tuple(row)), axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># split url</span></span><br><span class="line">        self.df = self.df[self.df[self.url].apply(<span class="keyword">lambda</span> request: <span class="literal">True</span> <span class="keyword">if</span> len(</span><br><span class="line">            request.split(<span class="string">'?'</span>)) == <span class="number">2</span> <span class="keyword">else</span> <span class="literal">False</span>)].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># normalized url</span></span><br><span class="line">        self.df[self.url] = self.df[self.url].apply(</span><br><span class="line">            <span class="keyword">lambda</span> request: html.unescape(request))</span><br><span class="line">        <span class="comment"># unique session_id</span></span><br><span class="line">        unique_session = self.df[<span class="string">'session_id'</span>].unique()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> session <span class="keyword">in</span> unique_session:</span><br><span class="line">            self.q_job.put(session)</span><br><span class="line"></span><br><span class="line">        mgr = Manager()</span><br><span class="line">        spider_list = mgr.list()</span><br><span class="line">        processes = [Process(target=self.find_spider, args=(</span><br><span class="line">            self.q_job, spider_list,)) <span class="keyword">for</span> thread <span class="keyword">in</span> range(self.NUM_PROCESSES)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Run processes</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">            p.start()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Exit the completed processes</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">            p.join()</span><br><span class="line"></span><br><span class="line">        results = pd.DataFrame(list(spider_list))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add timestamp</span></span><br><span class="line">        now = datetime.datetime.now().isoformat()</span><br><span class="line">        results[<span class="string">'timestamp'</span>] = now</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> results.empty:</span><br><span class="line">            results = results[results[<span class="string">'alert'</span>] == <span class="literal">True</span>]</span><br><span class="line"></span><br><span class="line">        match_log = <span class="string">"Queried rule %s matches %s crawl events"</span> % (</span><br><span class="line">            self.rules[<span class="string">'name'</span>],</span><br><span class="line">            results.shape[<span class="number">0</span>]</span><br><span class="line">        )</span><br><span class="line">        elastalert_logger.info(match_log)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure>

<h5 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h5><ul>
<li><h6 id="Web-yaml"><a href="#Web-yaml" class="headerlink" title="Web.yaml"></a>Web.yaml</h6></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">"Detection of Spider Crawlers"</span></span><br><span class="line"><span class="attr">es_host:</span> <span class="string">"es_server"</span></span><br><span class="line"><span class="attr">es_port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">"elastalert_modules.spider.my_rules.SpiderRule"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">index:</span> <span class="string">"zeek-other-%Y.%m.%d"</span></span><br><span class="line"><span class="attr">use_strftime_index:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">filter:</span></span><br><span class="line"><span class="attr">- term:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">"canon88.github.io"</span></span><br><span class="line"><span class="attr">- term:</span></span><br><span class="line">    <span class="string">method.keyword:</span> <span class="string">"GET"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">include:</span> <span class="string">["true_client_ip",</span> <span class="string">"host"</span><span class="string">,</span> <span class="string">"uri"</span><span class="string">,</span> <span class="string">"uri_path"</span><span class="string">,</span> <span class="string">"user_agent"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">timestamp:</span></span><br><span class="line"><span class="attr">  format:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">timestamp_field:</span> <span class="string">"@timestamp"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">buffer_time:</span></span><br><span class="line"><span class="attr">  hours:</span> <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="attr">run_every:</span></span><br><span class="line"><span class="attr">  minutes:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">max_query_size:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">scroll:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">beacon:</span></span><br><span class="line"><span class="attr">  max_args_length:</span> <span class="number">10</span>		<span class="comment"># æœ€å¤§æ£€æµ‹å‚æ•°ä¸ªæ•°</span></span><br><span class="line"><span class="attr">  min_hits:</span> <span class="number">120</span>					<span class="comment"># æœ€å°å‘½ä¸­äº‹ä»¶æ•°</span></span><br><span class="line"><span class="attr">  max_unique_args:</span> <span class="number">2</span>		<span class="comment"># æœ€å¤§åŠ¨æ€å˜åŒ–å‚æ•°</span></span><br><span class="line"><span class="attr">  threshold_percent:</span> <span class="number">70</span>	<span class="comment"># è¯·æ±‚é˜ˆå€¼ç™¾åˆ†æ¯”</span></span><br><span class="line"><span class="attr">  threads:</span> <span class="number">16</span>						<span class="comment"># å¤šè¿›ç¨‹</span></span><br><span class="line"><span class="attr">  beacon_module:</span> <span class="literal">true</span>		<span class="comment"># å¼€å¯å‘¨æœŸæ€§æ£€æµ‹</span></span><br><span class="line"><span class="attr">  min_interval:</span> <span class="number">1</span>				<span class="comment"># æœ€å°å‘¨æœŸ</span></span><br><span class="line"><span class="attr">  window:</span> <span class="number">2</span>							<span class="comment"># æŠ–åŠ¨çª—å£</span></span><br><span class="line"><span class="attr">  user_agent:</span> <span class="number">20</span>				<span class="comment"># å”¯ä¸€UAä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line"><span class="attr">field:</span></span><br><span class="line"><span class="attr">  true_client_ip:</span></span><br><span class="line"><span class="attr">    alias:</span> <span class="string">src_ip</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">[hash]</span></span><br><span class="line"><span class="attr">  host:</span></span><br><span class="line"><span class="attr">    alias:</span> <span class="string">http_host</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">[hash]</span></span><br><span class="line"><span class="attr">  uri_path:</span></span><br><span class="line"><span class="attr">    alias:</span> <span class="string">url_path</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">[hash]</span></span><br><span class="line"><span class="attr">  uri:</span></span><br><span class="line"><span class="attr">    alias:</span> <span class="string">url</span></span><br><span class="line"><span class="attr">  user_agent:</span></span><br><span class="line"><span class="attr">    alias:</span> <span class="string">user_agent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output:</span></span><br><span class="line"><span class="attr">  json:</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">yes</span>	<span class="comment"># æœ¬åœ°è¾“å‡º</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/var/log/spider/spider_detect.json</span></span><br><span class="line"><span class="attr">  redis:</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">no</span>	<span class="comment"># è¾“å‡ºè‡³Redisï¼Œè”åŠ¨æƒ…æŠ¥æ•°æ®è¿›è¡Œç ”åˆ¤ã€‚</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">redis_server</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">6379</span></span><br><span class="line"><span class="attr">    db:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">redis_password</span></span><br><span class="line"><span class="attr">    key:</span> <span class="attr">spider:feeds</span></span><br><span class="line"><span class="attr">    field:</span> <span class="string">src_ip</span></span><br><span class="line"></span><br><span class="line"><span class="attr">alert:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<h5 id="å‘Šè­¦è¾“å‡º"><a href="#å‘Šè­¦è¾“å‡º" class="headerlink" title="å‘Šè­¦è¾“å‡º"></a>å‘Šè­¦è¾“å‡º</h5><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"detail"</span>: &#123;</span><br><span class="line">    <span class="attr">"percent"</span>: &#123;</span><br><span class="line">      <span class="attr">"cookieid"</span>: <span class="number">81</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"unique"</span>: &#123;</span><br><span class="line">      <span class="attr">"cookieid"</span>: <span class="number">133</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"tags"</span>: [</span><br><span class="line">    <span class="string">"enumerate"</span>, // å­˜åœ¨å‚æ•°éå†è¡Œä¸º</span><br><span class="line">    <span class="string">"suspicious-ua"</span>	// user_agent è¶…è¿‡é˜ˆå€¼</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"src_ip"</span>: <span class="string">"54.160.169.250"</span>,</span><br><span class="line">  <span class="attr">"url_path"</span>: <span class="string">"/image/cookieId.html"</span>,</span><br><span class="line">  <span class="attr">"http_host"</span>: <span class="string">"canon88.github.io"</span>,</span><br><span class="line">  <span class="attr">"unique_ua"</span>: <span class="number">47</span>,</span><br><span class="line">  <span class="attr">"alert"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"beacon"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"args_list"</span>: [</span><br><span class="line">    <span class="string">"cookieid"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"total_hits"</span>: <span class="number">164</span>,</span><br><span class="line">  <span class="attr">"url_sample"</span>: <span class="string">"/image/cookieId.html?cookieid=E99A3E54-5A81-2907-1372-339FFB70A464"</span>,</span><br><span class="line">  <span class="attr">"period"</span>: <span class="string">"1:00"</span>,</span><br><span class="line">  <span class="attr">"timestamp"</span>: <span class="string">"2020-06-02T11:07:59.276581"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h5><p><strong>find_spiderï¼š **ç”¨äºæ£€æµ‹å‚æ•°éå†çš„è¡Œä¸ºï¼Œè¿™é‡ŒåŠ ä¸Š</strong>find_beacon**æ˜¯ä¸ºäº†å¢åŠ ä¸€ä¸ªå‘¨æœŸæ€§çš„æ£€æµ‹ç»´åº¦ã€‚å½“ç„¶å¾ˆå¤šçˆ¬è™«éƒ½ä¼šã€Œè‡ªå¸¦ã€æ—¶é—´æŠ–åŠ¨ï¼Œä»¥åŠä½¿ç”¨çˆ¬è™«æ± ï¼Œæ‰€ä»¥æ•ˆæœå¹¶ä¸æ˜¯ç‰¹åˆ«æ˜æ˜¾ã€‚</p>
<p><strong>find_beaconï¼š</strong>æ›´é€‚ç”¨äºæ£€æµ‹C2è¿æ¥ï¼Œä¾‹å¦‚é’ˆå¯¹DNSåŸŸåçš„è¯·æ±‚è¿™ç§æƒ…å†µï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ£€æµ‹åˆ°çš„åŸŸåå‘¨æœŸæ€§è¯·æ±‚çš„å‘Šè­¦ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"x.x.x.228"</span>,</span><br><span class="line">    <span class="attr">"hostname"</span>: <span class="string">"entitlement.service.imperva.com"</span>,</span><br><span class="line">    <span class="attr">"answers"</span>: [</span><br><span class="line">        <span class="string">"joxkwsf.x.incapdns.net"</span>,</span><br><span class="line">        <span class="string">"45.60.73.51"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"percent"</span>: <span class="string">"100"</span>,</span><br><span class="line">    <span class="attr">"interval"</span>: <span class="number">1800</span>,</span><br><span class="line">    <span class="attr">"occurrences"</span>: <span class="number">23</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2020-06-01T08:03:38.164363"</span>,</span><br><span class="line">    <span class="attr">"period"</span>: <span class="number">12</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"beaconing"</span>,</span><br><span class="line">    <span class="attr">"num_hits"</span>: <span class="number">806379</span>,</span><br><span class="line">    <span class="attr">"num_matches"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"kibana_url"</span>: <span class="string">"https://canon88.github.io/goto/5f089bcc411426b854da71b9062fdc8c"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/02/Elastalert-æ–°å¢å‘¨æœŸæ€§æ£€æµ‹è§„åˆ™/%E5%91%A8%E6%9C%9F%E6%80%A7DNS%E8%AF%B7%E6%B1%82%E6%88%AA%E5%9B%BE-1.png" alt="image-20200603113849810"></p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>â€‹        1å°æ—¶å†…ï¼ŒIP: 54.160.169.250 æ€»å…±è®¿é—®äº†è¯¥æ¥å£164æ¬¡ä¸”cookieidå‚æ•°æ›´æ¢äº†133æ¬¡ï¼Œå åˆ°æ€»è¯·æ±‚é‡çš„81%ã€‚å¹¶æ›´æ¢äº†47ä¸ªä¸åŒçš„user_agentã€‚</p>
<p><img src="/2020/06/02/Elastalert-æ–°å¢å‘¨æœŸæ€§æ£€æµ‹è§„åˆ™/%E5%BC%82%E5%B8%B8%E8%AE%BF%E9%97%AE%E6%88%AA%E5%9B%BE-1.png" alt="image-20200602114610615"></p>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><strong><a href="https://github.com/austin-taylor/flare" target="_blank" rel="noopener">Flare</a></strong></p>
<p><strong><a href="https://github.com/Yelp/elastalert" target="_blank" rel="noopener">ElastAlert</a></strong></p>
]]></content>
      <categories>
        <category>SIEM</category>
      </categories>
      <tags>
        <tag>ElasticSearch</tag>
        <tag>Elastalert</tag>
      </tags>
  </entry>
  <entry>
    <title>Zeek - é«˜åº¦å®šåˆ¶åŒ–çš„ DNSäº‹ä»¶ + æ–‡ä»¶è¿˜åŸ</title>
    <url>/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/</url>
    <content><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><ol>
<li>æœ¬åœ°ç¯å¢ƒä¸­éƒ¨ç½²äº†2å°NTAï¼ˆ<strong>Suricata</strong>ï¼‰æ¥æ”¶å†…ç½‘12å°DNSæœåŠ¡å™¨çš„æµé‡ï¼Œç”¨äºå‘ç°DNSè¯·æ±‚ä¸­å­˜åœ¨çš„å®‰å…¨é—®é¢˜ã€‚è¿‘ä¸€æ®µæ—¶é—´å‘ç°2å°NTAæœåŠ¡å™¨è¿è¡Œ10å°æ—¶å·¦å³å°±ä¼šè‡ªåŠ¨é‡å¯<strong>Suricata</strong>è¿›ç¨‹ï¼Œçœ‹äº†ä¸€ä¸‹æ—¥å¿—å¤§æ¦‚æ„æ€æ˜¯è¯´å†…å­˜ä¸è¶³ï¼Œéœ€è¦å¼ºåˆ¶é‡å¯é‡Šæ”¾å†…å­˜ã€‚è¯´èµ·è¿™ä¸ªé—®é¢˜å½“æ—¶ä¹Ÿæ˜¯èŠ±äº†ä¸€äº›æ—¶é—´å»å®šä½ã€‚é¦–å…ˆDNSè¿™ç§å°åŒ…åœ¨æˆ‘è¿™å¹³å‡æµé‡ä¹Ÿå°±25Mbpsï¼Œæ‰€ä»¥å¤§æ¦‚ç‡ä¸æ˜¯å› ä¸ºç½‘å¡æµé‡è¿‡å¤§è€Œå¯¼è‡´çš„ã€‚ç»§ç»­å®šä½ï¼Œç”±äºæˆ‘ä»¬è¿™å„ä¸ªåº”ç”¨æœåŠ¡å™¨ä¼šé€šè¿‡å†…ç½‘åŸŸåçš„å½¢å¼è¿›è¡Œæ¥å£è°ƒç”¨ï¼Œæ‰€ä»¥DNSè¯·æ±‚é‡å¾ˆå¤§ã€‚<strong>Kibana</strong>ä¸Šçœ‹äº†ä¸€ä¸‹ç›®å‰<code>dns_type: query</code>äº‹ä»¶çš„æ•°æ®é‡<strong>320,000,000/å¤© ~ 350,000,000/å¤©</strong>ï¼ˆè¿™ä»…ä»…æ˜¯<code>dns_type: query</code>æ•°æ®é‡ï¼Œ<code>dns_type: answer</code>æ•°æ®é‡<strong>ä¹Ÿè¶…çº§å¤§</strong>ï¼‰ã€‚ç”±äº<strong>Suricata</strong>ä¸èƒ½åœ¨æ•°æ®è¾“å‡ºä¹‹å‰å¯¹æŒ‡å®šåŸŸåè¿›è¡Œè¿‡æ»¤ï¼Œè¿™ä¸€ç‚¹ç¡®å®<strong>å¾ˆå‚»</strong>ï¼Œ<strong>å¿…é¡»åæ§½</strong>ã€‚å½“æ—¶çš„è§„é¿åšæ³•å°±æ˜¯åªä¿ç•™<code>dns_type: query</code>äº‹ä»¶ï¼Œæ—¢ä¿è¯äº†<strong>Suricata</strong>çš„æ­£å¸¸è¿è¡Œä¹Ÿæš‚æ—¶æ»¡è¶³äº†éœ€æ±‚ã€‚</li>
</ol>
<ol start="2">
<li>è¿‘ä¸€æ®µæ—¶é—´ç½‘ç«™çš„æŸä¸ªä¸Šä¼ æ¥å£è¢«ä¸Šä¼ äº†åŒ…å«<strong>æ¶æ„Payload</strong>çš„jpgä¸pngã€‚è™½ç„¶<strong>Suricata</strong>æœ‰æ£€æµ‹åˆ°ï¼Œä½†ä¹Ÿå»¶ä¼¸äº†æ–°çš„éœ€æ±‚ï¼Œå¦‚ä½•åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸Šä¼ æˆåŠŸä»¥åŠæ–‡ä»¶è¿˜åŸä¸æå–<strong>HASH</strong>ã€‚è™½ç„¶è¿™ä¸¤ç‚¹<strong>Suricata</strong>è‡ªèº«éƒ½å¯ä»¥åšï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¼Šç«¯ä¸å¾—ä¸è¯´ã€‚ä¾‹å¦‚<strong>Suricata</strong>åªè¦å¼€å¯<code>file_info</code>å°±ä¼šå¯¹æ‰€æœ‰æ”¯æŒæ–‡ä»¶è¿˜åŸçš„åè®®è¿›è¡Œ<strong>HASH</strong>æå–ã€‚ç”±äºæˆ‘ä»¬æ˜¯ç”µå•†ï¼Œå¤–éƒ¨è®¿é—®çš„æ•°æ®é‡ä¼šå¾ˆå¤§ï¼Œ<strong>Suricata</strong>é»˜è®¤ä¸æ”¯æŒè¿‡æ»¤ï¼Œé’ˆå¯¹ç”¨æˆ·è®¿é—®çš„HTMLç½‘é¡µè¿™ç§ä¹Ÿä¼šè¢«è®¡ç®—ä¸€ä¸ª<strong>HASH</strong>ï¼Œè¿™ä¸ªé‡å°±éå¸¸çš„<strong>ææ€–</strong>äº†ã€‚</li>
</ol>
<p><strong>æ€»ç»“ï¼š</strong>é’ˆå¯¹ä»¥ä¸Š2ä¸ªé—®é¢˜ï¼Œæˆ‘éœ€è¦çš„æ˜¯ä¸€ä¸ªæ›´åŠ çµæ´»çš„NTAæ¡†æ¶ï¼Œä¸‹é¢è¯·æ¥æœ¬æ¬¡ä¸»è§’ - <strong>Zeek</strong>ã€‚</p>
<hr>
<h4 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h4><ol>
<li>è¿‡æ»¤å†…éƒ¨DNSåŸŸåï¼Œåªä¿ç•™å¤–éƒ¨DNSåŸŸåçš„è¯·æ±‚ä¸å“åº”æ•°æ®ï¼›</li>
<li>æ›´çµæ´»çš„æ–‡ä»¶è¿˜åŸä¸æå–HASH;</li>
</ol>
<hr>
<h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><h5 id="1-è¿‡æ»¤æœ¬åœ°DNSè¯·æ±‚"><a href="#1-è¿‡æ»¤æœ¬åœ°DNSè¯·æ±‚" class="headerlink" title="1. è¿‡æ»¤æœ¬åœ°DNSè¯·æ±‚"></a>1. è¿‡æ»¤æœ¬åœ°DNSè¯·æ±‚</h5><h6 id="DNSè„šæœ¬"><a href="#DNSè„šæœ¬" class="headerlink" title="DNSè„šæœ¬"></a>DNSè„šæœ¬</h6><p><strong>dns-filter_external.zeek</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">redef Site::local_zones = &#123;<span class="string">"canon88.github.io"</span>, <span class="string">"baidu.com"</span>, <span class="string">"google.com"</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> dns_filter(rec: DNS::Info): bool</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="built_in">return</span> ! Site::is_local_name(rec<span class="variable">$query</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">redef Analyzer::disable_all = T</span><br><span class="line"></span><br><span class="line">event zeek_init()</span><br><span class="line">  &#123;</span><br><span class="line">  Analyzer::enable_analyzer(Analyzer::ANALYZER_VXLAN);</span><br><span class="line">  Analyzer::enable_analyzer(Analyzer::ANALYZER_DNS);</span><br><span class="line">  Log::remove_default_filter(DNS::LOG);</span><br><span class="line">  <span class="built_in">local</span> filter: Log::Filter = [<span class="variable">$name</span>=<span class="string">"dns_split"</span>, <span class="variable">$path</span>=<span class="string">"/data/logs/zeek/dns_remotezone"</span>, <span class="variable">$pred</span>=dns_filter];</span><br><span class="line">  Log::add_filter(DNS::LOG, filter);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h6 id="è„šæœ¬ç®€è¿°ï¼š"><a href="#è„šæœ¬ç®€è¿°ï¼š" class="headerlink" title="è„šæœ¬ç®€è¿°ï¼š"></a>è„šæœ¬ç®€è¿°ï¼š</h6><ol>
<li><p>é€šè¿‡<code>Site::local_zones</code>å®šä¹‰ä¸€ä¸ªå†…éƒ¨çš„åŸŸåï¼Œè¿™äº›åŸŸåé»˜è®¤éƒ½æ˜¯æˆ‘ä»¬éœ€è¦è¿‡æ»¤æ‰çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘çš„éœ€æ±‚ä¸­ï¼Œå¤šä¸ºå†…ç½‘çš„åŸŸåï¼›</p>
<ol start="2">
<li>ä¼˜åŒ–æ€§èƒ½ï¼Œ åªå¼€å¯DNSæµé‡è§£æã€‚ç”±äºè¿™2å°NTAåªè´Ÿè´£è§£æDNSæµé‡ï¼Œä¸ºäº†ä¿ç•™é’ˆå¯¹åŸŸåç‰¹å¾æ£€æµ‹çš„èƒ½åŠ›ï¼Œæˆ‘é€‰æ‹©äº†<strong>Suricata</strong>ä¸<strong>Zeek</strong>å…±å­˜ï¼Œå½“ç„¶<strong>Zeek</strong>ä¹Ÿå¯ä»¥åšç‰¹å¾æ£€æµ‹ï¼Œåªæ˜¯æˆ‘æ‡’ã€‚ã€‚ã€‚é€šè¿‡<code>Analyzer::enable_analyzer(Analyzer::ANALYZER_DNS);</code>æŒ‡å®šäº†åªå¯¹DNSæµé‡è¿›è¡Œåˆ†æï¼›</li>
<li>è¿‡æ»¤æ—¥å¿—å¹¶è¾“å‡ºï¼›</li>
</ol>
</li>
</ol>
<h6 id="æ—¥å¿—æ ·ä¾‹ï¼š"><a href="#æ—¥å¿—æ ·ä¾‹ï¼š" class="headerlink" title="æ—¥å¿—æ ·ä¾‹ï¼š"></a>æ—¥å¿—æ ·ä¾‹ï¼š</h6><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"ts"</span>: <span class="number">1589175829.994196</span>,</span><br><span class="line">  <span class="attr">"uid"</span>: <span class="string">"CPRxOZ2RtkPYhjz8R9"</span>,</span><br><span class="line">  <span class="attr">"id.orig_h"</span>: <span class="string">"1.1.1.1"</span>,</span><br><span class="line">  <span class="attr">"id.orig_p"</span>: <span class="number">40411</span>,</span><br><span class="line">  <span class="attr">"id.resp_h"</span>: <span class="string">"2.2.2.2"</span>,</span><br><span class="line">  <span class="attr">"id.resp_p"</span>: <span class="number">53</span>,</span><br><span class="line">  <span class="attr">"proto"</span>: <span class="string">"udp"</span>,</span><br><span class="line">  <span class="attr">"trans_id"</span>: <span class="number">696</span>,</span><br><span class="line">  <span class="attr">"rtt"</span>: <span class="number">1.3113021850585938e-05</span>,</span><br><span class="line">  <span class="attr">"query"</span>: <span class="string">"graph.facebook.com"</span>,</span><br><span class="line">  <span class="attr">"qclass"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"qclass_name"</span>: <span class="string">"C_INTERNET"</span>,</span><br><span class="line">  <span class="attr">"qtype"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"qtype_name"</span>: <span class="string">"A"</span>,</span><br><span class="line">  <span class="attr">"rcode"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"rcode_name"</span>: <span class="string">"NOERROR"</span>,</span><br><span class="line">  <span class="attr">"AA"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"TC"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"RD"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"RA"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"Z"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"answers"</span>: [</span><br><span class="line">    <span class="string">"api.facebook.com"</span>,</span><br><span class="line">    <span class="string">"star.c10r.facebook.com"</span>,</span><br><span class="line">    <span class="string">"157.240.22.19"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"TTLs"</span>: [</span><br><span class="line">    <span class="number">540</span>,</span><br><span class="line">    <span class="number">770</span>,</span><br><span class="line">    <span class="number">54</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"rejected"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"event_type"</span>: <span class="string">"dns"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h6><p>å½“é‡‡ç”¨Zeekè¿‡æ»¤äº†DNSè¯·æ±‚åï¼Œç°åœ¨æ¯å¤©çš„DNSæ•°æ®é‡ <strong>6,300,000/å¤© ~ 6,800,000/å¤©</strong>ï¼ˆquery + answerï¼‰ï¼Œå¯¹æ¯”ä¹‹å‰çš„æ•°æ®é‡<strong>320,000,000/å¤© ~ 350,000,000/å¤©</strong>ï¼ˆqueryï¼‰ã€‚æ•°æ®é‡å‡å°‘å¾ˆæ˜æ˜¾ï¼ŒåŒæ—¶ä¹Ÿå‡å°‘äº†åç«¯ESå­˜å‚¨çš„å‹åŠ›ã€‚</p>
<ul>
<li>Zeek DNS ï¼ˆquery + answerï¼‰</li>
</ul>
<p><img src="/2020/05/11/Zeekå®æˆ˜-1/Zeek-DNS-1.png" alt="image-20200511135508651"></p>
<ul>
<li>Suricata DNS ï¼ˆqueryï¼‰</li>
</ul>
<p><img src="/2020/05/11/Zeekå®æˆ˜-1/Suricata-DNS-1.png" alt="image-20200511140015791"></p>
<hr>
<h5 id="2-æ›´çµæ´»çš„æ–‡ä»¶è¿˜åŸä¸æå–æ–‡ä»¶HASH"><a href="#2-æ›´çµæ´»çš„æ–‡ä»¶è¿˜åŸä¸æå–æ–‡ä»¶HASH" class="headerlink" title="2. æ›´çµæ´»çš„æ–‡ä»¶è¿˜åŸä¸æå–æ–‡ä»¶HASH"></a>2. æ›´çµæ´»çš„æ–‡ä»¶è¿˜åŸä¸æå–æ–‡ä»¶HASH</h5><h6 id="æ–‡ä»¶è¿˜åŸè„šæœ¬"><a href="#æ–‡ä»¶è¿˜åŸè„šæœ¬" class="headerlink" title="æ–‡ä»¶è¿˜åŸè„šæœ¬"></a>æ–‡ä»¶è¿˜åŸè„šæœ¬</h6><p><strong>file_extraction.zeek</strong> </p>
<p><strong>Demoè„šæœ¬ï¼Œè¯­æ³•å¹¶ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œåˆ‡å‹¿çº ç»“ã€‚</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">@load base/frameworks/files/main</span><br><span class="line">@load base/protocols/http/main</span><br><span class="line"></span><br><span class="line">module Files;</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> &#123;</span><br><span class="line">    redef record Info += &#123;</span><br><span class="line">        hostname:         string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        proxied:          <span class="built_in">set</span>[string] &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        url:              string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        method:           string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        true_client_ip:   string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        logs:             bool &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    option http_info = T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">redef FileExtract::prefix = <span class="string">"/data/logs/zeek/extracted_files/"</span>;</span><br><span class="line"></span><br><span class="line">global mime_to_ext: table[string] of string = &#123;</span><br><span class="line">    [<span class="string">"text/plain"</span>] = <span class="string">"txt"</span>,</span><br><span class="line">    [<span class="string">"application/x-executable"</span>] = <span class="string">""</span>,</span><br><span class="line">    [<span class="string">"application/x-dosexec"</span>] = <span class="string">"exe"</span>,</span><br><span class="line">    [<span class="string">"image/jpeg"</span>] = <span class="string">"jpg"</span>,</span><br><span class="line">    [<span class="string">"image/png"</span>] = <span class="string">"png"</span>,</span><br><span class="line">    [<span class="string">"application/pdf"</span>] = <span class="string">"pdf"</span>,</span><br><span class="line">    [<span class="string">"application/java-archive"</span>] = <span class="string">"jar"</span>,</span><br><span class="line">    [<span class="string">"application/x-java-applet"</span>] = <span class="string">"jar"</span>,</span><br><span class="line">    [<span class="string">"application/x-java-jnlp-file"</span>] = <span class="string">"jnlp"</span>,</span><br><span class="line">    [<span class="string">"application/msword"</span>] = <span class="string">"doc"</span>,</span><br><span class="line">    [<span class="string">"application/vnd.openxmlformats-officedocument.wordprocessingml.document"</span>] = <span class="string">"docs"</span>,</span><br><span class="line">    [<span class="string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>] = <span class="string">"xlsx"</span>,</span><br><span class="line">    [<span class="string">"application/vnd.openxmlformats-officedocument.presentationml.presentation"</span>] = <span class="string">"pptx"</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global file_analyzer: table[string] of bool = &#123;</span><br><span class="line">    [<span class="string">"Extraction"</span>] = T,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global http_method: <span class="built_in">set</span>[string] = &#123;</span><br><span class="line">    <span class="string">"GET"</span>,</span><br><span class="line">    <span class="string">"POST"</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global http_hostname: <span class="built_in">set</span>[string] = &#123;</span><br><span class="line">  <span class="string">"canon88.github.io"</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global http_uri: <span class="built_in">set</span>[string] = &#123;</span><br><span class="line">  <span class="string">"/index.php"</span>,</span><br><span class="line">  <span class="string">"/account.php"</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> files_filter(rec: Files::Info): bool</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">return</span> rec?<span class="variable">$logs</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">event zeek_init()</span><br><span class="line">    &#123;</span><br><span class="line">    Log::remove_default_filter(Files::LOG);</span><br><span class="line">    <span class="built_in">local</span> filter: Log::Filter = [<span class="variable">$name</span>=<span class="string">"file_extraction"</span>, <span class="variable">$path</span>=<span class="string">"/data/logs/zeek/file_extraction"</span>, <span class="variable">$pred</span>=files_filter];</span><br><span class="line">    Log::add_filter(Files::LOG, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">event file_sniff(f: fa_file, meta: fa_metadata) &amp;priority=3</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">if</span> ( f<span class="variable">$source</span> != <span class="string">"HTTP"</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! f<span class="variable">$http</span>?<span class="variable">$method</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( f<span class="variable">$http</span><span class="variable">$method</span> !<span class="keyword">in</span> http_method )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! f<span class="variable">$http</span>?<span class="variable">$host</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( f<span class="variable">$http</span><span class="variable">$host</span> !<span class="keyword">in</span> http_hostname )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! meta?<span class="variable">$mime_type</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( meta<span class="variable">$mime_type</span> !<span class="keyword">in</span> mime_to_ext )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    f<span class="variable">$info</span><span class="variable">$logs</span> = T;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( file_analyzer[<span class="string">"Extraction"</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="built_in">local</span> fname = fmt(<span class="string">"%s-%s.%s"</span>, f<span class="variable">$source</span>, f<span class="variable">$id</span>, mime_to_ext[meta<span class="variable">$mime_type</span>]);</span><br><span class="line">        Files::add_analyzer(f, Files::ANALYZER_EXTRACT, [<span class="variable">$extract_filename</span>=fname]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    Files::add_analyzer(f, Files::ANALYZER_MD5);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( http_info )</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$host</span> )</span><br><span class="line">            f<span class="variable">$info</span><span class="variable">$hostname</span> = f<span class="variable">$http</span><span class="variable">$host</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$proxied</span> )</span><br><span class="line">            f<span class="variable">$info</span><span class="variable">$proxied</span> = f<span class="variable">$http</span><span class="variable">$proxied</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$method</span> )</span><br><span class="line">            f<span class="variable">$info</span><span class="variable">$method</span> = f<span class="variable">$http</span><span class="variable">$method</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$uri</span> )</span><br><span class="line">            f<span class="variable">$info</span><span class="variable">$url</span> = f<span class="variable">$http</span><span class="variable">$uri</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$true_client_ip</span> )</span><br><span class="line">            f<span class="variable">$info</span><span class="variable">$true_client_ip</span> = f<span class="variable">$http</span><span class="variable">$true_client_ip</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event file_state_remove(f: fa_file)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !f<span class="variable">$info</span>?<span class="variable">$extracted</span> || !f<span class="variable">$info</span>?<span class="variable">$md5</span> || FileExtract::prefix == <span class="string">""</span> || !f<span class="variable">$info</span>?<span class="variable">$logs</span> )</span><br><span class="line">            <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">local</span> orig = f<span class="variable">$info</span><span class="variable">$extracted</span>;</span><br><span class="line">        <span class="built_in">local</span> split_orig = split_string(f<span class="variable">$info</span><span class="variable">$extracted</span>, /\./);</span><br><span class="line">        <span class="built_in">local</span> extension = split_orig[|split_orig|-1];</span><br><span class="line">        <span class="built_in">local</span> ntime = fmt(<span class="string">"%D"</span>, network_time());</span><br><span class="line">        <span class="built_in">local</span> ndate = sub_bytes(ntime, 1, 10);</span><br><span class="line">        <span class="built_in">local</span> dest_dir = fmt(<span class="string">"%s%s"</span>, FileExtract::prefix, ndate);</span><br><span class="line">        mkdir(dest_dir);</span><br><span class="line">        <span class="built_in">local</span> dest = fmt(<span class="string">"%s/%s.%s"</span>, dest_dir, f<span class="variable">$info</span><span class="variable">$md5</span>, extension);</span><br><span class="line">        <span class="built_in">local</span> cmd = fmt(<span class="string">"mv %s/%s %s"</span>, FileExtract::prefix, orig, dest);</span><br><span class="line">        when ( <span class="built_in">local</span> result = Exec::run([<span class="variable">$cmd</span>=cmd]) )</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        f<span class="variable">$info</span><span class="variable">$extracted</span> = dest;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h6 id="è„šæœ¬ç®€è¿°ï¼š-1"><a href="#è„šæœ¬ç®€è¿°ï¼š-1" class="headerlink" title="è„šæœ¬ç®€è¿°ï¼š"></a>è„šæœ¬ç®€è¿°ï¼š</h6><pre><code>1. æ”¯æŒé’ˆå¯¹æŒ‡å®šhostnameï¼Œmethodï¼Œurlï¼Œæ–‡ä»¶å¤´è¿›è¡Œhashçš„æå–ä»¥åŠæ–‡ä»¶è¿˜åŸï¼›
2. é»˜è®¤æ–‡ä»¶è¿˜åŸæŒ‰ç…§å¹´æœˆæ—¥è¿›è¡Œæ•°æ®çš„å­˜å‚¨ï¼Œä¿å­˜åå­—æŒ‰ç…§MD5åç§°å‘½åï¼›
3. ä¸°å¯ŒåŒ–äº†æ–‡ä»¶è¿˜åŸçš„æ—¥å¿—ï¼Œå¢åŠ HTTPç›¸å…³å­—æ®µï¼›</code></pre><h6 id="æ—¥å¿—æ ·ä¾‹"><a href="#æ—¥å¿—æ ·ä¾‹" class="headerlink" title="æ—¥å¿—æ ·ä¾‹"></a>æ—¥å¿—æ ·ä¾‹</h6><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"ts"</span>: <span class="number">1588891497.173108</span>,</span><br><span class="line">  <span class="attr">"fuid"</span>: <span class="string">"FhOGNc2zDdlF3AP5c"</span>,</span><br><span class="line">  <span class="attr">"tx_hosts"</span>: [</span><br><span class="line">    <span class="string">"1.1.1.1"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"rx_hosts"</span>: [</span><br><span class="line">    <span class="string">"2.2.2.2"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"conn_uids"</span>: [</span><br><span class="line">    <span class="string">"CItQs61wvvtPqSB0Ub"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"source"</span>: <span class="string">"HTTP"</span>,</span><br><span class="line">  <span class="attr">"depth"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"analyzers"</span>: [</span><br><span class="line">    <span class="string">"MD5"</span>,</span><br><span class="line">    <span class="string">"SHA1"</span>,</span><br><span class="line">    <span class="string">"EXTRACT"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"mime_type"</span>: <span class="string">"image/png"</span>,</span><br><span class="line">  <span class="attr">"duration"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"local_orig"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"is_orig"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"seen_bytes"</span>: <span class="number">353</span>,</span><br><span class="line">  <span class="attr">"total_bytes"</span>: <span class="number">353</span>,</span><br><span class="line">  <span class="attr">"missing_bytes"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"overflow_bytes"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"timedout"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"md5"</span>: <span class="string">"fd0229d400049449084b3864359c445a"</span>,</span><br><span class="line">  <span class="attr">"sha1"</span>: <span class="string">"d836d3f06c0fc075cf0f5d95f50b79cac1dac97d"</span>,</span><br><span class="line">  <span class="attr">"extracted"</span>: <span class="string">"/data/logs/zeek/extracted_files/2020-05-07/fd0229d400049449084b3864359c445a.png"</span>,</span><br><span class="line">  <span class="attr">"extracted_cutoff"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"hostname"</span>: <span class="string">"canon88.github.io"</span>,</span><br><span class="line">  <span class="attr">"proxied"</span>: [</span><br><span class="line">    <span class="string">"TRUE-CLIENT-IP -&gt; 3.3.3.3"</span>,</span><br><span class="line">    <span class="string">"X-FORWARDED-FOR -&gt; 4.4.4.4"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"/image/close.png"</span>,</span><br><span class="line">  <span class="attr">"method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">  <span class="attr">"true_client_ip"</span>: <span class="string">"3.3.3.3"</span>,</span><br><span class="line">  <span class="attr">"logs"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="æ–‡ä»¶è¿˜åŸ"><a href="#æ–‡ä»¶è¿˜åŸ" class="headerlink" title="æ–‡ä»¶è¿˜åŸ"></a>æ–‡ä»¶è¿˜åŸ</h6><p><strong>è¿™æ˜¯å…¶ä¸­ä¸€ä¸ªåŒ…å«æ¶æ„Payloadè¿˜åŸå‡ºçš„å›¾ç‰‡æ ·ä¾‹</strong></p>
<p><img src="/2020/05/11/Zeekå®æˆ˜-1/Payload-pic.png" alt="image-20200511150738194"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ll /data/logs/zeek/extracted_files/</span><br><span class="line">total 89916</span><br><span class="line">drwxr-xr-x 10 root root      150 May 11 06:14 ./</span><br><span class="line">drwxr-xr-x  4 root root       67 May 11 06:00 ../</span><br><span class="line">drwxr-xr-x  2 root root       50 May  5 07:54 2020-05-04/</span><br><span class="line">drwxr-xr-x  2 root root     4096 May  5 23:51 2020-05-05/</span><br><span class="line">drwxr-xr-x  2 root root   671744 May  6 23:41 2020-05-06/</span><br><span class="line">drwxr-xr-x  2 root root     4096 May  7 22:44 2020-05-07/</span><br><span class="line">drwxr-xr-x  2 root root   741376 May  8 23:59 2020-05-08/</span><br><span class="line">drwxr-xr-x  2 root root 23425024 May  9 23:59 2020-05-09/</span><br><span class="line">drwxr-xr-x  2 root root 25047040 May 10 23:59 2020-05-10/</span><br><span class="line">drwxr-xr-x  2 root root 24846336 May 11 06:14 2020-05-11/</span><br><span class="line"></span><br><span class="line">$ xxd /data/logs/zeek/extracted_files/2020-05-07/884d9474180e5b49f851643cb2442bce.jpg</span><br><span class="line">00000000: 8950 4e47 0d0a 1a0a 0000 000d 4948 4452  .PNG........IHDR</span><br><span class="line">00000010: 0000 003c 0000 003c 0806 0000 003a fcd9  ...&lt;...&lt;.....:..</span><br><span class="line">00000020: 7200 0000 1974 4558 7453 6f66 7477 6172  r....tEXtSoftwar</span><br><span class="line">00000030: 6500 4164 6f62 6520 496d 6167 6552 6561  e.Adobe ImageRea</span><br><span class="line">00000040: 6479 71c9 653c 0000 0320 6954 5874 584d  dyq.e&lt;... iTXtXM</span><br><span class="line">00000050: 4c3a 636f 6d2e 6164 6f62 652e 786d 7000  L:com.adobe.xmp.</span><br><span class="line">..........</span><br><span class="line">00001030: 8916 ce5f 7480 2f38 c073 69f1 5c14 83fb  ..._t./8.si.\...</span><br><span class="line">00001040: aa9d 42a3 8f4b ff05 e012 e04b 802f 01be  ..B..K.....K./..</span><br><span class="line">00001050: 04b8 91c7 ff04 1800 bcae 819f d1da 1896  ................</span><br><span class="line">00001060: 0000 0000 4945 4e44 ae42 6082 3c3f 7068  ....IEND.B`.&lt;?ph</span><br><span class="line">00001070: 7020 7068 7069 6e66 6f28 293b 3f3e 1a    p phpinfo();?&gt;.</span><br></pre></td></tr></table></figure>

<h6 id="æ€»ç»“ï¼š-1"><a href="#æ€»ç»“ï¼š-1" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h6><p>é€šè¿‡Zeekè„šæœ¬æ‰©å±•åï¼Œå¯ä»¥<strong>â€œéšæ„æ‰€æ¬²â€</strong>çš„è·å–å„ç§ç±»å‹æ–‡ä»¶çš„Hashä»¥åŠå®šåˆ¶åŒ–çš„è¿›è¡Œæ–‡ä»¶è¿˜åŸã€‚</p>
<h4 id="å¤´è„‘é£æš´"><a href="#å¤´è„‘é£æš´" class="headerlink" title="å¤´è„‘é£æš´"></a>å¤´è„‘é£æš´</h4><p>å½“è·å–æ–‡ä»¶ä¸Šä¼ çš„Hashä¹‹åï¼Œå¯ä»¥å°è¯•æ‰©å±•å‡ºä»¥ä¸‹2ä¸ªå®‰å…¨äº‹ä»¶ï¼š</p>
<ol>
<li><p>åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸Šä¼ æˆåŠŸã€‚</p>
<p>é€šå¸¸ç¬¬ä¸€æ—¶é—´ä¼šéœ€è¦å®šä½æ–‡ä»¶æ˜¯å¦ä¸Šä¼ æˆåŠŸï¼Œè‹¥ä¸Šä¼ æˆåŠŸéœ€è¦è¿›è¡Œç›¸å…³çš„äº‹ä»¶è¾“å‡ºï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡‡ç”¨HIDSè¿›è¡Œæ–‡ä»¶è½åœ°äº‹ä»¶çš„å…³è”ã€‚</p>
</li>
<li><p>å…³è”æ€æ¯’å¼•æ“/å¨èƒæƒ…æŠ¥ã€‚</p>
<p>å°†ç¬¬ä¸€ä¸ªå…³è”å¥½çš„äº‹ä»¶è¿›è¡ŒHashçš„ç¢°æ’ï¼Œæœ€å¸¸è§çš„æ˜¯å°†HASHé€åˆ°VTæˆ–å¨èƒæƒ…æŠ¥ã€‚</p>
</li>
</ol>
<p>è¿™é‡Œä»¥<strong>Wazuh</strong>äº‹ä»¶ä¸ºä¾‹ï¼Œå°†<strong>Zeek</strong>çš„æ–‡ä»¶è¿˜åŸäº‹ä»¶ä¸<strong>Wazuh</strong>çš„æ–°å¢æ–‡ä»¶äº‹ä»¶è¿›è¡Œå…³è”ï¼Œå…³è”æŒ‡æ ‡é‡‡ç”¨<strong>Hash</strong>ã€‚</p>
<p><strong>a. Zeekäº‹ä»¶</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"ts"</span>: <span class="number">1589158812.471443</span>,</span><br><span class="line">  <span class="attr">"fuid"</span>: <span class="string">"FBkqzM2AFg0jrioji6"</span>,</span><br><span class="line">  <span class="attr">"tx_hosts"</span>: [</span><br><span class="line">    <span class="string">"1.1.1.1"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"rx_hosts"</span>: [</span><br><span class="line">    <span class="string">"2.2.2.2"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"conn_uids"</span>: [</span><br><span class="line">    <span class="string">"CcOyQo2ziEuoLBNIb9"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"source"</span>: <span class="string">"HTTP"</span>,</span><br><span class="line">  <span class="attr">"depth"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"analyzers"</span>: [</span><br><span class="line">    <span class="string">"SHA1"</span>,</span><br><span class="line">    <span class="string">"EXTRACT"</span>,</span><br><span class="line">    <span class="string">"MD5"</span>,</span><br><span class="line">    <span class="string">"DATA_EVENT"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"mime_type"</span>: <span class="string">"text/plain"</span>,</span><br><span class="line">  <span class="attr">"duration"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"local_orig"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"is_orig"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"seen_bytes"</span>: <span class="number">31</span>,</span><br><span class="line">  <span class="attr">"total_bytes"</span>: <span class="number">31</span>,</span><br><span class="line">  <span class="attr">"missing_bytes"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"overflow_bytes"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"timedout"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"md5"</span>: <span class="string">"37a74f452f1c49854a2951fd605687c5"</span>,</span><br><span class="line">  <span class="attr">"extracted"</span>: <span class="string">"/data/logs/zeek/extracted_files/2020-05-11/37a74f452f1c49854a2951fd605687c5.txt"</span>,</span><br><span class="line">  <span class="attr">"extracted_cutoff"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"hostname"</span>: <span class="string">"canon88.github.io"</span>,</span><br><span class="line">  <span class="attr">"proxied"</span>: [</span><br><span class="line">    <span class="string">"X-FORWARDED-FOR -&gt; 3.3.3.3"</span>,</span><br><span class="line">    <span class="string">"TRUE-CLIENT-IP -&gt; 4.4.4.4"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"/index.php"</span>,</span><br><span class="line">  <span class="attr">"method"</span>: <span class="string">"POST"</span>,</span><br><span class="line">  <span class="attr">"true_client_ip"</span>: <span class="string">"4.4.4.4"</span>,</span><br><span class="line">  <span class="attr">"logs"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>b. Wazuh äº‹ä»¶</strong></p>
<p><img src="/2020/05/11/Zeekå®æˆ˜-1/Wazuh-Hash-1.png" alt="image-20200511144805354"></p>
]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Zeek</tag>
        <tag>NTA</tag>
      </tags>
  </entry>
  <entry>
    <title>Elasticsearch-aliasä¸reindexçš„ä½¿ç”¨åœºæ™¯</title>
    <url>/2020/03/29/Elasticsearch-alias%E4%B8%8Ereindex%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/</url>
    <content><![CDATA[<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><strong><a href="https://javasgl.github.io/elastic-search-reindex/" target="_blank" rel="noopener">ä½¿ç”¨ reindex æ¥ä¿®æ”¹ elasticsearch ç´¢å¼•mapping</a></strong></li>
<li><strong><a href="https://javasgl.github.io/use-alias-migrate-index/" target="_blank" rel="noopener">ä½¿ç”¨ Elasticsearch alias åŠŸèƒ½åˆ‡æ¢ index</a></strong></li>
<li><strong><a href="https://blog.csdn.net/mlljava1111/article/details/51218868" target="_blank" rel="noopener">Elasticsearchæ›´æ”¹mapping(ä¸åœæœåŠ¡é‡å»ºç´¢å¼•)</a></strong></li>
<li><strong><a href="https://www.cnblogs.com/jajian/p/10152681.html" target="_blank" rel="noopener">Elasticsearch æŠ€æœ¯åˆ†æï¼ˆä¸‰ï¼‰ï¼š ç´¢å¼•åˆ«åAliasesé—®é¢˜</a></strong></li>
<li><strong><a href="https://www.jianshu.com/p/f67b046b4d3f" target="_blank" rel="noopener">Elasticsearch å®æˆ˜æ¡ˆä¾‹ï¼ˆç´¢å¼•åˆ‡åˆ†ã€æ¨¡æ¿ã€åˆ«åã€æ•°æ®è¿ç§»ï¼‰</a></strong></li>
<li><strong><a href="http://abusehub-reindex.py/" target="_blank" rel="noopener">abusehub-reindex.py/</a></strong></li>
</ul>
<h4 id="reindex"><a href="#reindex" class="headerlink" title="reindex"></a>reindex</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</span><br><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> helpers</span><br><span class="line"></span><br><span class="line">host = [<span class="string">'es_host1'</span>, <span class="string">'es_host2'</span>, <span class="string">'es_host3'</span>]</span><br><span class="line">port = <span class="number">9200</span></span><br><span class="line">timeout = <span class="number">600</span></span><br><span class="line">auth_user = <span class="string">'elastic'</span></span><br><span class="line">auth_password = <span class="string">'hello world'</span></span><br><span class="line">use_ssl = <span class="literal">True</span></span><br><span class="line">ca_certs = <span class="string">'/opt/certs/ca/ca.crt'</span></span><br><span class="line"></span><br><span class="line">es = Elasticsearch(host, port=port, timeout=timeout, http_auth=(auth_user, auth_password), verify_certs=<span class="literal">True</span>, use_ssl=use_ssl, ca_certs=ca_certs)</span><br></pre></td></tr></table></figure>

<h5 id="æŒ‰ç…§æŒ‡å®šæ—¥æœŸé‡å»ºç´¢å¼•"><a href="#æŒ‰ç…§æŒ‡å®šæ—¥æœŸé‡å»ºç´¢å¼•" class="headerlink" title="æŒ‰ç…§æŒ‡å®šæ—¥æœŸé‡å»ºç´¢å¼•"></a>æŒ‰ç…§æŒ‡å®šæ—¥æœŸé‡å»ºç´¢å¼•</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">begin_date = (datetime.datetime.now() - datetime.timedelta(days = <span class="number">10</span>)).strftime(<span class="string">"%Y.%m.%d"</span>)</span><br><span class="line">begin_date = datetime.datetime.strptime(begin_date, <span class="string">"%Y.%m.%d"</span>)</span><br><span class="line">end_date = (datetime.datetime.now() - datetime.timedelta(days = <span class="number">1</span>)).strftime(<span class="string">"%Y.%m.%d"</span>)</span><br><span class="line">end_date = datetime.datetime.strptime(end_date, <span class="string">"%Y.%m.%d"</span>)</span><br><span class="line"></span><br><span class="line">date_list = []</span><br><span class="line"><span class="keyword">while</span> begin_date &lt;= end_date:</span><br><span class="line">    date_str = begin_date.strftime(<span class="string">"%Y.%m.%d"</span>)</span><br><span class="line">    date_list.append(date_str)</span><br><span class="line">    begin_date += datetime.timedelta(days=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">date_list</span><br><span class="line">[<span class="string">'2020.03.19'</span>,</span><br><span class="line"> <span class="string">'2020.03.20'</span>,</span><br><span class="line"> <span class="string">'2020.03.21'</span>,</span><br><span class="line"> <span class="string">'2020.03.22'</span>,</span><br><span class="line"> <span class="string">'2020.03.23'</span>,</span><br><span class="line"> <span class="string">'2020.03.24'</span>,</span><br><span class="line"> <span class="string">'2020.03.25'</span>,</span><br><span class="line"> <span class="string">'2020.03.26'</span>,</span><br><span class="line"> <span class="string">'2020.03.27'</span>,</span><br><span class="line"> <span class="string">'2020.03.28'</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">chunk_size = <span class="number">10000</span></span><br><span class="line"><span class="keyword">for</span> day <span class="keyword">in</span> date_list:</span><br><span class="line">    source_index = <span class="string">'wazuh-alerts-3.x-'</span> + day</span><br><span class="line">    target_index = <span class="string">'siem-alerts-'</span> + day</span><br><span class="line">    helpers.reindex(</span><br><span class="line">        client=es, source_index=source_index, target_index=target_index, </span><br><span class="line">        target_client=es, chunk_size=chunk_size</span><br><span class="line">    )</span><br><span class="line">    print(source_index + <span class="string">' -&gt; '</span> + target_index + <span class="string">' fin.'</span>)</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>ElasticSearch</tag>
      </tags>
  </entry>
  <entry>
    <title>Wazuh - å¦‚ä½•å¯¹å¼‚æ„æ•°æ®è¿›è¡Œå…³è”å‘Šè­¦</title>
    <url>/2020/02/25/Wazuh-%E5%A6%82%E4%BD%95%E5%AF%B9%E5%BC%82%E6%9E%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%E5%91%8A%E8%AD%A6/</url>
    <content><![CDATA[<p><strong>å†™åœ¨å‰é¢</strong></p>
<p>â€‹       è¿™å¹¶ä¸æ˜¯ä»€ä¹ˆ<strong>é«˜ç²¾å°–</strong>çš„æ¶æ„ä¸æŠ€æœ¯ã€‚è¿™åªæ˜¯æˆ‘ä¸ªäººåœ¨å·¥ä½œä¸­ç»“åˆç›®å‰æ‰‹å¤´çš„èµ„æºè¿›è¡Œäº†ä¸€äº›<strong>æ•´åˆ</strong> ã€‚å½“ç„¶å®ç°è¿™äº›éœ€æ±‚çš„æ–¹æ³•æœ‰å¾ˆå¤š, æœ‰é’±çš„å¯ä»¥è€ƒè™‘Splunk, æ²¡é’±çš„æœ‰ç ”å‘çš„å›¢é˜Ÿçš„å¯ä»¥ä¸ŠFlinkã€Esper ã€‚ </p>
<h4 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h4><p>â€‹    ç”±äºæ”»é˜²å¯¹æŠ—çš„å‡çº§, é€šè¿‡å•ä¸€çš„æ•°æ®æºå¾ˆéš¾ç›´æ¥æ–­è¨€æ”»å‡»æ˜¯å¦æˆåŠŸã€‚å› æ­¤, æˆ‘ä»¬éœ€è¦ç»“åˆå¤šä¸ªæ•°æ®æºè¿›è¡Œå®‰å…¨äº‹ä»¶çš„å…³è”, ä»ä¸­æç‚¼å‡ºå¯é æ€§è¾ƒé«˜çš„å®‰å…¨å‘Šè­¦è¿›è¡Œäººå·¥æ’æŸ¥ã€‚ä¾‹å¦‚: é’ˆå¯¹WebShellä¸Šä¼ ç±»çš„, å¯ä»¥é€šè¿‡<strong>ç½‘ç»œæµé‡ + ç»ˆç«¯</strong>è¿›è¡Œå…³è”; é’ˆå¯¹Webæ”»å‡»ç±», å¯ä»¥é€šè¿‡<strong>WAF + NIDS</strong>çš„äº‹ä»¶å…³è”, å¾—åˆ°Bypass WAF çš„å®‰å…¨å‘Šè­¦ã€‚</p>
<h4 id="è§£å†³æ€è·¯"><a href="#è§£å†³æ€è·¯" class="headerlink" title="è§£å†³æ€è·¯"></a>è§£å†³æ€è·¯</h4><p>â€‹    è™½ç„¶Wazuhæœ¬èº«å…·å¤‡å®‰å…¨äº‹ä»¶çš„å…³è”èƒ½åŠ›, ä½†åœ¨ä¼ ç»Ÿçš„éƒ¨ç½²æ¶æ„ä¸­, é€šå¸¸æ˜¯ç”±Wazuh Agentå°†å®‰å…¨äº‹ä»¶å‘é€åˆ°Wazuh Manager,é€šè¿‡Managerè¿›è¡Œå®‰å…¨äº‹ä»¶çš„å…³è”å‘Šè­¦ã€‚ç”±äºç¼ºå°‘äº†å¯¹æ•°æ®è¿›è¡ŒETL, ä½¿å¾—Wazuh Managerå¾ˆéš¾å¯¹å¼‚æ„æ•°æ®è¿›è¡Œå…³è”ã€‚å› æ­¤, æˆ‘ä»¬éœ€è¦é€šè¿‡Logstashå®ç°å¯¹æ•°æ®çš„æ ‡å‡†åŒ–, å¹¶å°†æ ‡å‡†åŒ–åçš„æ•°æ®é€šè¿‡Syslogçš„å½¢å¼å‘é€åˆ°Wazuh Manager, ä»è€Œè¿›è¡Œå¼‚æ„æ•°æ®çš„å…³è”ã€‚</p>
<h5 id="å‘ç‚¹"><a href="#å‘ç‚¹" class="headerlink" title="å‘ç‚¹"></a>å‘ç‚¹</h5><ol>
<li>æœ¬æ¬¡æ”¹é€ é‡‡ç”¨äº†<strong>Syslog</strong>çš„å½¢å¼å°†æ•°æ®å‘é€åˆ°Wazuh Managerç«¯è¿›è¡Œæ•°æ®å…³è”ã€‚ç”±äº<strong>Syslog</strong> é»˜è®¤é‡‡ç”¨äº†<strong>UDP</strong>åè®®è¿›è¡Œæ•°æ®ä¼ è¾“, å½“æ•°æ®å‘é€è¿‡å¤§æ—¶å°†ä¼šå¯¼è‡´<strong>æ•°æ®æˆªæ–­</strong>çš„æŠ¥é”™ã€‚é’ˆå¯¹æ­¤é—®é¢˜, éœ€æ”¹ç”¨<strong>TCP</strong>çš„å½¢å¼è¿›è¡Œæ•°æ®å‘é€è§„é¿æ­¤é—®é¢˜ã€‚</li>
<li>Wazuh Manager éƒ¨åˆ†å‘Šè­¦ç¼ºå°‘â€<strong>å¿…è¦</strong>â€œå…³è”å­—æ®µçš„ç°è±¡ã€‚å¦‚: æœ¬æ¬¡åœºæ™¯ä¸­<code>syscheck</code>å‘Šè­¦äº‹ä»¶, é»˜è®¤ä¸ä¼šæºå¸¦<code>srcip</code>çš„å­—æ®µ, å¯¹äºæ­¤é—®é¢˜å¯ä»¥é€šè¿‡åœ¨Managerä¸Šç¼–å†™ä¸€ä¸ªé¢„å¤„ç†è„šæœ¬æ¥è§£å†³ã€‚</li>
</ol>
<h4 id="æ”¹é€ "><a href="#æ”¹é€ " class="headerlink" title="æ”¹é€ "></a>æ”¹é€ </h4><ol>
<li><h5 id="æ”¹é€ ä¹‹å‰"><a href="#æ”¹é€ ä¹‹å‰" class="headerlink" title="æ”¹é€ ä¹‹å‰:"></a>æ”¹é€ ä¹‹å‰:</h5><p>Suricata (Wazuh agent) â€”(Agent: UDP 1514)â€”&gt; Wazuh Manager</p>
</li>
<li><h5 id="æ”¹é€ ä¹‹å"><a href="#æ”¹é€ ä¹‹å" class="headerlink" title="æ”¹é€ ä¹‹å:"></a>æ”¹é€ ä¹‹å:</h5><p>æ‰€æœ‰çš„æ ‡å‡†åŒ–éƒ½ç”±Logstashæ¥è¿›è¡Œ, Filebeatåªéœ€è¦åšâ€™<strong>æ— è„‘</strong>â€˜è½¬å‘å³å¯ã€‚</p>
</li>
</ol>
<p><strong>workflow:</strong></p>
<p><img src="/2020/02/25/Wazuh-å¦‚ä½•å¯¹å¼‚æ„æ•°æ®è¿›è¡Œå…³è”å‘Šè­¦/image-20200303215020561.png" alt="image-20200303215020561"></p>
<hr>
<h5 id="Filebeaté…ç½®"><a href="#Filebeaté…ç½®" class="headerlink" title="Filebeaté…ç½®"></a>Filebeaté…ç½®</h5><ul>
<li><h6 id="filebeat-yaml"><a href="#filebeat-yaml" class="headerlink" title="filebeat.yaml"></a>filebeat.yaml</h6></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#=========================== Filebeat inputs =============================</span></span><br><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="attr">- type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"/var/log/suricata/alert-*.json"</span></span><br><span class="line"><span class="attr">  fields_under_root:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  fields:</span> <span class="string">&#123;</span> <span class="attr">application:</span> <span class="string">suricata</span> <span class="string">&#125;</span></span><br><span class="line">  <span class="string">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line">  <span class="string">json.overwrite_keys:</span> <span class="literal">true</span></span><br><span class="line">  <span class="string">json.message_key:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  tail_files:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  scan_frequency:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line"><span class="attr">  harvester_buffer_size:</span> <span class="number">104857600</span></span><br><span class="line"><span class="attr">  backoff:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line"><span class="attr">  max_backoff:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  close_timeout:</span> <span class="number">30</span><span class="string">m</span></span><br><span class="line"><span class="attr">  close_inactive:</span> <span class="number">10</span><span class="string">m</span></span><br><span class="line"><span class="attr">  clean_inactive:</span> <span class="number">72</span><span class="string">h</span></span><br><span class="line"><span class="attr">  ignore_older:</span> <span class="number">70</span><span class="string">h</span></span><br><span class="line"><span class="attr">  registry_file:</span> <span class="string">/etc/filebeat/registry/wazuh/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Processors ==================================</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line"><span class="attr">- drop_fields:</span></span><br><span class="line"><span class="attr">    fields:</span> <span class="string">["ecs.version",</span> <span class="string">"agent.ephemeral_id"</span><span class="string">,</span> <span class="string">"agent.version"</span><span class="string">,</span> <span class="string">"agent.type"</span><span class="string">,</span> <span class="string">"agent.id"</span><span class="string">,</span> <span class="string">"agent.ephemeral_id"</span><span class="string">,</span> <span class="string">"input.type"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Outputs =====================================</span></span><br><span class="line"><span class="string">output.logstash:</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">["logstash:5010"]</span></span><br><span class="line"><span class="attr">  loadbalance:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  worker:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">  compression_level:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  bulk_max_size:</span> <span class="number">4096</span></span><br></pre></td></tr></table></figure>

<hr>
<h5 id="Logstashé…ç½®"><a href="#Logstashé…ç½®" class="headerlink" title="Logstashé…ç½®"></a>Logstashé…ç½®</h5><ul>
<li><h6 id="00-input-conf"><a href="#00-input-conf" class="headerlink" title="00_input.conf"></a>00_input.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5010</span><br><span class="line">    codec =&gt; <span class="string">"json_lines"</span></span><br><span class="line">    tags =&gt; [<span class="string">"beats"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="50-suricata-conf"><a href="#50-suricata-conf" class="headerlink" title="50_suricata.conf"></a>50_suricata.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  <span class="keyword">if</span> [application] == <span class="string">"suricata"</span> &#123;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [ <span class="string">"timestamp"</span>, <span class="string">"ISO8601"</span> ]</span><br><span class="line">      target =&gt; <span class="string">"timestamp"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="mapping-json"><a href="#mapping-json" class="headerlink" title="mapping.json"></a>mapping.json</h6></li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"common_mapping"</span>: &#123;</span><br><span class="line">        <span class="attr">"src_ip"</span>: <span class="string">"srcip"</span>,</span><br><span class="line">        <span class="attr">"dest_ip"</span>: <span class="string">"dstip"</span>,</span><br><span class="line">        <span class="attr">"src_port"</span>: <span class="string">"srcport"</span>,</span><br><span class="line">        <span class="attr">"dest_port"</span>: <span class="string">"dstport"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="70-normalized-suricata-conf"><a href="#70-normalized-suricata-conf" class="headerlink" title="70_normalized-suricata.conf"></a>70_normalized-suricata.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  <span class="built_in">clone</span> &#123;</span><br><span class="line">    clones =&gt; [ <span class="string">"siem_events"</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"siem_events"</span> &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      remove_field =&gt; [ <span class="string">"application"</span>, <span class="string">"type"</span>, <span class="string">"agent"</span>, <span class="string">"@version"</span>, <span class="string">"@timestamp"</span>]</span><br><span class="line">      add_field =&gt; &#123;</span><br><span class="line">        <span class="string">"provider"</span> =&gt; <span class="string">"Suricata"</span></span><br><span class="line">        <span class="string">"product"</span> =&gt; <span class="string">"Intrusion Detection System"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ruby &#123;</span><br><span class="line">      init =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">        require 'json'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        mapping_json = File.read('/etc/logstash/mappings/wazuh/mapping.json')</span></span><br><span class="line"><span class="string">        mapping = JSON.parse(mapping_json)</span></span><br><span class="line"><span class="string">        @common_mapping = mapping['common_mapping']</span></span><br><span class="line"><span class="string">      "</span></span><br><span class="line"></span><br><span class="line">      code =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">        keys = event.to_hash.keys</span></span><br><span class="line"><span class="string">        keys.each do |key|</span></span><br><span class="line"><span class="string">            if @common_mapping.include? key then</span></span><br><span class="line"><span class="string">                value = event.get(key)</span></span><br><span class="line"><span class="string">                event.remove(key)</span></span><br><span class="line"><span class="string">                new_key = @common_mapping[key]</span></span><br><span class="line"><span class="string">                event.set(new_key, value)</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        sensor = event.get('[host][name]')</span></span><br><span class="line"><span class="string">        event.set('sensor', sensor)</span></span><br><span class="line"><span class="string">      "</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="99-output-elasticsearch-conf"><a href="#99-output-elasticsearch-conf" class="headerlink" title="99_output-elasticsearch.conf"></a>99_output-elasticsearch.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [event_type] == <span class="string">"alert"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      cacert =&gt; <span class="string">"/etc/logstash/certs/ca/ca.crt"</span></span><br><span class="line">      user =&gt; <span class="string">"elastic"</span></span><br><span class="line">      password =&gt; <span class="string">"Hello World!"</span></span><br><span class="line">      hosts =&gt; [<span class="string">"https://elasticsearch:9200"</span>]</span><br><span class="line">      index =&gt; <span class="string">"suricata-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">      template =&gt; <span class="string">"/etc/logstash/index-template.d/suricata-template.json"</span></span><br><span class="line">      template_name =&gt; <span class="string">"suricata"</span></span><br><span class="line">      template_overwrite =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="99-output-wazuh-conf"><a href="#99-output-wazuh-conf" class="headerlink" title="99_output-wazuh.conf"></a>99_output-wazuh.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [provider] == <span class="string">"Suricata"</span> &#123;</span><br><span class="line">    syslog &#123;</span><br><span class="line">        host =&gt; <span class="string">"wazuh"</span></span><br><span class="line">        protocol =&gt; <span class="string">"tcp"</span></span><br><span class="line">        port =&gt; 514</span><br><span class="line">        codec =&gt; <span class="string">"json"</span></span><br><span class="line">        sourcehost =&gt; <span class="string">"logstash"</span></span><br><span class="line">        appname =&gt; <span class="string">"NORMALIZED"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#stdout &#123;</span></span><br><span class="line">        <span class="comment">#codec =&gt; rubydebug</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="Wazuhé…ç½®"><a href="#Wazuhé…ç½®" class="headerlink" title="Wazuhé…ç½®"></a>Wazuhé…ç½®</h5><ul>
<li><h6 id="custom-syscheck-py"><a href="#custom-syscheck-py" class="headerlink" title="custom-syscheck.py"></a>custom-syscheck.py</h6><p>Wazuh Manager æ–°å¢é¢„å¤„ç†è„šæœ¬å¯¹æŒ‡å®šçš„å®‰å…¨äº‹ä»¶è¿›è¡Œé¢„å¤„ç†ã€‚å¦‚: syscheckäº‹ä»¶å¢åŠ <code>srcip</code>å­—æ®µã€‚</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta, timezone</span><br><span class="line"></span><br><span class="line"><span class="comment"># ossec.conf configuration:</span></span><br><span class="line"><span class="comment">#  &lt;integration&gt;</span></span><br><span class="line"><span class="comment">#      &lt;name&gt;custom-syscheck&lt;/name&gt;</span></span><br><span class="line"><span class="comment">#      &lt;rule_id&gt;554&lt;/rule_id&gt;</span></span><br><span class="line"><span class="comment">#      &lt;group&gt;syscheck&lt;/group&gt;</span></span><br><span class="line"><span class="comment">#      &lt;alert_format&gt;json&lt;/alert_format&gt;</span></span><br><span class="line"><span class="comment">#  &lt;/integration&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Global vars</span></span><br><span class="line">debug_enabled = <span class="literal">False</span></span><br><span class="line">pwd = os.path.dirname(os.path.dirname(os.path.realpath(__file__)))</span><br><span class="line">json_alert = &#123;&#125;</span><br><span class="line">now = time.strftime(<span class="string">"%a %b %d %H:%M:%S %Z %Y"</span>)</span><br><span class="line">wazuh_server = <span class="string">"192.168.199.97"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set paths</span></span><br><span class="line">log_file = <span class="string">'&#123;0&#125;/logs/integrations.log'</span>.format(pwd)</span><br><span class="line">syscheck_file = <span class="string">'&#123;0&#125;/logs/syscheck.json'</span>.format(pwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">iso8601</span><span class="params">(hours=<span class="number">8</span>)</span>:</span></span><br><span class="line">    td = timedelta(hours=hours)</span><br><span class="line">    tz = timezone(td)</span><br><span class="line">    <span class="keyword">return</span> datetime.now(tz=tz).isoformat()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(args)</span>:</span></span><br><span class="line">    debug(<span class="string">"# Starting"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read args</span></span><br><span class="line">    alert_file_location = args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">"# File location"</span>)</span><br><span class="line">    debug(alert_file_location)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Load alert. Parse JSON object.</span></span><br><span class="line">    <span class="keyword">with</span> open(alert_file_location) <span class="keyword">as</span> alert_file:</span><br><span class="line">        json_alert = json.load(alert_file)</span><br><span class="line">    debug(<span class="string">"# Processing alert"</span>)</span><br><span class="line">    debug(json_alert)</span><br><span class="line"></span><br><span class="line">    alert = normalized_data(json_alert)</span><br><span class="line">    <span class="keyword">with</span> open(syscheck_file, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        msg = json.dumps(alert)</span><br><span class="line">        f.write(msg + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> debug_enabled:</span><br><span class="line">        msg = <span class="string">"&#123;0&#125;: &#123;1&#125;\n"</span>.format(now, msg)</span><br><span class="line">        <span class="keyword">with</span> open(log_file, <span class="string">"a"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(msg)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalized_data</span><span class="params">(alert)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> alert[<span class="string">'agent'</span>][<span class="string">'id'</span>] == <span class="string">'000'</span>:</span><br><span class="line">        alert[<span class="string">'srcip'</span>] = wazuh_server</span><br><span class="line">    <span class="keyword">elif</span> alert[<span class="string">'agent'</span>].get(<span class="string">'ip'</span>):</span><br><span class="line">        alert[<span class="string">'srcip'</span>] = alert[<span class="string">'agent'</span>][<span class="string">'ip'</span>]</span><br><span class="line">        alert[<span class="string">'dstip'</span>] = alert[<span class="string">'agent'</span>][<span class="string">'ip'</span>]</span><br><span class="line">    alert[<span class="string">'integration'</span>] = <span class="string">'custom-syscheck'</span></span><br><span class="line">    alert[<span class="string">'create_timestamp'</span>] = iso8601()</span><br><span class="line">    debug(alert)</span><br><span class="line">    <span class="keyword">return</span>(alert)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Read arguments</span></span><br><span class="line">        bad_arguments = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> len(sys.argv) &gt;= <span class="number">4</span>:</span><br><span class="line">            msg = <span class="string">'&#123;0&#125; &#123;1&#125; &#123;2&#125; &#123;3&#125; &#123;4&#125;'</span>.format(now, sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>], sys.argv[<span class="number">3</span>], sys.argv[<span class="number">4</span>] <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">4</span> <span class="keyword">else</span> <span class="string">''</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = <span class="string">'&#123;0&#125; Wrong arguments'</span>.format(now)</span><br><span class="line">            bad_arguments = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Logging the call</span></span><br><span class="line">        <span class="keyword">with</span> open(log_file, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(msg + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> bad_arguments:</span><br><span class="line">            debug(<span class="string">"# Exiting: Bad arguments."</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Main function</span></span><br><span class="line">        main(sys.argv)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        debug(str(e))</span><br><span class="line">        <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="ossec-conf"><a href="#ossec-conf" class="headerlink" title="ossec.conf"></a>ossec.conf</h6><ul>
<li>é…ç½®syslogé€‰ç”¨<strong>TCP</strong>åè®®;</li>
<li>åŠ è½½é¢„å¤„ç†è„šæœ¬;</li>
<li>åŠ è½½è„šæœ¬è¾“å‡ºæ—¥å¿—;</li>
</ul>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ossec_config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">remote</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">connection</span>&gt;</span>syslog<span class="tag">&lt;/<span class="name">connection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>514<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">protocol</span>&gt;</span>tcp<span class="tag">&lt;/<span class="name">protocol</span>&gt;</span> <span class="comment">&lt;!-- udp(default)/tcp --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">allowed-ips</span>&gt;</span>192.168.199.0/24<span class="tag">&lt;/<span class="name">allowed-ips</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">remote</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- Custom external Integration --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">integration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>custom-syscheck<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule_id</span>&gt;</span>554<span class="tag">&lt;/<span class="name">rule_id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span>&gt;</span>syscheck<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">alert_format</span>&gt;</span>json<span class="tag">&lt;/<span class="name">alert_format</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">integration</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- Custom syscheck.json --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">localfile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">log_format</span>&gt;</span>json<span class="tag">&lt;/<span class="name">log_format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/var/ossec/logs/syscheck.json<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">localfile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ossec_config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="local-decoder-normalized-xml"><a href="#local-decoder-normalized-xml" class="headerlink" title="local_decoder_normalized.xml"></a>local_decoder_normalized.xml</h6></li>
</ul>
<p><strong>Sample</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">2020 Mar 03 02:53:39 logstash NORMALIZED[-]: &#123;"timestamp":"2020-02-21T19:47:04.382300+0800","flow_id":1133835979634527,"in_iface":"wlp3s0","event_type":"alert","src_ip":"192.168.199.97","src_port":60022,"dest_ip":"192.168.199.162","dest_port":59143,"proto":"TCP","alert":&#123;"action":"allowed","gid":1,"signature_id":123456,"rev":1,"signature":"LOCAL RULES XXX","severity":3&#125;&#125;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">decoder</span> <span class="attr">name</span>=<span class="string">"nta_json"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prematch</span>&gt;</span>NORMALIZED[-]: <span class="tag">&lt;/<span class="name">prematch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin_decoder</span> <span class="attr">offset</span>=<span class="string">"after_prematch"</span>&gt;</span>JSON_Decoder<span class="tag">&lt;/<span class="name">plugin_decoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">decoder</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="0901-local-raw-xml"><a href="#0901-local-raw-xml" class="headerlink" title="0901-local_raw.xml"></a>0901-local_raw.xml</h6><ul>
<li>é»˜è®¤å¼•ç”¨çš„è§£ç å™¨ä¸º<code>json</code>, è¿™é‡Œéœ€è¦ä¿®æ”¹ä¸ºåˆšæ‰æ–°å¢çš„<code>nta_json</code>;</li>
<li>é€šè¿‡<code>overwrite=yes</code>è¦†ç›–åŸå§‹è§„åˆ™;</li>
</ul>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"suricata,"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- /var/ossec/ruleset/rules/0475-suricata_rules.xml --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Defind Suricata Rules --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ID: 86600 - 86699 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"86600"</span> <span class="attr">level</span>=<span class="string">"0"</span> <span class="attr">overwrite</span>=<span class="string">"yes"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">decoded_as</span>&gt;</span>nta_json<span class="tag">&lt;/<span class="name">decoded_as</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"timestamp"</span>&gt;</span>\.+<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"event_type"</span>&gt;</span>\.+<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Suricata messages.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="0905-local-syscheck-xml"><a href="#0905-local-syscheck-xml" class="headerlink" title="0905-local_syscheck.xml"></a>0905-local_syscheck.xml</h6><p>ä¸ºé¢„å¤„ç†è„šæœ¬ç”Ÿæˆçš„æ—¥å¿—è¿›è¡Œè§£æ</p>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"syscheck,"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"187100"</span> <span class="attr">level</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">decoded_as</span>&gt;</span>json<span class="tag">&lt;/<span class="name">decoded_as</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"integration"</span>&gt;</span>custom-syscheck<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>syscheck integration messages.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="9999-local-composite-xml"><a href="#9999-local-composite-xml" class="headerlink" title="9999-local_composite.xml"></a>9999-local_composite.xml</h6></li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"local,composite,"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Local Composite Rules Range ID: 200000 - 205000 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"200000"</span> <span class="attr">level</span>=<span class="string">"15"</span> <span class="attr">frequency</span>=<span class="string">"2"</span> <span class="attr">timeframe</span>=<span class="string">"600"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_matched_sid</span>&gt;</span>101000<span class="tag">&lt;/<span class="name">if_matched_sid</span>&gt;</span> <span class="comment">&lt;!-- æ–‡ä»¶ä¸Šä¼ ç±»è§„åˆ™ or æ£€æµ‹WebShellä¸Šä¼ ç±»è§„åˆ™ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_sid</span>&gt;</span>187100<span class="tag">&lt;/<span class="name">if_sid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">same_source_ip</span> /&gt;</span>	<span class="comment">&lt;!-- é€šè¿‡IPè¿›è¡Œå…³è” --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Phase 3: æ£€æµ‹åˆ°æœåŠ¡å™¨:$(srcip), è¢«ä¸Šä¼ WebShell.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"200001"</span> <span class="attr">level</span>=<span class="string">"12"</span> <span class="attr">frequency</span>=<span class="string">"2"</span> <span class="attr">timeframe</span>=<span class="string">"600"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_matched_sid</span>&gt;</span>88801<span class="tag">&lt;/<span class="name">if_matched_sid</span>&gt;</span> <span class="comment">&lt;!-- WAFå®‰å…¨äº‹ä»¶ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_group</span>&gt;</span>ids<span class="tag">&lt;/<span class="name">if_group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">same_source_ip</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Phase 3: Alarm - Same ip Bypass WAF of within 600 seconds. $(srcip) -&gt; $(http.hostname) -&gt; $(alert.signature) -&gt; $(alert.signature_id).<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ol>
<li>å¯¹äº<strong>WebShell</strong>å…³è”æ£€æµ‹,ç›®å‰é‡‡ç”¨çš„æ˜¯åŒæºIPä»¥åŠæ—¶åºçš„å…³è”, æœ€ä¸ºé è°±çš„åº”è¯¥æ˜¯é€šè¿‡Hashçš„æ¯”å¯¹ã€‚è¿™é‡Œè¦åæ§½ä¸€ä¸‹Suricataé»˜è®¤çš„fileinfo, æ²¡åŠæ³•è‡ªå®šä¹‰è¾“å‡º, åªè¦å¼€å¯å¯è¢«è¿˜åŸçš„åè®®éƒ½ä¼šè¾“å‡ºfileinfoçš„äº‹ä»¶ã€‚æ­£å› å¦‚æ­¤, æ•°æ®é‡ä¸€å¤§Wazuhçš„å¼•æ“å‹åŠ›ä¼šå¾ˆå¤§ã€‚æˆ‘å°è¯•é€šè¿‡<strong>Lua</strong>æ¥è‡ªå®šä¹‰ä¸€ä¸ªæ–‡ä»¶å®¡è®¡ç±»çš„äº‹ä»¶, è²Œä¼¼ä¹ŸåŒæ ·æ²¡åŠæ³•åŒºåˆ†åè®®æ›´åˆ«è¯´é’ˆå¯¹httpè¿‡æ»¤æ¡ä»¶è¿›è¡Œè‡ªå®šä¹‰çš„è¿‡æ»¤è¾“å‡ºäº†ã€‚</li>
</ol>
<ol start="2">
<li>ç”±äºå…³è”è§„åˆ™æœ¬èº«æ˜¯é€šè¿‡åº•å±‚å¤šä¸ªå®‰å…¨äº‹ä»¶è¿›è¡Œç»´åº¦çš„å…³è”æå‡å‘Šè­¦çš„<strong>å¯é æ€§</strong>ã€‚å› æ­¤, åº•å±‚å®‰å…¨äº‹ä»¶ä¸å¤Ÿå‡†ç¡®åŒæ ·ä¼šè®©ä¸Šå±‚çš„å…³è”è§„åˆ™å¸¦æ¥å¤§é‡è¯¯æŠ¥ã€‚å¯¹äºåº•å±‚å®‰å…¨äº‹ä»¶çš„ä¼˜åŒ–ä¹Ÿæ˜¯éœ€è¦æŒç»­è¿›è¡Œçš„ã€‚</li>
</ol>
<ol start="3">
<li><strong>Wazuh v3.11.4</strong> é‡‡ç”¨syslogæ¥æ”¶å¤§æ—¥å¿—æ—¶, ä¼šè§¦å‘<code>memory violation</code>å¯¼è‡´<code>ossec-remoted</code>è¿›ç¨‹é‡å¯, è¯¥é—®é¢˜å·²å‘ç¤¾åŒºåé¦ˆä¸‹ä¸ªç‰ˆæœ¬ä¸­ä¼šè§£å†³ã€‚</li>
</ol>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><p><strong><a href="https://wazuh.com/blog/how-to-forward-android-syslog-to-wazuh/" target="_blank" rel="noopener">How to forward Android syslog to Wazuh</a></strong></p>
</li>
<li><p><strong><a href="https://wazuh.com/blog/how-to-configure-rsyslog-client-to-send-events-to-wazuh/" target="_blank" rel="noopener">How to configure Rsyslog client to send events to Wazuh</a></strong></p>
</li>
<li><p><strong><a href="https://wazuh.com/blog/how-to-integrate-external-software-using-integrator/" target="_blank" rel="noopener">How to integrate external software using Integrator</a></strong></p>
</li>
</ul>
]]></content>
      <categories>
        <category>HIDSã€NIDS</category>
      </categories>
      <tags>
        <tag>Logstash</tag>
        <tag>Suricata</tag>
        <tag>Wazuh</tag>
        <tag>Filbeat</tag>
      </tags>
  </entry>
  <entry>
    <title>Wazuh - åˆ©ç”¨CDB listè¿‡æ»¤ç§ç½‘IPåœ°å€</title>
    <url>/2020/01/31/Wazuh-%E5%88%A9%E7%94%A8CDB-list%E8%BF%87%E6%BB%A4%E7%A7%81%E7%BD%91IP%E5%9C%B0%E5%9D%80/</url>
    <content><![CDATA[<h4 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h4><p>â€‹        ç›®å‰å¹³å°æ¥å…¥äº†<strong>Suricata</strong>çš„å‘Šè­¦è§„åˆ™, ç”±äºé•œåƒæºçš„å…³ç³»éƒ¨åˆ†è§„åˆ™äº§ç”Ÿäº†<strong>â€˜è¯¯â€™</strong>å‘Šè­¦, å› æ­¤éœ€è¦é’ˆå¯¹è¿™éƒ¨åˆ†è§„åˆ™è¿›è¡ŒIPåœ°å€çš„è¿‡æ»¤ã€‚</p>
<h4 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h4><ol>
<li>ä¿®æ”¹Suricataçš„è§„åˆ™, å¦‚æœä½ çš„<strong>â€˜è¯¯â€™</strong>å‘Šè­¦é‡å¾ˆå¤§ä¸”ä¸ºäº†æ€§èƒ½è€ƒè™‘, æ¨èç›´æ¥ä¿®æ”¹Suricataçš„è§„åˆ™ã€‚</li>
<li>ç”±äºæˆ‘è¿™è¾¹çš„Suricataå‘Šè­¦éƒ½æ˜¯åˆ©ç”¨Wazuhè¿›è¡Œ<strong>â€˜æ¶ˆè´¹â€™</strong>çš„ã€‚å› æ­¤, æˆ‘è¿™è¾¹ç›´æ¥é‡‡ç”¨äº†<strong><a href="https://documentation.wazuh.com/3.10/user-manual/ruleset/cdb-list.html" target="_blank" rel="noopener">Wazuh CDB list</a></strong>è¿™ä¸ªåŠŸèƒ½è¿›è¡ŒæŒ‡å®šIPåœ°å€çš„è¿‡æ»¤ã€‚</li>
</ol>
<h4 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h4><h5 id="1-åˆ›å»º-CDB-list"><a href="#1-åˆ›å»º-CDB-list" class="headerlink" title="1. åˆ›å»º CDB list"></a>1. åˆ›å»º CDB list</h5><blockquote>
<p>Each key must be unique and is terminated with a colon <code>:</code>.</p>
<p>For IP addresses the dot notation is used for subnet matches:</p>
</blockquote>
<table>
<thead>
<tr>
<th>key</th>
<th>CIDR</th>
<th>Possible matches</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.:</td>
<td>192.168.0.0/16</td>
<td>192.168.0.0 - 192.168.255.255</td>
</tr>
<tr>
<td>172.16.19.:</td>
<td>172.16.19.0/24</td>
<td>172.16.19.0 - 172.16.19.255</td>
</tr>
<tr>
<td>10.1.1.1:</td>
<td>10.1.1.1/32</td>
<td>10.1.1.1</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /var/ossec/etc/lists/private_ip</span><br><span class="line"></span><br><span class="line">10.168.:PrivateNet</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Since Wazuh v3.11.3, CDB lists are built and loaded automatically when the analysis engine is started. Therefore, when adding or modifying CDB lists, it is no longer needed to run <code>ossec-makelists</code>, just restart the manager.</p>
</blockquote>
<p>ä»Wazuh v3.11.3å¼€å§‹ï¼Œå°†åœ¨å¯åŠ¨åˆ†æå¼•æ“æ—¶è‡ªåŠ¨æ„å»ºå’ŒåŠ è½½CDBåˆ—è¡¨ã€‚å› æ­¤ï¼Œæ·»åŠ æˆ–ä¿®æ”¹CDBåˆ—è¡¨æ—¶ï¼Œä¸å†éœ€è¦è¿è¡Œossec-makelistsï¼Œåªéœ€é‡æ–°å¯åŠ¨ç®¡ç†å™¨å³å¯ã€‚</p>
<blockquote>
<p><strong>3.11.3 ä¹‹å‰ç‰ˆæœ¬éœ€è¦æ‰§è¡Œ</strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ /var/ossec/bin/ossec-makelists</span><br></pre></td></tr></table></figure>

<h5 id="2-åœ¨-ossec-conf-ä¸­æ·»åŠ -list"><a href="#2-åœ¨-ossec-conf-ä¸­æ·»åŠ -list" class="headerlink" title="2. åœ¨ ossec.conf ä¸­æ·»åŠ  list"></a>2. åœ¨ ossec.conf ä¸­æ·»åŠ  list</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /var/ossec/etc/ossec.conf</span><br><span class="line"></span><br><span class="line">&lt;ossec_config&gt;</span><br><span class="line">  &lt;ruleset&gt;</span><br><span class="line">    &lt;!-- User-defined CDB --&gt;</span><br><span class="line">    &lt;list&gt;etc/lists/private_ip&lt;/list&gt;</span><br><span class="line">  &lt;/ruleset&gt;</span><br><span class="line">&lt;/ossec_config&gt;</span><br></pre></td></tr></table></figure>

<h5 id="3-é‡å¯è¿›ç¨‹"><a href="#3-é‡å¯è¿›ç¨‹" class="headerlink" title="3. é‡å¯è¿›ç¨‹"></a>3. é‡å¯è¿›ç¨‹</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl restart wazuh-manager</span><br></pre></td></tr></table></figure>

<h5 id="4-é…ç½®è§„åˆ™"><a href="#4-é…ç½®è§„åˆ™" class="headerlink" title="4. é…ç½®è§„åˆ™"></a>4. é…ç½®è§„åˆ™</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;var name=<span class="string">"SAME_IP_TIME"</span>&gt;120&lt;/var&gt;</span><br><span class="line">&lt;var name=<span class="string">"SAME_IP_IGORE"</span>&gt;300&lt;/var&gt;</span><br><span class="line"></span><br><span class="line">&lt;group name=<span class="string">"local,suricata,ids,"</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;rule id=<span class="string">"102018"</span> level=<span class="string">"8"</span> frequency=<span class="string">"5"</span> timeframe=<span class="string">"<span class="variable">$SAME_IP_TIME</span>"</span> ignore=<span class="string">"<span class="variable">$SAME_IP_IGORE</span>"</span>&gt;</span><br><span class="line">      &lt;if_matched_sid&gt;86601&lt;/if_matched_sid&gt;</span><br><span class="line">      &lt;field name=<span class="string">"alert.signature_id"</span>&gt;2013057&lt;/field&gt;</span><br><span class="line">      &lt;list field=<span class="string">"src_ip"</span> lookup=<span class="string">"not_address_match_key"</span>&gt;etc/lists/private_ip&lt;/list&gt;</span><br><span class="line">      &lt;description&gt;Wazuh Rules - Same ip of attack occurred 5 <span class="built_in">times</span> within <span class="variable">$SAME_IP_TIME</span> seconds. $(src_ip) -&gt; $(alert.signature) -&gt; $(alert.signature_id).&lt;/description&gt;</span><br><span class="line">      &lt;options&gt;no_full_log&lt;/options&gt;</span><br><span class="line">    &lt;/rule&gt;</span><br><span class="line"></span><br><span class="line">&lt;/group&gt;</span><br></pre></td></tr></table></figure>

<h5 id="5-æµ‹è¯•è§„åˆ™"><a href="#5-æµ‹è¯•è§„åˆ™" class="headerlink" title="5. æµ‹è¯•è§„åˆ™"></a>5. æµ‹è¯•è§„åˆ™</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ /var/ossec/bin/ossec-logtest</span><br></pre></td></tr></table></figure>

<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><strong><a href="https://documentation.wazuh.com/3.11/user-manual/ruleset/cdb-list.html?highlight=match_key" target="_blank" rel="noopener">Using CDB lists</a></strong></li>
</ul>
]]></content>
      <categories>
        <category>HIDS</category>
      </categories>
      <tags>
        <tag>Wazuh</tag>
      </tags>
  </entry>
  <entry>
    <title>Logstash Event API</title>
    <url>/2019/12/30/Logstash-Event-API/</url>
    <content><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>â€‹        ç”±äºé¡¹ç›®éœ€è¦, ç”¨åˆ°äº†<code>Ruby</code>å¯¹Logstashè¿›è¡Œä¸€äº›å®šåˆ¶åŒ–çš„é…ç½®ã€‚ç¿»éäº†æ•´ä¸ªLogstashçš„å®˜æ–¹æ–‡æ¡£, å¯¹äºRuby APIçš„ä»‹ç»å°±å†™äº†ä¸¤ä¸ªæ–¹æ³•ã€‚<code>get</code> ä¸ <code>set</code> ä¹Ÿæ˜¯é†‰äº†ğŸ˜‚, å¹¸å¥½è°·æ­Œä¸€ä¸‹â€¦</p>
<h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><ul>
<li>åˆ é™¤äº‹ä»¶ï¼šcancel</li>
<li>å–æ¶ˆåˆ é™¤äº‹ä»¶ï¼šuncancel</li>
<li>æ˜¯å¦åˆ é™¤ï¼šcancelled?</li>
<li>æ˜¯å¦åŒ…å«å­—æ®µï¼šinclude?</li>
<li>åˆ é™¤å­—æ®µï¼šremove</li>
<li>äº‹ä»¶è½¬å­—ç¬¦ä¸²ï¼što_s</li>
<li>äº‹ä»¶è½¬hashå­—å…¸ï¼ˆä¸å«metadataå­—æ®µï¼‰ï¼što_hash</li>
<li>äº‹ä»¶è½¬hashå­—å…¸ï¼ˆå«metadataå­—æ®µï¼‰ï¼što_hash_with_metadata</li>
<li>äº‹ä»¶è½¬jsonå­—ç¬¦ä¸²ï¼što_json</li>
<li>å¢åŠ tagï¼štag</li>
<li>å–äº‹ä»¶æ—¶é—´æˆ³ï¼štimestamp</li>
</ul>
<p><strong>æ›´å¤šæŸ¥è¯¢å®˜æ–¹æ¥å£æºç :</strong> <a href="https://github.com/elastic/logstash/blob/master/logstash-core/src/main/java/org/logstash/ext/JrubyEventExtLibrary.java" target="_blank" rel="noopener"><strong>JrubyEventExtLibrary.java</strong></a></p>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><strong><a href="https://blog.csdn.net/mvpboss1004/article/details/78070300" target="_blank" rel="noopener">Lostash event APIè¯¦è§£</a></strong></li>
<li><a href="https://github.com/elastic/logstash/blob/master/logstash-core/src/main/java/org/logstash/ext/JrubyEventExtLibrary.java" target="_blank" rel="noopener"><strong>JrubyEventExtLibrary.java</strong></a></li>
<li><strong><a href="https://www.rubydoc.info/gems/logstash-event/1.1.5/LogStash/Event#cancel-instance_method" target="_blank" rel="noopener">Class: LogStash::Event</a></strong></li>
</ul>
]]></content>
      <categories>
        <category>ELK</category>
      </categories>
      <tags>
        <tag>Logstash</tag>
      </tags>
  </entry>
  <entry>
    <title>Logstash Multiple Pipelines</title>
    <url>/2019/12/30/Logstash-Multiple-Pipelines/</url>
    <content><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>å½“Logstashè¦å¤„ç†çš„å¤šä¸ªinputç±»å‹æ—¶, æœ€å¸¸è§çš„ä¸¤ç§è§£å†³æ–¹æ¡ˆ(<strong>ä¸æ¨è</strong>):</p>
<ol>
<li><p>é€šè¿‡æ¡ä»¶åˆ¤æ–­è§£å†³é—®é¢˜</p>
</li>
<li><p>é€šè¿‡å¤šå®ä¾‹è§£å†³é—®é¢˜</p>
</li>
</ol>
<p><strong>è´Ÿé¢å½±å“:</strong></p>
<ol>
<li><p>æ¡ä»¶åˆ¤æ–­</p>
<ol>
<li>æ¡ä»¶åœ°ç‹±ã€‚å·²çŸ¥çš„åœ¨ä¸€ä¸ªç®¡é“ä¸­å®ç°å¤šä¸ªç‹¬ç«‹æµçš„æ–¹æ³•æ˜¯ä½¿ç”¨æ¡ä»¶åˆ¤æ–­ã€‚ä¸»è¦æ–¹å¼æ˜¯åœ¨è¾“å…¥éƒ¨åˆ†é€šè¿‡æ ‡ç­¾æ ‡è®°äº‹ä»¶ï¼Œç„¶ååœ¨è¿‡æ»¤å™¨ä¸­å’Œè¾“å‡ºé˜¶æ®µåˆ›å»ºæ¡ä»¶åˆ†æ”¯ï¼Œå¯¹è´´æœ‰ä¸åŒæ ‡ç­¾çš„äº‹ä»¶ï¼Œåº”ç”¨ä¸åŒçš„æ’ä»¶é›†ã€‚è¿™ç§æ–¹å¼è™½ç„¶å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†åœ¨å®é™…çš„ä½¿ç”¨ä¸­å´éå¸¸çš„ç—›è‹¦ï¼ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ demo ç‰‡æ®µï¼š</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    beats &#123; </span><br><span class="line">        port =&gt; 3444  </span><br><span class="line">        tag =&gt; apache </span><br><span class="line">    &#125;</span><br><span class="line">    tcp &#123; </span><br><span class="line">        port =&gt; 4222</span><br><span class="line">        tag =&gt; firewall</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"apache"</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        dissect &#123; ... &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">"firewall"</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        grok &#123; ... &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"apache"</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        elasticsearch &#123; ... &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">"firewall"</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        tcp &#123; ... &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol>
<li>ç¼ºä¹æ‹¥å¡ç®¡ç†ã€‚Logstashåœ¨æ‰€æœ‰äº‹ä»¶å’Œå®Œæˆæ‰€æœ‰è¾“å‡ºä¹‹å‰ä¸ä¼šç§»åŠ¨åˆ°ä¸‹ä¸€æ‰¹äº‹ä»¶ã€‚è¿™æ„å‘³ç€ï¼Œå¯¹äºä¸Šé¢çš„ç®¡é“ï¼Œå¦‚æœ TCP å¥—æ¥å­—ç›®æ ‡ä¸å¯è¾¾ï¼ŒLogstashå°†ä¸ä¼šå¤„ç†å…¶ä»–æ‰¹æ¬¡çš„äº‹ä»¶ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ Elasticsearch å°†ä¸ä¼šæ¥æ”¶äº‹ä»¶ï¼Œå¹¶ä¸”ä¼šå¯¹ TCP è¾“å…¥å’Œ Beats è¾“å…¥æ–½åŠ åå‹åŠ›ã€‚</li>
<li>ä¸åŒçš„æ•°æ®æµéœ€è¦ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†ã€‚å¦‚æœ TCP - &gt; Grok - &gt; TCP æ•°æ®æµå¤„ç†å¤§é‡çš„å°æ•°æ®ï¼Œè€Œ Beats -&gt; Dissect -&gt; ES æ•°æ®æµä¸­çš„å•ä¸ªæ•°æ®ä½“ç§¯å¤§ä½†æ˜¯æ•°é‡å°‘ã€‚é‚£ä¹ˆå‰ä¸€ä¸ªæ•°æ®æµå¸Œæœ›æœ‰å¤šä¸ª worker å¹¶è¡Œå¹¶å…¶æ¯ä¸€æ‰¹æ¬¡å¤„ç†æ›´å¤šäº‹ä»¶ï¼Œç¬¬äºŒä¸ªæ•°æ®æµåˆ™æœŸæœ›ä½¿ç”¨å°‘é‡çš„ worker å’Œæ¯æ‰¹æ¬¡å¤„ç†å°‘é‡çš„äº‹ä»¶ã€‚ä½¿ç”¨å•ä¸ªç®¡é“ï¼Œæ— æ³•ä¸ºå•ä¸ªæ•°æ®æµæŒ‡å®šç‹¬ç«‹çš„ç®¡é“é…ç½®ã€‚</li>
</ol>
<ol start="2">
<li>å¤šå®ä¾‹<ol>
<li>éœ€è¦ç®¡ç†å¤šä¸ªå®ä¾‹(é€šè¿‡ init ç³»ç»Ÿç®¡ç†å¤šä¸ªåå°æœåŠ¡)</li>
<li>æ¯ä¸ª Logstash çš„å®ä¾‹ä¹Ÿæ„å‘³ç€ä¸€ä¸ªç‹¬ç«‹çš„ JVM</li>
<li>éœ€è¦ç›‘è§†æ¯ä¸ª Logstash å®ä¾‹</li>
</ol>
</li>
</ol>
<h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><p>â€‹        é€šè¿‡é…ç½®å¤šç®¡é“(Multiple Pipelines), è§£å†³ä»¥ä¸Šçš„æ‰€æœ‰é—®é¢˜ã€‚</p>
<h5 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h5><p><code>/usr/share/logstash/config/pipelines.yml</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># This file is where you define your pipelines. You can define multiple.</span></span><br><span class="line"><span class="comment"># For more information on multiple pipelines, see the documentation:</span></span><br><span class="line"><span class="comment">#   https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html</span></span><br><span class="line"></span><br><span class="line">- pipeline.id: dsiem</span><br><span class="line">  path.config: <span class="string">"/etc/logstash/conf.d_siem/*.conf"</span></span><br><span class="line">  pipeline.workers: 16</span><br><span class="line">  queue.type: persisted</span><br><span class="line">  queue.max_bytes: 300gb</span><br><span class="line"></span><br><span class="line">- pipeline.id: cloudflare</span><br><span class="line">  path.config: <span class="string">"/etc/logstash/conf.d_cf/*.conf"</span></span><br><span class="line">  pipeline.workers: 8</span><br><span class="line">  queue.type: persisted</span><br><span class="line">  queue.max_bytes: 100gb</span><br><span class="line"></span><br><span class="line">- pipeline.id: ti</span><br><span class="line">  path.config: <span class="string">"/etc/logstash/conf.d_ti/*.conf"</span></span><br><span class="line">  pipeline.workers: 8</span><br><span class="line">  queue.type: persisted</span><br><span class="line">  queue.max_bytes: 50gb</span><br></pre></td></tr></table></figure>

<p><code>/etc/supervisord.d/logstash.ini</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[program:logstash]</span><br><span class="line"><span class="built_in">command</span>=/usr/share/logstash/bin/logstash --path.data /lingtian/data/logstash/</span><br><span class="line"><span class="comment">#user=logstash</span></span><br><span class="line">numprocs=1</span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">startsecs=1</span><br><span class="line">startretries=3</span><br><span class="line">exitcodes=0,2</span><br><span class="line">stopsignal=INT</span><br><span class="line">redirect_stderr=<span class="literal">true</span></span><br><span class="line">stdout_logfile_maxbytes=1MB</span><br><span class="line">stdout_logfile_backups=5</span><br><span class="line">stdout_capture_maxbytes=1MB</span><br><span class="line">stdout_logfile=/lingtian/logs/logstash/logstash.log</span><br></pre></td></tr></table></figure>

<h5 id="åŠ è½½é…ç½®æ–‡ä»¶"><a href="#åŠ è½½é…ç½®æ–‡ä»¶" class="headerlink" title="åŠ è½½é…ç½®æ–‡ä»¶"></a>åŠ è½½é…ç½®æ–‡ä»¶</h5><p>å¯é€šè¿‡ä½¿ç”¨å‚æ•°, <code>--config.reload.automatic</code> or <code>-r</code> åœ¨é…ç½®æ–‡ä»¶å‘ç”Ÿæ›´æ”¹åè‡ªåŠ¨æ£€æµ‹å¹¶é‡æ–°åŠ è½½é…ç½®ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ bin/logstash -f apache.config --config.reload.automatic</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤3ç§’æ£€æŸ¥é…ç½®æ–‡ä»¶, å¯ä»¥é€šè¿‡ä½¿ç”¨å‚æ•°, <code>--config.reload.interval</code>ä¿®æ”¹ç§’æ•°ã€‚</p>
<p>å¦‚æœLogstashå·²ç»åœ¨æ²¡æœ‰å¯ç”¨è‡ªåŠ¨é‡è½½çš„æƒ…å†µä¸‹è¿è¡Œï¼Œåˆ™å¯ä»¥é€šè¿‡å‘è¿è¡ŒLogstashçš„è¿›ç¨‹å‘é€SIGHUPï¼ˆä¿¡å·æŒ‚èµ·ï¼‰æ¥å¼ºåˆ¶Logstashé‡è½½é…ç½®æ–‡ä»¶å¹¶é‡æ–°å¯åŠ¨ç®¡é“ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> -SIGHUP <span class="variable">$logstash_pid</span></span><br></pre></td></tr></table></figure>

<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><p><strong><a href="https://github.com/elastic/logstash/blob/master/config/pipelines.yml" target="_blank" rel="noopener">Pipelines å‚æ•°</a></strong></p>
</li>
<li><p><strong><a href="https://www.elastic.co/guide/en/logstash/6.7/multiple-pipelines.html" target="_blank" rel="noopener">Multiple Pipelines</a></strong></p>
</li>
<li><p><strong><a href="https://www.elastic.co/cn/blog/logstash-multiple-pipelines" target="_blank" rel="noopener">Introducing Multiple Pipelines in Logstash - åŸæ–‡</a></strong></p>
</li>
<li><p><strong><a href="https://www.cnblogs.com/sparkdev/p/11073980.html" target="_blank" rel="noopener">Introducing Multiple Pipelines in Logstash - ä¸­æ–‡</a></strong></p>
</li>
<li><p><strong><a href="https://www.elastic.co/guide/en/logstash/current/reloading-config.html" target="_blank" rel="noopener">Reloading the Config Fileedit </a></strong></p>
</li>
<li><p><a href="http://www.51niux.com/?id=205" target="_blank" rel="noopener"><strong>Logstashè¯¦ç»†è®°å½•ï¼ˆäº”</strong>ï¼‰</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>ELK</category>
      </categories>
      <tags>
        <tag>Logstash</tag>
      </tags>
  </entry>
  <entry>
    <title>Scrapy å¤šä¸ªitemå¯¹åº”ä¸€ä¸ªpipeline</title>
    <url>/2019/12/30/Scrapy-%E5%A4%9A%E4%B8%AAitem%E5%AF%B9%E5%BA%94%E4%B8%80%E4%B8%AApipeline/</url>
    <content><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>â€‹        åœ¨åˆ©ç”¨<strong>Scrapy</strong>ç¼–å†™çˆ¬è™«æ—¶,ç»å¸¸ä¼šé‡åˆ°åŒä¸€ä¸ªçˆ¬è™«ä¸­åŒ…å«å¤šä¸ªitem classes, å¹¶ä¸”éœ€è¦åœ¨åŒä¸€ä¸ª<code>pipelines.py</code>ä¸­æ ¹æ®ä¸åŒçš„item classesè¿›è¡Œé€»è¾‘çš„å¤„ç†ã€‚</p>
<p>â€‹        <strong>éœ€æ±‚:</strong> æ•°æ®éœ€è¦åŒæ—¶å‘é€åˆ°ElasticSearchä»¥åŠRedis, å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯item classes,ä¸åŒã€‚å‘é€åˆ°Redisçš„æ•°æ®æ˜¯æ ‡å‡†åŒ–ä¹‹åçš„æ•°æ®, å‘é€åˆ°ElasticSearchæ˜¯åŸå§‹çš„æ•°æ®ã€‚</p>
<p>â€‹        <strong>è§£å†³æ–¹æ³•:</strong> è¿™é‡Œå¯ä»¥é€šè¿‡<code>isinstance</code>æ¥è¿›è¡ŒåŒºåˆ†ã€‚</p>
<h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define your item pipelines here</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Don't forget to add your pipeline to the ITEM_PIPELINES setting</span></span><br><span class="line"><span class="comment"># See: https://doc.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tb.items <span class="keyword">import</span> RedisItem</span><br><span class="line"><span class="keyword">from</span> tb.items <span class="keyword">import</span> ElasticSearchItem</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisPipeline</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(item, RedisItem):</span><br><span class="line">            <span class="comment"># to do something</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ElasticPipeline</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(item, ElasticSearchItem):</span><br><span class="line">            <span class="comment"># to do something</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>

<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><strong><a href="https://stackoverflow.com/questions/32743469/scrapy-python-multiple-item-classes-in-one-pipeline" target="_blank" rel="noopener">Scrapy, Python: Multiple Item Classes in one pipeline?</a></strong></li>
<li><strong><a href="https://blog.csdn.net/sinat_32651363/article/details/79092431" target="_blank" rel="noopener">ScrapyåŒä¸€ä¸ªçˆ¬è™«é‡ŒåŒ…å«ä¸åŒitemï¼Œpipelinesæ–‡ä»¶ç¼–å†™</a></strong></li>
</ul>
]]></content>
      <categories>
        <category>Spider</category>
      </categories>
      <tags>
        <tag>Scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis Key è¿‡æœŸäº‹ä»¶è®¢é˜…</title>
    <url>/2019/12/24/Redis-Key-%E8%BF%87%E6%9C%9F%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85/</url>
    <content><![CDATA[<h3 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h3><p>â€‹        åœ¨è‡ªå»ºä¼ä¸šå†…éƒ¨å¨èƒæƒ…æŠ¥çš„è¿‡ç¨‹ä¸­, éœ€è¦é€šè¿‡<strong>Redis</strong>ç»Ÿä¸€ç®¡ç†è¿‡æœŸæ—¶é—´çš„<strong>Key</strong>ã€‚å› æ­¤éœ€è¦å¯¹è¿‡æœŸçš„<strong>Key</strong>è¿›è¡Œå®æ—¶ç›‘å¬, å¹¶è¿›è¡Œå›è°ƒå¤„ç†ã€‚</p>
<h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>â€‹        åœ¨ <strong>Redis</strong> çš„ <strong>2.8.0</strong> ç‰ˆæœ¬ä¹‹åï¼Œå…¶æ¨å‡ºäº†ä¸€ä¸ªæ–°çš„ç‰¹æ€§â€”â€”é”®ç©ºé—´æ¶ˆæ¯ï¼ˆRedis Keyspace Notificationsï¼‰ï¼Œå®ƒé…åˆ 2.0.0 ç‰ˆæœ¬ä¹‹åçš„ SUBSCRIBE å°±èƒ½å®Œæˆè¿™ä¸ªå®šæ—¶ä»»åŠ¡çš„æ“ä½œäº†ã€‚</p>
<p><strong>Redis çš„é”®ç©ºé—´é€šçŸ¥æ”¯æŒ è®¢é˜…æŒ‡å®š Key çš„æ‰€æœ‰äº‹ä»¶ ä¸ è®¢é˜…æŒ‡å®šäº‹ä»¶ ä¸¤ç§æ–¹å¼ã€‚</strong></p>
<blockquote>
<p>Keyspace notifications are implemented sending two distinct type of events for every operation affecting the Redis data space. For instance a DEL operation targeting the key named mykey in database 0 will trigger the delivering of two messages, exactly equivalent to the following two PUBLISH commands:</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUBLISH __keyspace@0__:mykey del</span><br><span class="line">PUBLISH __keyevent@0__:del mykey</span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡ Redis çš„é”®ç©ºé—´é€šçŸ¥ï¼ˆkeyspace notificationï¼‰å¯ä»¥åšåˆ°ï¼šå°†IoCæ•°æ®å†™å…¥Redisï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´10åˆ†é’Ÿï¼Œåˆ©ç”¨ Redis é”®è¿‡æœŸå›è°ƒæé†’ï¼Œå¦‚æœæœªè¢«æ¶ˆè´¹ï¼Œåˆ™è¿›è¡Œå¤„ç†ã€‚</strong></p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><h4 id="1-ä¿®æ”¹-redis-conf-å¼€å¯redis-keyè¿‡æœŸæé†’"><a href="#1-ä¿®æ”¹-redis-conf-å¼€å¯redis-keyè¿‡æœŸæé†’" class="headerlink" title="1. ä¿®æ”¹ redis.conf å¼€å¯redis keyè¿‡æœŸæé†’"></a>1. ä¿®æ”¹ redis.conf å¼€å¯redis keyè¿‡æœŸæé†’</h4><blockquote>
<p>By default keyspace events notifications are disabled because while not very sensible the feature uses some CPU power. Notifications are enabled using the notify-keyspace-events of redis.conf or via the CONFIG SET.</p>
</blockquote>
<p>ç”±äºé”®ç©ºé—´é€šçŸ¥æ¯”è¾ƒè€—CPU, æ‰€ä»¥ Redisé»˜è®¤æ˜¯å…³é—­é”®ç©ºé—´äº‹ä»¶é€šçŸ¥çš„ï¼Œ éœ€è¦æ‰‹åŠ¨å¼€å¯ <code>notify-keyspace-events</code>åæ‰å¯ä½œç”¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Kï¼škeyspaceäº‹ä»¶ï¼Œäº‹ä»¶ä»¥__keyspace@&lt;db&gt;__ä¸ºå‰ç¼€è¿›è¡Œå‘å¸ƒï¼›        </span><br><span class="line">Eï¼škeyeventäº‹ä»¶ï¼Œäº‹ä»¶ä»¥__keyevent@&lt;db&gt;__ä¸ºå‰ç¼€è¿›è¡Œå‘å¸ƒï¼›        </span><br><span class="line">gï¼šä¸€èˆ¬æ€§çš„ï¼Œéç‰¹å®šç±»å‹çš„å‘½ä»¤ï¼Œæ¯”å¦‚delï¼Œexpireï¼Œrenameç­‰ï¼›       </span><br><span class="line">$ï¼šString ç‰¹å®šå‘½ä»¤ï¼›        </span><br><span class="line">lï¼šList ç‰¹å®šå‘½ä»¤ï¼›        </span><br><span class="line">sï¼šSet ç‰¹å®šå‘½ä»¤ï¼›        </span><br><span class="line">hï¼šHash ç‰¹å®šå‘½ä»¤ï¼›        </span><br><span class="line">zï¼šSorted ç‰¹å®šå‘½ä»¤ï¼›        </span><br><span class="line">xï¼šè¿‡æœŸäº‹ä»¶ï¼Œå½“æŸä¸ªé”®è¿‡æœŸå¹¶åˆ é™¤æ—¶ä¼šäº§ç”Ÿè¯¥äº‹ä»¶ï¼›        </span><br><span class="line">eï¼šé©±é€äº‹ä»¶ï¼Œå½“æŸä¸ªé”®å› maxmemoreç­–ç•¥è€Œè¢«åˆ é™¤æ—¶ï¼Œäº§ç”Ÿè¯¥äº‹ä»¶ï¼›        </span><br><span class="line">Aï¼šg<span class="variable">$lshzxe</span>çš„åˆ«åï¼Œå› æ­¤â€AKEâ€æ„å‘³ç€æ‰€æœ‰äº‹ä»¶ã€‚</span><br></pre></td></tr></table></figure>

<p><strong><code>notify-keyspace-events Ex</code> è¡¨ç¤ºå¼€å¯é”®è¿‡æœŸäº‹ä»¶æé†’</strong></p>
<p><strong>redis.conf</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># RDB Config</span></span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum no</span><br><span class="line">dir ./</span><br><span class="line"><span class="comment"># AOF Config</span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"><span class="comment"># set Password</span></span><br><span class="line">requirepass %&#123;mypassword&#125;</span><br><span class="line"><span class="comment"># set notify-keyspace-events</span></span><br><span class="line">notify-keyspace-events Ex</span><br></pre></td></tr></table></figure>

<h4 id="2-RedisHelper"><a href="#2-RedisHelper" class="headerlink" title="2. RedisHelper"></a>2. RedisHelper</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># Author: Canon</span></span><br><span class="line"><span class="comment"># Date: 2019-12-27</span></span><br><span class="line"><span class="comment"># Version: 0.2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisHelper</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># è¿æ¥Redis</span></span><br><span class="line">        self.__conn = redis.Redis(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">6379</span>, password=<span class="string">'mypassword'</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># å®šä¹‰keyevent, æ­¤å¤„0ä¸ºindexdb</span></span><br><span class="line">        self.keyevent = <span class="string">'__keyevent@0__:expired'</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># å‘å¸ƒæ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">publish</span><span class="params">(self, key, msg)</span>:</span></span><br><span class="line">        ttl = <span class="number">10</span></span><br><span class="line">        self.__conn.setex(key, msg, ttl)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¢é˜…æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">subscribe</span><span class="params">(self)</span>:</span></span><br><span class="line">        sub = self.__conn.pubsub()</span><br><span class="line">        sub.subscribe(self.keyevent)</span><br><span class="line">        <span class="keyword">for</span> msg <span class="keyword">in</span> sub.listen():</span><br><span class="line">            <span class="keyword">if</span> msg[<span class="string">'type'</span>] == <span class="string">'message'</span>:</span><br><span class="line">                ex_key = msg[<span class="string">'data'</span>].decode()</span><br><span class="line">                print(ex_key)</span><br></pre></td></tr></table></figure>

<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul>
<li><p><strong><a href="https://crazyfzw.github.io/2019/03/26/redis-keyspace-notifications/" target="_blank" rel="noopener">è®¢é˜… Redis çš„ key è¿‡æœŸäº‹ä»¶å®ç°åŠ¨æ€å®šæ—¶ä»»åŠ¡</a></strong></p>
</li>
<li><p><strong><a href="https://segmentfault.com/a/1190000016898228" target="_blank" rel="noopener">pythonå¼€å‘-å®ç°redisä¸­çš„å‘å¸ƒè®¢é˜…åŠŸèƒ½</a></strong></p>
</li>
</ul>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Scrapyd + Scrapyd-Client</title>
    <url>/2019/12/19/Scrapyd%20+%20Scrapyd-Client/</url>
    <content><![CDATA[<h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><p>â€‹        ç”±äºç½‘ç«™æ—¶å¸¸é­å—é»‘å®¢æ”»å‡», ç°å‡†å¤‡å°†æ‰‹å¤´ä¸€äº›æ”»å‡»è€…çš„IPåœ°å€æ”¶é›†èµ·æ¥ç”¨åšä¼ä¸šå†…éƒ¨çš„å¨èƒæƒ…æŠ¥ã€‚æ—¢ç„¶è¦ç€æ‰‹åšå¨èƒæƒ…æŠ¥, é‚£ä¹ˆå°±é¿å…ä¸äº†é€šè¿‡ä¸€äº›ç½‘ç«™è¿›è¡Œæ•°æ®çš„ä¸°å¯ŒåŒ–ã€‚è¦æƒ³ç®€å•çœäº‹å„¿, å½“ç„¶æ˜¯ä½¿ç”¨è´­ä¹°apiè´¦å·çš„æ–¹å¼,ä¸è¿‡æœ‰çš„apiä¹Ÿå¾ˆå‘, é™¤éè´­ä¹°çš„æ˜¯ä¼ä¸šç‰ˆ, å¦åˆ™ä¸ªäººç‰ˆçš„apiä¼šå—åˆ°è¯·æ±‚é€Ÿç‡çš„é™åˆ¶ã€‚æ‰€ä»¥è¿™è¾¹åªèƒ½ä¾é çˆ¬è™«(<strong>Scrapy</strong>)æ¥æ”¶é›†æ•°æ®ã€‚ä½†æ˜¯é‡‡ç”¨äº†åˆ†å¸ƒå¼çˆ¬è™«, å°±é¿å…ä¸äº†éœ€è¦è¿›è¡Œé›†ä¸­ç®¡ç†, ä»¥åŠç»Ÿä¸€ä¸‹ç­‰æ“ä½œã€‚ä¸‹é¢å°±è¯´ä¸‹åˆ©ç”¨<strong>Scrapy</strong>å®˜æ–¹æä¾›çš„çˆ¬è™«ç®¡ç†å·¥å…·(<strong>Scrapyd</strong>)æ¥æ»¡è¶³ä»¥ä¸Šçš„éœ€æ±‚ã€‚</p>
<h1 id="Scrapyd"><a href="#Scrapyd" class="headerlink" title="Scrapyd"></a>Scrapyd</h1><p>â€‹        <strong>Scrapyd</strong>æ˜¯ç”±<strong>Scrapy</strong> å®˜æ–¹æä¾›çš„çˆ¬è™«ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨å®ƒæˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°ä¸Šä¼ ã€æ§åˆ¶çˆ¬è™«å¹¶ä¸”æŸ¥çœ‹è¿è¡Œæ—¥å¿—ã€‚</p>
<p><strong>å®‰è£…</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install scrapyd</span><br></pre></td></tr></table></figure>

<p><strong>å¯åŠ¨</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ scrapyd</span><br><span class="line">2019-12-19T10:56:06+0800 [-] Loading /Users/canon/anaconda3/lib/python3.7/site-packages/scrapyd/txapp.py...</span><br><span class="line">2019-12-19T10:56:06+0800 [-] Scrapyd web console available at http://127.0.0.1:6800/</span><br><span class="line">2019-12-19T10:56:06+0800 [-] Loaded.</span><br><span class="line">2019-12-19T10:56:06+0800 [twisted.scripts._twistd_unix.UnixAppLogger<span class="comment">#info] twistd 18.9.0 (/Users/canon/anaconda3/bin/python 3.7.1) starting up.</span></span><br><span class="line">2019-12-19T10:56:06+0800 [twisted.scripts._twistd_unix.UnixAppLogger<span class="comment">#info] reactor class: twisted.internet.selectreactor.SelectReactor.</span></span><br><span class="line">2019-12-19T10:56:06+0800 [-] Site starting on 6800</span><br><span class="line">2019-12-19T10:56:06+0800 [twisted.web.server.Site<span class="comment">#info] Starting factory &lt;twisted.web.server.Site object at 0x109efcf98&gt;</span></span><br><span class="line">2019-12-19T10:56:06+0800 [Launcher] Scrapyd 1.2.1 started: max_proc=48, runner=<span class="string">'scrapyd.runner'</span></span><br></pre></td></tr></table></figure>

<p>â€‹        <strong>Scrapyd</strong>æ˜¯ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªå®¢æˆ·ç«¯(<strong>Scrapyd-Client</strong>)å°†çˆ¬è™«é¡¹ç›®å‘é€åˆ°<strong>Scrapyd</strong>æœåŠ¡ä¸­å»ã€‚è¿™é‡Œå…ˆä¿®æ”¹ä¸€ä¸‹<strong>Scrapyd</strong>æœåŠ¡åœ°å€ï¼Œé»˜è®¤<strong>Scrapyd</strong>å¯åŠ¨æ˜¯é€šè¿‡å‘½ä»¤: <code>Scrapyd</code>å°±å¯ä»¥ç›´æ¥å¯åŠ¨ï¼Œé»˜è®¤ç»‘å®šçš„ipåœ°å€æ˜¯<em>127.0.0.1</em>ç«¯å£æ˜¯:<em>6800</em>ï¼Œè¿™é‡Œä¸ºäº†å…¶ä»–ä¸»æœºå¯ä»¥è®¿é—®ï¼Œéœ€å°†ipåœ°å€è®¾ç½®ä¸º<em>0.0.0.0</em>ã€‚</p>
<p>â€‹         æ ¹æ®ä¸Šå›¾å¯åŠ¨çš„ä¿¡æ¯, å¯ä»¥çœ‹åˆ°é»˜è®¤é…ç½®æ–‡ä»¶æ˜¯åœ¨<code>/Users/canon/anaconda3/lib/python3.7/site-packages/scrapyd/</code>ä¸­ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim default_scrapyd.conf</span><br><span class="line"></span><br><span class="line">[scrapyd]</span><br><span class="line">eggs_dir    = eggs</span><br><span class="line">logs_dir    = logs</span><br><span class="line">items_dir   =</span><br><span class="line">jobs_to_keep = 5</span><br><span class="line">dbs_dir     = dbs</span><br><span class="line">max_proc    = 0</span><br><span class="line">max_proc_per_cpu = 4</span><br><span class="line">finished_to_keep = 100</span><br><span class="line">poll_interval = 5.0</span><br><span class="line">bind_address = 0.0.0.0</span><br><span class="line">http_port   = 6800</span><br><span class="line">debug       = off</span><br><span class="line">runner      = scrapyd.runner</span><br><span class="line">application = scrapyd.app.application</span><br><span class="line">launcher    = scrapyd.launcher.Launcher</span><br><span class="line">webroot     = scrapyd.website.Root</span><br><span class="line"></span><br><span class="line">[services]</span><br><span class="line">schedule.json     = scrapyd.webservice.Schedule</span><br><span class="line">cancel.json       = scrapyd.webservice.Cancel</span><br><span class="line">addversion.json   = scrapyd.webservice.AddVersion</span><br><span class="line">listprojects.json = scrapyd.webservice.ListProjects</span><br><span class="line">listversions.json = scrapyd.webservice.ListVersions</span><br><span class="line">listspiders.json  = scrapyd.webservice.ListSpiders</span><br><span class="line">delproject.json   = scrapyd.webservice.DeleteProject</span><br><span class="line">delversion.json   = scrapyd.webservice.DeleteVersion</span><br><span class="line">listjobs.json     = scrapyd.webservice.ListJobs</span><br><span class="line">daemonstatus.json = scrapyd.webservice.DaemonStatus</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Scrapyd-Client"><a href="#Scrapyd-Client" class="headerlink" title="Scrapyd-Client"></a>Scrapyd-Client</h1><p>â€‹        <strong>Scrapyd-Client</strong>å¯ä»¥ç”¨æ¥éƒ¨ç½²<strong>Scrapy</strong>é¡¹ç›®ï¼Œå®ƒä¼šå¸®æˆ‘ä»¬æŠŠé¡¹ç›®æ‰“åŒ…æˆ<strong>egg</strong>æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¸ç”¨å†åŠ¨æ‰‹è°ƒç”¨<code>add version.json</code>æ¥å£å»éƒ¨ç½²åˆ°<strong>Scrapyd</strong>ï¼Œæ“ä½œç®€å•ã€‚</p>
<p><strong>å®‰è£…</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install scrapyd-client</span><br></pre></td></tr></table></figure>

<p><strong>é…ç½®</strong></p>
<p>â€‹        è¦éƒ¨ç½²<strong>Scrapy</strong>é¡¹ç›®ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¿®æ”¹é¡¹ç›®çš„é…ç½®æ–‡ä»¶ã€‚é¦–å…ˆåˆ‡æ¢è‡³é¡¹ç›®æ ¹ç›®å½•, ä¼šçœ‹åˆ°æœ‰ä¸€ä¸ª<code>scrapy.cfg</code>æ–‡ä»¶ï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Automatically created by: scrapy startproject</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information about the [deploy] section see:</span></span><br><span class="line"><span class="comment"># https://scrapyd.readthedocs.io/en/latest/deploy.html</span></span><br><span class="line"></span><br><span class="line">[settings]</span><br><span class="line">default = spider_ti.settings</span><br><span class="line"></span><br><span class="line">[deploy]</span><br><span class="line"><span class="comment">#url = http://localhost:6800/</span></span><br><span class="line">project = spider_ti</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦é…ç½®ä¸€ä¸‹<code>deploy</code>éƒ¨åˆ†ã€‚ä¾‹å¦‚, æˆ‘ä»¬å°†é¡¹ç›®éƒ¨ç½²åˆ°<em>10.10.10.1</em>çš„<strong>Scrapyd</strong>ä¸Šï¼Œåˆ™ä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[deploy]</span><br><span class="line">url = http://10.10.10.1:6800/</span><br><span class="line">project = spider_ti</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬å†åœ¨<code>scrapy.cf</code>gæ–‡ä»¶æ‰€åœ¨è·¯å¾„æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ scrapyd-deploy</span><br><span class="line"></span><br><span class="line">Packing version 1576725163</span><br><span class="line">Deploying to project <span class="string">"spider_ti"</span> <span class="keyword">in</span> http://localhost:6800/addversion.json</span><br><span class="line">Server response (200):</span><br><span class="line">&#123;<span class="string">"node_name"</span>: <span class="string">"CanondeMacBook-Pro.local"</span>, <span class="string">"status"</span>: <span class="string">"ok"</span>, <span class="string">"project"</span>: <span class="string">"spider_ti"</span>, <span class="string">"version"</span>: <span class="string">"1576725163"</span>, <span class="string">"spiders"</span>: 3&#125;</span><br></pre></td></tr></table></figure>

<p>é¡¹ç›®ç‰ˆæœ¬é»˜è®¤ä¸ºå½“å‰æ—¶é—´æˆ³ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šé¡¹ç›®ç‰ˆæœ¬ï¼Œé€šè¿‡<code>version</code>å‚æ•°ä¼ é€’å³å¯ã€‚ä¾‹å¦‚:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ scrapyd-deploy --version 201912191114</span><br></pre></td></tr></table></figure>

<p>æ³¨: åœ¨Python3çš„Scrapyd 1.2.0ç‰ˆæœ¬ä¸­ï¼Œ<strong>ç‰ˆæœ¬å·ä¸èƒ½æŒ‡å®šä¸ºå¸¦å­—æ¯çš„å­—ç¬¦ä¸²ï¼Œå®ƒä»¬å¿…é¡»ä¸ºçº¯æ•°å­—</strong>ï¼Œå¦åˆ™ä¼šå‡ºç°æŠ¥é”™ã€‚</p>
<p>å¦‚æœæœ‰å¤šå°ä¸»æœºï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®å„å°ä¸»æœºçš„åˆ«åï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ä¸º:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[deploy:vm1]</span><br><span class="line">url = http://10.10.10.1:6800/</span><br><span class="line">project = spider_ti</span><br><span class="line"></span><br><span class="line">[deploy:vm2]</span><br><span class="line">url = http://10.10.10.2:6800/</span><br><span class="line">project = spider_ti</span><br></pre></td></tr></table></figure>

<p>åœ¨æ­¤ç»Ÿä¸€é…ç½®å¤šå°ä¸»æœºï¼Œä¸€å°ä¸»æœºå¯¹åº”ä¸€ç»„é…ç½®ï¼Œåœ¨<code>deploy</code>åé¢åŠ ä¸Šä¸»æœºçš„åˆ«åå³å¯ã€‚å¦‚æœæƒ³å°†é¡¹ç›®éƒ¨ç½²åˆ°IPä¸º<em>10.10.10.2</em>çš„<strong>vm2</strong>ä¸»æœºï¼Œæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">scrapyd-deploy vm2</span><br></pre></td></tr></table></figure>

<p>å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨<code>scrapy.cfg</code>æ–‡ä»¶ä¸­é…ç½®å¥½å„å°ä¸»æœºçš„<strong>Scrapyd</strong>åœ°å€ï¼Œç„¶åè°ƒç”¨<code>scrapyd-deploy</code>å‘½ä»¤åŠ ä¸»æœºåç§°å³å¯å®ç°éƒ¨ç½²ã€‚</p>
<p>å¦‚æœ<strong>Scrapyd</strong>è®¾ç½®äº†è®¿é—®é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ç”¨æˆ·åå’Œå¯†ç çš„é…ç½®ï¼ŒåŒæ—¶ä¿®æ”¹ç«¯å£æˆNginxä»£ç†ç«¯å£ã€‚ä¾‹å¦‚: åœ¨ç¬¬1ç« æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯6801ï¼Œé‚£ä¹ˆè¿™é‡Œå°±éœ€è¦æ”¹æˆ6801ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[deploy:vm1]</span><br><span class="line">url = http://10.10.10.1:6801/</span><br><span class="line">project = spider_ti</span><br><span class="line">username = admin</span><br><span class="line">password = admin</span><br><span class="line"></span><br><span class="line">[deploy:vm2]</span><br><span class="line">url = http://10.10.10.2:6801/</span><br><span class="line">project = spider_ti</span><br><span class="line">username = canon</span><br><span class="line">password = canon</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åŠ å…¥usernameå’Œpasswordå­—æ®µï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨éƒ¨ç½²æ—¶è‡ªåŠ¨è¿›è¡ŒAuthéªŒè¯ï¼Œç„¶åæˆåŠŸå®ç°éƒ¨ç½²ã€‚</p>
<p><strong>è¿è¡Œ</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/schedule.json -d project=spider_ti -d spider=ti</span><br></pre></td></tr></table></figure>

<p><strong>åˆ—å‡ºä»»åŠ¡</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/listjobs.json?project=spider_ti | python -m json.tool</span><br></pre></td></tr></table></figure>

<p><strong>åˆ—å‡ºé¡¹ç›®</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/listprojects.json</span><br></pre></td></tr></table></figure>

<p><strong>åœæ­¢</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/cancel.json -d project=spider_ti -d job=838dec26222311ea8eb6a5eb893a35a5</span><br></pre></td></tr></table></figure>

<p><strong>åˆ é™¤</strong></p>
<ul>
<li><em>ç‰ˆæœ¬</em></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/delversion.json -d project=spider_ti -d version=1576735972</span><br></pre></td></tr></table></figure>

<ul>
<li><em>é¡¹ç›®</em></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/delproject.json -d project=spider_ti</span><br></pre></td></tr></table></figure>

<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="https://juejin.im/post/5b0f8f6f6fb9a00a2364a020" target="_blank" rel="noopener"><strong>åˆ†å¸ƒå¼çˆ¬è™«çš„éƒ¨ç½²ä¹‹Scrapyd-Clientçš„ä½¿ç”¨</strong></a></li>
<li><a href="https://link.jianshu.com/?t=http://scrapyd.readthedocs.org/en/latest/api.html" target="_blank" rel="noopener"><strong>Scrapyd</strong></a></li>
</ul>
]]></content>
      <categories>
        <category>Spider</category>
      </categories>
      <tags>
        <tag>Scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>Suricata Custom Rules</title>
    <url>/2019/10/31/Suricata%20-%20Rules/</url>
    <content><![CDATA[<h1 id="Solr-RCE-CVE-2019-0193"><a href="#Solr-RCE-CVE-2019-0193" class="headerlink" title="Solr RCE CVE-2019-0193"></a>Solr RCE CVE-2019-0193</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Solr POST RCE CVE-2019-0193</span></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">"LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 POST"</span>; flow:to_server,established; flowbits:<span class="built_in">set</span>,CVE-2019-0193.post.request; content:<span class="string">"POST"</span>; http_method; fast_pattern; content:<span class="string">"/solr"</span>; http_uri; content:<span class="string">"/config"</span>; http_uri; content:<span class="string">"params.resource.loader.enabled"</span>; http_client_body; classtype:shellcode-detect; sid:3020016; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br><span class="line"></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">"LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 POST Successful"</span>; flow:from_server,established; flowbits:isset,CVE-2019-0193.post.request; content:<span class="string">"200"</span>; http_stat_code; classtype:shellcode-detect; sid:3020017; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Solr GET RCE CVE-2019-0193</span></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">"LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 GET"</span>; flow:to_server,established; flowbits:<span class="built_in">set</span>,CVE-2019-0193.get.request; content:<span class="string">"GET"</span>; http_method; content:<span class="string">"/solr"</span>; http_uri; fast_pattern; content:<span class="string">"/select?"</span>; http_uri; content:<span class="string">"wt=velocity"</span>; http_uri; content:<span class="string">"java.lang.Runtime"</span>; http_uri; content:<span class="string">"getRuntime().exec"</span>; http_uri; classtype:shellcode-detect; sid:3020018; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br><span class="line"></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">"LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 GET Successful"</span>; flow:from_server,established; flowbits:isset,CVE-2019-0193.get.request; content:<span class="string">"200"</span>; http_stat_code; classtype:shellcode-detect; sid:3020019; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>Suricata + Luaå®ç°æœ¬åœ°æƒ…æŠ¥å¯¹æ¥</title>
    <url>/2019/10/24/Suricata+Lua%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E6%83%85%E6%8A%A5%E5%AF%B9%E6%8E%A5/</url>
    <content><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>â€‹        ç”±äºè¿‘æœŸç½‘ç«™é­å—æ¶æ„æ”»å‡», é€šè¿‡å¯¹äºç™»å½•æ¥å£çš„å®¡è®¡ä¸åˆ†æ, ç°å·²ç¡®å®šäº†ä¸€æ‰¹å¯ç–‘è´¦å·ã€‚æ—¢ç„¶ä¹‹å‰å†™è¿‡ä¸€ä¸ªç™»å½•æ¥å£çš„å®¡è®¡è„šæœ¬, é‚£ä¹ˆå®Œå…¨å¯ä»¥é€šè¿‡æ‰©å±•è¿™ä¸ªè„šæœ¬æ¥å®ç°å¯¹äºå¯ç–‘è´¦å·çš„æ¯”å¯¹ã€‚ä¸»è¦æ€è·¯: é€šè¿‡å°†å¯ç–‘è´¦å·å­˜è¿›Redisä¸­, å†åˆ©ç”¨Luaè„šæœ¬è°ƒç”¨Redisæ¥å£è¿›è¡Œè´¦å·çš„æ¯”å¯¹ã€‚</p>
<p>å…ˆè¯´ä¸€ä¸‹<strong>Suricata</strong>é»˜è®¤æ˜¯å­˜åœ¨é»‘åå•æœºåˆ¶çš„, å¦‚ä¸‹:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># IP Reputation</span></span><br><span class="line"><span class="comment">#reputation-categories-file: /etc/suricata/iprep/categories.txt</span></span><br><span class="line"><span class="comment">#default-reputation-path: /etc/suricata/iprep</span></span><br><span class="line"><span class="comment">#reputation-files:</span></span><br><span class="line"><span class="comment"># - reputation.list</span></span><br></pre></td></tr></table></figure>

<p>åœ¨<strong>Suricata 5.0</strong> ç‰ˆæœ¬ä¸­æ›´æ˜¯å¢åŠ äº†æ–°çš„åŠŸèƒ½<strong><a href="https://suricata.readthedocs.io/en/suricata-5.0.0/rules/datasets.html" target="_blank" rel="noopener">Datasets</a></strong>ã€‚å¤§æ¦‚çœ‹äº†ä¸€ä¸‹, å¯ä»¥é€šè¿‡åœ¨è§„åˆ™ä¸­ä½¿ç”¨<code>dataset</code>å’Œ<code>datarep</code>å…³é”®å­—å°†å¤§é‡æ•°æ®ä¸<code>sticky buffer</code>è¿›è¡ŒåŒ¹é…ã€‚ç¡®å®æ˜¯ä¸ªå¾ˆèµçš„åŠŸèƒ½!</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">alert http any any -&gt; any any (http.user_agent; dataset:<span class="built_in">set</span>, ua-seen, <span class="built_in">type</span> string, save ua-seen.lst; sid:1;)</span><br><span class="line"></span><br><span class="line">alert dns any any -&gt; any any (dns.query; to_sha256; dataset:<span class="built_in">set</span>, dns-sha256-seen, <span class="built_in">type</span> sha256, save dns-sha256-seen.lst; sid:2;)</span><br><span class="line"></span><br><span class="line">alert http any any -&gt; any any (http.uri; to_md5; dataset:isset, http-uri-md5-seen, <span class="built_in">type</span> md5, load http-uri-md5-seen.lst; sid:3;)</span><br></pre></td></tr></table></figure>

<p><strong>ä½†æ˜¯</strong>â€¦ è¿™å¹¶ä¸é€‚ç”¨æˆ‘ç°åœ¨çš„åœºæ™¯, å› ä¸ºåœ¨æˆ‘çš„åœºæ™¯ä¸­, ç”¨æˆ·çš„ç™»å½•è¯·æ±‚å­˜åœ¨äºPOSTè¯·æ±‚ä¸­, é»˜è®¤çš„Suricataæ–¹æ³•å¹¶ä¸èƒ½å‡†ç¡®å®šä½åˆ°æˆ‘ä»¬éœ€è¦çš„è´¦å·ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±åªèƒ½ä¾èµ–äº<strong>Lua</strong>è„šæœ¬æ¥æ‰©å±•ã€‚å½“ç„¶è¿™äº›éœ€æ±‚<strong>Zeek</strong>ä¹Ÿå¯ä»¥æ»¡è¶³, åªæ˜¯â€¦<strong>Zeek</strong>çš„è„šæœ¬çœŸæ˜¯éš¾å†™â€¦ä¸å¿åæ§½~</p>
<h1 id="å‡†å¤‡é˜¶æ®µ"><a href="#å‡†å¤‡é˜¶æ®µ" class="headerlink" title="å‡†å¤‡é˜¶æ®µ"></a>å‡†å¤‡é˜¶æ®µ</h1><h2 id="è¿è¡Œç¯å¢ƒ"><a href="#è¿è¡Œç¯å¢ƒ" class="headerlink" title="è¿è¡Œç¯å¢ƒ"></a>è¿è¡Œç¯å¢ƒ</h2><p>â€‹    <strong>OS</strong>: <em>Ubuntu 18.04</em></p>
<p>â€‹    <strong>Suricata</strong>: <em>Suricata 5.0.0 RELEASE</em></p>
<h2 id="LuaRocks"><a href="#LuaRocks" class="headerlink" title="LuaRocks"></a>LuaRocks</h2><ol>
<li>ç”±äºUbuntué»˜è®¤æ²¡æœ‰å®‰è£…<strong><a href="https://luarocks.org/" target="_blank" rel="noopener">LuaRocks</a></strong> (<em>LuaRocks is the package manager for Lua modules</em>), è¿™é‡Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å®‰è£…ã€‚</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡aptç›´æ¥å®‰è£…, ç®€å•çœäº‹å„¿ã€‚</span></span><br><span class="line">$ apt-get install luarocks</span><br></pre></td></tr></table></figure>

<hr>
<ol start="2">
<li>é€šè¿‡<code>luarocks</code>å®‰è£…æˆ‘ä»¬æ‰€éœ€è¦çš„<code>lua</code>æ¨¡å—, è¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°<code>redis-lua</code>ã€<code>luasocket</code>è¿™ä¸¤ä¸ªæ¨¡å—ã€‚</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Install Modules</span></span><br><span class="line">$ luarocks install luasocket</span><br><span class="line">$ luarocks install redis-lua</span><br><span class="line"></span><br><span class="line">$ ll /usr/<span class="built_in">local</span>/share/lua/5.1/</span><br><span class="line">total 72</span><br><span class="line">drwxr-xr-x 3 root root  4096 Oct 25 03:35 ./</span><br><span class="line">drwxr-xr-x 3 root root  4096 Sep 17 14:14 ../</span><br><span class="line">-rw-r--r-- 1 root root  8331 Oct 25 03:34 ltn12.lua</span><br><span class="line">-rw-r--r-- 1 root root  2487 Oct 25 03:34 mime.lua</span><br><span class="line">-rw-r--r-- 1 root root 35599 Oct 25 03:35 redis.lua</span><br><span class="line">drwxr-xr-x 2 root root  4096 Oct 25 03:34 socket/</span><br><span class="line">-rw-r--r-- 1 root root  4451 Oct 25 03:34 socket.lua</span><br></pre></td></tr></table></figure>

<hr>
<ol start="3">
<li>å®‰è£…æˆåŠŸå,  å¯ä»¥ç®€å•çš„æµ‹è¯•ä¸€ä¸‹ã€‚</li>
</ol>
<ul>
<li>åˆ©ç”¨<strong>Docker</strong>å¯åŠ¨<strong>Redis</strong>å®¹å™¨</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -ti -d -p 6379:6379 redis</span><br></pre></td></tr></table></figure>

<ul>
<li>æµ‹è¯•è„šæœ¬<code>hello_redis.lua</code></li>
</ul>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span> <span class="string">"redis"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> client = redis.connect(<span class="string">"127.0.0.1"</span>, <span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> response = client:ping()</span><br><span class="line"><span class="keyword">if</span> response == <span class="literal">false</span> <span class="keyword">then</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">client:set(<span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> var = client:get(<span class="string">"hello"</span>)</span><br><span class="line"><span class="built_in">print</span>(var)</span><br></pre></td></tr></table></figure>

<ul>
<li>å¯èƒ½ä¼šå­˜åœ¨ç¯å¢ƒå˜é‡ä¸å¯¹å¯¼è‡´çš„æŠ¥é”™</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luajit hello_redis.lua</span><br><span class="line">	luajit: /usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:793: module <span class="string">'socket'</span> not found:</span><br><span class="line">	no field package.preload[<span class="string">'socket'</span>]</span><br><span class="line">	no file <span class="string">'./socket.lua'</span></span><br><span class="line">	no file <span class="string">'/usr/local/share/luajit-2.0.5/socket.lua'</span></span><br><span class="line">	no file <span class="string">'/usr/local/share/lua/5.1/socket.lua'</span></span><br><span class="line">	no file <span class="string">'/usr/local/share/lua/5.1/socket/init.lua'</span></span><br><span class="line">	no file <span class="string">'./socket.so'</span></span><br><span class="line">	no file <span class="string">'/usr/local/lib/lua/5.1/socket.so'</span></span><br><span class="line">	no file <span class="string">'/usr/local/lib/lua/5.1/loadall.so'</span></span><br><span class="line">stack traceback:</span><br><span class="line">	[C]: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">'require'</span></span><br><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:793: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">'create_connection'</span></span><br><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:836: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">'connect'</span></span><br><span class="line">	a.lua:3: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: at 0x56508049e440</span><br></pre></td></tr></table></figure>

<ul>
<li>æ‰§è¡Œ<code>luarocks path --bin</code> å¹¶å°†ç»“æœè¾“å…¥</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luarocks path --bin</span><br><span class="line">Warning: The directory <span class="string">'/home/canon/.cache/luarocks'</span> or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing /usr/<span class="built_in">local</span>/bin/luarocks with sudo, you may want sudo<span class="string">'s -H flag.</span></span><br><span class="line"><span class="string">export LUA_PATH='</span>/home/canon/.luarocks/share/lua/5.1/?.lua;/home/canon/.luarocks/share/lua/5.1/?/init.lua;/usr/<span class="built_in">local</span>/share/lua/5.1/?.lua;/usr/<span class="built_in">local</span>/share/lua/5.1/?/init.lua;./?.lua;/usr/<span class="built_in">local</span>/share/luajit-2.0.5/?.lua<span class="string">'</span></span><br><span class="line"><span class="string">export LUA_CPATH='</span>/home/canon/.luarocks/lib/lua/5.1/?.so;/usr/<span class="built_in">local</span>/lib/lua/5.1/?.so;./?.so;/usr/<span class="built_in">local</span>/lib/lua/5.1/loadall.so<span class="string">'</span></span><br><span class="line"><span class="string">export PATH='</span>/home/canon/.luarocks/bin:/usr/<span class="built_in">local</span>/bin:/home/canon/anaconda3/bin:/home/canon/anaconda3/condabin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin<span class="string">'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æ‰§è¡Œè„šæœ¬, å°†ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡º:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luajit hello_redis.lua</span><br><span class="line">world</span><br></pre></td></tr></table></figure>

<h3 id="CJson"><a href="#CJson" class="headerlink" title="CJson"></a>CJson</h3><p>â€‹        è¿™é‡Œ<strong>å¼ºçƒˆå»ºè®®</strong>å¤§å®¶ä½¿ç”¨CJsonæ¨¡å—, æˆ‘ä¹‹å‰ä¸ºäº†æµ‹è¯•éšä¾¿ä»githubä¸Šæ‰¾äº†ä¸ªjsonæ¨¡å—æ¥ä½¿ç”¨ã€‚è¿™å‡ å¤©å‘ç°åœ¨ç½‘ç«™çš„é«˜å³°æ—¶æœŸ Suricata <strong>app_layer.flow</strong> è¿™ä¸ªå­—æ®µéå¸¸çš„å¤§, ä»è€Œå¯¼è‡´äº† <strong>kernel_drops</strong>ã€‚ç”±äºæˆ‘ä»¬çš„ç½‘ç«™æ˜¯é¢å¯¹æµ·å¤–ç”¨æˆ·æœ‰æ—¶å·®, ç»è¿‡å‡ å¤©çš„ç†¬å¤œæœ€ç»ˆå®šä½åˆ°æ˜¯ç”±äºjsonæ¨¡å—å¤ªè¿‡äºæ¶ˆè€—æ€§èƒ½è€Œå¯¼è‡´ã€‚å¯ä»¥çœ‹ä¸‹è¿™ä¸ªæˆªå›¾:</p>
<ul>
<li>å¯ç”¨CJsonæ¨¡å—ä¹‹å‰çš„ç›‘æ§å›¾</li>
</ul>
<p><img src="/2019/10/24/Suricata+Luaå®ç°æœ¬åœ°æƒ…æŠ¥å¯¹æ¥/image-20191104103020962.png" alt="image-20191104103020962"></p>
<ul>
<li>å¯ç”¨CJsonæ¨¡å—ä¹‹åçš„ç›‘æ§å›¾</li>
</ul>
<p><img src="/2019/10/24/Suricata+Luaå®ç°æœ¬åœ°æƒ…æŠ¥å¯¹æ¥/image-20191104103557884.png" alt="image-20191104103557884"></p>
<ol>
<li>ä¸‹è½½CJsonæ¨¡å—</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget ä¸‹è½½</span></span><br><span class="line">$ wget https://www.kyne.com.au/~mark/software/download/lua-cjson-2.1.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># Git</span></span><br><span class="line">$ git <span class="built_in">clone</span> git@github.com:mpx/lua-cjson.git</span><br></pre></td></tr></table></figure>

<hr>
<ol start="2">
<li>æ ¹æ®Luaç¯å¢ƒä¿®æ”¹Makefile(ä¸ªäººé…ç½®)</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">##### Build defaults #####</span></span><br><span class="line">LUA_VERSION =       5.1</span><br><span class="line">TARGET =            cjson.so</span><br><span class="line">PREFIX =            /usr/<span class="built_in">local</span></span><br><span class="line"><span class="comment">#CFLAGS =            -g -Wall -pedantic -fno-inline</span></span><br><span class="line">CFLAGS =            -O3 -Wall -pedantic -DNDEBUG</span><br><span class="line">CJSON_CFLAGS =      -fpic</span><br><span class="line">CJSON_LDFLAGS =     -shared</span><br><span class="line">LUA_INCLUDE_DIR =   $(PREFIX)/include/luajit-2.0</span><br><span class="line">LUA_CMODULE_DIR =   $(PREFIX)/lib/lua/$(LUA_VERSION)</span><br><span class="line">LUA_MODULE_DIR =    $(PREFIX)/share/lua/$(LUA_VERSION)</span><br><span class="line">LUA_BIN_DIR =       $(PREFIX)/bin</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å®‰è£…</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ make</span><br><span class="line">cc -c -O3 -Wall -pedantic -DNDEBUG  -I/usr/<span class="built_in">local</span>/include/luajit-2.0 -fpic -o lua_cjson.o lua_cjson.c</span><br><span class="line">In file included from lua_cjson.c:47:0:</span><br><span class="line">fpconv.h:15:20: warning: inline <span class="keyword">function</span> â€˜fpconv_initâ€™ declared but never defined</span><br><span class="line"> extern inline void fpconv_init();</span><br><span class="line">                    ^~~~~~~~~~~</span><br><span class="line">cc -c -O3 -Wall -pedantic -DNDEBUG  -I/usr/<span class="built_in">local</span>/include/luajit-2.0 -fpic -o strbuf.o strbuf.c</span><br><span class="line">cc -c -O3 -Wall -pedantic -DNDEBUG  -I/usr/<span class="built_in">local</span>/include/luajit-2.0 -fpic -o fpconv.o fpconv.c</span><br><span class="line">cc  -shared -o cjson.so lua_cjson.o strbuf.o fpconv.o</span><br><span class="line"></span><br><span class="line">$ make install</span><br><span class="line">mkdir -p //usr/<span class="built_in">local</span>/lib/lua/5.1</span><br><span class="line">cp cjson.so //usr/<span class="built_in">local</span>/lib/lua/5.1</span><br><span class="line">chmod 755 //usr/<span class="built_in">local</span>/lib/lua/5.1/cjson.so</span><br></pre></td></tr></table></figure>

<h3 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a><a href="https://github.com/kikito/md5.lua" target="_blank" rel="noopener">MD5</a></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luarocks install --server=http://luarocks.org/manifests/kikito md5</span><br></pre></td></tr></table></figure>

<h1 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h1><p>æ‰©å±•ç™»å½•æ¥å£å®¡è®¡è„šæœ¬: <code>http_audit.lua</code></p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">json = <span class="built_in">require</span> <span class="string">"cjson.safe"</span></span><br><span class="line">md5 = <span class="built_in">require</span> <span class="string">"md5"</span></span><br><span class="line">redis = <span class="built_in">require</span> <span class="string">"redis"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç™»å½•æ¥å£</span></span><br><span class="line">login_url = <span class="string">"/login"</span></span><br><span class="line"><span class="comment">-- ç™»å½•é”™è¯¯æç¤º</span></span><br><span class="line">success_code = <span class="number">0</span></span><br><span class="line"><span class="comment">-- event_name</span></span><br><span class="line">event_name = <span class="string">"login_audit"</span></span><br><span class="line"><span class="comment">-- event_type</span></span><br><span class="line">event_type = <span class="string">"lua"</span></span><br><span class="line"><span class="comment">-- logs</span></span><br><span class="line">name = <span class="string">"login_audit.json"</span></span><br><span class="line"><span class="comment">-- åè®®</span></span><br><span class="line">proto = <span class="string">"TCP"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- redis_config</span></span><br><span class="line">host = <span class="string">"127.0.0.1"</span></span><br><span class="line">port = <span class="number">6379</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- common_mapping</span></span><br><span class="line">http_common_mapping = <span class="string">'&#123;"accept":"accept","accept-charset":"accept_charset","accept-encoding":"accept_encoding","accept-language":"accept_language","user-agent":"user_agent"&#125;'</span></span><br><span class="line">common_mapping_table = json.decode(http_common_mapping)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- defind functioin</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5Encode</span><span class="params">(args)</span></span></span><br><span class="line">    m = md5.new()</span><br><span class="line">    m:update(args)</span><br><span class="line">    <span class="keyword">return</span> md5.tohex(m:finish())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStr</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    ios = <span class="built_in">string</span>.<span class="built_in">match</span>(args, <span class="string">'canon'</span>)</span><br><span class="line">    <span class="keyword">if</span> ios ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        mail = <span class="string">'email"%s+(.-)%s'</span></span><br><span class="line">        t[<span class="string">'email'</span>] = <span class="built_in">string</span>.<span class="built_in">match</span>(args, mail)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        data = <span class="built_in">string</span>.split(args, <span class="string">'&amp;'</span>)</span><br><span class="line">        <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">            d = <span class="built_in">string</span>.split(v, <span class="string">'='</span>)</span><br><span class="line">            t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.split</span><span class="params">(s, p)</span></span></span><br><span class="line">    rt = &#123;&#125;</span><br><span class="line">    <span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">'[^'</span>..p..<span class="string">']+'</span>, <span class="function"><span class="keyword">function</span><span class="params">(w)</span></span> <span class="built_in">table</span>.<span class="built_in">insert</span>(rt, w) <span class="keyword">end</span> )</span><br><span class="line">    <span class="keyword">return</span> rt</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- default function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(args)</span></span></span><br><span class="line">    <span class="keyword">local</span> needs = &#123;&#125;</span><br><span class="line">    needs[<span class="string">"protocol"</span>] = <span class="string">"http"</span></span><br><span class="line">    <span class="keyword">return</span> needs</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span> <span class="params">(args)</span></span></span><br><span class="line">    filename = SCLogPath() .. <span class="string">"/"</span> .. name</span><br><span class="line">    file = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">"a"</span>))</span><br><span class="line">    SCLogInfo(<span class="string">"app_login_audit filename: "</span> .. filename)</span><br><span class="line">    http = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- Connect Redis Server</span></span><br><span class="line">    SCLogInfo(<span class="string">"Connect Redis Server..."</span>)</span><br><span class="line">    client = redis.connect(host, port)</span><br><span class="line">    response = client:ping()</span><br><span class="line">    <span class="keyword">if</span> response <span class="keyword">then</span></span><br><span class="line">        SCLogInfo(<span class="string">"Redis Server connection succeeded."</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(args)</span></span></span><br><span class="line">    <span class="comment">-- init tables</span></span><br><span class="line">    http_table = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- ti tables</span></span><br><span class="line">    ti = &#123;</span><br><span class="line">        tags = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- init score</span></span><br><span class="line">    score = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_hostname &amp; http_url</span></span><br><span class="line">    http_hostname = HttpGetRequestHost()</span><br><span class="line">    http_url = HttpGetRequestUriNormalized()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- http_method</span></span><br><span class="line">    rl = HttpGetRequestLine()</span><br><span class="line">    <span class="keyword">if</span> rl <span class="keyword">then</span></span><br><span class="line">        http_method = <span class="built_in">string</span>.<span class="built_in">match</span>(rl, <span class="string">"%w+"</span>)</span><br><span class="line">        <span class="keyword">if</span> http_method <span class="keyword">then</span></span><br><span class="line">            http_table[<span class="string">"method"</span>] = http_method</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	</span><br><span class="line">	  <span class="comment">-- ä¸ºäº†ä¿è¯ Suricata çš„æ€§èƒ½ä¸å—å½±å“, ä¸¥æ ¼æ§åˆ¶è¿‡æ»¤æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> http_url == login_url <span class="keyword">and</span> http_method == <span class="string">"POST"</span> <span class="keyword">then</span></span><br><span class="line">        http_table[<span class="string">"hostname"</span>] = http_hostname</span><br><span class="line">        http_table[<span class="string">"url"</span>] = http_url</span><br><span class="line">        http_table[<span class="string">"url_path"</span>] = http_url</span><br><span class="line">        </span><br><span class="line">        <span class="comment">-- http_status &amp; http_protocol</span></span><br><span class="line">        rsl = HttpGetResponseLine()</span><br><span class="line">        <span class="keyword">if</span> rsl <span class="keyword">then</span></span><br><span class="line">            status_code = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"%s(%d+)%s"</span>)</span><br><span class="line">            http_table[<span class="string">"status"</span>] = <span class="built_in">tonumber</span>(status_code)</span><br><span class="line"></span><br><span class="line">            http_protocol = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"(.-)%s"</span>)</span><br><span class="line">            http_table[<span class="string">"protocol"</span>] = http_protocol</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- login_results</span></span><br><span class="line">        a, o, e = HttpGetResponseBody()</span><br><span class="line">        <span class="keyword">if</span> a <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">                body = json.decode(v)</span><br><span class="line">                results_code = <span class="built_in">tonumber</span>(body[<span class="string">"code"</span>])</span><br><span class="line">                <span class="keyword">if</span> results_code == success_code <span class="keyword">then</span></span><br><span class="line">                    http_table[<span class="string">"results"</span>] = <span class="string">"success"</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    http_table[<span class="string">"results"</span>] = <span class="string">"failed"</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            http_table[<span class="string">"results_code"</span>] = results_code</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">--[[</span></span><br><span class="line"><span class="comment">            1. è·å–ç”¨æˆ·ç™»å½•email å¹¶æŸ¥è¯¢ Redisä¸­æ˜¯å¦å­˜åœ¨è¯¥è´¦å·</span></span><br><span class="line"><span class="comment">            2. æ ¹æ®ç»“æœè¿›è¡Œç›¸åº”çš„æ‰“åˆ†ä»¥åŠtagsæ ‡æ³¨</span></span><br><span class="line"><span class="comment">        ]]</span></span><br><span class="line">        <span class="comment">-- </span></span><br><span class="line">        a, o, e = HttpGetRequestBody()</span><br><span class="line">        <span class="keyword">if</span> a <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">                res = formatStr(v)</span><br><span class="line">                <span class="keyword">if</span> res[<span class="string">"email"</span>] <span class="keyword">then</span></span><br><span class="line">                    <span class="comment">-- æŸ¥è¯¢Rediså¯¹æ¯”é»‘åå•</span></span><br><span class="line">                    black_ioc = client:get(res[<span class="string">"email"</span>])</span><br><span class="line">                    <span class="keyword">if</span> black_ioc <span class="keyword">then</span></span><br><span class="line">                        ti[<span class="string">"provider"</span>] = <span class="string">"Canon"</span></span><br><span class="line">                        ti[<span class="string">"producer"</span>] = <span class="string">"NTA"</span></span><br><span class="line">                        <span class="built_in">table</span>.<span class="built_in">insert</span>(ti[<span class="string">"tags"</span>], <span class="string">"account in blacklist"</span>)</span><br><span class="line">                        score = score + <span class="number">10</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- RequestHeaders</span></span><br><span class="line">        rh = HttpGetRequestHeaders()</span><br><span class="line">        <span class="keyword">if</span> rh <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rh) <span class="keyword">do</span></span><br><span class="line">                key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line">                request_var = request_mapping_table[key]</span><br><span class="line">                <span class="keyword">if</span> request_var <span class="keyword">then</span></span><br><span class="line">                    http_table[request_var] = v</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- ResponseHeaders</span></span><br><span class="line">        rsh = HttpGetResponseHeaders()</span><br><span class="line">        <span class="keyword">if</span> rsh <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rsh) <span class="keyword">do</span></span><br><span class="line">                key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line">                response_var = response_mapping_table[key]</span><br><span class="line">                <span class="keyword">if</span> response_var <span class="keyword">then</span></span><br><span class="line">                    http_table[response_var] = v</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- timestring</span></span><br><span class="line">        sec, usec = SCPacketTimestamp()</span><br><span class="line">        timestring = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">"!%Y-%m-%dT%T"</span>, sec) .. <span class="string">'.'</span> .. usec .. <span class="string">'+0000'</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">-- flow_info</span></span><br><span class="line">        ip_version, src_ip, dst_ip, protocol, src_port, dst_port = SCFlowTuple()</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- flow_id</span></span><br><span class="line">        id = SCFlowId()</span><br><span class="line">        flow_id = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%.0f"</span>, id)</span><br><span class="line">        flow_id = <span class="built_in">tonumber</span>(flow_id)</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- true_ip</span></span><br><span class="line">        true_client_ip = HttpGetRequestHeader(<span class="string">"True-Client-IP"</span>)</span><br><span class="line">        <span class="keyword">if</span> true_client_ip ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            src_ip = true_client_ip</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- session_id</span></span><br><span class="line">        tetrad = src_ip .. src_port .. dst_ip .. dst_port</span><br><span class="line">        session_id = md5Encode(tetrad)</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- table</span></span><br><span class="line">        raw_data = &#123;</span><br><span class="line">            timestamp = timestring,</span><br><span class="line">            flow_id = flow_id,</span><br><span class="line">            session_id = session_id,</span><br><span class="line">            src_ip = src_ip,</span><br><span class="line">            src_port = src_port,</span><br><span class="line">            proto = proto,</span><br><span class="line">            dest_ip = dst_ip,</span><br><span class="line">            dest_port = dst_port,</span><br><span class="line">            event_name = event_name,</span><br><span class="line">            event_type = event_type,</span><br><span class="line">            app_type = app_type,</span><br><span class="line">            http = http_table,</span><br><span class="line">            ti = ti,</span><br><span class="line">            score = score</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- json encode</span></span><br><span class="line">        data = json.encode(raw_data)</span><br><span class="line"></span><br><span class="line">        file:<span class="built_in">write</span>(data .. <span class="string">"\n"</span>)</span><br><span class="line">        file:<span class="built_in">flush</span>()</span><br><span class="line"></span><br><span class="line">        http = http + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deinit</span> <span class="params">(args)</span></span></span><br><span class="line">    SCLogInfo (<span class="string">"app_login_audit transactions logged: "</span> .. http);</span><br><span class="line">    file:<span class="built_in">close</span>(file)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>ç®€å•è¯´ä¸‹ä»¥ä¸Šè„šæœ¬çš„åŠŸèƒ½:</strong></p>
<ol>
<li>ç™»å½•æ¥å£çš„ç”¨æˆ·åå®¡è®¡(åºŸè¯â€¦); </li>
<li>é€šè¿‡è¯·æ±‚<strong>Redis</strong>æ¯”å¯¹å½“å‰ç”¨æˆ·æ˜¯å¦åœ¨é»‘åå•ä¸­, å¹¶è¿›è¡Œç›¸åº”çš„æ‰“åˆ†ã€æ ‡ç­¾å¤„ç†;</li>
<li>æ ¹æ®è‡ªå®šä¹‰çš„éœ€æ±‚è·å–çš„http headers, è¿™ä¸ªå¯¹äºä¸šåŠ¡å®‰å…¨ä¸Šè¿˜æ˜¯æœ‰ç‚¹ç”¨çš„;</li>
<li>é’ˆå¯¹<strong>CDN</strong>æˆ–è€…Nginxè¿™ç§åœºæ™¯ä¸‹, å¯ä»¥ç›´æ¥å¯¹ xff æˆ–è€… true_client_ip è¿›è¡Œå››å…ƒç»„çš„hash, å¾—åˆ°<strong>session_id</strong>, è¿™æ ·æº¯æºçš„æ—¶å€™ä¼šæ¯”è¾ƒæ–¹ä¾¿ã€‚å› ä¸ºåœ¨è¿™ç§åœºæ™¯ä¸‹ä¼ ç»Ÿçš„å››å±‚<strong>flow_id</strong>å°±ä¸æ˜¯é‚£ä¹ˆæœ‰ç”¨äº†ã€‚</li>
<li>åç»­å¯ä»¥è¿½åŠ ä¸€äº›ç®€å•çš„æ£€æµ‹æ–¹æ³•, ä¾‹å¦‚:<ol>
<li>æ£€æŸ¥è¯·æ±‚å¤´ä¸­çš„å­—æ®µæ˜¯å¦å®Œæˆ;</li>
<li>æ£€æŸ¥è¯·æ±‚å¤´ä¸­çš„æŸä¸ªå­—æ®µé•¿åº¦æ˜¯å¦ç¬¦åˆåˆè§„;</li>
<li>â€¦â€¦</li>
</ol>
</li>
</ol>
<p><strong>é…ç½®Suricataå¯ç”¨Luaè„šæœ¬</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">- lua:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    scripts-dir:</span> <span class="string">/etc/suricata/lua-output/</span></span><br><span class="line"><span class="attr">    scripts:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">login_audit.lua</span></span><br></pre></td></tr></table></figure>

<p><strong>å¯ç”¨Suricata</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ suricata -vvv --pfring -k none -c /etc/suricata/suricata.yaml</span><br></pre></td></tr></table></figure>

<p><strong><em>æ³¨: è¿™é‡Œ<code>-vvv</code> å‚æ•°å»ºè®®åŠ ä¸Š. å¦‚æœä½ çš„Luaè„šæœ¬æœ‰ä¸€äº›é—®é¢˜, å¦‚æœåŠ ä¸Šäº†è¿™ä¸ªå‚æ•°, å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ—¥å¿—çœ‹å‡ºã€‚</em></strong></p>
<h1 id="æ—¥å¿—æ ·ä¾‹"><a href="#æ—¥å¿—æ ·ä¾‹" class="headerlink" title="æ—¥å¿—æ ·ä¾‹"></a>æ—¥å¿—æ ·ä¾‹</h1><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">62722</span>,</span><br><span class="line">    <span class="attr">"score"</span>: <span class="number">65</span>,</span><br><span class="line">    <span class="attr">"session_id"</span>: <span class="string">"c863aeb2ef8d1b37f3257f8c210bf440"</span>,</span><br><span class="line">    <span class="attr">"ti"</span>: &#123;</span><br><span class="line">        <span class="attr">"tags"</span>: [</span><br><span class="line">            <span class="string">"account in blacklist"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"provider"</span>: <span class="string">"Canon"</span>,</span><br><span class="line">        <span class="attr">"producer"</span>: <span class="string">"NTA"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"alert"</span>: &#123;</span><br><span class="line">        <span class="attr">"alerted"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"rules"</span>: &#123;</span><br><span class="line">            <span class="attr">"è¯·æ±‚å¤´æ ¡éªŒ"</span>: <span class="string">"dev-id"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="string">"1064295903559076"</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-25T08:33:55.585519+0000"</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"lua"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"1.1.1.1"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">80</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"response_content_length"</span>: <span class="string">"96"</span>,</span><br><span class="line">        <span class="attr">"response_content_type"</span>: <span class="string">"application/json; charset=UTF-8"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">        <span class="attr">"results_code"</span>: <span class="number">400504</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"nginx"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Fri, 25 Oct 2019 08:33:55 GMT"</span>,</span><br><span class="line">        <span class="attr">"app_version"</span>: <span class="string">"6.6.0"</span>,</span><br><span class="line">        <span class="attr">"request_content_type"</span>: <span class="string">"application/x-www-form-urlencoded"</span>,</span><br><span class="line">        <span class="attr">"user_agent"</span>: <span class="string">"okhttp/3.12.0"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/login"</span>,</span><br><span class="line">        <span class="attr">"email"</span>: <span class="string">"canon@gmail.com"</span>,</span><br><span class="line">        <span class="attr">"results"</span>: <span class="string">"failed"</span>,</span><br><span class="line">        "pragma": "no-cache",-</span><br><span class="line">        "cache_control": "no-cache, max-age=0, no-store",</span><br><span class="line">        "connection": "keep-alive",</span><br><span class="line">        "status": 200,</span><br><span class="line">        "protocol": "HTTP/1.1",</span><br><span class="line">        "hostname": "x.x.x.x",</span><br><span class="line">        "url_path": "/login",</span><br><span class="line">        "method": "POST",</span><br><span class="line">        "device": "RMX1920 Android8.0.0",</span><br><span class="line">        "device_type": "Android",</span><br><span class="line">        "request_content_length": "39"</span><br><span class="line">    &#125;,</span><br><span class="line">    "event_name": "login_audit",</span><br><span class="line">    "dest_ip": "2.2.2.2"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>Wazuh - é»‘åå•åŒ¹é…å‘Šè­¦(CDB list)</title>
    <url>/2019/10/18/Wazuh-Using-CDB-lists/</url>
    <content><![CDATA[<p><strong>éœ€æ±‚:</strong></p>
<p>â€‹        ç°æœ‰ä¸€æ‰¹é«˜å±ç”¨æˆ·, éœ€è¦å®æ—¶å…³æ³¨è¯¥è´¦å·çš„ç™»å½•æƒ…å†µã€‚ç”±äºä¹‹å‰å·²ç»å†™å¥½äº†ä¸€ä¸ªé’ˆå¯¹ç”¨æˆ·ç™»å½•è´¦å·çš„å®¡è®¡è§„åˆ™, å› æ­¤, è¿™é‡Œéœ€è¦ç”¨åˆ°<strong><a href="https://documentation.wazuh.com/3.10/user-manual/ruleset/cdb-list.html" target="_blank" rel="noopener">Wazuh CDB list</a></strong>è¿™ä¸ªåŠŸèƒ½(<em>æ­¤åŠŸèƒ½ä¸»è¦ç”¨ä¾‹æ˜¯åˆ›å»ºç”¨æˆ·ï¼ŒIPæˆ–åŸŸåçš„ç™½/é»‘åˆ—è¡¨ã€‚</em>)æ¶ˆè´¹å®¡è®¡è§„åˆ™æ•°æ®å³å¯ã€‚</p>
<hr>
<ol>
<li><strong>æ–°å»ºåˆ—è¡¨</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ more blacklist</span><br><span class="line"></span><br><span class="line">admin:</span><br><span class="line">root:</span><br><span class="line">administrator:</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>å°†åˆ—è¡¨æ–‡ä»¶æ·»åŠ åˆ°<code>ossec.conf</code></strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ more ossec.conf</span><br><span class="line"></span><br><span class="line">&lt;ossec_config&gt;</span><br><span class="line">	&lt;ruleset&gt;</span><br><span class="line">    &lt;!-- User-defined CDB list --&gt;</span><br><span class="line">    &lt;list&gt;etc/lists/blacklist&lt;/list&gt;</span><br><span class="line">	&lt;/ruleset&gt;</span><br><span class="line">&lt;/ossec_config&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>ç¼–è¯‘åˆ—è¡¨</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ /var/ossec/bin/ossec-makelists</span><br><span class="line"></span><br><span class="line"> * File etc/lists/blacklist.cdb needs to be updated</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>é‡å¯è¿›ç¨‹</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl restart wazuh-manager</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><strong>é…ç½®è§„åˆ™</strong></li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"local,blacklist,"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Defind blacklist Rules --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ID: 100150 - 100199 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"100163"</span> <span class="attr">level</span>=<span class="string">"12"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_sid</span>&gt;</span>100303<span class="tag">&lt;/<span class="name">if_sid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span> <span class="attr">field</span>=<span class="string">"http.email"</span> <span class="attr">lookup</span>=<span class="string">"match_key"</span>&gt;</span>etc/lists/blacklist<span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Wazuh Rules - High-risk user login detected. $(src_ip) -&gt; $(http.email) -&gt; $(http.hostname) -&gt; $(http.url) = $(http.results).<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span>blacklist,<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li><strong>æµ‹è¯•è§„åˆ™</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./ossec-logtest</span><br><span class="line">2019/10/18 15:06:47 ossec-testrule: INFO: Started (pid: 2184).</span><br><span class="line">ossec-testrule: Type one <span class="built_in">log</span> per line.</span><br><span class="line"></span><br><span class="line">**Phase 3: Completed filtering (rules).</span><br><span class="line">       Rule id: <span class="string">'100163'</span></span><br><span class="line">       Level: <span class="string">'12'</span></span><br><span class="line">       Description: <span class="string">'Wazuh Rules - High-risk user login detected. 1.1.1.1 -&gt; admin -&gt; canon88.github.io -&gt; /user/login = success.'</span></span><br><span class="line">**Alert to be generated.</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>HIDS</category>
      </categories>
      <tags>
        <tag>Wazuh</tag>
      </tags>
  </entry>
  <entry>
    <title>æˆ‘åœ¨'äº‘'ä¸Šçš„æ—¥å­ - AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘</title>
    <url>/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/</url>
    <content><![CDATA[<p>â€‹    </p>
<p>â€‹        è‡ªä»AWSåœ¨6æœˆä»½æ–°å‡ºäº†<strong>Traffic Mirroring</strong>åŠŸèƒ½å, æˆ‘ä¹Ÿç®—æ˜¯ç¬¬ä¸€æ—¶é—´ä½¿ç”¨äº†è¿™ä¸ªåŠŸèƒ½ã€‚ä¸ä¼ ç»Ÿçš„äº¤æ¢æœºæµé‡é•œåƒä¸åŒçš„æ˜¯, AWSä¸Šæ˜¯å°†æµé‡é•œåƒåçš„æ•°æ®é€šè¿‡<strong>VXLAN</strong>åè®®å‘é€è‡³æµé‡åˆ†æå¼•æ“(<strong>Suricata</strong>ã€<strong>Zeek</strong>)ã€‚æ­£æ˜¯ç”±äºè¿™ä¸€ç‚¹è®©æˆ‘ç¢°åˆ°äº†ä»¥ä¸‹å‡ ä¸ªé—®é¢˜, è¿™é‡Œå†™å‡ºæ¥å¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚</p>
<ol>
<li>æ¥æ”¶æµé‡é•œåƒçš„ç›®æ ‡ç«¯, ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„æµé‡åˆ†æå¼•æ“ç«¯æ˜¯æœ‰æ¥æ”¶é™åˆ¶çš„ã€‚</li>
</ol>
<p>â€‹       å¦‚æœä½ æ˜¯åœ¨ä¸€ä¸ªéä¸“ç”¨å®ä¾‹ä¸Šéƒ¨ç½²çš„Suricataã€Zeekã€‚é‚£ä¹ˆä½ åªèƒ½æœ€å¤šåŒæ—¶æ¥æ”¶10ä¸ªæºçš„æµé‡é•œåƒ, ä¹Ÿå°±æ˜¯ä½ åªèƒ½æ¥æ”¶10ä¸ªç½‘å¡çš„æ•°æ®ã€‚å¾ˆä¸å·§çš„æ˜¯æˆ‘ä»¬ç¢°ä¸Šäº†è¿™ä¸ªé—®é¢˜, è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•, ä½¿ç”¨ä¸“ç”¨å®ä¾‹(<strong>Dedicated instance</strong>) æˆ–è€… ä½¿ç”¨AWSçš„ç½‘ç»œè´Ÿè½½å‡è¡¡(<strong>Network Load Balancer</strong>)ã€‚å‰è€…å¯ä»¥å°†Limitæå‡åˆ°<strong>100</strong>, åè€…å°†<strong>ä¸å—é™</strong>ã€‚å¦‚å›¾:</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016164935291.png" alt="image-20191016164935291"></p>
<hr>
<ol start="2">
<li>C5ä¸C4å®ä¾‹çš„å·®å¼‚</li>
</ol>
<p>â€‹        å°±æˆ‘ç›®å‰ä½¿ç”¨çš„å®ä¾‹è€Œè¨€, åˆ†åˆ«æµ‹è¯•è¿‡C5 ä¸ C4ä¸¤ç§å®ä¾‹ã€‚ä»–ä»¬çš„ç½‘å¡é©±åŠ¨æœ‰æ‰€åŒºåˆ«çš„, å¦‚å›¾:</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016160923628.png" alt="image-20191016160923628"></p>
<p>â€‹        æˆ‘è¿™ä½¿ç”¨ä¸‹æ¥æœ€ç›´è§‚çš„åŒºåˆ«, åœ¨C4å®ä¾‹ä¸Šè‹¥ä¸ä½¿ç”¨PF_RINGæ•åŒ…æ¨¡å¼çš„è¯, Suricataä¸¢åŒ…ç‡æ„Ÿäºº, 0.5 Gbpså°±å¼€å§‹ä¸¢åŒ…ã€‚æµ‹è¯•çš„æœºå™¨é…ç½®: 32C 60Gçš„æœºå™¨, åˆ‡æ¢åˆ°PF_RINGæ•åŒ…æ¨¡å¼æ— æ­¤é—®é¢˜ã€‚åä¹‹C5å®ä¾‹å°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜, AF-PACKETç›´æ¥ä¸Šåˆ°2 Gbpsçš„çº¯HTTPæµé‡éƒ½æ²¡æœ‰ä¸¢åŒ…ã€‚ç¡¬ä»¶é…ç½®: 16C 32Gçš„æœºå™¨ã€‚</p>
<hr>
<ol start="3">
<li>è¶…è¿‡<strong>MTU: 9001</strong>æ•°æ®åŒ…è¢«æˆªæ–­</li>
</ol>
<p>â€‹      è¿™å‡ å¤©åœ¨æ’æŸ¥å®‰å…¨äº‹ä»¶æ—¶, å‘ç°ç›‘æ§çš„åŒä¸€å°Nginxä¸Šè§£æå‡ºçš„æµé‡(HTTPäº‹ä»¶)ä¸æ—¥å¿—(HTTPäº‹ä»¶)æ•°é‡ç›¸å·®è¾ƒå¤§ã€‚ç»è¿‡ä¸¤å¤©çš„æ’æŸ¥ç»ˆäºå®šä½äº†é—®é¢˜, Suricata kernel å¹¶æ²¡æœ‰ä¸¢åŒ…, æ‰€ä»¥æ€€ç–‘æ˜¯ä¸æ˜¯Suricata HTTPè§£æå‡ºé”™å¯¼è‡´ã€‚æœ€ç»ˆé€šè¿‡æŠ“åŒ…å‘ç°å¯¼è‡´è¯¥é—®é¢˜çš„â€ç½ªé­ç¥¸é¦–â€å°±æ˜¯<strong>VXLAN</strong>, ç”±äºAWSåœ¨æµé‡é•œåƒæ—¶é‡‡ç”¨äº†<strong>VXLAN</strong>åè®®è¿›è¡Œå°è£…, å¯¼è‡´åœ¨åŸæœ‰<strong>MTU</strong>çš„åŸºç¡€ä¸Š<strong>å¢åŠ äº†50ä¸ªå­—èŠ‚</strong>, é€ æˆæ•°æ®åŒ…è¢«æˆªæ–­, æ— æ³•è¿˜åŸå‡ºHTTPäº‹ä»¶ã€‚ä»¥ä¸‹æˆªå›¾å°±æ˜¯ä¸€ä¸ªæ— æ³•è¢«æ­£ç¡®è¿˜åŸHTTPäº‹ä»¶çš„æ•°æ®åŒ…, æˆ‘ç”¨Suricataè½½å…¥æ•°æ®åŒ…å, åªè¿˜åŸå‡ºäº†é•¿åº¦<strong>9015</strong>æ•°æ®åŒ…ä¹‹å‰çš„HTTPä¿¡æ¯, é•¿åº¦<strong>9015</strong>æ•°æ®åŒ…ä¹‹åçš„æ‰€æœ‰äº‹ä»¶å‡æ— æ³•è¢«è¿˜åŸã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191014095249725.png" alt="image-20191014095249725"></p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191014094741753.png" alt="image-20191014094741753"></p>
<p><strong>å®˜æ–¹æè¿°:</strong></p>
<p>â€‹        For example, if an 8996 byte packet is mirrored, and the traffic mirror target MTU value is 9001 bytes, the mirror encapsulation results in the mirrored packet being greater than the MTU value. In this case, the mirror packet is truncated. To prevent mirror packets from being truncated, set the traffic mirror source interface MTU value to 54 bytes less than the traffic mirror target MTU value. For more information about configuring the network MTU value, see Network Maximum Transmission Unit (MTU) for Your EC2 Instance in the <em>Amazon EC2 User Guide for Linux Instances</em>.</p>
<p>â€‹        ä¾‹å¦‚ï¼Œå¦‚æœå¯¹8996å­—èŠ‚çš„æ•°æ®åŒ…è¿›è¡Œäº†é•œåƒï¼Œå¹¶ä¸”æµé‡é•œåƒç›®æ ‡MTUå€¼ä¸º9001å­—èŠ‚ï¼Œåˆ™é•œåƒå°è£…ä¼šå¯¼è‡´é•œåƒçš„æ•°æ®åŒ…å¤§äºMTUå€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé•œåƒæ•°æ®åŒ…å°†è¢«æˆªæ–­ã€‚ä¸ºé˜²æ­¢é•œåƒæ•°æ®åŒ…è¢«æˆªæ–­ï¼Œè¯·å°†æµé‡é•œåƒæºæ¥å£çš„MTUå€¼è®¾ç½®ä¸ºæ¯”æµé‡é•œåƒç›®æ ‡MTUå€¼å°54ä¸ªå­—èŠ‚ã€‚æœ‰å…³é…ç½®ç½‘ç»œMTUå€¼çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…Amazon EC2 Linuxå®ä¾‹ç”¨æˆ·æŒ‡å—ä¸­çš„EC2å®ä¾‹çš„ç½‘ç»œæœ€å¤§ä¼ è¾“å•ä½ï¼ˆMTUï¼‰ã€‚</p>
<hr>
<p><strong>å…³äºVXLANå¯¼è‡´Suricataæ— æ³•æ­£å¸¸è§£ææ•°æ®çš„é—®é¢˜, ç‰¹åœ°è¿›è¡Œäº†æµ‹è¯•:</strong></p>
<p>å‡†å¤‡å·¥ä½œ:</p>
<ul>
<li>æ–°å»ºäº†<strong>test_files</strong>æ–‡ä»¶, è¯¥æ–‡ä»¶åªåŒ…å«å†…å®¹â€™<strong>hello, world!</strong>â€˜;</li>
<li>ä¸ºäº†ä½¿æ•°æ®åŒ…åœ¨ä¼ è¾“æ—¶æ»¡è¶³<strong>MTU: 9001</strong>, æ‰‹åŠ¨ç”Ÿæˆäº†ä¸€ä¸ª10MBç©ºæ–‡ä»¶<strong>10mb_exist_files</strong>. </li>
</ul>
<p>å…±è®¡è®¿é—®: 14æ¬¡</p>
<p>è®¿é—®é¡ºåº:</p>
<ol>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (æ¬¡)</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (æ¬¡)</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (æ¬¡)</li>
</ol>
<p>æ­£å¸¸æƒ…å†µ:</p>
<ul>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (æ¬¡) - æ­£å¸¸</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (æ¬¡) - æ­£å¸¸</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (æ¬¡) - æ­£å¸¸</li>
</ul>
<p>å¼‚å¸¸æƒ…å†µ:</p>
<ul>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (æ¬¡) - æ­£å¸¸</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (æ¬¡) - å¼‚å¸¸</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (æ¬¡) - ä¸¢å¤±</li>
</ul>
<p><strong>MTU: 9001</strong></p>
<ul>
<li>éé•œåƒæµé‡çš„æ•°æ®åŒ…è¯¦æƒ…:</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°ä»æ•°æ®åŒ…<strong>20</strong>åˆ°æ•°æ®åŒ…<strong>6126</strong>ä¹‹é—´éƒ½æ˜¯åœ¨è¿›è¡Œ<strong>10MB</strong>æ–‡ä»¶(<strong>10mb_exist_files</strong>)çš„ä¼ è¾“è¿‡ç¨‹ã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016103409831.png" alt="image-20191016103409831"></p>
<hr>
<p>ä»httpæ•°æ®åŒ…ä¸­å¯ä»¥çœ‹å‡º, è¿™é‡Œè¯·æ±‚åŒ…ä¸å“åº”åŒ…éƒ½å¯ä»¥æ­£å¸¸è¢«è¿˜åŸå‡ºæ¥ã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016104502919.png" alt="image-20191016104502919"></p>
<hr>
<p>æ•°æ®åŒ…åœ¨Suricataä¸Šçš„è§£æç»“æœ:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-15T22:52:10.180505+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">415026399241324</span>,</span><br><span class="line">    <span class="attr">"pcap_cnt"</span>: <span class="number">6127</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43418</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"http_content_type"</span>: <span class="string">"text/html"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress"</span>,</span><br><span class="line">        <span class="attr">"content_length"</span>: <span class="string">"41943044"</span>,</span><br><span class="line">        <span class="attr">"content_type"</span>: <span class="string">"text/html; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Tue, 15 Oct 2019 14:52:10 GMT"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"Werkzeug/0.16.0 Python/2.7.16"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">41943044</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>é•œåƒæµé‡çš„æ•°æ®åŒ…è¯¦æƒ…:</strong>(ä¹Ÿå°±æ˜¯<strong>VXLAN</strong>å°è£…åçš„æ•°æ®åŒ…)</li>
</ul>
<p>åŒæ ·å¯ä»¥çœ‹åˆ°ä»æ•°æ®åŒ…<strong>26</strong>åˆ°æ•°æ®åŒ…<strong>6170</strong>ä¹‹é—´éƒ½æ˜¯åœ¨è¿›è¡Œ<strong>10MB</strong>æ–‡ä»¶(<strong>10mb_exist_files</strong>)çš„ä¼ è¾“è¿‡ç¨‹ã€‚ä½†æ˜¯åœ¨ç¬¬<strong>34</strong>ä¸ªæ•°æ®åŒ…ä¸­å¯ä»¥çœ‹åˆ°, å·²ç»æ ‡æ³¨äº†æ•°æ®è¶…å‡ºäº†æœ€å¤§é•¿åº¦ã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016105636906.png" alt="image-20191016105636906"></p>
<hr>
<p>è¶…å‡ºé•¿åº¦çš„æ•°æ®å°†ä¼šè¢«æˆªæ–­, æ ‡æ³¨: <strong>50 bytes missing in capture file</strong>ã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016150322620.png" alt="image-20191016150322620"></p>
<p>ä»HTTPæ•°æ®åŒ…ä¸­å¯ä»¥çœ‹å‡º, è¿™é‡Œåªæœ‰è¯·æ±‚åŒ…, ç”±äºåç»­çš„å“åº”åŒ…è¶…å‡ºäº†<strong>MTU: 9001</strong>,  å› æ­¤å¹¶æ²¡æœ‰å“åº”åŒ…ã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016105948606.png" alt="image-20191016105948606"></p>
<hr>
<p>æ•°æ®åŒ…åœ¨Suricataä¸Šçš„è§£æç»“æœ:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-15T22:52:48.295823+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">1746715371266426</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43420</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç»“è®º:</strong></p>
<p>â€‹        ç›¸æ¯”éé•œåƒæµé‡çš„æ•°æ®åŒ…, Suricata å°‘äº†åç»­10æ¡httpè¯·æ±‚çš„æ•°æ®è§£æã€‚é’ˆå¯¹è®¿é—®<strong>10mb_exist_files</strong>çš„è¯·æ±‚, ç”±äºè¶…è¿‡äº†MTU, æ•°æ®åŒ…è¢«é˜¶æ®µäº†, httpçš„è§£ææ•°æ®ä¹Ÿæ˜¯ä¸å®Œæ•´çš„ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ:</strong></p>
<p>â€‹        è¿™é‡Œç›´æ¥å¼•ç”¨AWSçš„å®˜æ–¹æ–‡æ¡£æè¿°ã€‚å¦‚æœå¯¹8996å­—èŠ‚çš„æ•°æ®åŒ…è¿›è¡Œäº†é•œåƒï¼Œå¹¶ä¸”æµé‡é•œåƒç›®æ ‡MTUå€¼ä¸º9001å­—èŠ‚ï¼Œåˆ™é•œåƒå°è£…ä¼šå¯¼è‡´é•œåƒçš„æ•°æ®åŒ…å¤§äºMTUå€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé•œåƒæ•°æ®åŒ…å°†è¢«æˆªæ–­ã€‚ä¸ºé˜²æ­¢é•œåƒæ•°æ®åŒ…è¢«æˆªæ–­ï¼Œè¯·å°†æµé‡é•œåƒæºæ¥å£çš„MTUå€¼è®¾ç½®ä¸ºæ¯”æµé‡é•œåƒç›®æ ‡MTUå€¼å°54ä¸ªå­—èŠ‚ã€‚æœ‰å…³é…ç½®ç½‘ç»œMTUå€¼çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…Amazon EC2 Linuxå®ä¾‹ç”¨æˆ·æŒ‡å—ä¸­çš„EC2å®ä¾‹çš„ç½‘ç»œæœ€å¤§ä¼ è¾“å•ä½ï¼ˆMTUï¼‰ã€‚</p>
<p>â€‹        ä¸€èˆ¬æ¥è¯´ï¼Œé™ä½ MTU çš„è¯ï¼Œæœ‰å¯èƒ½å‘ç°ç½‘è·¯ä¼ è¾“æ•ˆèƒ½æœ‰ä¸‹é™ï¼Œè¿™æ˜¯å› ä¸ºæ¯ä¸ªå°åŒ… size å˜å°ï¼Œæ‰€ä»¥ä¼ é€åŒæ ·çš„èµ„æ–™é‡ï¼Œå°åŒ…æ•°å°±ä¼šå˜å¤šï¼Œé€ æˆ overhead å˜å¤šã€‚ä½†æ˜¯å¯¹äºä¼ è¾“æ˜¯ä¸ä¼šäº§ç”Ÿé”™è¯¯çš„çŠ¶å†µçš„ã€‚</p>
<hr>
<p><strong>MTU:1500</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br><span class="line"></span><br><span class="line">$ sudo ip link <span class="built_in">set</span> dev eth0 mtu 1500</span><br><span class="line"></span><br><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016154823748.png" alt="image-20191016154823748"></p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016155112376.png" alt="image-20191016155112376"></p>
<p>æ•°æ®åŒ…åœ¨Suricataä¸Šçš„è§£æç»“æœ:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-16T15:14:15.576656+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">1135596924232203</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43554</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"http_content_type"</span>: <span class="string">"text/html"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress\n"</span>,</span><br><span class="line">        <span class="attr">"content_length"</span>: <span class="string">"41943044"</span>,</span><br><span class="line">        <span class="attr">"content_type"</span>: <span class="string">"text/html; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Wed, 16 Oct 2019 07:14:15 GMT"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"Werkzeug/0.16.0 Python/2.7.16"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">41943044</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹        ç»“è®º: <strong>MTUå‡å°åˆ°1500æ—¶</strong>, æ— è®ºä»WireSharkæ¥æŸ¥çœ‹æˆ–è€…Suricataåè®®è¿˜åŸçš„è§’åº¦æ¥è¯´, éƒ½æ˜¯å¯ä»¥çš„ã€‚</p>
<hr>
<p>â€‹        å†™åœ¨æœ€å, è¯´å®è¯AWSæä¾›äº†åœ¨äº‘ä¸Šçš„æµé‡é•œåƒç¡®å®å¾ˆä¸é”™, è‡³å°‘æ¯”ä¼ ç»Ÿåœ¨äº‘ä¸Šæ¯ä¸€å°æœºå™¨é€šè¿‡å®‰è£…agentæŠŠæµé‡å¤–å‘çš„å½¢å¼å¼º, ä¼¼ä¹<strong>å›½å†…</strong>çš„äº‘å‚å•†ç°åœ¨ä¹Ÿæ²¡æœ‰è¿™ä¸ªåŠŸèƒ½! </p>
<p>â€‹        ä¸è¿‡é€šè¿‡VXLANå°†æ•°æ®åŒ…å°è£…åå¯¼è‡´MTUè¶…è¿‡æœ€å¤§å€¼è¿™é—®é¢˜ä¹Ÿç¡®å®æœ‰ç‚¹å‘ã€‚ä½ è®©å·²ç»æˆå‹çš„æ¶æ„å»è°ƒæ•´MTUå€¼, è™½ç„¶ç†è®ºä¸Šæ˜¯å¯è¡Œ, ä½†å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ç½‘ç»œçš„è°ƒæ•´éƒ½æ˜¯æ¯”è¾ƒæ…é‡çš„, é™¤éä¼ä¸šç°åœ¨å¿…é¡»å¾—ä¸Šæµé‡é•œåƒ, å¦åˆ™ä¸å¤ªèƒ½è¯´æœè¿ç»´çš„å°ä¼™ä¼´å»è°ƒæ•´, è¦æ˜¯çœŸå‡ºäº†ä»€ä¹ˆé—®é¢˜, éƒ½æ˜¯å¤§é—®é¢˜ã€‚</p>
<p><strong>å‚è€ƒ</strong></p>
<ul>
<li><a href="https://docs.aws.amazon.com/vpc/latest/mirroring/vpc-tm.pdf" target="_blank" rel="noopener">Amazon Virtual Private Cloud Traffic Mirroring</a></li>
<li><a href="https://community.emc.com/community/support/chinese/teamblog/blog/2016/05/12/å¤§å’–è®²ç½‘ç»œ-mtuå¯¼è‡´çš„æ‚²å‰§" target="_blank" rel="noopener">å¤§å’–è®²ç½‘ç»œ-mtuå¯¼è‡´çš„æ‚²å‰§</a></li>
<li><a href="https://www.cnblogs.com/sammyliu/p/5079898.html" target="_blank" rel="noopener">Neutron VxLAN + Linux Bridge ç¯å¢ƒä¸­çš„ç½‘ç»œ MTU</a></li>
</ul>
]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>Suricata - Lua Output Script</title>
    <url>/2019/10/14/Suricata%20-%20Lua%20Output/</url>
    <content><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>â€‹    ç”±äºè¿‘æœŸç½‘ç«™é­å—å¤§é‡æ’åº“æ”»å‡», æƒ³ç›‘æ§ä¸€ä¸‹ç™»å½•æ¥å£ä¸­çš„å¼‚å¸¸è¡Œä¸ºã€‚é€šè¿‡<strong>alert</strong>å¹¶ä¸èƒ½èµ·åˆ°å¾ˆå¥½çš„æ•ˆæœ, æ‰€ä»¥é‡‡ç”¨<strong>Lua</strong>è„šæœ¬è¿›è¡Œæ‰©å±•, å†™äº†ä¸€ä¸ªå®¡è®¡ç™»å½•æ¥å£çš„è„šæœ¬ã€‚é€šè¿‡ç™»å½•æ¥å£äº‹ä»¶, å†é…åˆ<strong>Wazuh</strong>è¿›è¡Œä¸€äº›ç®€å•çš„å…³è”å‘Šè­¦,  æ•ˆæœè¿˜æ˜¯ä¸é”™çš„ã€‚</p>
<h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><ul>
<li>ç”±äºå®¡è®¡å†…å®¹æ¶‰åŠåˆ°ç”¨æˆ·æ•æ„Ÿä¿¡æ¯, å› æ­¤éœ€è¦å¯¹æ•æ„Ÿä¿¡æ¯è¿›è¡Œ<strong>Hash</strong>ä¹‹åå†è¾“å‡º;</li>
<li>é™¤é€šç”¨<strong>HTTP Header</strong>å­—æ®µå¤–æ”¯æŒå¯¹è‡ªå®šä¹‰å­—æ®µè¿›è¡Œé€‰æ‹©æ€§è¾“å‡º;</li>
</ul>
<h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">json = <span class="built_in">require</span> <span class="string">"json"</span></span><br><span class="line">md5 = <span class="built_in">require</span> <span class="string">"md5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç™»å½•æ¥å£</span></span><br><span class="line">login_url = <span class="string">"/login"</span></span><br><span class="line"><span class="comment">-- ç™»å½•çŠ¶æ€ç </span></span><br><span class="line">success_code = <span class="number">0</span></span><br><span class="line"><span class="comment">-- event_name</span></span><br><span class="line">event_name = <span class="string">"login_audit"</span></span><br><span class="line"><span class="comment">-- event_type</span></span><br><span class="line">event_type = <span class="string">"lua"</span></span><br><span class="line"><span class="comment">-- app_type</span></span><br><span class="line">app_type = <span class="string">"web"</span></span><br><span class="line"><span class="comment">-- logs</span></span><br><span class="line">name = <span class="string">"web_login_audit.json"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- common_mapping</span></span><br><span class="line">http_common_mapping = <span class="string">'&#123;"accept":"accept","accept-charset":"accept_charset","accept-encoding":"accept_encoding","accept-language":"accept_language","accept-datetime":"accept_datetime","authorization":"authorization","cache-control":"cache_control","from":"from","max-forwards":"max_forwards","origin":"origin","pragma":"pragma","proxy-authorization":"proxy_authorization","via":"via","vary":"vary","x-requested-with":"x_requested_with","x-forwarded-proto":"x_forwarded_proto","accept-range":"accept_range","allow":"allow","connection":"connection","content-encoding":"content_encoding","content-language":"content_language","content-location":"content_location","content-md5":"content_md5","content-range":"content_range","date":"date","last-modified":"last_modified","location":"location","proxy-authenticate":"proxy_authenticate","referrer":"refer","retry-after":"retry_after","server":"server","transfer-encoding":"transfer_encoding","upgrade":"upgrade","www-authenticate":"www_authenticate","x-authenticated-user":"x_authenticated_user","user-agent":"user_agent"&#125;'</span></span><br><span class="line">common_mapping_table = json.decode(http_common_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- request_mapping</span></span><br><span class="line">http_request_mapping = <span class="string">'&#123;"content-length":"request_content_length","content-type":"request_content_type"&#125;'</span></span><br><span class="line">request_mapping_table = json.decode(http_request_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- response_mapping</span></span><br><span class="line">http_response_mapping = <span class="string">'&#123;"content-length":"response_content_length","content-type":"response_content_type"&#125;'</span></span><br><span class="line">response_mapping_table = json.decode(http_response_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- defind functioin</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5Encode</span><span class="params">(args)</span></span></span><br><span class="line">    m = md5.new()</span><br><span class="line">    m:update(args)</span><br><span class="line">    <span class="keyword">return</span> md5.tohex(m:finish())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlDecode</span><span class="params">(args)</span></span></span><br><span class="line">    s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(args, <span class="string">"%%(%x%x)"</span>, <span class="function"><span class="keyword">function</span><span class="params">(h)</span></span> <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="built_in">tonumber</span>(h, <span class="number">16</span>)) <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- email=xxx@yyy.com&amp;password=zzz</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStr</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    data = <span class="built_in">string</span>.split(args, <span class="string">'&amp;'</span>)</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">        d = <span class="built_in">string</span>.split(v, <span class="string">'='</span>)</span><br><span class="line">        t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.split</span><span class="params">(s, p)</span></span></span><br><span class="line">    <span class="keyword">local</span> rt = &#123;&#125;</span><br><span class="line">    <span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">'[^'</span>..p..<span class="string">']+'</span>, <span class="function"><span class="keyword">function</span><span class="params">(w)</span></span> <span class="built_in">table</span>.<span class="built_in">insert</span>(rt, w) <span class="keyword">end</span> )</span><br><span class="line">    <span class="keyword">return</span> rt</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trim</span><span class="params">(s)</span></span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">"^%s*(.-)%s*$"</span>, <span class="string">"%1"</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatCookie</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    data = <span class="built_in">string</span>.split(args, <span class="string">";"</span>)</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">        v = trim(v)</span><br><span class="line">        d = <span class="built_in">string</span>.split(v, <span class="string">"="</span>)</span><br><span class="line">        t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- default function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(args)</span></span></span><br><span class="line">    <span class="keyword">local</span> needs = &#123;&#125;</span><br><span class="line">    needs[<span class="string">"protocol"</span>] = <span class="string">"http"</span></span><br><span class="line">    <span class="keyword">return</span> needs</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span> <span class="params">(args)</span></span></span><br><span class="line">    filename = SCLogPath() .. <span class="string">"/"</span> .. name</span><br><span class="line">    file = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">"a"</span>))</span><br><span class="line">    SCLogInfo(<span class="string">"Web Login Log Filename "</span> .. filename)</span><br><span class="line">    http = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(args)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- init tables</span></span><br><span class="line">    http_table = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_hostname</span></span><br><span class="line">    http_hostname = HttpGetRequestHost()</span><br><span class="line">    http_table[<span class="string">"hostname"</span>] = http_hostname</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_url</span></span><br><span class="line">    http_url = HttpGetRequestUriNormalized()</span><br><span class="line">    <span class="keyword">if</span> http_url ~= login_url <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"url"</span>] = login_url</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_url_path</span></span><br><span class="line">    http_table[<span class="string">"url_path"</span>] = http_url</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_method</span></span><br><span class="line">    rl = HttpGetRequestLine()</span><br><span class="line">    http_method = <span class="built_in">string</span>.<span class="built_in">match</span>(rl, <span class="string">"%w+"</span>)</span><br><span class="line">    http_table[<span class="string">"method"</span>] = http_method</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_status</span></span><br><span class="line">    rsl = HttpGetResponseLine()</span><br><span class="line">    status_code = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"%s(%d+)%s"</span>)</span><br><span class="line">    http_status = <span class="built_in">tonumber</span>(status_code)</span><br><span class="line">    http_table[<span class="string">"status"</span>] = http_status</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_protocol</span></span><br><span class="line">    http_protocol = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"(.-)%s"</span>)</span><br><span class="line">    http_table[<span class="string">"protocol"</span>] = http_protocol</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- request_token</span></span><br><span class="line">    cookie = HttpGetRequestHeader(<span class="string">"Cookie"</span>)</span><br><span class="line">    <span class="keyword">if</span> cookie ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        session_id = <span class="built_in">string</span>.<span class="built_in">match</span>(cookie, <span class="string">"sessionID=(.-);"</span>)</span><br><span class="line">        <span class="keyword">if</span> session_id ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[<span class="string">"request_token"</span>] = md5Encode(session_id)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            http_table[<span class="string">"request_token"</span>]  = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- response_token &amp;&amp; member_id</span></span><br><span class="line">    set_cookie = HttpGetResponseHeader(<span class="string">"Set-Cookie"</span>)</span><br><span class="line">    <span class="keyword">if</span> set_cookie ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        session_id = <span class="built_in">string</span>.<span class="built_in">match</span>(set_cookie, <span class="string">"sessionID=(.-);"</span>)</span><br><span class="line">        http_table[<span class="string">"response_token"</span>]  = md5Encode(session_id)</span><br><span class="line">        member_id = <span class="built_in">string</span>.<span class="built_in">match</span>(set_cookie, <span class="string">"memberId=(.-);"</span>)</span><br><span class="line">        http_table[<span class="string">"member_id"</span>] = <span class="built_in">tonumber</span>(member_id)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- login_results</span></span><br><span class="line">    a, o, e = HttpGetResponseBody()</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        body = json.decode(v)</span><br><span class="line">        results_code = <span class="built_in">tonumber</span>(body[<span class="string">"code"</span>])</span><br><span class="line">        <span class="keyword">if</span> results_code == success_code <span class="keyword">then</span></span><br><span class="line">            results = <span class="string">"success"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            results = <span class="string">"failed"</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"results"</span>] = results</span><br><span class="line">    http_table[<span class="string">"results_code"</span>] = results_code</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- email &amp; password</span></span><br><span class="line">    a, o, e = HttpGetRequestBody()</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        res = formatStr(v)</span><br><span class="line">        mail = urlDecode(res[<span class="string">'email'</span>])</span><br><span class="line">        pass = md5Encode(res[<span class="string">'password'</span>])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"email"</span>] = mail</span><br><span class="line">    http_table[<span class="string">"password"</span>] = pass</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- RequestHeaders</span></span><br><span class="line">    rh = HttpGetRequestHeaders()</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rh) <span class="keyword">do</span></span><br><span class="line">        key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line"></span><br><span class="line">        common_var = common_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> common_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[common_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        request_var = request_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> request_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[request_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- ResponseHeaders</span></span><br><span class="line">    rsh = HttpGetResponseHeaders()</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rsh) <span class="keyword">do</span></span><br><span class="line">        key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line"></span><br><span class="line">        common_var = common_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> common_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[common_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        response_var = response_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> response_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[response_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- timestring = SCPacketTimeString() 2019-09-10T06:08:35.582449+0000</span></span><br><span class="line">    sec, usec = SCPacketTimestamp()</span><br><span class="line">    timestring = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">"!%Y-%m-%dT%T"</span>, sec) .. <span class="string">"."</span> .. usec .. <span class="string">"+0000"</span></span><br><span class="line">    </span><br><span class="line">    ip_version, src_ip, dst_ip, protocol, src_port, dst_port = SCFlowTuple()</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- flow_id</span></span><br><span class="line">    id = SCFlowId()</span><br><span class="line">    flow_id = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%.0f"</span>, id)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- true_ip</span></span><br><span class="line">    true_client_ip = HttpGetRequestHeader(<span class="string">"True-Client-IP"</span>)</span><br><span class="line">    <span class="keyword">if</span> true_client_ip ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        src_ip = true_client_ip</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- table</span></span><br><span class="line">    raw_data = &#123;</span><br><span class="line">        timestamp = timestring,</span><br><span class="line">        flow_id = flow_id,</span><br><span class="line">        src_ip = src_ip,</span><br><span class="line">        src_port = src_port,</span><br><span class="line">        dest_ip = dst_ip,</span><br><span class="line">        dest_port = dst_port,</span><br><span class="line">        event_name = event_name,</span><br><span class="line">        event_type = event_type,</span><br><span class="line">        app_type = app_type,</span><br><span class="line">        http = http_table,</span><br><span class="line">        proto = <span class="string">"TCP"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- json encode</span></span><br><span class="line">    data = json.encode(raw_data)</span><br><span class="line"></span><br><span class="line">    file:<span class="built_in">write</span>(data .. <span class="string">"\n"</span>)</span><br><span class="line">    file:<span class="built_in">flush</span>()</span><br><span class="line"></span><br><span class="line">    http = http + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deinit</span> <span class="params">(args)</span></span></span><br><span class="line">    SCLogInfo (<span class="string">"HTTP transactions logged: "</span> .. http);</span><br><span class="line">    file:<span class="built_in">close</span>(file)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h1><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">34963</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"lua"</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="string">"471693756052529"</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-07T13:51:01.560556+0000"</span>,</span><br><span class="line">    <span class="attr">"event_name"</span>: <span class="string">"login_audit"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">3007</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"response_content_length"</span>: <span class="string">"446"</span>,</span><br><span class="line">        <span class="attr">"response_content_type"</span>: <span class="string">"application/json; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"nginx"</span>,</span><br><span class="line">        <span class="attr">"results_code"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"vary"</span>: <span class="string">"Accept-Encoding"</span>,</span><br><span class="line">        <span class="attr">"password"</span>: <span class="string">"420ce28ef813a2dc05e52a7e24eb0d5c"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Mon, 07 Oct 2019 13:51:01 GMT"</span>,</span><br><span class="line">        <span class="attr">"request_content_type"</span>: <span class="string">"application/x-www-form-urlencoded; charset=UTF-8"</span>,</span><br><span class="line">        <span class="attr">"accept_language"</span>: <span class="string">"en-US,en;q=0.9"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/login"</span>,</span><br><span class="line">        <span class="attr">"x_requested_with"</span>: <span class="string">"XMLHttpRequest"</span>,</span><br><span class="line">        <span class="attr">"x_forwarded_proto"</span>: <span class="string">"https"</span>,</span><br><span class="line">        <span class="attr">"user_agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36"</span>,</span><br><span class="line">        <span class="attr">"origin"</span>: <span class="string">"https://www.canon.com"</span>,</span><br><span class="line">        <span class="attr">"response_token"</span>: <span class="string">"4f5f386aec34e877ce63fce7ddd3f15f"</span>,</span><br><span class="line">        <span class="attr">"pragma"</span>: <span class="string">"no-cache"</span>,</span><br><span class="line">        <span class="attr">"connection"</span>: <span class="string">"close"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"www.canon.com"</span>,</span><br><span class="line">        <span class="attr">"url_path"</span>: <span class="string">"/login"</span>,</span><br><span class="line">        <span class="attr">"cache_control"</span>: <span class="string">"no-cache, max-age=0, no-store, must-revalidate"</span>,</span><br><span class="line">        <span class="attr">"method"</span>: <span class="string">"POST"</span>,</span><br><span class="line">        <span class="attr">"email"</span>: <span class="string">"admin@canon.com"</span>,</span><br><span class="line">        <span class="attr">"request_token"</span>: <span class="string">"109464370570b23fa9768078ab1ac8a9"</span>,</span><br><span class="line">        <span class="attr">"member_id"</span>: <span class="number">123456</span>,</span><br><span class="line">        <span class="attr">"results"</span>: <span class="string">"success"</span>,</span><br><span class="line">        <span class="attr">"request_content_length"</span>: <span class="string">"49"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"77.99.22.17"</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"1.1.1.1"</span>,</span><br><span class="line">    <span class="attr">"app_type"</span>: <span class="string">"web"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>æˆ‘åœ¨'äº‘'ä¸Šçš„æ—¥å­ - Zeek(éƒ¨ç½²)</title>
    <url>/2019/10/14/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90%20-%20Zeek%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h4 id="Optional-Dependencies"><a href="#Optional-Dependencies" class="headerlink" title="Optional Dependencies"></a>Optional Dependencies</h4><h5 id="PF-RING"><a href="#PF-RING" class="headerlink" title="PF_RING"></a>PF_RING</h5><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><strong><a href="https://docs.zeek.org/en/v3.1.1/configuration/index.html#pf-ring-cluster-configuration" target="_blank" rel="noopener">Installing PF_RING</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/ntop/PF_RING.git</span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/userland/lib</span><br><span class="line">$ ./configure</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ../libpcap</span><br><span class="line">$ ./configure</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ../tcpdump</span><br><span class="line">$ ./configure</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> ../../kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line">$ modprobe pf_ring enable_tx_capture=0 min_num_slots=65536</span><br></pre></td></tr></table></figure>

<p><strong><em>Load pf_ring at boot</em></strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'pf_ring'</span> &gt;&gt; /etc/modules</span><br><span class="line">$ sudo reboot</span><br><span class="line"></span><br><span class="line">root@ubuntu:~<span class="comment"># lsmod | grep pf_ring</span></span><br><span class="line">pf_ring              1245184  0</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="GeoLocation"><a href="#GeoLocation" class="headerlink" title="GeoLocation"></a>GeoLocation</h5><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><strong><a href="https://docs.zeek.org/en/stable/frameworks/geoip.html#geolocation" target="_blank" rel="noopener">Installing LibgeoIP</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install libmaxminddb-dev</span><br><span class="line">$ wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz</span><br><span class="line">$ tar zxf GeoLite2-City.tar.gz</span><br><span class="line">$ mkdir -p /usr/share/GeoIP</span><br><span class="line">$ mv GeoLite2-City_20190702/GeoLite2-City.mmdb /usr/share/GeoIP/</span><br></pre></td></tr></table></figure>

<p><strong>Testing</strong></p>
<p><em>å¦‚æœæœªæ‰¾åˆ°ä»»ä½•å†…å®¹æˆ–æœªè®¾ç½®<code>mmdb_dir</code>ï¼Œåˆ™<code>Zeek</code>æŒ‰ä»¥ä¸‹é¡ºåºæŸ¥æ‰¾ä½ç½®æ•°æ®åº“æ–‡ä»¶ï¼š</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ zeek -e <span class="string">"print lookup_location(8.8.8.8);"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>/usr/share/GeoIP/GeoLite2-City.mmdb</li>
<li>/var/lib/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/local/share/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/local/var/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/share/GeoIP/GeoLite2-Country.mmdb</li>
<li>/var/lib/GeoIP/GeoLite2-Country.mmdb</li>
<li>/usr/local/share/GeoIP/GeoLite2-Country.mmdb</li>
<li>/usr/local/var/GeoIP/GeoLite2-Country.mmdb</li>
</ul>
<p><em>å¦‚æœå‡ºç° â€œZeek was not configured for GeoIP supportâ€, æºç å®‰è£…æ—¶éœ€è¦æŒ‡å®š<code>./configure --with-geoip=/usr/share/GeoIP</code></em></p>
<hr>
<h5 id="Gperftools"><a href="#Gperftools" class="headerlink" title="Gperftools"></a>Gperftools</h5><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><strong><a href="http://pkxpp.github.io/2017/03/30/gperftools%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">Installing Gperftools</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/gperftools/gperftools.git</span><br><span class="line">$ sudo apt-get install libunwind-dev autoconf automake libtool</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="IPsumdump"><a href="#IPsumdump" class="headerlink" title="IPsumdump"></a>IPsumdump</h5><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><a href="http://www.read.seas.harvard.edu/~kohler/ipsumdump/" target="_blank" rel="noopener"><strong>Installing IPsumdump</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -O http://www.read.seas.harvard.edu/~kohler/ipsumdump/ipsumdump-1.86.tar.gz</span><br><span class="line">$ tar -xzf ipsumdump-1.86.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> ipsumdump-1.86</span><br><span class="line">$ ./configure --prefix=/usr/</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line">$ sudo make clean</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="Krb5"><a href="#Krb5" class="headerlink" title="Krb5"></a>Krb5</h5><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><strong><a href="http://computing.help.inf.ed.ac.uk/kerberos-ubuntu" target="_blank" rel="noopener">Installing Krb5</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install krb5-user</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="Jemalloc"><a href="#Jemalloc" class="headerlink" title="Jemalloc"></a>Jemalloc</h5><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><a href="https://blog.csdn.net/u013224233/article/details/87930772" target="_blank" rel="noopener"><strong>Installing Jemalloc</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/jemalloc/jemalloc.git</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ make -j2</span><br><span class="line">$ sudo make install</span><br><span class="line">$ sudo ldconfig</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="Zeek"><a href="#Zeek" class="headerlink" title="Zeek"></a>Zeek</h4><p><strong>Required Dependencies</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install cmake make gcc g++ flex bison libpcap-dev libssl-dev python-dev swig zlib1g-dev</span><br></pre></td></tr></table></figure>

<p><em>If your system uses Python 2.7, then you will also need to install the <code>python-ipaddres</code> package.</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install python-ipaddress</span><br></pre></td></tr></table></figure>

<p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><strong><a href="https://docs.zeek.org/en/stable/install/install.html" target="_blank" rel="noopener">Installing Zeek</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> --recursive https://github.com/zeek/zeek</span><br><span class="line">$ ./configure --with-pcap=/usr/<span class="built_in">local</span> --with-geoip=/usr/share/GeoIP --<span class="built_in">enable</span>-jemalloc --<span class="built_in">enable</span>-perftools</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong><em>ç¡®ä¿<code>Zeek</code>æ­£ç¡®é“¾æ¥åˆ°æ‰€éœ€çš„<code>libpcap</code>åº“:</em></strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldd /usr/<span class="built_in">local</span>/zeek/bin/zeek | grep pcap</span><br><span class="line">	libpcap.so.1 =&gt; /usr/<span class="built_in">local</span>/lib/libpcap.so.1 (0x00007fd5b3cfc000)</span><br></pre></td></tr></table></figure>

<h5 id="Add-PATH"><a href="#Add-PATH" class="headerlink" title="Add PATH"></a><strong>Add PATH</strong></h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/zeek/bin:<span class="variable">$PATH</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br><span class="line"></span><br><span class="line">$ sudo vim ~/.bashrc</span><br><span class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/zeek/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<hr>
<h5 id="Using-PF-RING"><a href="#Using-PF-RING" class="headerlink" title="Using PF_RING"></a><strong>Using PF_RING</strong></h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /usr/<span class="built_in">local</span>/zeek/etc/node.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example ZeekControl node configuration.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This example has a standalone node ready to go except for possibly changing</span></span><br><span class="line"><span class="comment"># the sniffing interface.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is a complete standalone configuration.  Most likely you will</span></span><br><span class="line"><span class="comment"># only need to change the interface.</span></span><br><span class="line"><span class="comment"># [zeek]</span></span><br><span class="line"><span class="comment"># type=standalone</span></span><br><span class="line"><span class="comment"># host=localhost</span></span><br><span class="line"><span class="comment"># interface=ens33</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Below is an example clustered configuration. If you use this,</span></span><br><span class="line"><span class="comment">## remove the [zeek] node above.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[logger]</span></span><br><span class="line"><span class="comment">#type=logger</span></span><br><span class="line"><span class="comment">#host=localhost</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[manager]</span><br><span class="line"><span class="built_in">type</span>=manager</span><br><span class="line">host=localhost</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[proxy-1]</span><br><span class="line"><span class="built_in">type</span>=proxy</span><br><span class="line">host=localhost</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[worker-1]</span><br><span class="line"><span class="built_in">type</span>=worker</span><br><span class="line">host=localhost</span><br><span class="line">interface=ens33</span><br><span class="line">lb_method=pf_ring</span><br><span class="line">lb_procs=35</span><br><span class="line">pin_cpus=0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#[worker-2]</span></span><br><span class="line"><span class="comment">#type=worker</span></span><br><span class="line"><span class="comment">#host=localhost</span></span><br><span class="line"><span class="comment">#interface=eth0</span></span><br></pre></td></tr></table></figure>

<h5 id="Enable-Json"><a href="#Enable-Json" class="headerlink" title="Enable Json"></a>Enable Json</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /usr/<span class="built_in">local</span>/zeek/share/zeek/site/local.zeek</span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to enable logging of link-layer addresses. Enabling</span></span><br><span class="line"><span class="comment"># this adds the link-layer address for each connection endpoint to the conn.log file.</span></span><br><span class="line"><span class="comment"># @load policy/protocols/conn/mac-logging</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">@load policy/tuning/json-logs.zeek</span><br></pre></td></tr></table></figure>

<h4 id="å‹æµ‹"><a href="#å‹æµ‹" class="headerlink" title="å‹æµ‹"></a>å‹æµ‹</h4><ol>
<li><h5 id="æŸ¥çœ‹æ˜¯å¦ä¸¢åŒ…"><a href="#æŸ¥çœ‹æ˜¯å¦ä¸¢åŒ…" class="headerlink" title="æŸ¥çœ‹æ˜¯å¦ä¸¢åŒ…"></a><strong>æŸ¥çœ‹æ˜¯å¦ä¸¢åŒ…</strong></h5></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ zeekctl netstats; date</span><br><span class="line"> worker-1-1: 1585999488.317958 recvd=18 dropped=0 link=18</span><br><span class="line"> worker-1-2: 1585999488.335990 recvd=0 dropped=0 link=0</span><br><span class="line"> worker-1-3: 1585999488.345568 recvd=2 dropped=0 link=2</span><br><span class="line">Sat Apr  4 04:24:48 PDT 2020</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><h5 id="æŸ¥çœ‹èµ„æºå ç”¨"><a href="#æŸ¥çœ‹èµ„æºå ç”¨" class="headerlink" title="æŸ¥çœ‹èµ„æºå ç”¨"></a><strong>æŸ¥çœ‹èµ„æºå ç”¨</strong></h5></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ zeekctl top; date</span><br><span class="line">Name         Type    Host             Pid     VSize  Rss  Cpu   Cmd</span><br><span class="line">manager      manager localhost        4818      1G    87M   0%  zeek</span><br><span class="line">proxy-1      proxy   localhost        4870    649M    85M   0%  zeek</span><br><span class="line">worker-1-1   worker  localhost        4948    655M    92M   0%  zeek</span><br><span class="line">worker-1-2   worker  localhost        4952    655M    92M   0%  zeek</span><br><span class="line">worker-1-3   worker  localhost        4954    655M    92M   0%  zeek</span><br><span class="line">Sat Apr  4 04:24:52 PDT 2020</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><h5 id="æŸ¥çœ‹æµé‡å¤§å°-10ç§’"><a href="#æŸ¥çœ‹æµé‡å¤§å°-10ç§’" class="headerlink" title="æŸ¥çœ‹æµé‡å¤§å°(10ç§’)"></a><strong>æŸ¥çœ‹æµé‡å¤§å°(10ç§’)</strong></h5></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ zeekctl capstats; date</span><br><span class="line">Interface             kpps       mbps       (10s average)</span><br><span class="line">----------------------------------------</span><br><span class="line">localhost/ens5        37.8       375.2</span><br><span class="line">Fri Aug 16 16:12:47 UTC 2019</span><br></pre></td></tr></table></figure>

<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><a href="https://holdmybeersecurity.com/2019/04/03/part-1-install-setup-zeek-pf_ring-on-ubuntu-18-04-on-proxmox-5-3-openvswitch/" target="_blank" rel="noopener"><strong>PART 1: INSTALL/SETUP ZEEK + PF_RING ON UBUNTU 18.04 ON PROXMOX 5.3 + OPENVSWITCH</strong></a></li>
</ul>
]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Zeek</tag>
      </tags>
  </entry>
  <entry>
    <title>æˆ‘åœ¨'äº‘'ä¸Šçš„æ—¥å­ - Suricata(éƒ¨ç½²)</title>
    <url>/2019/10/14/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90%20-%20Suricata%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><h2 id="PF-RING"><a href="#PF-RING" class="headerlink" title="PF_RING"></a>PF_RING</h2><p><strong>1. pf_ring</strong></p>
<ul>
<li><strong>äºŒè¿›åˆ¶å®‰è£…</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 18.04 LTS</span></span><br><span class="line">$ apt-get install software-properties-common wget</span><br><span class="line">$ add-apt-repository universe [ unless you have <span class="keyword">done</span> it previously ]</span><br><span class="line">$ wget http://apt-stable.ntop.org/18.04/all/apt-ntop-stable.deb</span><br><span class="line">$ apt install ./apt-ntop-stable.deb</span><br><span class="line"></span><br><span class="line">$ apt-get clean all</span><br><span class="line">$ apt-get update</span><br><span class="line">$ apt-get install pfring</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>ç¼–è¯‘å®‰è£…</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¾èµ–</span></span><br><span class="line">$ apt install git make gcc libelf-dev build-essential subversion flex libnuma-dev bison pkg-config libtool rustc cargo libjansson-dev ethtool autoconf autogen liblzma-dev libpcre3-dev libyaml-dev libpcap-dev zlib1g-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/ntop/PF_RING.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ pf_ring.ko</span></span><br><span class="line">$ sudo insmod pf_ring.ko min_num_slots=65536 transparent_mode=2 enable_tx_capture=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ pf_ring ä¿¡æ¯</span></span><br><span class="line">$ cat /proc/net/pf_ring/info</span><br><span class="line">PF_RING Version          : 7.5.0 (dev:14f62e0edb2b54cd614ab9d1f6467ccb8c6c9c32)</span><br><span class="line">Total rings              : 0</span><br><span class="line"></span><br><span class="line">Standard (non ZC) Options</span><br><span class="line">Ring slots               : 65536</span><br><span class="line">Slot version             : 17</span><br><span class="line">Capture TX               : No [RX only]</span><br><span class="line">IP Defragment            : No</span><br><span class="line">Socket Mode              : Standard</span><br><span class="line">Cluster Fragment Queue   : 0</span><br><span class="line">Cluster Fragment Discard : 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸è½½ pf_ring.ko</span></span><br><span class="line">$ sudo rmmod pf_ring</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>2. libpfringã€libpcap</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> PF_RING/userland/lib</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure &amp;&amp; make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ../libpcap</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure &amp;&amp; make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> éªŒè¯</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> PF_RING/userland/examples</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¥æ”¶æ•°æ®åŒ…</span></span><br><span class="line">root@ubuntu:/opt/PF_RING/userland/examples# ./pfcount -i ens33</span><br><span class="line">Using PF_RING v.7.5.0</span><br><span class="line">Capturing from ens33 [mac: 00:0C:29:D5:B9:8F][if_index: 2][speed: 0Mb/s]</span><br><span class="line"><span class="meta">#</span><span class="bash"> Device RX channels: 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Polling threads:    1</span></span><br><span class="line">Dumping statistics on /proc/net/pf_ring/stats/51441-ens33.3</span><br><span class="line">=========================</span><br><span class="line">Absolute Stats: [2 pkts total][0 pkts dropped][0.0% dropped]</span><br><span class="line">[2 pkts rcvd][424 bytes rcvd]</span><br><span class="line">=========================</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å‘é€æ•°æ®åŒ…</span></span><br><span class="line">root@ubuntu:/opt/PF_RING/userland/examples# sudo ./pfsend -f 64byte_packets.pcap -n 0 -i ens33 -r 5</span><br><span class="line">Sending packets on ens33</span><br><span class="line">Using PF_RING v.7.5.0</span><br><span class="line">Estimated CPU freq: 2429795000 Hz</span><br><span class="line">Unable to open file 64byte_packets.pcap</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>3. tcpdump</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/userland/tcpdump/</span><br><span class="line">$ ./configure &amp;&amp; make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><p><strong><a href="https://www.ntop.org/guides/pf_ring/get_started/git_installation.html" target="_blank" rel="noopener">PF_RING</a></strong></p>
</li>
<li><p><a href="http://packages.ntop.org/apt-stable/" target="_blank" rel="noopener">http://packages.ntop.org/apt-stable/</a></p>
</li>
<li><p><a href="https://www.ntop.org/guides/pf_ring/get_started/packages_installation.html" target="_blank" rel="noopener">https://www.ntop.org/guides/pf_ring/get_started/packages_installation.html</a></p>
</li>
<li><p><a href="https://www.ntop.org/guides/pf_ring/thirdparty/suricata.html" target="_blank" rel="noopener">https://www.ntop.org/guides/pf_ring/thirdparty/suricata.html</a></p>
</li>
</ul>
<h2 id="LuaJIT"><a href="#LuaJIT" class="headerlink" title="LuaJIT"></a>LuaJIT</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget http://luajit.org/download/LuaJIT-2.0.5.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -zxf LuaJIT-2.0.5.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> LuaJIT-2.0.5/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make &amp;&amp; make install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> éªŒè¯</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig -p | grep lua</span></span><br><span class="line">	liblua5.1.so.0 (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1.so.0</span><br><span class="line">	liblua5.1.so (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1.so</span><br><span class="line">	liblua5.1-c++.so.0 (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1-c++.so.0</span><br><span class="line">	liblua5.1-c++.so (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1-c++.so</span><br></pre></td></tr></table></figure>

<h2 id="Hyperscan"><a href="#Hyperscan" class="headerlink" title="Hyperscan"></a>Hyperscan</h2><p><strong>1. boost</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä¾èµ–</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> apt install cmake</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸‹è½½</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://dl.bintray.com/boostorg/release/1.69.0/<span class="built_in">source</span>/boost_1_69_0.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -xvf boost_1_69_0.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> boost_1_69_0/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./bootstrap.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ./b2 --with-iostreams --with-random install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig</span></span><br></pre></td></tr></table></figure>

<p><strong>2. ragle</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¾èµ–</span></span><br><span class="line">$ sudo apt-get install autoconf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½</span></span><br><span class="line">$ wget http://www.colm.net/files/ragel/ragel-6.10.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">$ tar zxvf ragel-6.10.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> ragel-6.10</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>

<p><strong>3. hyperscan</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¾èµ–</span></span><br><span class="line">$ sudo apt install libpcap-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½</span></span><br><span class="line">$ wget https://github.com/intel/hyperscan/archive/v5.1.0.tar.gz -O hyperscan-5.1.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">$ tar -zxvf hyperscan-5.1.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> hyperscan-5.1.0</span><br><span class="line">$ mkdir cmake-build</span><br><span class="line">$ <span class="built_in">cd</span> cmake-build</span><br><span class="line">$ cmake -DBUILD_SHARED_LIBS=on -DCMAKE_BUILD_TYPE=Release ..</span><br><span class="line">$ make -j8</span><br><span class="line">$ sudo make install</span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>

<p><strong>4. éªŒè¯</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ldconfig -p | grep hs</span></span><br><span class="line">	libhs_runtime.so.5 (libc6,x86-64) =&gt; /usr/local/lib/libhs_runtime.so.5</span><br><span class="line">	libhs_runtime.so (libc6,x86-64) =&gt; /usr/local/lib/libhs_runtime.so</span><br><span class="line">	libhs.so.5 (libc6,x86-64) =&gt; /usr/local/lib/libhs.so.5</span><br><span class="line">	libhs.so (libc6,x86-64) =&gt; /usr/local/lib/libhs.so</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><a href="http://www.manongjc.com/article/110977.html" target="_blank" rel="noopener"><strong>Hyperscan - 5.1.0 å®‰è£…</strong></a></li>
</ul>
<h2 id="Suricata"><a href="#Suricata" class="headerlink" title="Suricata"></a><strong>Suricata</strong></h2><h3 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> apt-get install libpcre3 libpcre3-dbg libpcre3-dev build-essential libpcap-dev   \</span></span><br><span class="line">                libnet1-dev libyaml-0-2 libyaml-dev pkg-config zlib1g zlib1g-dev \</span><br><span class="line">                libcap-ng-dev libcap-ng0 make libmagic-dev libjansson-dev        \</span><br><span class="line">                libnss3-dev libgeoip-dev libhiredis-dev libevent-dev \</span><br><span class="line">                python-yaml rustc cargo libmaxminddb-dev liblzma-dev \</span><br><span class="line">                python3-distutils liblz4-dev</span><br></pre></td></tr></table></figure>

<h3 id="å®‰è£…æ–¹å¼-2é€‰1"><a href="#å®‰è£…æ–¹å¼-2é€‰1" class="headerlink" title="å®‰è£…æ–¹å¼: 2é€‰1"></a>å®‰è£…æ–¹å¼: 2é€‰1</h3><h4 id="release"><a href="#release" class="headerlink" title="release"></a>release</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget https://www.openinfosecfoundation.org/download/suricata-5.0.2.tar.gz</span><br><span class="line">$ tar zxvf suricata-5.0.2.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> suricata</span><br><span class="line">$ ./configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var --<span class="built_in">enable</span>-pfring --with-libpfring-includes=/usr/<span class="built_in">local</span>/include --with-libpfring-libraries=/usr/<span class="built_in">local</span>/lib --<span class="built_in">enable</span>-geoip  --<span class="built_in">enable</span>-luajit --with-libluajit-includes=/usr/<span class="built_in">local</span>/include/luajit-2.0/ --with-libluajit-libraries=/usr/<span class="built_in">local</span>/lib/ --with-libhs-includes=/usr/<span class="built_in">local</span>/include/hs/ --with-libhs-libraries=/usr/<span class="built_in">local</span>/lib/</span><br><span class="line">$ make &amp;&amp; make install-full</span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>

<h4 id="git-clone"><a href="#git-clone" class="headerlink" title="git clone"></a>git clone</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir suricata</span><br><span class="line">$ <span class="built_in">cd</span> suricata</span><br><span class="line">$ git <span class="built_in">clone</span> git://phalanx.openinfosecfoundation.org/oisf.git</span><br><span class="line">$ <span class="built_in">cd</span> oisf</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/OISF/libhtp.git</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ ./configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var --<span class="built_in">enable</span>-pfring --with-libpfring-includes=/usr/<span class="built_in">local</span>/include --with-libpfring-libraries=/usr/<span class="built_in">local</span>/lib --<span class="built_in">enable</span>-geoip  --<span class="built_in">enable</span>-luajit --with-libluajit-includes=/usr/<span class="built_in">local</span>/include/luajit-2.0/ --with-libluajit-libraries=/usr/<span class="built_in">local</span>/lib/ --with-libhs-includes=/usr/<span class="built_in">local</span>/include/hs/ --with-libhs-libraries=/usr/<span class="built_in">local</span>/lib/</span><br><span class="line">$ make &amp;&amp; make install-full</span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>

<h1 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h1><p><strong>1. PF_RING</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep PF_RING</span></span><br><span class="line">Features: PCAP_SET_BUFF PF_RING AF_PACKET HAVE_PACKET_FANOUT LIBCAP_NG LIBNET1.1 HAVE_HTP_URI_NORMALIZE_HOOK PCRE_JIT HAVE_NSS HAVE_LUA HAVE_LUAJIT HAVE_LIBJANSSON PROFILING TLS MAGIC RUST</span><br><span class="line">  PF_RING support:                         yes</span><br></pre></td></tr></table></figure>

<p><strong>2. LuaJit</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep lua</span></span><br><span class="line">  LUA support:                             yes, through luajit</span><br><span class="line">  libluajit:                               yes</span><br></pre></td></tr></table></figure>

<p><strong>3. Hyperscan</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep Hyperscan</span></span><br><span class="line">  Hyperscan support:                       yes</span><br></pre></td></tr></table></figure>

<h1 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a><strong>å¯åŠ¨</strong></h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --pfring-int=ens6 --pfring-cluster-id=99 --pfring-cluster-type=cluster_flow -c /etc/suricata/suricata.yaml</span></span><br></pre></td></tr></table></figure>

<h1 id="è§„åˆ™ç®¡ç†"><a href="#è§„åˆ™ç®¡ç†" class="headerlink" title="è§„åˆ™ç®¡ç†"></a>è§„åˆ™ç®¡ç†</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install --upgrade suricata-update</span><br></pre></td></tr></table></figure>

<p><strong>å®šæ—¶æ›´æ–°</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> crontab -l</span></span><br><span class="line">10 0 * * * /usr/bin/suricata-update --no-test &amp;&amp; /usr/bin/suricatasc -c reload-rules</span><br></pre></td></tr></table></figure>

<h1 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h1><p><a href="https://www.jianshu.com/p/9348e211a6a2" target="_blank" rel="noopener">https://www.jianshu.com/p/9348e211a6a2</a></p>
]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>Scrapy + Splash å®ç°åŠ¨æ€ç½‘é¡µçˆ¬å–</title>
    <url>/2019/10/08/Scrapy%20+%20Splash%20%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E7%BD%91%E9%A1%B5%E7%88%AC%E5%8F%96/</url>
    <content><![CDATA[<h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><p>â€‹        è¿™æ˜¯ä¸€ä¸ªæ’åº“äº‹ä»¶çš„åç»­, é€šè¿‡ä¹‹å‰ç¼–å†™çš„è„šæœ¬<strong>Suricata - login_audit</strong>è„šæœ¬æˆåŠŸå®¡è®¡åˆ°äº†æ‰€æœ‰ç™»å½•ç½‘ç«™çš„è´¦å·ã€‚è¿™é‡Œéœ€è¦å¯¹ç»è¿‡åˆ†æåå­˜åœ¨å¯ç–‘è¡Œä¸ºçš„è´¦å·è¿›è¡Œåå‘æŸ¥è¯¢, ä¸»è¦åˆ¤æ–­è¯¥è´¦å·æ˜¯å¦å·²è¢«æ ‡è®°ä¸ºæ³„éœ²è´¦å·ã€‚</p>
<h2 id="å‘ç‚¹"><a href="#å‘ç‚¹" class="headerlink" title="å‘ç‚¹"></a>å‘ç‚¹</h2><p>â€‹        ç”±äº<strong>Scrapy</strong>æ²¡æœ‰<strong>JS Eengine</strong>åªèƒ½çˆ¬å–é™æ€é¡µé¢çš„, å¯¹äºJSç”Ÿæˆçš„åŠ¨æ€é¡µé¢æ˜¯ä¸æ”¯æŒçš„ã€‚ä½†æ˜¯å¯ä»¥å€ŸåŠ©<a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener"><strong>Scrapy-Splash</strong></a>æ¥å®ç°åŠ¨æ€é¡µé¢çš„çˆ¬å–ã€‚</p>
<h1 id="éƒ¨ç½²æ–¹æ³•"><a href="#éƒ¨ç½²æ–¹æ³•" class="headerlink" title="éƒ¨ç½²æ–¹æ³•"></a>éƒ¨ç½²æ–¹æ³•</h1><h2 id="1-Scrapy-Splash"><a href="#1-Scrapy-Splash" class="headerlink" title="1. Scrapy-Splash"></a>1. Scrapy-Splash</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install scrapy-splash --user</span><br></pre></td></tr></table></figure>

<h2 id="2-Splash-Instance"><a href="#2-Splash-Instance" class="headerlink" title="2. Splash Instance"></a>2. Splash Instance</h2><p>ç”±äº<strong>Scrapy-Splash</strong>ä½¿ç”¨çš„æ˜¯<strong>Splash HTTP API</strong>ï¼Œ æ‰€ä»¥éœ€è¦ä¸€ä¸ª<strong><a href="https://splash.readthedocs.io/en/stable/install.html" target="_blank" rel="noopener">Splash Instance</a></strong>ï¼Œä¸€èˆ¬é‡‡ç”¨<strong><a href="https://hub.docker.com/r/scrapinghub/splash" target="_blank" rel="noopener">Docker</a></strong>è¿è¡Œ<strong>Splash</strong>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ more docker-compose.yml</span><br><span class="line">version: <span class="string">"2.0"</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  splash:</span><br><span class="line">    restart: always</span><br><span class="line">    image: scrapinghub/splash</span><br><span class="line">    tty: <span class="literal">true</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8050:8050"</span></span><br><span class="line">    network_mode: <span class="string">"bridge"</span></span><br><span class="line">    container_name: <span class="string">"Splash"</span></span><br><span class="line">    hostname: <span class="string">"Splash"</span></span><br></pre></td></tr></table></figure>

<h2 id="3-é…ç½®SplashæœåŠ¡ï¼ˆä»¥ä¸‹æ“ä½œå…¨éƒ¨åœ¨settings-pyï¼‰"><a href="#3-é…ç½®SplashæœåŠ¡ï¼ˆä»¥ä¸‹æ“ä½œå…¨éƒ¨åœ¨settings-pyï¼‰" class="headerlink" title="3. é…ç½®SplashæœåŠ¡ï¼ˆä»¥ä¸‹æ“ä½œå…¨éƒ¨åœ¨settings.pyï¼‰"></a>3. é…ç½®<a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener"><strong>Splash</strong></a>æœåŠ¡ï¼ˆä»¥ä¸‹æ“ä½œå…¨éƒ¨åœ¨<strong>settings.py</strong>ï¼‰</h2><p><strong>3.1    æ·»åŠ SplashæœåŠ¡å™¨åœ°å€</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SPLASH_URL = <span class="string">'http://localhost:8050'</span></span><br></pre></td></tr></table></figure>

<p><strong>3.2    å¯ç”¨Splash middleware</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line">    <span class="string">'scrapy_splash.SplashCookiesMiddleware'</span>: 723,</span><br><span class="line">    <span class="string">'scrapy_splash.SplashMiddleware'</span>: 725,</span><br><span class="line">    <span class="string">'scrapy.downloadermiddlewares.httpcompression.HttpCompressionMiddleware'</span>: 810,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>Order 723 is just before HttpProxyMiddleware (750) in default scrapy settings.</em></p>
<p><strong>3.3    å¯ç”¨SplashDeduplicateArgsMiddleware</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SPIDER_MIDDLEWARES = &#123;</span><br><span class="line">    <span class="string">'scrapy_splash.SplashDeduplicateArgsMiddleware'</span>: 100,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.4  è‡ªå®šä¹‰ DUPEFILTER_CLASS</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DUPEFILTER_CLASS = <span class="string">'scrapy_splash.SplashAwareDupeFilter'</span></span><br></pre></td></tr></table></figure>

<p><strong>3.5 ä½¿ç”¨Scrapy HTTPç¼“å­˜</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HTTPCACHE_STORAGE = <span class="string">'scrapy_splash.SplashAwareFSCacheStorage'</span></span><br></pre></td></tr></table></figure>

<h2 id="4-ä»£ç "><a href="#4-ä»£ç " class="headerlink" title="4. ä»£ç "></a>4. ä»£ç </h2><p>æ³¨:  å½“ä½¿ç”¨<strong>Scrapy-Splash</strong>ä¹‹å, å°†æ— æ³•ç›´æ¥ä½¿ç”¨<strong>crawlera middleware</strong>ã€‚éœ€è¦æ‰‹åŠ¨å¼•ç”¨å¤–éƒ¨luaè„šæœ¬ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> haveibeenpwned.items <span class="keyword">import</span> feed</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> scrapy_splash <span class="keyword">import</span> SplashRequest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">from redis crawl haveibeenpwned</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">LUA_SOURCE = <span class="string">"""</span></span><br><span class="line"><span class="string">    function main(splash)</span></span><br><span class="line"><span class="string">        local host = "proxy.crawlera.com"</span></span><br><span class="line"><span class="string">        local port = 8010</span></span><br><span class="line"><span class="string">        local user = "api_key"</span></span><br><span class="line"><span class="string">        local password = ""</span></span><br><span class="line"><span class="string">        local session_header = "X-Crawlera-Session"</span></span><br><span class="line"><span class="string">        local session_id = "create"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:on_request(function (request)</span></span><br><span class="line"><span class="string">            request:set_header("X-Crawlera-UA", "desktop")</span></span><br><span class="line"><span class="string">            request:set_header(session_header, session_id)</span></span><br><span class="line"><span class="string">            request:set_proxy&#123;host, port, username=user, password=password&#125;</span></span><br><span class="line"><span class="string">        end)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:on_response_headers(function (response)</span></span><br><span class="line"><span class="string">            if response.headers[session_header] ~= nil then</span></span><br><span class="line"><span class="string">                session_id = response.headers[session_header]</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">        end)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:go(splash.args.url)</span></span><br><span class="line"><span class="string">        return splash:html()</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CheckSpider</span><span class="params">(scrapy.Spider)</span>:</span></span><br><span class="line">    name = <span class="string">'scrapy_demo'</span></span><br><span class="line">    start_urls = <span class="string">'https://httpbin.org/get'</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> SplashRequest(self.start_urls, self.parse, endpoint=<span class="string">'execute'</span>,  args=&#123;<span class="string">'wait'</span>: <span class="number">3</span>, <span class="string">'lua_source'</span>: LUA_SOURCE&#125;)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        print(response.text)</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒ:</p>
<ul>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash/issues/117" target="_blank" rel="noopener">https://github.com/scrapy-plugins/scrapy-splash/issues/117</a></li>
</ul>
<p>å‚è€ƒ:</p>
<ul>
<li><a href="https://splash.readthedocs.io/en/stable/search.html?q=splash%3Ahtml&check_keywords=yes&area=default" target="_blank" rel="noopener">Splash</a></li>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener">Scrapy-Splash</a></li>
<li><a href="https://doc.scrapinghub.com/crawlera.html#using-crawlera-with-splash" target="_blank" rel="noopener">Scrapinghub API Reference</a></li>
<li><a href="https://stackoverflow.com/questions/43646438/using-proxy-with-scrapy-splash" target="_blank" rel="noopener">using proxy with scrapy-splash</a></li>
<li><a href="http://stackoverflow.com/questions/43090352/proxy-servers-with-scrapy-splash" target="_blank" rel="noopener"><strong>Proxy servers with Scrapy-Splash</strong></a></li>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash/issues/97" target="_blank" rel="noopener">Crawlera integration</a></li>
<li><a href="https://blog.csdn.net/zhengxiangwen/article/details/55227368" target="_blank" rel="noopener"><strong>åˆ©ç”¨scrapy-splashçˆ¬å–JSç”Ÿæˆçš„åŠ¨æ€é¡µé¢</strong></a></li>
</ul>
]]></content>
      <categories>
        <category>Spider</category>
      </categories>
      <tags>
        <tag>Scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2019/10/04/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
  </entry>
</search>
