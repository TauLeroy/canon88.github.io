<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Wazuh - å¦‚ä½•å¯¹å¼‚æ„æ•°æ®è¿›è¡Œå…³è”å‘Šè­¦</title>
    <url>/2020/02/25/Wazuh-%E5%A6%82%E4%BD%95%E5%AF%B9%E5%BC%82%E6%9E%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%E5%91%8A%E8%AD%A6/</url>
    <content><![CDATA[<p><strong>å†™åœ¨å‰é¢</strong></p>
<p>â€‹       è¿™å¹¶ä¸æ˜¯ä»€ä¹ˆ<strong>é«˜ç²¾å°–</strong>çš„æ¶æ„ä¸æŠ€æœ¯ã€‚è¿™åªæ˜¯æˆ‘ä¸ªäººåœ¨å·¥ä½œä¸­ç»“åˆç›®å‰æ‰‹å¤´çš„èµ„æºè¿›è¡Œäº†ä¸€äº›<strong>æ•´åˆ</strong> ã€‚å½“ç„¶å®ç°è¿™äº›éœ€æ±‚çš„æ–¹æ³•æœ‰å¾ˆå¤š, æœ‰é’±çš„å¯ä»¥è€ƒè™‘Splunk, æ²¡é’±çš„æœ‰ç ”å‘çš„å›¢é˜Ÿçš„å¯ä»¥ä¸ŠFlinkã€Esper ã€‚ </p>
<h4 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h4><p>â€‹    ç”±äºæ”»é˜²å¯¹æŠ—çš„å‡çº§, é€šè¿‡å•ä¸€çš„æ•°æ®æºå¾ˆéš¾ç›´æ¥æ–­è¨€æ”»å‡»æ˜¯å¦æˆåŠŸã€‚å› æ­¤, æˆ‘ä»¬éœ€è¦ç»“åˆå¤šä¸ªæ•°æ®æºè¿›è¡Œå®‰å…¨äº‹ä»¶çš„å…³è”, ä»ä¸­æç‚¼å‡ºå¯é æ€§è¾ƒé«˜çš„å®‰å…¨å‘Šè­¦è¿›è¡Œäººå·¥æ’æŸ¥ã€‚ä¾‹å¦‚: é’ˆå¯¹WebShellä¸Šä¼ ç±»çš„, å¯ä»¥é€šè¿‡<strong>ç½‘ç»œæµé‡ + ç»ˆç«¯</strong>è¿›è¡Œå…³è”; é’ˆå¯¹Webæ”»å‡»ç±», å¯ä»¥é€šè¿‡<strong>WAF + NIDS</strong>çš„äº‹ä»¶å…³è”, å¾—åˆ°Bypass WAF çš„å®‰å…¨å‘Šè­¦ã€‚</p>
<h4 id="è§£å†³æ€è·¯"><a href="#è§£å†³æ€è·¯" class="headerlink" title="è§£å†³æ€è·¯"></a>è§£å†³æ€è·¯</h4><p>â€‹    è™½ç„¶Wazuhæœ¬èº«å…·å¤‡å®‰å…¨äº‹ä»¶çš„å…³è”èƒ½åŠ›, ä½†åœ¨ä¼ ç»Ÿçš„éƒ¨ç½²æ¶æ„ä¸­, é€šå¸¸æ˜¯ç”±Wazuh Agentå°†å®‰å…¨äº‹ä»¶å‘é€åˆ°Wazuh Manager,é€šè¿‡Managerè¿›è¡Œå®‰å…¨äº‹ä»¶çš„å…³è”å‘Šè­¦ã€‚ç”±äºç¼ºå°‘äº†å¯¹æ•°æ®è¿›è¡ŒETL, ä½¿å¾—Wazuh Managerå¾ˆéš¾å¯¹å¼‚æ„æ•°æ®è¿›è¡Œå…³è”ã€‚å› æ­¤, æˆ‘ä»¬éœ€è¦é€šè¿‡Logstashå®ç°å¯¹æ•°æ®çš„æ ‡å‡†åŒ–, å¹¶å°†æ ‡å‡†åŒ–åçš„æ•°æ®é€šè¿‡Syslogçš„å½¢å¼å‘é€åˆ°Wazuh Manager, ä»è€Œè¿›è¡Œå¼‚æ„æ•°æ®çš„å…³è”ã€‚</p>
<h5 id="å‘ç‚¹"><a href="#å‘ç‚¹" class="headerlink" title="å‘ç‚¹"></a>å‘ç‚¹</h5><ol>
<li>æœ¬æ¬¡æ”¹é€ é‡‡ç”¨äº†<strong>Syslog</strong>çš„å½¢å¼å°†æ•°æ®å‘é€åˆ°Wazuh Managerç«¯è¿›è¡Œæ•°æ®å…³è”ã€‚ç”±äº<strong>Syslog</strong> é»˜è®¤é‡‡ç”¨äº†<strong>UDP</strong>åè®®è¿›è¡Œæ•°æ®ä¼ è¾“, å½“æ•°æ®å‘é€è¿‡å¤§æ—¶å°†ä¼šå¯¼è‡´<strong>æ•°æ®æˆªæ–­</strong>çš„æŠ¥é”™ã€‚é’ˆå¯¹æ­¤é—®é¢˜, éœ€æ”¹ç”¨<strong>TCP</strong>çš„å½¢å¼è¿›è¡Œæ•°æ®å‘é€è§„é¿æ­¤é—®é¢˜ã€‚</li>
<li>Wazuh Manager éƒ¨åˆ†å‘Šè­¦ç¼ºå°‘â€<strong>å¿…è¦</strong>â€œå…³è”å­—æ®µçš„ç°è±¡ã€‚å¦‚: æœ¬æ¬¡åœºæ™¯ä¸­<code>syscheck</code>å‘Šè­¦äº‹ä»¶, é»˜è®¤ä¸ä¼šæºå¸¦<code>srcip</code>çš„å­—æ®µ, å¯¹äºæ­¤é—®é¢˜å¯ä»¥é€šè¿‡åœ¨Managerä¸Šç¼–å†™ä¸€ä¸ªé¢„å¤„ç†è„šæœ¬æ¥è§£å†³ã€‚</li>
</ol>
<h4 id="æ”¹é€ "><a href="#æ”¹é€ " class="headerlink" title="æ”¹é€ "></a>æ”¹é€ </h4><ol>
<li><h5 id="æ”¹é€ ä¹‹å‰"><a href="#æ”¹é€ ä¹‹å‰" class="headerlink" title="æ”¹é€ ä¹‹å‰:"></a>æ”¹é€ ä¹‹å‰:</h5><p>Suricata (Wazuh agent) â€”(Agent: UDP 1514)â€”&gt; Wazuh Manager</p>
</li>
<li><h5 id="æ”¹é€ ä¹‹å"><a href="#æ”¹é€ ä¹‹å" class="headerlink" title="æ”¹é€ ä¹‹å:"></a>æ”¹é€ ä¹‹å:</h5><p>æ‰€æœ‰çš„æ ‡å‡†åŒ–éƒ½ç”±Logstashæ¥è¿›è¡Œ, Filebeatåªéœ€è¦åšâ€™<strong>æ— è„‘</strong>â€˜è½¬å‘å³å¯ã€‚</p>
</li>
</ol>
<p><strong>workflow:</strong></p>
<p><img src="/2020/02/25/Wazuh-å¦‚ä½•å¯¹å¼‚æ„æ•°æ®è¿›è¡Œå…³è”å‘Šè­¦/image-20200303215020561.png" alt="image-20200303215020561"></p>
<hr>
<h5 id="Filebeaté…ç½®"><a href="#Filebeaté…ç½®" class="headerlink" title="Filebeaté…ç½®"></a>Filebeaté…ç½®</h5><ul>
<li><h6 id="filebeat-yaml"><a href="#filebeat-yaml" class="headerlink" title="filebeat.yaml"></a>filebeat.yaml</h6></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#=========================== Filebeat inputs =============================</span></span><br><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="attr">- type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"/var/log/suricata/alert-*.json"</span></span><br><span class="line"><span class="attr">  fields_under_root:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  fields:</span> <span class="string">&#123;</span> <span class="attr">application:</span> <span class="string">suricata</span> <span class="string">&#125;</span></span><br><span class="line">  <span class="string">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line">  <span class="string">json.overwrite_keys:</span> <span class="literal">true</span></span><br><span class="line">  <span class="string">json.message_key:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  tail_files:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  scan_frequency:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line"><span class="attr">  harvester_buffer_size:</span> <span class="number">104857600</span></span><br><span class="line"><span class="attr">  backoff:</span> <span class="number">1</span><span class="string">s</span></span><br><span class="line"><span class="attr">  max_backoff:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">  close_timeout:</span> <span class="number">30</span><span class="string">m</span></span><br><span class="line"><span class="attr">  close_inactive:</span> <span class="number">10</span><span class="string">m</span></span><br><span class="line"><span class="attr">  clean_inactive:</span> <span class="number">72</span><span class="string">h</span></span><br><span class="line"><span class="attr">  ignore_older:</span> <span class="number">70</span><span class="string">h</span></span><br><span class="line"><span class="attr">  registry_file:</span> <span class="string">/etc/filebeat/registry/wazuh/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Processors ==================================</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line"><span class="attr">- drop_fields:</span></span><br><span class="line"><span class="attr">    fields:</span> <span class="string">["ecs.version",</span> <span class="string">"agent.ephemeral_id"</span><span class="string">,</span> <span class="string">"agent.version"</span><span class="string">,</span> <span class="string">"agent.type"</span><span class="string">,</span> <span class="string">"agent.id"</span><span class="string">,</span> <span class="string">"agent.ephemeral_id"</span><span class="string">,</span> <span class="string">"input.type"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Outputs =====================================</span></span><br><span class="line"><span class="string">output.logstash:</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">["logstash:5010"]</span></span><br><span class="line"><span class="attr">  loadbalance:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  worker:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">  compression_level:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  bulk_max_size:</span> <span class="number">4096</span></span><br></pre></td></tr></table></figure>

<hr>
<h5 id="Logstashé…ç½®"><a href="#Logstashé…ç½®" class="headerlink" title="Logstashé…ç½®"></a>Logstashé…ç½®</h5><ul>
<li><h6 id="00-input-conf"><a href="#00-input-conf" class="headerlink" title="00_input.conf"></a>00_input.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5010</span><br><span class="line">    codec =&gt; <span class="string">"json_lines"</span></span><br><span class="line">    tags =&gt; [<span class="string">"beats"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="50-suricata-conf"><a href="#50-suricata-conf" class="headerlink" title="50_suricata.conf"></a>50_suricata.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  <span class="keyword">if</span> [application] == <span class="string">"suricata"</span> &#123;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [ <span class="string">"timestamp"</span>, <span class="string">"ISO8601"</span> ]</span><br><span class="line">      target =&gt; <span class="string">"timestamp"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="mapping-json"><a href="#mapping-json" class="headerlink" title="mapping.json"></a>mapping.json</h6></li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"common_mapping"</span>: &#123;</span><br><span class="line">        <span class="attr">"src_ip"</span>: <span class="string">"srcip"</span>,</span><br><span class="line">        <span class="attr">"dest_ip"</span>: <span class="string">"dstip"</span>,</span><br><span class="line">        <span class="attr">"src_port"</span>: <span class="string">"srcport"</span>,</span><br><span class="line">        <span class="attr">"dest_port"</span>: <span class="string">"dstport"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="70-normalized-suricata-conf"><a href="#70-normalized-suricata-conf" class="headerlink" title="70_normalized-suricata.conf"></a>70_normalized-suricata.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  <span class="built_in">clone</span> &#123;</span><br><span class="line">    clones =&gt; [ <span class="string">"siem_events"</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"siem_events"</span> &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      remove_field =&gt; [ <span class="string">"application"</span>, <span class="string">"type"</span>, <span class="string">"agent"</span>, <span class="string">"@version"</span>, <span class="string">"@timestamp"</span>]</span><br><span class="line">      add_field =&gt; &#123;</span><br><span class="line">        <span class="string">"provider"</span> =&gt; <span class="string">"Suricata"</span></span><br><span class="line">        <span class="string">"product"</span> =&gt; <span class="string">"Intrusion Detection System"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ruby &#123;</span><br><span class="line">      init =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">        require 'json'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        mapping_json = File.read('/etc/logstash/mappings/wazuh/mapping.json')</span></span><br><span class="line"><span class="string">        mapping = JSON.parse(mapping_json)</span></span><br><span class="line"><span class="string">        @common_mapping = mapping['common_mapping']</span></span><br><span class="line"><span class="string">      "</span></span><br><span class="line"></span><br><span class="line">      code =&gt; <span class="string">"</span></span><br><span class="line"><span class="string">        keys = event.to_hash.keys</span></span><br><span class="line"><span class="string">        keys.each do |key|</span></span><br><span class="line"><span class="string">            if @common_mapping.include? key then</span></span><br><span class="line"><span class="string">                value = event.get(key)</span></span><br><span class="line"><span class="string">                event.remove(key)</span></span><br><span class="line"><span class="string">                new_key = @common_mapping[key]</span></span><br><span class="line"><span class="string">                event.set(new_key, value)</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        sensor = event.get('[host][name]')</span></span><br><span class="line"><span class="string">        event.set('sensor', sensor)</span></span><br><span class="line"><span class="string">      "</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="99-output-elasticsearch-conf"><a href="#99-output-elasticsearch-conf" class="headerlink" title="99_output-elasticsearch.conf"></a>99_output-elasticsearch.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [event_type] == <span class="string">"alert"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      cacert =&gt; <span class="string">"/etc/logstash/certs/ca/ca.crt"</span></span><br><span class="line">      user =&gt; <span class="string">"elastic"</span></span><br><span class="line">      password =&gt; <span class="string">"Hello World!"</span></span><br><span class="line">      hosts =&gt; [<span class="string">"https://elasticsearch:9200"</span>]</span><br><span class="line">      index =&gt; <span class="string">"suricata-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">      template =&gt; <span class="string">"/etc/logstash/index-template.d/suricata-template.json"</span></span><br><span class="line">      template_name =&gt; <span class="string">"suricata"</span></span><br><span class="line">      template_overwrite =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="99-output-wazuh-conf"><a href="#99-output-wazuh-conf" class="headerlink" title="99_output-wazuh.conf"></a>99_output-wazuh.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [provider] == <span class="string">"Suricata"</span> &#123;</span><br><span class="line">    syslog &#123;</span><br><span class="line">        host =&gt; <span class="string">"wazuh"</span></span><br><span class="line">        protocol =&gt; <span class="string">"tcp"</span></span><br><span class="line">        port =&gt; 514</span><br><span class="line">        codec =&gt; <span class="string">"json"</span></span><br><span class="line">        sourcehost =&gt; <span class="string">"logstash"</span></span><br><span class="line">        appname =&gt; <span class="string">"NORMALIZED"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#stdout &#123;</span></span><br><span class="line">        <span class="comment">#codec =&gt; rubydebug</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="Wazuhé…ç½®"><a href="#Wazuhé…ç½®" class="headerlink" title="Wazuhé…ç½®"></a>Wazuhé…ç½®</h5><ul>
<li><h6 id="custom-syscheck-py"><a href="#custom-syscheck-py" class="headerlink" title="custom-syscheck.py"></a>custom-syscheck.py</h6><p>Wazuh Manager æ–°å¢é¢„å¤„ç†è„šæœ¬å¯¹æŒ‡å®šçš„å®‰å…¨äº‹ä»¶è¿›è¡Œé¢„å¤„ç†ã€‚å¦‚: syscheckäº‹ä»¶å¢åŠ <code>srcip</code>å­—æ®µã€‚</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta, timezone</span><br><span class="line"></span><br><span class="line"><span class="comment"># ossec.conf configuration:</span></span><br><span class="line"><span class="comment">#  &lt;integration&gt;</span></span><br><span class="line"><span class="comment">#      &lt;name&gt;custom-syscheck&lt;/name&gt;</span></span><br><span class="line"><span class="comment">#      &lt;rule_id&gt;554&lt;/rule_id&gt;</span></span><br><span class="line"><span class="comment">#      &lt;group&gt;syscheck&lt;/group&gt;</span></span><br><span class="line"><span class="comment">#      &lt;alert_format&gt;json&lt;/alert_format&gt;</span></span><br><span class="line"><span class="comment">#  &lt;/integration&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Global vars</span></span><br><span class="line">debug_enabled = <span class="literal">False</span></span><br><span class="line">pwd = os.path.dirname(os.path.dirname(os.path.realpath(__file__)))</span><br><span class="line">json_alert = &#123;&#125;</span><br><span class="line">now = time.strftime(<span class="string">"%a %b %d %H:%M:%S %Z %Y"</span>)</span><br><span class="line">wazuh_server = <span class="string">"192.168.199.97"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set paths</span></span><br><span class="line">log_file = <span class="string">'&#123;0&#125;/logs/integrations.log'</span>.format(pwd)</span><br><span class="line">syscheck_file = <span class="string">'&#123;0&#125;/logs/syscheck.json'</span>.format(pwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">iso8601</span><span class="params">(hours=<span class="number">8</span>)</span>:</span></span><br><span class="line">    td = timedelta(hours=hours)</span><br><span class="line">    tz = timezone(td)</span><br><span class="line">    <span class="keyword">return</span> datetime.now(tz=tz).isoformat()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(args)</span>:</span></span><br><span class="line">    debug(<span class="string">"# Starting"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read args</span></span><br><span class="line">    alert_file_location = args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">"# File location"</span>)</span><br><span class="line">    debug(alert_file_location)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Load alert. Parse JSON object.</span></span><br><span class="line">    <span class="keyword">with</span> open(alert_file_location) <span class="keyword">as</span> alert_file:</span><br><span class="line">        json_alert = json.load(alert_file)</span><br><span class="line">    debug(<span class="string">"# Processing alert"</span>)</span><br><span class="line">    debug(json_alert)</span><br><span class="line"></span><br><span class="line">    alert = normalized_data(json_alert)</span><br><span class="line">    <span class="keyword">with</span> open(syscheck_file, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        msg = json.dumps(alert)</span><br><span class="line">        f.write(msg + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> debug_enabled:</span><br><span class="line">        msg = <span class="string">"&#123;0&#125;: &#123;1&#125;\n"</span>.format(now, msg)</span><br><span class="line">        <span class="keyword">with</span> open(log_file, <span class="string">"a"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(msg)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalized_data</span><span class="params">(alert)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> alert[<span class="string">'agent'</span>][<span class="string">'id'</span>] == <span class="string">'000'</span>:</span><br><span class="line">        alert[<span class="string">'srcip'</span>] = wazuh_server</span><br><span class="line">    <span class="keyword">elif</span> alert[<span class="string">'agent'</span>].get(<span class="string">'ip'</span>):</span><br><span class="line">        alert[<span class="string">'srcip'</span>] = alert[<span class="string">'agent'</span>][<span class="string">'ip'</span>]</span><br><span class="line">        alert[<span class="string">'dstip'</span>] = alert[<span class="string">'agent'</span>][<span class="string">'ip'</span>]</span><br><span class="line">    alert[<span class="string">'integration'</span>] = <span class="string">'custom-syscheck'</span></span><br><span class="line">    alert[<span class="string">'create_timestamp'</span>] = iso8601()</span><br><span class="line">    debug(alert)</span><br><span class="line">    <span class="keyword">return</span>(alert)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Read arguments</span></span><br><span class="line">        bad_arguments = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> len(sys.argv) &gt;= <span class="number">4</span>:</span><br><span class="line">            msg = <span class="string">'&#123;0&#125; &#123;1&#125; &#123;2&#125; &#123;3&#125; &#123;4&#125;'</span>.format(now, sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>], sys.argv[<span class="number">3</span>], sys.argv[<span class="number">4</span>] <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">4</span> <span class="keyword">else</span> <span class="string">''</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = <span class="string">'&#123;0&#125; Wrong arguments'</span>.format(now)</span><br><span class="line">            bad_arguments = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Logging the call</span></span><br><span class="line">        <span class="keyword">with</span> open(log_file, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(msg + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> bad_arguments:</span><br><span class="line">            debug(<span class="string">"# Exiting: Bad arguments."</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Main function</span></span><br><span class="line">        main(sys.argv)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        debug(str(e))</span><br><span class="line">        <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="ossec-conf"><a href="#ossec-conf" class="headerlink" title="ossec.conf"></a>ossec.conf</h6><ul>
<li>é…ç½®syslogé€‰ç”¨<strong>TCP</strong>åè®®;</li>
<li>åŠ è½½é¢„å¤„ç†è„šæœ¬;</li>
<li>åŠ è½½è„šæœ¬è¾“å‡ºæ—¥å¿—;</li>
</ul>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ossec_config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">remote</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">connection</span>&gt;</span>syslog<span class="tag">&lt;/<span class="name">connection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>514<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">protocol</span>&gt;</span>tcp<span class="tag">&lt;/<span class="name">protocol</span>&gt;</span> <span class="comment">&lt;!-- udp(default)/tcp --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">allowed-ips</span>&gt;</span>192.168.199.0/24<span class="tag">&lt;/<span class="name">allowed-ips</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">remote</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- Custom external Integration --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">integration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>custom-syscheck<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule_id</span>&gt;</span>554<span class="tag">&lt;/<span class="name">rule_id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span>&gt;</span>syscheck<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">alert_format</span>&gt;</span>json<span class="tag">&lt;/<span class="name">alert_format</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">integration</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- Custom syscheck.json --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">localfile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">log_format</span>&gt;</span>json<span class="tag">&lt;/<span class="name">log_format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/var/ossec/logs/syscheck.json<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">localfile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ossec_config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="local-decoder-normalized-xml"><a href="#local-decoder-normalized-xml" class="headerlink" title="local_decoder_normalized.xml"></a>local_decoder_normalized.xml</h6></li>
</ul>
<p><strong>Sample</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">2020 Mar 03 02:53:39 logstash NORMALIZED[-]: &#123;"timestamp":"2020-02-21T19:47:04.382300+0800","flow_id":1133835979634527,"in_iface":"wlp3s0","event_type":"alert","src_ip":"192.168.199.97","src_port":60022,"dest_ip":"192.168.199.162","dest_port":59143,"proto":"TCP","alert":&#123;"action":"allowed","gid":1,"signature_id":123456,"rev":1,"signature":"LOCAL RULES XXX","severity":3&#125;&#125;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">decoder</span> <span class="attr">name</span>=<span class="string">"nta_json"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prematch</span>&gt;</span>NORMALIZED[-]: <span class="tag">&lt;/<span class="name">prematch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin_decoder</span> <span class="attr">offset</span>=<span class="string">"after_prematch"</span>&gt;</span>JSON_Decoder<span class="tag">&lt;/<span class="name">plugin_decoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">decoder</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="0901-local-raw-xml"><a href="#0901-local-raw-xml" class="headerlink" title="0901-local_raw.xml"></a>0901-local_raw.xml</h6><ul>
<li>é»˜è®¤å¼•ç”¨çš„è§£ç å™¨ä¸º<code>json</code>, è¿™é‡Œéœ€è¦ä¿®æ”¹ä¸ºåˆšæ‰æ–°å¢çš„<code>nta_json</code>;</li>
<li>é€šè¿‡<code>overwrite=yes</code>è¦†ç›–åŸå§‹è§„åˆ™;</li>
</ul>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"suricata,"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- /var/ossec/ruleset/rules/0475-suricata_rules.xml --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Defind Suricata Rules --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ID: 86600 - 86699 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"86600"</span> <span class="attr">level</span>=<span class="string">"0"</span> <span class="attr">overwrite</span>=<span class="string">"yes"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">decoded_as</span>&gt;</span>nta_json<span class="tag">&lt;/<span class="name">decoded_as</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"timestamp"</span>&gt;</span>\.+<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"event_type"</span>&gt;</span>\.+<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Suricata messages.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="0905-local-syscheck-xml"><a href="#0905-local-syscheck-xml" class="headerlink" title="0905-local_syscheck.xml"></a>0905-local_syscheck.xml</h6><p>ä¸ºé¢„å¤„ç†è„šæœ¬ç”Ÿæˆçš„æ—¥å¿—è¿›è¡Œè§£æ</p>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"syscheck,"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"187100"</span> <span class="attr">level</span>=<span class="string">"7"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">decoded_as</span>&gt;</span>json<span class="tag">&lt;/<span class="name">decoded_as</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"integration"</span>&gt;</span>custom-syscheck<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>syscheck integration messages.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="9999-local-composite-xml"><a href="#9999-local-composite-xml" class="headerlink" title="9999-local_composite.xml"></a>9999-local_composite.xml</h6></li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"local,composite,"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Local Composite Rules Range ID: 200000 - 205000 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"200000"</span> <span class="attr">level</span>=<span class="string">"15"</span> <span class="attr">frequency</span>=<span class="string">"2"</span> <span class="attr">timeframe</span>=<span class="string">"600"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_matched_sid</span>&gt;</span>101000<span class="tag">&lt;/<span class="name">if_matched_sid</span>&gt;</span> <span class="comment">&lt;!-- æ–‡ä»¶ä¸Šä¼ ç±»è§„åˆ™ or æ£€æµ‹WebShellä¸Šä¼ ç±»è§„åˆ™ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_sid</span>&gt;</span>187100<span class="tag">&lt;/<span class="name">if_sid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">same_source_ip</span> /&gt;</span>	<span class="comment">&lt;!-- é€šè¿‡IPè¿›è¡Œå…³è” --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Phase 3: æ£€æµ‹åˆ°æœåŠ¡å™¨:$(srcip), è¢«ä¸Šä¼ WebShell.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"200001"</span> <span class="attr">level</span>=<span class="string">"12"</span> <span class="attr">frequency</span>=<span class="string">"2"</span> <span class="attr">timeframe</span>=<span class="string">"600"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_matched_sid</span>&gt;</span>88801<span class="tag">&lt;/<span class="name">if_matched_sid</span>&gt;</span> <span class="comment">&lt;!-- WAFå®‰å…¨äº‹ä»¶ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_group</span>&gt;</span>ids<span class="tag">&lt;/<span class="name">if_group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">same_source_ip</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Phase 3: Alarm - Same ip Bypass WAF of within 600 seconds. $(srcip) -&gt; $(http.hostname) -&gt; $(alert.signature) -&gt; $(alert.signature_id).<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ol>
<li>å¯¹äº<strong>WebShell</strong>å…³è”æ£€æµ‹,ç›®å‰é‡‡ç”¨çš„æ˜¯åŒæºIPä»¥åŠæ—¶åºçš„å…³è”, æœ€ä¸ºé è°±çš„åº”è¯¥æ˜¯é€šè¿‡Hashçš„æ¯”å¯¹ã€‚è¿™é‡Œè¦åæ§½ä¸€ä¸‹Suricataé»˜è®¤çš„fileinfo, æ²¡åŠæ³•è‡ªå®šä¹‰è¾“å‡º, åªè¦å¼€å¯å¯è¢«è¿˜åŸçš„åè®®éƒ½ä¼šè¾“å‡ºfileinfoçš„äº‹ä»¶ã€‚æ­£å› å¦‚æ­¤, æ•°æ®é‡ä¸€å¤§Wazuhçš„å¼•æ“å‹åŠ›ä¼šå¾ˆå¤§ã€‚æˆ‘å°è¯•é€šè¿‡<strong>Lua</strong>æ¥è‡ªå®šä¹‰ä¸€ä¸ªæ–‡ä»¶å®¡è®¡ç±»çš„äº‹ä»¶, è²Œä¼¼ä¹ŸåŒæ ·æ²¡åŠæ³•åŒºåˆ†åè®®æ›´åˆ«è¯´é’ˆå¯¹httpè¿‡æ»¤æ¡ä»¶è¿›è¡Œè‡ªå®šä¹‰çš„è¿‡æ»¤è¾“å‡ºäº†ã€‚</li>
</ol>
<ol start="2">
<li>ç”±äºå…³è”è§„åˆ™æœ¬èº«æ˜¯é€šè¿‡åº•å±‚å¤šä¸ªå®‰å…¨äº‹ä»¶è¿›è¡Œç»´åº¦çš„å…³è”æå‡å‘Šè­¦çš„<strong>å¯é æ€§</strong>ã€‚å› æ­¤, åº•å±‚å®‰å…¨äº‹ä»¶ä¸å¤Ÿå‡†ç¡®åŒæ ·ä¼šè®©ä¸Šå±‚çš„å…³è”è§„åˆ™å¸¦æ¥å¤§é‡è¯¯æŠ¥ã€‚å¯¹äºåº•å±‚å®‰å…¨äº‹ä»¶çš„ä¼˜åŒ–ä¹Ÿæ˜¯éœ€è¦æŒç»­è¿›è¡Œçš„ã€‚</li>
</ol>
<ol start="3">
<li><strong>Wazuh v3.11.4</strong> é‡‡ç”¨syslogæ¥æ”¶å¤§æ—¥å¿—æ—¶, ä¼šè§¦å‘<code>memory violation</code>å¯¼è‡´<code>ossec-remoted</code>è¿›ç¨‹é‡å¯, è¯¥é—®é¢˜å·²å‘ç¤¾åŒºåé¦ˆä¸‹ä¸ªç‰ˆæœ¬ä¸­ä¼šè§£å†³ã€‚</li>
</ol>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><p><strong><a href="https://wazuh.com/blog/how-to-forward-android-syslog-to-wazuh/" target="_blank" rel="noopener">How to forward Android syslog to Wazuh</a></strong></p>
</li>
<li><p><strong><a href="https://wazuh.com/blog/how-to-configure-rsyslog-client-to-send-events-to-wazuh/" target="_blank" rel="noopener">How to configure Rsyslog client to send events to Wazuh</a></strong></p>
</li>
<li><p><strong><a href="https://wazuh.com/blog/how-to-integrate-external-software-using-integrator/" target="_blank" rel="noopener">How to integrate external software using Integrator</a></strong></p>
</li>
</ul>
]]></content>
      <categories>
        <category>HIDSã€NIDS</category>
      </categories>
      <tags>
        <tag>Logstash</tag>
        <tag>Suricata</tag>
        <tag>Wazuh</tag>
        <tag>Filbeat</tag>
      </tags>
  </entry>
  <entry>
    <title>Wazuh - åˆ©ç”¨CDB listè¿‡æ»¤ç§ç½‘IPåœ°å€</title>
    <url>/2020/01/31/Wazuh-%E5%88%A9%E7%94%A8CDB-list%E8%BF%87%E6%BB%A4%E7%A7%81%E7%BD%91IP%E5%9C%B0%E5%9D%80/</url>
    <content><![CDATA[<h4 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h4><p>â€‹        ç›®å‰å¹³å°æ¥å…¥äº†<strong>Suricata</strong>çš„å‘Šè­¦è§„åˆ™, ç”±äºé•œåƒæºçš„å…³ç³»éƒ¨åˆ†è§„åˆ™äº§ç”Ÿäº†<strong>â€˜è¯¯â€™</strong>å‘Šè­¦, å› æ­¤éœ€è¦é’ˆå¯¹è¿™éƒ¨åˆ†è§„åˆ™è¿›è¡ŒIPåœ°å€çš„è¿‡æ»¤ã€‚</p>
<h4 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h4><ol>
<li>ä¿®æ”¹Suricataçš„è§„åˆ™, å¦‚æœä½ çš„<strong>â€˜è¯¯â€™</strong>å‘Šè­¦é‡å¾ˆå¤§ä¸”ä¸ºäº†æ€§èƒ½è€ƒè™‘, æ¨èç›´æ¥ä¿®æ”¹Suricataçš„è§„åˆ™ã€‚</li>
<li>ç”±äºæˆ‘è¿™è¾¹çš„Suricataå‘Šè­¦éƒ½æ˜¯åˆ©ç”¨Wazuhè¿›è¡Œ<strong>â€˜æ¶ˆè´¹â€™</strong>çš„ã€‚å› æ­¤, æˆ‘è¿™è¾¹ç›´æ¥é‡‡ç”¨äº†<strong><a href="https://documentation.wazuh.com/3.10/user-manual/ruleset/cdb-list.html" target="_blank" rel="noopener">Wazuh CDB list</a></strong>è¿™ä¸ªåŠŸèƒ½è¿›è¡ŒæŒ‡å®šIPåœ°å€çš„è¿‡æ»¤ã€‚</li>
</ol>
<h4 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h4><h5 id="1-åˆ›å»º-CDB-list"><a href="#1-åˆ›å»º-CDB-list" class="headerlink" title="1. åˆ›å»º CDB list"></a>1. åˆ›å»º CDB list</h5><blockquote>
<p>Each key must be unique and is terminated with a colon <code>:</code>.</p>
<p>For IP addresses the dot notation is used for subnet matches:</p>
</blockquote>
<table>
<thead>
<tr>
<th>key</th>
<th>CIDR</th>
<th>Possible matches</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.:</td>
<td>192.168.0.0/16</td>
<td>192.168.0.0 - 192.168.255.255</td>
</tr>
<tr>
<td>172.16.19.:</td>
<td>172.16.19.0/24</td>
<td>172.16.19.0 - 172.16.19.255</td>
</tr>
<tr>
<td>10.1.1.1:</td>
<td>10.1.1.1/32</td>
<td>10.1.1.1</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /var/ossec/etc/lists/private_ip</span><br><span class="line"></span><br><span class="line">10.168.:PrivateNet</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Since Wazuh v3.11.3, CDB lists are built and loaded automatically when the analysis engine is started. Therefore, when adding or modifying CDB lists, it is no longer needed to run <code>ossec-makelists</code>, just restart the manager.</p>
</blockquote>
<p>ä»Wazuh v3.11.3å¼€å§‹ï¼Œå°†åœ¨å¯åŠ¨åˆ†æå¼•æ“æ—¶è‡ªåŠ¨æ„å»ºå’ŒåŠ è½½CDBåˆ—è¡¨ã€‚å› æ­¤ï¼Œæ·»åŠ æˆ–ä¿®æ”¹CDBåˆ—è¡¨æ—¶ï¼Œä¸å†éœ€è¦è¿è¡Œossec-makelistsï¼Œåªéœ€é‡æ–°å¯åŠ¨ç®¡ç†å™¨å³å¯ã€‚</p>
<blockquote>
<p><strong>3.11.3 ä¹‹å‰ç‰ˆæœ¬éœ€è¦æ‰§è¡Œ</strong></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ /var/ossec/bin/ossec-makelists</span><br></pre></td></tr></table></figure>

<h5 id="2-åœ¨-ossec-conf-ä¸­æ·»åŠ -list"><a href="#2-åœ¨-ossec-conf-ä¸­æ·»åŠ -list" class="headerlink" title="2. åœ¨ ossec.conf ä¸­æ·»åŠ  list"></a>2. åœ¨ ossec.conf ä¸­æ·»åŠ  list</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /var/ossec/etc/ossec.conf</span><br><span class="line"></span><br><span class="line">&lt;ossec_config&gt;</span><br><span class="line">  &lt;ruleset&gt;</span><br><span class="line">    &lt;!-- User-defined CDB --&gt;</span><br><span class="line">    &lt;list&gt;etc/lists/private_ip&lt;/list&gt;</span><br><span class="line">  &lt;/ruleset&gt;</span><br><span class="line">&lt;/ossec_config&gt;</span><br></pre></td></tr></table></figure>

<h5 id="3-é‡å¯è¿›ç¨‹"><a href="#3-é‡å¯è¿›ç¨‹" class="headerlink" title="3. é‡å¯è¿›ç¨‹"></a>3. é‡å¯è¿›ç¨‹</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl restart wazuh-manager</span><br></pre></td></tr></table></figure>

<h5 id="4-é…ç½®è§„åˆ™"><a href="#4-é…ç½®è§„åˆ™" class="headerlink" title="4. é…ç½®è§„åˆ™"></a>4. é…ç½®è§„åˆ™</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;var name=<span class="string">"SAME_IP_TIME"</span>&gt;120&lt;/var&gt;</span><br><span class="line">&lt;var name=<span class="string">"SAME_IP_IGORE"</span>&gt;300&lt;/var&gt;</span><br><span class="line"></span><br><span class="line">&lt;group name=<span class="string">"local,suricata,ids,"</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;rule id=<span class="string">"102018"</span> level=<span class="string">"8"</span> frequency=<span class="string">"5"</span> timeframe=<span class="string">"<span class="variable">$SAME_IP_TIME</span>"</span> ignore=<span class="string">"<span class="variable">$SAME_IP_IGORE</span>"</span>&gt;</span><br><span class="line">      &lt;if_matched_sid&gt;86601&lt;/if_matched_sid&gt;</span><br><span class="line">      &lt;field name=<span class="string">"alert.signature_id"</span>&gt;2013057&lt;/field&gt;</span><br><span class="line">      &lt;list field=<span class="string">"src_ip"</span> lookup=<span class="string">"not_address_match_key"</span>&gt;etc/lists/private_ip&lt;/list&gt;</span><br><span class="line">      &lt;description&gt;Wazuh Rules - Same ip of attack occurred 5 <span class="built_in">times</span> within <span class="variable">$SAME_IP_TIME</span> seconds. $(src_ip) -&gt; $(alert.signature) -&gt; $(alert.signature_id).&lt;/description&gt;</span><br><span class="line">      &lt;options&gt;no_full_log&lt;/options&gt;</span><br><span class="line">    &lt;/rule&gt;</span><br><span class="line"></span><br><span class="line">&lt;/group&gt;</span><br></pre></td></tr></table></figure>

<h5 id="5-æµ‹è¯•è§„åˆ™"><a href="#5-æµ‹è¯•è§„åˆ™" class="headerlink" title="5. æµ‹è¯•è§„åˆ™"></a>5. æµ‹è¯•è§„åˆ™</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ /var/ossec/bin/ossec-logtest</span><br></pre></td></tr></table></figure>

<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><strong><a href="https://documentation.wazuh.com/3.11/user-manual/ruleset/cdb-list.html?highlight=match_key" target="_blank" rel="noopener">Using CDB lists</a></strong></li>
</ul>
]]></content>
      <categories>
        <category>HIDS</category>
      </categories>
      <tags>
        <tag>Wazuh</tag>
      </tags>
  </entry>
  <entry>
    <title>Logstash Event API</title>
    <url>/2019/12/30/Logstash-Event-API/</url>
    <content><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>â€‹        ç”±äºé¡¹ç›®éœ€è¦, ç”¨åˆ°äº†<code>Ruby</code>å¯¹Logstashè¿›è¡Œä¸€äº›å®šåˆ¶åŒ–çš„é…ç½®ã€‚ç¿»éäº†æ•´ä¸ªLogstashçš„å®˜æ–¹æ–‡æ¡£, å¯¹äºRuby APIçš„ä»‹ç»å°±å†™äº†ä¸¤ä¸ªæ–¹æ³•ã€‚<code>get</code> ä¸ <code>set</code> ä¹Ÿæ˜¯é†‰äº†ğŸ˜‚, å¹¸å¥½è°·æ­Œä¸€ä¸‹â€¦</p>
<h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><ul>
<li>åˆ é™¤äº‹ä»¶ï¼šcancel</li>
<li>å–æ¶ˆåˆ é™¤äº‹ä»¶ï¼šuncancel</li>
<li>æ˜¯å¦åˆ é™¤ï¼šcancelled?</li>
<li>æ˜¯å¦åŒ…å«å­—æ®µï¼šinclude?</li>
<li>åˆ é™¤å­—æ®µï¼šremove</li>
<li>äº‹ä»¶è½¬å­—ç¬¦ä¸²ï¼što_s</li>
<li>äº‹ä»¶è½¬hashå­—å…¸ï¼ˆä¸å«metadataå­—æ®µï¼‰ï¼što_hash</li>
<li>äº‹ä»¶è½¬hashå­—å…¸ï¼ˆå«metadataå­—æ®µï¼‰ï¼što_hash_with_metadata</li>
<li>äº‹ä»¶è½¬jsonå­—ç¬¦ä¸²ï¼što_json</li>
<li>å¢åŠ tagï¼štag</li>
<li>å–äº‹ä»¶æ—¶é—´æˆ³ï¼štimestamp</li>
</ul>
<p><strong>æ›´å¤šæŸ¥è¯¢å®˜æ–¹æ¥å£æºç :</strong> <a href="https://github.com/elastic/logstash/blob/master/logstash-core/src/main/java/org/logstash/ext/JrubyEventExtLibrary.java" target="_blank" rel="noopener"><strong>JrubyEventExtLibrary.java</strong></a></p>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><strong><a href="https://blog.csdn.net/mvpboss1004/article/details/78070300" target="_blank" rel="noopener">Lostash event APIè¯¦è§£</a></strong></li>
<li><a href="https://github.com/elastic/logstash/blob/master/logstash-core/src/main/java/org/logstash/ext/JrubyEventExtLibrary.java" target="_blank" rel="noopener"><strong>JrubyEventExtLibrary.java</strong></a></li>
<li><strong><a href="https://www.rubydoc.info/gems/logstash-event/1.1.5/LogStash/Event#cancel-instance_method" target="_blank" rel="noopener">Class: LogStash::Event</a></strong></li>
</ul>
]]></content>
      <categories>
        <category>ELK</category>
      </categories>
      <tags>
        <tag>Logstash</tag>
      </tags>
  </entry>
  <entry>
    <title>Logstash Multiple Pipelines</title>
    <url>/2019/12/30/Logstash-Multiple-Pipelines/</url>
    <content><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>å½“Logstashè¦å¤„ç†çš„å¤šä¸ªinputç±»å‹æ—¶, æœ€å¸¸è§çš„ä¸¤ç§è§£å†³æ–¹æ¡ˆ(<strong>ä¸æ¨è</strong>):</p>
<ol>
<li><p>é€šè¿‡æ¡ä»¶åˆ¤æ–­è§£å†³é—®é¢˜</p>
</li>
<li><p>é€šè¿‡å¤šå®ä¾‹è§£å†³é—®é¢˜</p>
</li>
</ol>
<p><strong>è´Ÿé¢å½±å“:</strong></p>
<ol>
<li><p>æ¡ä»¶åˆ¤æ–­</p>
<ol>
<li>æ¡ä»¶åœ°ç‹±ã€‚å·²çŸ¥çš„åœ¨ä¸€ä¸ªç®¡é“ä¸­å®ç°å¤šä¸ªç‹¬ç«‹æµçš„æ–¹æ³•æ˜¯ä½¿ç”¨æ¡ä»¶åˆ¤æ–­ã€‚ä¸»è¦æ–¹å¼æ˜¯åœ¨è¾“å…¥éƒ¨åˆ†é€šè¿‡æ ‡ç­¾æ ‡è®°äº‹ä»¶ï¼Œç„¶ååœ¨è¿‡æ»¤å™¨ä¸­å’Œè¾“å‡ºé˜¶æ®µåˆ›å»ºæ¡ä»¶åˆ†æ”¯ï¼Œå¯¹è´´æœ‰ä¸åŒæ ‡ç­¾çš„äº‹ä»¶ï¼Œåº”ç”¨ä¸åŒçš„æ’ä»¶é›†ã€‚è¿™ç§æ–¹å¼è™½ç„¶å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†åœ¨å®é™…çš„ä½¿ç”¨ä¸­å´éå¸¸çš„ç—›è‹¦ï¼ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ demo ç‰‡æ®µï¼š</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    beats &#123; </span><br><span class="line">        port =&gt; 3444  </span><br><span class="line">        tag =&gt; apache </span><br><span class="line">    &#125;</span><br><span class="line">    tcp &#123; </span><br><span class="line">        port =&gt; 4222</span><br><span class="line">        tag =&gt; firewall</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"apache"</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        dissect &#123; ... &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">"firewall"</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        grok &#123; ... &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"apache"</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        elasticsearch &#123; ... &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">"firewall"</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        tcp &#123; ... &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol>
<li>ç¼ºä¹æ‹¥å¡ç®¡ç†ã€‚Logstashåœ¨æ‰€æœ‰äº‹ä»¶å’Œå®Œæˆæ‰€æœ‰è¾“å‡ºä¹‹å‰ä¸ä¼šç§»åŠ¨åˆ°ä¸‹ä¸€æ‰¹äº‹ä»¶ã€‚è¿™æ„å‘³ç€ï¼Œå¯¹äºä¸Šé¢çš„ç®¡é“ï¼Œå¦‚æœ TCP å¥—æ¥å­—ç›®æ ‡ä¸å¯è¾¾ï¼ŒLogstashå°†ä¸ä¼šå¤„ç†å…¶ä»–æ‰¹æ¬¡çš„äº‹ä»¶ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ Elasticsearch å°†ä¸ä¼šæ¥æ”¶äº‹ä»¶ï¼Œå¹¶ä¸”ä¼šå¯¹ TCP è¾“å…¥å’Œ Beats è¾“å…¥æ–½åŠ åå‹åŠ›ã€‚</li>
<li>ä¸åŒçš„æ•°æ®æµéœ€è¦ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†ã€‚å¦‚æœ TCP - &gt; Grok - &gt; TCP æ•°æ®æµå¤„ç†å¤§é‡çš„å°æ•°æ®ï¼Œè€Œ Beats -&gt; Dissect -&gt; ES æ•°æ®æµä¸­çš„å•ä¸ªæ•°æ®ä½“ç§¯å¤§ä½†æ˜¯æ•°é‡å°‘ã€‚é‚£ä¹ˆå‰ä¸€ä¸ªæ•°æ®æµå¸Œæœ›æœ‰å¤šä¸ª worker å¹¶è¡Œå¹¶å…¶æ¯ä¸€æ‰¹æ¬¡å¤„ç†æ›´å¤šäº‹ä»¶ï¼Œç¬¬äºŒä¸ªæ•°æ®æµåˆ™æœŸæœ›ä½¿ç”¨å°‘é‡çš„ worker å’Œæ¯æ‰¹æ¬¡å¤„ç†å°‘é‡çš„äº‹ä»¶ã€‚ä½¿ç”¨å•ä¸ªç®¡é“ï¼Œæ— æ³•ä¸ºå•ä¸ªæ•°æ®æµæŒ‡å®šç‹¬ç«‹çš„ç®¡é“é…ç½®ã€‚</li>
</ol>
<ol start="2">
<li>å¤šå®ä¾‹<ol>
<li>éœ€è¦ç®¡ç†å¤šä¸ªå®ä¾‹(é€šè¿‡ init ç³»ç»Ÿç®¡ç†å¤šä¸ªåå°æœåŠ¡)</li>
<li>æ¯ä¸ª Logstash çš„å®ä¾‹ä¹Ÿæ„å‘³ç€ä¸€ä¸ªç‹¬ç«‹çš„ JVM</li>
<li>éœ€è¦ç›‘è§†æ¯ä¸ª Logstash å®ä¾‹</li>
</ol>
</li>
</ol>
<h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><p>â€‹        é€šè¿‡é…ç½®å¤šç®¡é“(Multiple Pipelines), è§£å†³ä»¥ä¸Šçš„æ‰€æœ‰é—®é¢˜ã€‚</p>
<h5 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h5><p><code>/usr/share/logstash/config/pipelines.yml</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># This file is where you define your pipelines. You can define multiple.</span></span><br><span class="line"><span class="comment"># For more information on multiple pipelines, see the documentation:</span></span><br><span class="line"><span class="comment">#   https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html</span></span><br><span class="line"></span><br><span class="line">- pipeline.id: dsiem</span><br><span class="line">  path.config: <span class="string">"/etc/logstash/conf.d_siem/*.conf"</span></span><br><span class="line">  pipeline.workers: 16</span><br><span class="line">  queue.type: persisted</span><br><span class="line">  queue.max_bytes: 300gb</span><br><span class="line"></span><br><span class="line">- pipeline.id: cloudflare</span><br><span class="line">  path.config: <span class="string">"/etc/logstash/conf.d_cf/*.conf"</span></span><br><span class="line">  pipeline.workers: 8</span><br><span class="line">  queue.type: persisted</span><br><span class="line">  queue.max_bytes: 100gb</span><br><span class="line"></span><br><span class="line">- pipeline.id: ti</span><br><span class="line">  path.config: <span class="string">"/etc/logstash/conf.d_ti/*.conf"</span></span><br><span class="line">  pipeline.workers: 8</span><br><span class="line">  queue.type: persisted</span><br><span class="line">  queue.max_bytes: 50gb</span><br></pre></td></tr></table></figure>

<p><code>/etc/supervisord.d/logstash.ini</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[program:logstash]</span><br><span class="line"><span class="built_in">command</span>=/usr/share/logstash/bin/logstash --path.data /lingtian/data/logstash/</span><br><span class="line"><span class="comment">#user=logstash</span></span><br><span class="line">numprocs=1</span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">startsecs=1</span><br><span class="line">startretries=3</span><br><span class="line">exitcodes=0,2</span><br><span class="line">stopsignal=INT</span><br><span class="line">redirect_stderr=<span class="literal">true</span></span><br><span class="line">stdout_logfile_maxbytes=1MB</span><br><span class="line">stdout_logfile_backups=5</span><br><span class="line">stdout_capture_maxbytes=1MB</span><br><span class="line">stdout_logfile=/lingtian/logs/logstash/logstash.log</span><br></pre></td></tr></table></figure>

<h5 id="åŠ è½½é…ç½®æ–‡ä»¶"><a href="#åŠ è½½é…ç½®æ–‡ä»¶" class="headerlink" title="åŠ è½½é…ç½®æ–‡ä»¶"></a>åŠ è½½é…ç½®æ–‡ä»¶</h5><p>å¯é€šè¿‡ä½¿ç”¨å‚æ•°, <code>--config.reload.automatic</code> or <code>-r</code> åœ¨é…ç½®æ–‡ä»¶å‘ç”Ÿæ›´æ”¹åè‡ªåŠ¨æ£€æµ‹å¹¶é‡æ–°åŠ è½½é…ç½®ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ bin/logstash -f apache.config --config.reload.automatic</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤3ç§’æ£€æŸ¥é…ç½®æ–‡ä»¶, å¯ä»¥é€šè¿‡ä½¿ç”¨å‚æ•°, <code>--config.reload.interval</code>ä¿®æ”¹ç§’æ•°ã€‚</p>
<p>å¦‚æœLogstashå·²ç»åœ¨æ²¡æœ‰å¯ç”¨è‡ªåŠ¨é‡è½½çš„æƒ…å†µä¸‹è¿è¡Œï¼Œåˆ™å¯ä»¥é€šè¿‡å‘è¿è¡ŒLogstashçš„è¿›ç¨‹å‘é€SIGHUPï¼ˆä¿¡å·æŒ‚èµ·ï¼‰æ¥å¼ºåˆ¶Logstashé‡è½½é…ç½®æ–‡ä»¶å¹¶é‡æ–°å¯åŠ¨ç®¡é“ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> -SIGHUP <span class="variable">$logstash_pid</span></span><br></pre></td></tr></table></figure>

<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><p><strong><a href="https://github.com/elastic/logstash/blob/master/config/pipelines.yml" target="_blank" rel="noopener">Pipelines å‚æ•°</a></strong></p>
</li>
<li><p><strong><a href="https://www.elastic.co/guide/en/logstash/6.7/multiple-pipelines.html" target="_blank" rel="noopener">Multiple Pipelines</a></strong></p>
</li>
<li><p><strong><a href="https://www.elastic.co/cn/blog/logstash-multiple-pipelines" target="_blank" rel="noopener">Introducing Multiple Pipelines in Logstash - åŸæ–‡</a></strong></p>
</li>
<li><p><strong><a href="https://www.cnblogs.com/sparkdev/p/11073980.html" target="_blank" rel="noopener">Introducing Multiple Pipelines in Logstash - ä¸­æ–‡</a></strong></p>
</li>
<li><p><strong><a href="https://www.elastic.co/guide/en/logstash/current/reloading-config.html" target="_blank" rel="noopener">Reloading the Config Fileedit </a></strong></p>
</li>
<li><p><a href="http://www.51niux.com/?id=205" target="_blank" rel="noopener"><strong>Logstashè¯¦ç»†è®°å½•ï¼ˆäº”</strong>ï¼‰</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>ELK</category>
      </categories>
      <tags>
        <tag>Logstash</tag>
      </tags>
  </entry>
  <entry>
    <title>Scrapy å¤šä¸ªitemå¯¹åº”ä¸€ä¸ªpipeline</title>
    <url>/2019/12/30/Scrapy-%E5%A4%9A%E4%B8%AAitem%E5%AF%B9%E5%BA%94%E4%B8%80%E4%B8%AApipeline/</url>
    <content><![CDATA[<h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>â€‹        åœ¨åˆ©ç”¨<strong>Scrapy</strong>ç¼–å†™çˆ¬è™«æ—¶,ç»å¸¸ä¼šé‡åˆ°åŒä¸€ä¸ªçˆ¬è™«ä¸­åŒ…å«å¤šä¸ªitem classes, å¹¶ä¸”éœ€è¦åœ¨åŒä¸€ä¸ª<code>pipelines.py</code>ä¸­æ ¹æ®ä¸åŒçš„item classesè¿›è¡Œé€»è¾‘çš„å¤„ç†ã€‚</p>
<p>â€‹        <strong>éœ€æ±‚:</strong> æ•°æ®éœ€è¦åŒæ—¶å‘é€åˆ°ElasticSearchä»¥åŠRedis, å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯item classes,ä¸åŒã€‚å‘é€åˆ°Redisçš„æ•°æ®æ˜¯æ ‡å‡†åŒ–ä¹‹åçš„æ•°æ®, å‘é€åˆ°ElasticSearchæ˜¯åŸå§‹çš„æ•°æ®ã€‚</p>
<p>â€‹        <strong>è§£å†³æ–¹æ³•:</strong> è¿™é‡Œå¯ä»¥é€šè¿‡<code>isinstance</code>æ¥è¿›è¡ŒåŒºåˆ†ã€‚</p>
<h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define your item pipelines here</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Don't forget to add your pipeline to the ITEM_PIPELINES setting</span></span><br><span class="line"><span class="comment"># See: https://doc.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tb.items <span class="keyword">import</span> RedisItem</span><br><span class="line"><span class="keyword">from</span> tb.items <span class="keyword">import</span> ElasticSearchItem</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisPipeline</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(item, RedisItem):</span><br><span class="line">            <span class="comment"># to do something</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ElasticPipeline</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(item, ElasticSearchItem):</span><br><span class="line">            <span class="comment"># to do something</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>

<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><strong><a href="https://stackoverflow.com/questions/32743469/scrapy-python-multiple-item-classes-in-one-pipeline" target="_blank" rel="noopener">Scrapy, Python: Multiple Item Classes in one pipeline?</a></strong></li>
<li><strong><a href="https://blog.csdn.net/sinat_32651363/article/details/79092431" target="_blank" rel="noopener">ScrapyåŒä¸€ä¸ªçˆ¬è™«é‡ŒåŒ…å«ä¸åŒitemï¼Œpipelinesæ–‡ä»¶ç¼–å†™</a></strong></li>
</ul>
]]></content>
      <categories>
        <category>Spider</category>
      </categories>
      <tags>
        <tag>Scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis Key è¿‡æœŸäº‹ä»¶è®¢é˜…</title>
    <url>/2019/12/24/Redis-Key-%E8%BF%87%E6%9C%9F%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85/</url>
    <content><![CDATA[<h3 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h3><p>â€‹        åœ¨è‡ªå»ºä¼ä¸šå†…éƒ¨å¨èƒæƒ…æŠ¥çš„è¿‡ç¨‹ä¸­, éœ€è¦é€šè¿‡<strong>Redis</strong>ç»Ÿä¸€ç®¡ç†è¿‡æœŸæ—¶é—´çš„<strong>Key</strong>ã€‚å› æ­¤éœ€è¦å¯¹è¿‡æœŸçš„<strong>Key</strong>è¿›è¡Œå®æ—¶ç›‘å¬, å¹¶è¿›è¡Œå›è°ƒå¤„ç†ã€‚</p>
<h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>â€‹        åœ¨ <strong>Redis</strong> çš„ <strong>2.8.0</strong> ç‰ˆæœ¬ä¹‹åï¼Œå…¶æ¨å‡ºäº†ä¸€ä¸ªæ–°çš„ç‰¹æ€§â€”â€”é”®ç©ºé—´æ¶ˆæ¯ï¼ˆRedis Keyspace Notificationsï¼‰ï¼Œå®ƒé…åˆ 2.0.0 ç‰ˆæœ¬ä¹‹åçš„ SUBSCRIBE å°±èƒ½å®Œæˆè¿™ä¸ªå®šæ—¶ä»»åŠ¡çš„æ“ä½œäº†ã€‚</p>
<p><strong>Redis çš„é”®ç©ºé—´é€šçŸ¥æ”¯æŒ è®¢é˜…æŒ‡å®š Key çš„æ‰€æœ‰äº‹ä»¶ ä¸ è®¢é˜…æŒ‡å®šäº‹ä»¶ ä¸¤ç§æ–¹å¼ã€‚</strong></p>
<blockquote>
<p>Keyspace notifications are implemented sending two distinct type of events for every operation affecting the Redis data space. For instance a DEL operation targeting the key named mykey in database 0 will trigger the delivering of two messages, exactly equivalent to the following two PUBLISH commands:</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUBLISH __keyspace@0__:mykey del</span><br><span class="line">PUBLISH __keyevent@0__:del mykey</span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡ Redis çš„é”®ç©ºé—´é€šçŸ¥ï¼ˆkeyspace notificationï¼‰å¯ä»¥åšåˆ°ï¼šå°†IoCæ•°æ®å†™å…¥Redisï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´10åˆ†é’Ÿï¼Œåˆ©ç”¨ Redis é”®è¿‡æœŸå›è°ƒæé†’ï¼Œå¦‚æœæœªè¢«æ¶ˆè´¹ï¼Œåˆ™è¿›è¡Œå¤„ç†ã€‚</strong></p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><h4 id="1-ä¿®æ”¹-redis-conf-å¼€å¯redis-keyè¿‡æœŸæé†’"><a href="#1-ä¿®æ”¹-redis-conf-å¼€å¯redis-keyè¿‡æœŸæé†’" class="headerlink" title="1. ä¿®æ”¹ redis.conf å¼€å¯redis keyè¿‡æœŸæé†’"></a>1. ä¿®æ”¹ redis.conf å¼€å¯redis keyè¿‡æœŸæé†’</h4><blockquote>
<p>By default keyspace events notifications are disabled because while not very sensible the feature uses some CPU power. Notifications are enabled using the notify-keyspace-events of redis.conf or via the CONFIG SET.</p>
</blockquote>
<p>ç”±äºé”®ç©ºé—´é€šçŸ¥æ¯”è¾ƒè€—CPU, æ‰€ä»¥ Redisé»˜è®¤æ˜¯å…³é—­é”®ç©ºé—´äº‹ä»¶é€šçŸ¥çš„ï¼Œ éœ€è¦æ‰‹åŠ¨å¼€å¯ <code>notify-keyspace-events</code>åæ‰å¯ä½œç”¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Kï¼škeyspaceäº‹ä»¶ï¼Œäº‹ä»¶ä»¥__keyspace@&lt;db&gt;__ä¸ºå‰ç¼€è¿›è¡Œå‘å¸ƒï¼›        </span><br><span class="line">Eï¼škeyeventäº‹ä»¶ï¼Œäº‹ä»¶ä»¥__keyevent@&lt;db&gt;__ä¸ºå‰ç¼€è¿›è¡Œå‘å¸ƒï¼›        </span><br><span class="line">gï¼šä¸€èˆ¬æ€§çš„ï¼Œéç‰¹å®šç±»å‹çš„å‘½ä»¤ï¼Œæ¯”å¦‚delï¼Œexpireï¼Œrenameç­‰ï¼›       </span><br><span class="line">$ï¼šString ç‰¹å®šå‘½ä»¤ï¼›        </span><br><span class="line">lï¼šList ç‰¹å®šå‘½ä»¤ï¼›        </span><br><span class="line">sï¼šSet ç‰¹å®šå‘½ä»¤ï¼›        </span><br><span class="line">hï¼šHash ç‰¹å®šå‘½ä»¤ï¼›        </span><br><span class="line">zï¼šSorted ç‰¹å®šå‘½ä»¤ï¼›        </span><br><span class="line">xï¼šè¿‡æœŸäº‹ä»¶ï¼Œå½“æŸä¸ªé”®è¿‡æœŸå¹¶åˆ é™¤æ—¶ä¼šäº§ç”Ÿè¯¥äº‹ä»¶ï¼›        </span><br><span class="line">eï¼šé©±é€äº‹ä»¶ï¼Œå½“æŸä¸ªé”®å› maxmemoreç­–ç•¥è€Œè¢«åˆ é™¤æ—¶ï¼Œäº§ç”Ÿè¯¥äº‹ä»¶ï¼›        </span><br><span class="line">Aï¼šg<span class="variable">$lshzxe</span>çš„åˆ«åï¼Œå› æ­¤â€AKEâ€æ„å‘³ç€æ‰€æœ‰äº‹ä»¶ã€‚</span><br></pre></td></tr></table></figure>

<p><strong><code>notify-keyspace-events Ex</code> è¡¨ç¤ºå¼€å¯é”®è¿‡æœŸäº‹ä»¶æé†’</strong></p>
<p><strong>redis.conf</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># RDB Config</span></span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum no</span><br><span class="line">dir ./</span><br><span class="line"><span class="comment"># AOF Config</span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"><span class="comment"># set Password</span></span><br><span class="line">requirepass %&#123;mypassword&#125;</span><br><span class="line"><span class="comment"># set notify-keyspace-events</span></span><br><span class="line">notify-keyspace-events Ex</span><br></pre></td></tr></table></figure>

<h4 id="2-RedisHelper"><a href="#2-RedisHelper" class="headerlink" title="2. RedisHelper"></a>2. RedisHelper</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># Author: Canon</span></span><br><span class="line"><span class="comment"># Date: 2019-12-27</span></span><br><span class="line"><span class="comment"># Version: 0.2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisHelper</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># è¿æ¥Redis</span></span><br><span class="line">        self.__conn = redis.Redis(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">6379</span>, password=<span class="string">'mypassword'</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># å®šä¹‰keyevent, æ­¤å¤„0ä¸ºindexdb</span></span><br><span class="line">        self.keyevent = <span class="string">'__keyevent@0__:expired'</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># å‘å¸ƒæ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">publish</span><span class="params">(self, key, msg)</span>:</span></span><br><span class="line">        ttl = <span class="number">10</span></span><br><span class="line">        self.__conn.setex(key, msg, ttl)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¢é˜…æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">subscribe</span><span class="params">(self)</span>:</span></span><br><span class="line">        sub = self.__conn.pubsub()</span><br><span class="line">        sub.subscribe(self.keyevent)</span><br><span class="line">        <span class="keyword">for</span> msg <span class="keyword">in</span> sub.listen():</span><br><span class="line">            <span class="keyword">if</span> msg[<span class="string">'type'</span>] == <span class="string">'message'</span>:</span><br><span class="line">                ex_key = msg[<span class="string">'data'</span>].decode()</span><br><span class="line">                print(ex_key)</span><br></pre></td></tr></table></figure>

<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul>
<li><p><strong><a href="https://crazyfzw.github.io/2019/03/26/redis-keyspace-notifications/" target="_blank" rel="noopener">è®¢é˜… Redis çš„ key è¿‡æœŸäº‹ä»¶å®ç°åŠ¨æ€å®šæ—¶ä»»åŠ¡</a></strong></p>
</li>
<li><p><strong><a href="https://segmentfault.com/a/1190000016898228" target="_blank" rel="noopener">pythonå¼€å‘-å®ç°redisä¸­çš„å‘å¸ƒè®¢é˜…åŠŸèƒ½</a></strong></p>
</li>
</ul>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Scrapyd + Scrapyd-Client</title>
    <url>/2019/12/19/Scrapyd%20+%20Scrapyd-Client/</url>
    <content><![CDATA[<h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><p>â€‹        ç”±äºç½‘ç«™æ—¶å¸¸é­å—é»‘å®¢æ”»å‡», ç°å‡†å¤‡å°†æ‰‹å¤´ä¸€äº›æ”»å‡»è€…çš„IPåœ°å€æ”¶é›†èµ·æ¥ç”¨åšä¼ä¸šå†…éƒ¨çš„å¨èƒæƒ…æŠ¥ã€‚æ—¢ç„¶è¦ç€æ‰‹åšå¨èƒæƒ…æŠ¥, é‚£ä¹ˆå°±é¿å…ä¸äº†é€šè¿‡ä¸€äº›ç½‘ç«™è¿›è¡Œæ•°æ®çš„ä¸°å¯ŒåŒ–ã€‚è¦æƒ³ç®€å•çœäº‹å„¿, å½“ç„¶æ˜¯ä½¿ç”¨è´­ä¹°apiè´¦å·çš„æ–¹å¼,ä¸è¿‡æœ‰çš„apiä¹Ÿå¾ˆå‘, é™¤éè´­ä¹°çš„æ˜¯ä¼ä¸šç‰ˆ, å¦åˆ™ä¸ªäººç‰ˆçš„apiä¼šå—åˆ°è¯·æ±‚é€Ÿç‡çš„é™åˆ¶ã€‚æ‰€ä»¥è¿™è¾¹åªèƒ½ä¾é çˆ¬è™«(<strong>Scrapy</strong>)æ¥æ”¶é›†æ•°æ®ã€‚ä½†æ˜¯é‡‡ç”¨äº†åˆ†å¸ƒå¼çˆ¬è™«, å°±é¿å…ä¸äº†éœ€è¦è¿›è¡Œé›†ä¸­ç®¡ç†, ä»¥åŠç»Ÿä¸€ä¸‹ç­‰æ“ä½œã€‚ä¸‹é¢å°±è¯´ä¸‹åˆ©ç”¨<strong>Scrapy</strong>å®˜æ–¹æä¾›çš„çˆ¬è™«ç®¡ç†å·¥å…·(<strong>Scrapyd</strong>)æ¥æ»¡è¶³ä»¥ä¸Šçš„éœ€æ±‚ã€‚</p>
<h1 id="Scrapyd"><a href="#Scrapyd" class="headerlink" title="Scrapyd"></a>Scrapyd</h1><p>â€‹        <strong>Scrapyd</strong>æ˜¯ç”±<strong>Scrapy</strong> å®˜æ–¹æä¾›çš„çˆ¬è™«ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨å®ƒæˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°ä¸Šä¼ ã€æ§åˆ¶çˆ¬è™«å¹¶ä¸”æŸ¥çœ‹è¿è¡Œæ—¥å¿—ã€‚</p>
<p><strong>å®‰è£…</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install scrapyd</span><br></pre></td></tr></table></figure>

<p><strong>å¯åŠ¨</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ scrapyd</span><br><span class="line">2019-12-19T10:56:06+0800 [-] Loading /Users/canon/anaconda3/lib/python3.7/site-packages/scrapyd/txapp.py...</span><br><span class="line">2019-12-19T10:56:06+0800 [-] Scrapyd web console available at http://127.0.0.1:6800/</span><br><span class="line">2019-12-19T10:56:06+0800 [-] Loaded.</span><br><span class="line">2019-12-19T10:56:06+0800 [twisted.scripts._twistd_unix.UnixAppLogger<span class="comment">#info] twistd 18.9.0 (/Users/canon/anaconda3/bin/python 3.7.1) starting up.</span></span><br><span class="line">2019-12-19T10:56:06+0800 [twisted.scripts._twistd_unix.UnixAppLogger<span class="comment">#info] reactor class: twisted.internet.selectreactor.SelectReactor.</span></span><br><span class="line">2019-12-19T10:56:06+0800 [-] Site starting on 6800</span><br><span class="line">2019-12-19T10:56:06+0800 [twisted.web.server.Site<span class="comment">#info] Starting factory &lt;twisted.web.server.Site object at 0x109efcf98&gt;</span></span><br><span class="line">2019-12-19T10:56:06+0800 [Launcher] Scrapyd 1.2.1 started: max_proc=48, runner=<span class="string">'scrapyd.runner'</span></span><br></pre></td></tr></table></figure>

<p>â€‹        <strong>Scrapyd</strong>æ˜¯ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªå®¢æˆ·ç«¯(<strong>Scrapyd-Client</strong>)å°†çˆ¬è™«é¡¹ç›®å‘é€åˆ°<strong>Scrapyd</strong>æœåŠ¡ä¸­å»ã€‚è¿™é‡Œå…ˆä¿®æ”¹ä¸€ä¸‹<strong>Scrapyd</strong>æœåŠ¡åœ°å€ï¼Œé»˜è®¤<strong>Scrapyd</strong>å¯åŠ¨æ˜¯é€šè¿‡å‘½ä»¤: <code>Scrapyd</code>å°±å¯ä»¥ç›´æ¥å¯åŠ¨ï¼Œé»˜è®¤ç»‘å®šçš„ipåœ°å€æ˜¯<em>127.0.0.1</em>ç«¯å£æ˜¯:<em>6800</em>ï¼Œè¿™é‡Œä¸ºäº†å…¶ä»–ä¸»æœºå¯ä»¥è®¿é—®ï¼Œéœ€å°†ipåœ°å€è®¾ç½®ä¸º<em>0.0.0.0</em>ã€‚</p>
<p>â€‹         æ ¹æ®ä¸Šå›¾å¯åŠ¨çš„ä¿¡æ¯, å¯ä»¥çœ‹åˆ°é»˜è®¤é…ç½®æ–‡ä»¶æ˜¯åœ¨<code>/Users/canon/anaconda3/lib/python3.7/site-packages/scrapyd/</code>ä¸­ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim default_scrapyd.conf</span><br><span class="line"></span><br><span class="line">[scrapyd]</span><br><span class="line">eggs_dir    = eggs</span><br><span class="line">logs_dir    = logs</span><br><span class="line">items_dir   =</span><br><span class="line">jobs_to_keep = 5</span><br><span class="line">dbs_dir     = dbs</span><br><span class="line">max_proc    = 0</span><br><span class="line">max_proc_per_cpu = 4</span><br><span class="line">finished_to_keep = 100</span><br><span class="line">poll_interval = 5.0</span><br><span class="line">bind_address = 0.0.0.0</span><br><span class="line">http_port   = 6800</span><br><span class="line">debug       = off</span><br><span class="line">runner      = scrapyd.runner</span><br><span class="line">application = scrapyd.app.application</span><br><span class="line">launcher    = scrapyd.launcher.Launcher</span><br><span class="line">webroot     = scrapyd.website.Root</span><br><span class="line"></span><br><span class="line">[services]</span><br><span class="line">schedule.json     = scrapyd.webservice.Schedule</span><br><span class="line">cancel.json       = scrapyd.webservice.Cancel</span><br><span class="line">addversion.json   = scrapyd.webservice.AddVersion</span><br><span class="line">listprojects.json = scrapyd.webservice.ListProjects</span><br><span class="line">listversions.json = scrapyd.webservice.ListVersions</span><br><span class="line">listspiders.json  = scrapyd.webservice.ListSpiders</span><br><span class="line">delproject.json   = scrapyd.webservice.DeleteProject</span><br><span class="line">delversion.json   = scrapyd.webservice.DeleteVersion</span><br><span class="line">listjobs.json     = scrapyd.webservice.ListJobs</span><br><span class="line">daemonstatus.json = scrapyd.webservice.DaemonStatus</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Scrapyd-Client"><a href="#Scrapyd-Client" class="headerlink" title="Scrapyd-Client"></a>Scrapyd-Client</h1><p>â€‹        <strong>Scrapyd-Client</strong>å¯ä»¥ç”¨æ¥éƒ¨ç½²<strong>Scrapy</strong>é¡¹ç›®ï¼Œå®ƒä¼šå¸®æˆ‘ä»¬æŠŠé¡¹ç›®æ‰“åŒ…æˆ<strong>egg</strong>æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¸ç”¨å†åŠ¨æ‰‹è°ƒç”¨<code>add version.json</code>æ¥å£å»éƒ¨ç½²åˆ°<strong>Scrapyd</strong>ï¼Œæ“ä½œç®€å•ã€‚</p>
<p><strong>å®‰è£…</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install scrapyd-client</span><br></pre></td></tr></table></figure>

<p><strong>é…ç½®</strong></p>
<p>â€‹        è¦éƒ¨ç½²<strong>Scrapy</strong>é¡¹ç›®ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¿®æ”¹é¡¹ç›®çš„é…ç½®æ–‡ä»¶ã€‚é¦–å…ˆåˆ‡æ¢è‡³é¡¹ç›®æ ¹ç›®å½•, ä¼šçœ‹åˆ°æœ‰ä¸€ä¸ª<code>scrapy.cfg</code>æ–‡ä»¶ï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Automatically created by: scrapy startproject</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information about the [deploy] section see:</span></span><br><span class="line"><span class="comment"># https://scrapyd.readthedocs.io/en/latest/deploy.html</span></span><br><span class="line"></span><br><span class="line">[settings]</span><br><span class="line">default = spider_ti.settings</span><br><span class="line"></span><br><span class="line">[deploy]</span><br><span class="line"><span class="comment">#url = http://localhost:6800/</span></span><br><span class="line">project = spider_ti</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦é…ç½®ä¸€ä¸‹<code>deploy</code>éƒ¨åˆ†ã€‚ä¾‹å¦‚, æˆ‘ä»¬å°†é¡¹ç›®éƒ¨ç½²åˆ°<em>10.10.10.1</em>çš„<strong>Scrapyd</strong>ä¸Šï¼Œåˆ™ä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[deploy]</span><br><span class="line">url = http://10.10.10.1:6800/</span><br><span class="line">project = spider_ti</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬å†åœ¨<code>scrapy.cf</code>gæ–‡ä»¶æ‰€åœ¨è·¯å¾„æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ scrapyd-deploy</span><br><span class="line"></span><br><span class="line">Packing version 1576725163</span><br><span class="line">Deploying to project <span class="string">"spider_ti"</span> <span class="keyword">in</span> http://localhost:6800/addversion.json</span><br><span class="line">Server response (200):</span><br><span class="line">&#123;<span class="string">"node_name"</span>: <span class="string">"CanondeMacBook-Pro.local"</span>, <span class="string">"status"</span>: <span class="string">"ok"</span>, <span class="string">"project"</span>: <span class="string">"spider_ti"</span>, <span class="string">"version"</span>: <span class="string">"1576725163"</span>, <span class="string">"spiders"</span>: 3&#125;</span><br></pre></td></tr></table></figure>

<p>é¡¹ç›®ç‰ˆæœ¬é»˜è®¤ä¸ºå½“å‰æ—¶é—´æˆ³ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šé¡¹ç›®ç‰ˆæœ¬ï¼Œé€šè¿‡<code>version</code>å‚æ•°ä¼ é€’å³å¯ã€‚ä¾‹å¦‚:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ scrapyd-deploy --version 201912191114</span><br></pre></td></tr></table></figure>

<p>æ³¨: åœ¨Python3çš„Scrapyd 1.2.0ç‰ˆæœ¬ä¸­ï¼Œ<strong>ç‰ˆæœ¬å·ä¸èƒ½æŒ‡å®šä¸ºå¸¦å­—æ¯çš„å­—ç¬¦ä¸²ï¼Œå®ƒä»¬å¿…é¡»ä¸ºçº¯æ•°å­—</strong>ï¼Œå¦åˆ™ä¼šå‡ºç°æŠ¥é”™ã€‚</p>
<p>å¦‚æœæœ‰å¤šå°ä¸»æœºï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®å„å°ä¸»æœºçš„åˆ«åï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ä¸º:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[deploy:vm1]</span><br><span class="line">url = http://10.10.10.1:6800/</span><br><span class="line">project = spider_ti</span><br><span class="line"></span><br><span class="line">[deploy:vm2]</span><br><span class="line">url = http://10.10.10.2:6800/</span><br><span class="line">project = spider_ti</span><br></pre></td></tr></table></figure>

<p>åœ¨æ­¤ç»Ÿä¸€é…ç½®å¤šå°ä¸»æœºï¼Œä¸€å°ä¸»æœºå¯¹åº”ä¸€ç»„é…ç½®ï¼Œåœ¨<code>deploy</code>åé¢åŠ ä¸Šä¸»æœºçš„åˆ«åå³å¯ã€‚å¦‚æœæƒ³å°†é¡¹ç›®éƒ¨ç½²åˆ°IPä¸º<em>10.10.10.2</em>çš„<strong>vm2</strong>ä¸»æœºï¼Œæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">scrapyd-deploy vm2</span><br></pre></td></tr></table></figure>

<p>å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨<code>scrapy.cfg</code>æ–‡ä»¶ä¸­é…ç½®å¥½å„å°ä¸»æœºçš„<strong>Scrapyd</strong>åœ°å€ï¼Œç„¶åè°ƒç”¨<code>scrapyd-deploy</code>å‘½ä»¤åŠ ä¸»æœºåç§°å³å¯å®ç°éƒ¨ç½²ã€‚</p>
<p>å¦‚æœ<strong>Scrapyd</strong>è®¾ç½®äº†è®¿é—®é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ç”¨æˆ·åå’Œå¯†ç çš„é…ç½®ï¼ŒåŒæ—¶ä¿®æ”¹ç«¯å£æˆNginxä»£ç†ç«¯å£ã€‚ä¾‹å¦‚: åœ¨ç¬¬1ç« æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯6801ï¼Œé‚£ä¹ˆè¿™é‡Œå°±éœ€è¦æ”¹æˆ6801ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[deploy:vm1]</span><br><span class="line">url = http://10.10.10.1:6801/</span><br><span class="line">project = spider_ti</span><br><span class="line">username = admin</span><br><span class="line">password = admin</span><br><span class="line"></span><br><span class="line">[deploy:vm2]</span><br><span class="line">url = http://10.10.10.2:6801/</span><br><span class="line">project = spider_ti</span><br><span class="line">username = canon</span><br><span class="line">password = canon</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åŠ å…¥usernameå’Œpasswordå­—æ®µï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨éƒ¨ç½²æ—¶è‡ªåŠ¨è¿›è¡ŒAuthéªŒè¯ï¼Œç„¶åæˆåŠŸå®ç°éƒ¨ç½²ã€‚</p>
<p><strong>è¿è¡Œ</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/schedule.json -d project=spider_ti -d spider=ti</span><br></pre></td></tr></table></figure>

<p><strong>åˆ—å‡ºä»»åŠ¡</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/listjobs.json?project=spider_ti | python -m json.tool</span><br></pre></td></tr></table></figure>

<p><strong>åˆ—å‡ºé¡¹ç›®</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/listprojects.json</span><br></pre></td></tr></table></figure>

<p><strong>åœæ­¢</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/cancel.json -d project=spider_ti -d job=838dec26222311ea8eb6a5eb893a35a5</span><br></pre></td></tr></table></figure>

<p><strong>åˆ é™¤</strong></p>
<ul>
<li><em>ç‰ˆæœ¬</em></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/delversion.json -d project=spider_ti -d version=1576735972</span><br></pre></td></tr></table></figure>

<ul>
<li><em>é¡¹ç›®</em></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/delproject.json -d project=spider_ti</span><br></pre></td></tr></table></figure>

<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="https://juejin.im/post/5b0f8f6f6fb9a00a2364a020" target="_blank" rel="noopener"><strong>åˆ†å¸ƒå¼çˆ¬è™«çš„éƒ¨ç½²ä¹‹Scrapyd-Clientçš„ä½¿ç”¨</strong></a></li>
<li><a href="https://link.jianshu.com/?t=http://scrapyd.readthedocs.org/en/latest/api.html" target="_blank" rel="noopener"><strong>Scrapyd</strong></a></li>
</ul>
]]></content>
      <categories>
        <category>Spider</category>
      </categories>
      <tags>
        <tag>Scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>Suricata Custom Rules</title>
    <url>/2019/10/31/Suricata%20-%20Rules/</url>
    <content><![CDATA[<h1 id="Solr-RCE-CVE-2019-0193"><a href="#Solr-RCE-CVE-2019-0193" class="headerlink" title="Solr RCE CVE-2019-0193"></a>Solr RCE CVE-2019-0193</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Solr POST RCE CVE-2019-0193</span></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">"LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 POST"</span>; flow:to_server,established; flowbits:<span class="built_in">set</span>,CVE-2019-0193.post.request; content:<span class="string">"POST"</span>; http_method; fast_pattern; content:<span class="string">"/solr"</span>; http_uri; content:<span class="string">"/config"</span>; http_uri; content:<span class="string">"params.resource.loader.enabled"</span>; http_client_body; classtype:shellcode-detect; sid:3020016; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br><span class="line"></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">"LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 POST Successful"</span>; flow:from_server,established; flowbits:isset,CVE-2019-0193.post.request; content:<span class="string">"200"</span>; http_stat_code; classtype:shellcode-detect; sid:3020017; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Solr GET RCE CVE-2019-0193</span></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">"LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 GET"</span>; flow:to_server,established; flowbits:<span class="built_in">set</span>,CVE-2019-0193.get.request; content:<span class="string">"GET"</span>; http_method; content:<span class="string">"/solr"</span>; http_uri; fast_pattern; content:<span class="string">"/select?"</span>; http_uri; content:<span class="string">"wt=velocity"</span>; http_uri; content:<span class="string">"java.lang.Runtime"</span>; http_uri; content:<span class="string">"getRuntime().exec"</span>; http_uri; classtype:shellcode-detect; sid:3020018; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br><span class="line"></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">"LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 GET Successful"</span>; flow:from_server,established; flowbits:isset,CVE-2019-0193.get.request; content:<span class="string">"200"</span>; http_stat_code; classtype:shellcode-detect; sid:3020019; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>Suricata + Luaå®ç°æœ¬åœ°æƒ…æŠ¥å¯¹æ¥</title>
    <url>/2019/10/24/Suricata+Lua%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E6%83%85%E6%8A%A5%E5%AF%B9%E6%8E%A5/</url>
    <content><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>â€‹        ç”±äºè¿‘æœŸç½‘ç«™é­å—æ¶æ„æ”»å‡», é€šè¿‡å¯¹äºç™»å½•æ¥å£çš„å®¡è®¡ä¸åˆ†æ, ç°å·²ç¡®å®šäº†ä¸€æ‰¹å¯ç–‘è´¦å·ã€‚æ—¢ç„¶ä¹‹å‰å†™è¿‡ä¸€ä¸ªç™»å½•æ¥å£çš„å®¡è®¡è„šæœ¬, é‚£ä¹ˆå®Œå…¨å¯ä»¥é€šè¿‡æ‰©å±•è¿™ä¸ªè„šæœ¬æ¥å®ç°å¯¹äºå¯ç–‘è´¦å·çš„æ¯”å¯¹ã€‚ä¸»è¦æ€è·¯: é€šè¿‡å°†å¯ç–‘è´¦å·å­˜è¿›Redisä¸­, å†åˆ©ç”¨Luaè„šæœ¬è°ƒç”¨Redisæ¥å£è¿›è¡Œè´¦å·çš„æ¯”å¯¹ã€‚</p>
<p>å…ˆè¯´ä¸€ä¸‹<strong>Suricata</strong>é»˜è®¤æ˜¯å­˜åœ¨é»‘åå•æœºåˆ¶çš„, å¦‚ä¸‹:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># IP Reputation</span></span><br><span class="line"><span class="comment">#reputation-categories-file: /etc/suricata/iprep/categories.txt</span></span><br><span class="line"><span class="comment">#default-reputation-path: /etc/suricata/iprep</span></span><br><span class="line"><span class="comment">#reputation-files:</span></span><br><span class="line"><span class="comment"># - reputation.list</span></span><br></pre></td></tr></table></figure>

<p>åœ¨<strong>Suricata 5.0</strong> ç‰ˆæœ¬ä¸­æ›´æ˜¯å¢åŠ äº†æ–°çš„åŠŸèƒ½<strong><a href="https://suricata.readthedocs.io/en/suricata-5.0.0/rules/datasets.html" target="_blank" rel="noopener">Datasets</a></strong>ã€‚å¤§æ¦‚çœ‹äº†ä¸€ä¸‹, å¯ä»¥é€šè¿‡åœ¨è§„åˆ™ä¸­ä½¿ç”¨<code>dataset</code>å’Œ<code>datarep</code>å…³é”®å­—å°†å¤§é‡æ•°æ®ä¸<code>sticky buffer</code>è¿›è¡ŒåŒ¹é…ã€‚ç¡®å®æ˜¯ä¸ªå¾ˆèµçš„åŠŸèƒ½!</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">alert http any any -&gt; any any (http.user_agent; dataset:<span class="built_in">set</span>, ua-seen, <span class="built_in">type</span> string, save ua-seen.lst; sid:1;)</span><br><span class="line"></span><br><span class="line">alert dns any any -&gt; any any (dns.query; to_sha256; dataset:<span class="built_in">set</span>, dns-sha256-seen, <span class="built_in">type</span> sha256, save dns-sha256-seen.lst; sid:2;)</span><br><span class="line"></span><br><span class="line">alert http any any -&gt; any any (http.uri; to_md5; dataset:isset, http-uri-md5-seen, <span class="built_in">type</span> md5, load http-uri-md5-seen.lst; sid:3;)</span><br></pre></td></tr></table></figure>

<p><strong>ä½†æ˜¯</strong>â€¦ è¿™å¹¶ä¸é€‚ç”¨æˆ‘ç°åœ¨çš„åœºæ™¯, å› ä¸ºåœ¨æˆ‘çš„åœºæ™¯ä¸­, ç”¨æˆ·çš„ç™»å½•è¯·æ±‚å­˜åœ¨äºPOSTè¯·æ±‚ä¸­, é»˜è®¤çš„Suricataæ–¹æ³•å¹¶ä¸èƒ½å‡†ç¡®å®šä½åˆ°æˆ‘ä»¬éœ€è¦çš„è´¦å·ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±åªèƒ½ä¾èµ–äº<strong>Lua</strong>è„šæœ¬æ¥æ‰©å±•ã€‚å½“ç„¶è¿™äº›éœ€æ±‚<strong>Zeek</strong>ä¹Ÿå¯ä»¥æ»¡è¶³, åªæ˜¯â€¦<strong>Zeek</strong>çš„è„šæœ¬çœŸæ˜¯éš¾å†™â€¦ä¸å¿åæ§½~</p>
<h1 id="å‡†å¤‡é˜¶æ®µ"><a href="#å‡†å¤‡é˜¶æ®µ" class="headerlink" title="å‡†å¤‡é˜¶æ®µ"></a>å‡†å¤‡é˜¶æ®µ</h1><h2 id="è¿è¡Œç¯å¢ƒ"><a href="#è¿è¡Œç¯å¢ƒ" class="headerlink" title="è¿è¡Œç¯å¢ƒ"></a>è¿è¡Œç¯å¢ƒ</h2><p>â€‹    <strong>OS</strong>: <em>Ubuntu 18.04</em></p>
<p>â€‹    <strong>Suricata</strong>: <em>Suricata 5.0.0 RELEASE</em></p>
<h2 id="LuaRocks"><a href="#LuaRocks" class="headerlink" title="LuaRocks"></a>LuaRocks</h2><ol>
<li>ç”±äºUbuntué»˜è®¤æ²¡æœ‰å®‰è£…<strong><a href="https://luarocks.org/" target="_blank" rel="noopener">LuaRocks</a></strong> (<em>LuaRocks is the package manager for Lua modules</em>), è¿™é‡Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å®‰è£…ã€‚</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡aptç›´æ¥å®‰è£…, ç®€å•çœäº‹å„¿ã€‚</span></span><br><span class="line">$ apt-get install luarocks</span><br></pre></td></tr></table></figure>

<hr>
<ol start="2">
<li>é€šè¿‡<code>luarocks</code>å®‰è£…æˆ‘ä»¬æ‰€éœ€è¦çš„<code>lua</code>æ¨¡å—, è¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°<code>redis-lua</code>ã€<code>luasocket</code>è¿™ä¸¤ä¸ªæ¨¡å—ã€‚</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Install Modules</span></span><br><span class="line">$ luarocks install luasocket</span><br><span class="line">$ luarocks install redis-lua</span><br><span class="line"></span><br><span class="line">$ ll /usr/<span class="built_in">local</span>/share/lua/5.1/</span><br><span class="line">total 72</span><br><span class="line">drwxr-xr-x 3 root root  4096 Oct 25 03:35 ./</span><br><span class="line">drwxr-xr-x 3 root root  4096 Sep 17 14:14 ../</span><br><span class="line">-rw-r--r-- 1 root root  8331 Oct 25 03:34 ltn12.lua</span><br><span class="line">-rw-r--r-- 1 root root  2487 Oct 25 03:34 mime.lua</span><br><span class="line">-rw-r--r-- 1 root root 35599 Oct 25 03:35 redis.lua</span><br><span class="line">drwxr-xr-x 2 root root  4096 Oct 25 03:34 socket/</span><br><span class="line">-rw-r--r-- 1 root root  4451 Oct 25 03:34 socket.lua</span><br></pre></td></tr></table></figure>

<hr>
<ol start="3">
<li>å®‰è£…æˆåŠŸå,  å¯ä»¥ç®€å•çš„æµ‹è¯•ä¸€ä¸‹ã€‚</li>
</ol>
<ul>
<li>åˆ©ç”¨<strong>Docker</strong>å¯åŠ¨<strong>Redis</strong>å®¹å™¨</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -ti -d -p 6379:6379 redis</span><br></pre></td></tr></table></figure>

<ul>
<li>æµ‹è¯•è„šæœ¬<code>hello_redis.lua</code></li>
</ul>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span> <span class="string">"redis"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> client = redis.connect(<span class="string">"127.0.0.1"</span>, <span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> response = client:ping()</span><br><span class="line"><span class="keyword">if</span> response == <span class="literal">false</span> <span class="keyword">then</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">client:set(<span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> var = client:get(<span class="string">"hello"</span>)</span><br><span class="line"><span class="built_in">print</span>(var)</span><br></pre></td></tr></table></figure>

<ul>
<li>å¯èƒ½ä¼šå­˜åœ¨ç¯å¢ƒå˜é‡ä¸å¯¹å¯¼è‡´çš„æŠ¥é”™</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luajit hello_redis.lua</span><br><span class="line">	luajit: /usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:793: module <span class="string">'socket'</span> not found:</span><br><span class="line">	no field package.preload[<span class="string">'socket'</span>]</span><br><span class="line">	no file <span class="string">'./socket.lua'</span></span><br><span class="line">	no file <span class="string">'/usr/local/share/luajit-2.0.5/socket.lua'</span></span><br><span class="line">	no file <span class="string">'/usr/local/share/lua/5.1/socket.lua'</span></span><br><span class="line">	no file <span class="string">'/usr/local/share/lua/5.1/socket/init.lua'</span></span><br><span class="line">	no file <span class="string">'./socket.so'</span></span><br><span class="line">	no file <span class="string">'/usr/local/lib/lua/5.1/socket.so'</span></span><br><span class="line">	no file <span class="string">'/usr/local/lib/lua/5.1/loadall.so'</span></span><br><span class="line">stack traceback:</span><br><span class="line">	[C]: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">'require'</span></span><br><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:793: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">'create_connection'</span></span><br><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:836: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">'connect'</span></span><br><span class="line">	a.lua:3: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: at 0x56508049e440</span><br></pre></td></tr></table></figure>

<ul>
<li>æ‰§è¡Œ<code>luarocks path --bin</code> å¹¶å°†ç»“æœè¾“å…¥</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luarocks path --bin</span><br><span class="line">Warning: The directory <span class="string">'/home/canon/.cache/luarocks'</span> or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing /usr/<span class="built_in">local</span>/bin/luarocks with sudo, you may want sudo<span class="string">'s -H flag.</span></span><br><span class="line"><span class="string">export LUA_PATH='</span>/home/canon/.luarocks/share/lua/5.1/?.lua;/home/canon/.luarocks/share/lua/5.1/?/init.lua;/usr/<span class="built_in">local</span>/share/lua/5.1/?.lua;/usr/<span class="built_in">local</span>/share/lua/5.1/?/init.lua;./?.lua;/usr/<span class="built_in">local</span>/share/luajit-2.0.5/?.lua<span class="string">'</span></span><br><span class="line"><span class="string">export LUA_CPATH='</span>/home/canon/.luarocks/lib/lua/5.1/?.so;/usr/<span class="built_in">local</span>/lib/lua/5.1/?.so;./?.so;/usr/<span class="built_in">local</span>/lib/lua/5.1/loadall.so<span class="string">'</span></span><br><span class="line"><span class="string">export PATH='</span>/home/canon/.luarocks/bin:/usr/<span class="built_in">local</span>/bin:/home/canon/anaconda3/bin:/home/canon/anaconda3/condabin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin<span class="string">'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æ‰§è¡Œè„šæœ¬, å°†ä¼šçœ‹åˆ°å¦‚ä¸‹è¾“å‡º:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luajit hello_redis.lua</span><br><span class="line">world</span><br></pre></td></tr></table></figure>

<h2 id="CJson"><a href="#CJson" class="headerlink" title="CJson"></a>CJson</h2><p>â€‹        è¿™é‡Œ<strong>å¼ºçƒˆå»ºè®®</strong>å¤§å®¶ä½¿ç”¨CJsonæ¨¡å—, æˆ‘ä¹‹å‰ä¸ºäº†æµ‹è¯•éšä¾¿ä»githubä¸Šæ‰¾äº†ä¸ªjsonæ¨¡å—æ¥ä½¿ç”¨ã€‚è¿™å‡ å¤©å‘ç°åœ¨ç½‘ç«™çš„é«˜å³°æ—¶æœŸ Suricata <strong>app_layer.flow</strong> è¿™ä¸ªå­—æ®µéå¸¸çš„å¤§, ä»è€Œå¯¼è‡´äº† <strong>kernel_drops</strong>ã€‚ç”±äºæˆ‘ä»¬çš„ç½‘ç«™æ˜¯é¢å¯¹æµ·å¤–ç”¨æˆ·æœ‰æ—¶å·®, ç»è¿‡å‡ å¤©çš„ç†¬å¤œæœ€ç»ˆå®šä½åˆ°æ˜¯ç”±äºjsonæ¨¡å—å¤ªè¿‡äºæ¶ˆè€—æ€§èƒ½è€Œå¯¼è‡´ã€‚å¯ä»¥çœ‹ä¸‹è¿™ä¸ªæˆªå›¾:</p>
<ul>
<li>å¯ç”¨CJsonæ¨¡å—ä¹‹å‰çš„ç›‘æ§å›¾</li>
</ul>
<p><img src="/2019/10/24/Suricata+Luaå®ç°æœ¬åœ°æƒ…æŠ¥å¯¹æ¥/image-20191104103020962.png" alt="image-20191104103020962"></p>
<ul>
<li>å¯ç”¨CJsonæ¨¡å—ä¹‹åçš„ç›‘æ§å›¾</li>
</ul>
<p><img src="/2019/10/24/Suricata+Luaå®ç°æœ¬åœ°æƒ…æŠ¥å¯¹æ¥/image-20191104103557884.png" alt="image-20191104103557884"></p>
<ol>
<li>ä¸‹è½½CJsonæ¨¡å—</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget ä¸‹è½½</span></span><br><span class="line">$ wget https://www.kyne.com.au/~mark/software/download/lua-cjson-2.1.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># Git</span></span><br><span class="line">$ git <span class="built_in">clone</span> git@github.com:mpx/lua-cjson.git</span><br></pre></td></tr></table></figure>

<hr>
<ol start="2">
<li>æ ¹æ®Luaç¯å¢ƒä¿®æ”¹Makefile(ä¸ªäººé…ç½®)</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">##### Build defaults #####</span></span><br><span class="line">LUA_VERSION =       5.1</span><br><span class="line">TARGET =            cjson.so</span><br><span class="line">PREFIX =            /usr/<span class="built_in">local</span></span><br><span class="line"><span class="comment">#CFLAGS =            -g -Wall -pedantic -fno-inline</span></span><br><span class="line">CFLAGS =            -O3 -Wall -pedantic -DNDEBUG</span><br><span class="line">CJSON_CFLAGS =      -fpic</span><br><span class="line">CJSON_LDFLAGS =     -shared</span><br><span class="line">LUA_INCLUDE_DIR =   $(PREFIX)/include/luajit-2.0</span><br><span class="line">LUA_CMODULE_DIR =   $(PREFIX)/lib/lua/$(LUA_VERSION)</span><br><span class="line">LUA_MODULE_DIR =    $(PREFIX)/share/lua/$(LUA_VERSION)</span><br><span class="line">LUA_BIN_DIR =       $(PREFIX)/bin</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å®‰è£…</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ make</span><br><span class="line">cc -c -O3 -Wall -pedantic -DNDEBUG  -I/usr/<span class="built_in">local</span>/include/luajit-2.0 -fpic -o lua_cjson.o lua_cjson.c</span><br><span class="line">In file included from lua_cjson.c:47:0:</span><br><span class="line">fpconv.h:15:20: warning: inline <span class="keyword">function</span> â€˜fpconv_initâ€™ declared but never defined</span><br><span class="line"> extern inline void fpconv_init();</span><br><span class="line">                    ^~~~~~~~~~~</span><br><span class="line">cc -c -O3 -Wall -pedantic -DNDEBUG  -I/usr/<span class="built_in">local</span>/include/luajit-2.0 -fpic -o strbuf.o strbuf.c</span><br><span class="line">cc -c -O3 -Wall -pedantic -DNDEBUG  -I/usr/<span class="built_in">local</span>/include/luajit-2.0 -fpic -o fpconv.o fpconv.c</span><br><span class="line">cc  -shared -o cjson.so lua_cjson.o strbuf.o fpconv.o</span><br><span class="line"></span><br><span class="line">$ make install</span><br><span class="line">mkdir -p //usr/<span class="built_in">local</span>/lib/lua/5.1</span><br><span class="line">cp cjson.so //usr/<span class="built_in">local</span>/lib/lua/5.1</span><br><span class="line">chmod 755 //usr/<span class="built_in">local</span>/lib/lua/5.1/cjson.so</span><br></pre></td></tr></table></figure>

<h1 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h1><p>æ‰©å±•ç™»å½•æ¥å£å®¡è®¡è„šæœ¬: <code>http_audit.lua</code></p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">json = <span class="built_in">require</span> <span class="string">"cjson.safe"</span></span><br><span class="line">md5 = <span class="built_in">require</span> <span class="string">"md5"</span></span><br><span class="line">redis = <span class="built_in">require</span> <span class="string">"redis"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç™»å½•æ¥å£</span></span><br><span class="line">login_url = <span class="string">"/login"</span></span><br><span class="line"><span class="comment">-- ç™»å½•é”™è¯¯æç¤º</span></span><br><span class="line">success_code = <span class="number">0</span></span><br><span class="line"><span class="comment">-- event_name</span></span><br><span class="line">event_name = <span class="string">"login_audit"</span></span><br><span class="line"><span class="comment">-- event_type</span></span><br><span class="line">event_type = <span class="string">"lua"</span></span><br><span class="line"><span class="comment">-- logs</span></span><br><span class="line">name = <span class="string">"login_audit.json"</span></span><br><span class="line"><span class="comment">-- åè®®</span></span><br><span class="line">proto = <span class="string">"TCP"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- redis_config</span></span><br><span class="line">host = <span class="string">"127.0.0.1"</span></span><br><span class="line">port = <span class="number">6379</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- common_mapping</span></span><br><span class="line">http_common_mapping = <span class="string">'&#123;"accept":"accept","accept-charset":"accept_charset","accept-encoding":"accept_encoding","accept-language":"accept_language","user-agent":"user_agent"&#125;'</span></span><br><span class="line">common_mapping_table = json.decode(http_common_mapping)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- defind functioin</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5Encode</span><span class="params">(args)</span></span></span><br><span class="line">    m = md5.new()</span><br><span class="line">    m:update(args)</span><br><span class="line">    <span class="keyword">return</span> md5.tohex(m:finish())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStr</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    ios = <span class="built_in">string</span>.<span class="built_in">match</span>(args, <span class="string">'canon'</span>)</span><br><span class="line">    <span class="keyword">if</span> ios ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        mail = <span class="string">'email"%s+(.-)%s'</span></span><br><span class="line">        t[<span class="string">'email'</span>] = <span class="built_in">string</span>.<span class="built_in">match</span>(args, mail)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        data = <span class="built_in">string</span>.split(args, <span class="string">'&amp;'</span>)</span><br><span class="line">        <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">            d = <span class="built_in">string</span>.split(v, <span class="string">'='</span>)</span><br><span class="line">            t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.split</span><span class="params">(s, p)</span></span></span><br><span class="line">    rt = &#123;&#125;</span><br><span class="line">    <span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">'[^'</span>..p..<span class="string">']+'</span>, <span class="function"><span class="keyword">function</span><span class="params">(w)</span></span> <span class="built_in">table</span>.<span class="built_in">insert</span>(rt, w) <span class="keyword">end</span> )</span><br><span class="line">    <span class="keyword">return</span> rt</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- default function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(args)</span></span></span><br><span class="line">    <span class="keyword">local</span> needs = &#123;&#125;</span><br><span class="line">    needs[<span class="string">"protocol"</span>] = <span class="string">"http"</span></span><br><span class="line">    <span class="keyword">return</span> needs</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span> <span class="params">(args)</span></span></span><br><span class="line">    filename = SCLogPath() .. <span class="string">"/"</span> .. name</span><br><span class="line">    file = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">"a"</span>))</span><br><span class="line">    SCLogInfo(<span class="string">"app_login_audit filename: "</span> .. filename)</span><br><span class="line">    http = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- Connect Redis Server</span></span><br><span class="line">    SCLogInfo(<span class="string">"Connect Redis Server..."</span>)</span><br><span class="line">    client = redis.connect(host, port)</span><br><span class="line">    response = client:ping()</span><br><span class="line">    <span class="keyword">if</span> response <span class="keyword">then</span></span><br><span class="line">        SCLogInfo(<span class="string">"Redis Server connection succeeded."</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(args)</span></span></span><br><span class="line">    <span class="comment">-- init tables</span></span><br><span class="line">    http_table = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- ti tables</span></span><br><span class="line">    ti = &#123;</span><br><span class="line">        tags = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- init score</span></span><br><span class="line">    score = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_hostname &amp; http_url</span></span><br><span class="line">    http_hostname = HttpGetRequestHost()</span><br><span class="line">    http_url = HttpGetRequestUriNormalized()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- http_method</span></span><br><span class="line">    rl = HttpGetRequestLine()</span><br><span class="line">    <span class="keyword">if</span> rl <span class="keyword">then</span></span><br><span class="line">        http_method = <span class="built_in">string</span>.<span class="built_in">match</span>(rl, <span class="string">"%w+"</span>)</span><br><span class="line">        <span class="keyword">if</span> http_method <span class="keyword">then</span></span><br><span class="line">            http_table[<span class="string">"method"</span>] = http_method</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	</span><br><span class="line">	  <span class="comment">-- ä¸ºäº†ä¿è¯ Suricata çš„æ€§èƒ½ä¸å—å½±å“, ä¸¥æ ¼æ§åˆ¶è¿‡æ»¤æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> http_url == login_url <span class="keyword">and</span> http_method == <span class="string">"POST"</span> <span class="keyword">then</span></span><br><span class="line">        http_table[<span class="string">"hostname"</span>] = http_hostname</span><br><span class="line">        http_table[<span class="string">"url"</span>] = http_url</span><br><span class="line">        http_table[<span class="string">"url_path"</span>] = http_url</span><br><span class="line">        </span><br><span class="line">        <span class="comment">-- http_status &amp; http_protocol</span></span><br><span class="line">        rsl = HttpGetResponseLine()</span><br><span class="line">        <span class="keyword">if</span> rsl <span class="keyword">then</span></span><br><span class="line">            status_code = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"%s(%d+)%s"</span>)</span><br><span class="line">            http_table[<span class="string">"status"</span>] = <span class="built_in">tonumber</span>(status_code)</span><br><span class="line"></span><br><span class="line">            http_protocol = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"(.-)%s"</span>)</span><br><span class="line">            http_table[<span class="string">"protocol"</span>] = http_protocol</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- login_results</span></span><br><span class="line">        a, o, e = HttpGetResponseBody()</span><br><span class="line">        <span class="keyword">if</span> a <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">                body = json.decode(v)</span><br><span class="line">                results_code = <span class="built_in">tonumber</span>(body[<span class="string">"code"</span>])</span><br><span class="line">                <span class="keyword">if</span> results_code == success_code <span class="keyword">then</span></span><br><span class="line">                    http_table[<span class="string">"results"</span>] = <span class="string">"success"</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    http_table[<span class="string">"results"</span>] = <span class="string">"failed"</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            http_table[<span class="string">"results_code"</span>] = results_code</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">--[[</span></span><br><span class="line"><span class="comment">            1. è·å–ç”¨æˆ·ç™»å½•email å¹¶æŸ¥è¯¢ Redisä¸­æ˜¯å¦å­˜åœ¨è¯¥è´¦å·</span></span><br><span class="line"><span class="comment">            2. æ ¹æ®ç»“æœè¿›è¡Œç›¸åº”çš„æ‰“åˆ†ä»¥åŠtagsæ ‡æ³¨</span></span><br><span class="line"><span class="comment">        ]]</span></span><br><span class="line">        <span class="comment">-- </span></span><br><span class="line">        a, o, e = HttpGetRequestBody()</span><br><span class="line">        <span class="keyword">if</span> a <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">                res = formatStr(v)</span><br><span class="line">                <span class="keyword">if</span> res[<span class="string">"email"</span>] <span class="keyword">then</span></span><br><span class="line">                    <span class="comment">-- æŸ¥è¯¢Rediså¯¹æ¯”é»‘åå•</span></span><br><span class="line">                    black_ioc = client:get(res[<span class="string">"email"</span>])</span><br><span class="line">                    <span class="keyword">if</span> black_ioc <span class="keyword">then</span></span><br><span class="line">                        ti[<span class="string">"provider"</span>] = <span class="string">"Canon"</span></span><br><span class="line">                        ti[<span class="string">"producer"</span>] = <span class="string">"NTA"</span></span><br><span class="line">                        <span class="built_in">table</span>.<span class="built_in">insert</span>(ti[<span class="string">"tags"</span>], <span class="string">"account in blacklist"</span>)</span><br><span class="line">                        score = score + <span class="number">10</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- RequestHeaders</span></span><br><span class="line">        rh = HttpGetRequestHeaders()</span><br><span class="line">        <span class="keyword">if</span> rh <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rh) <span class="keyword">do</span></span><br><span class="line">                key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line">                request_var = request_mapping_table[key]</span><br><span class="line">                <span class="keyword">if</span> request_var <span class="keyword">then</span></span><br><span class="line">                    http_table[request_var] = v</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- ResponseHeaders</span></span><br><span class="line">        rsh = HttpGetResponseHeaders()</span><br><span class="line">        <span class="keyword">if</span> rsh <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rsh) <span class="keyword">do</span></span><br><span class="line">                key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line">                response_var = response_mapping_table[key]</span><br><span class="line">                <span class="keyword">if</span> response_var <span class="keyword">then</span></span><br><span class="line">                    http_table[response_var] = v</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- timestring</span></span><br><span class="line">        sec, usec = SCPacketTimestamp()</span><br><span class="line">        timestring = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">"!%Y-%m-%dT%T"</span>, sec) .. <span class="string">'.'</span> .. usec .. <span class="string">'+0000'</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">-- flow_info</span></span><br><span class="line">        ip_version, src_ip, dst_ip, protocol, src_port, dst_port = SCFlowTuple()</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- flow_id</span></span><br><span class="line">        id = SCFlowId()</span><br><span class="line">        flow_id = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%.0f"</span>, id)</span><br><span class="line">        flow_id = <span class="built_in">tonumber</span>(flow_id)</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- true_ip</span></span><br><span class="line">        true_client_ip = HttpGetRequestHeader(<span class="string">"True-Client-IP"</span>)</span><br><span class="line">        <span class="keyword">if</span> true_client_ip ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            src_ip = true_client_ip</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- session_id</span></span><br><span class="line">        tetrad = src_ip .. src_port .. dst_ip .. dst_port</span><br><span class="line">        session_id = md5Encode(tetrad)</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- table</span></span><br><span class="line">        raw_data = &#123;</span><br><span class="line">            timestamp = timestring,</span><br><span class="line">            flow_id = flow_id,</span><br><span class="line">            session_id = session_id,</span><br><span class="line">            src_ip = src_ip,</span><br><span class="line">            src_port = src_port,</span><br><span class="line">            proto = proto,</span><br><span class="line">            dest_ip = dst_ip,</span><br><span class="line">            dest_port = dst_port,</span><br><span class="line">            event_name = event_name,</span><br><span class="line">            event_type = event_type,</span><br><span class="line">            app_type = app_type,</span><br><span class="line">            http = http_table,</span><br><span class="line">            ti = ti,</span><br><span class="line">            score = score</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- json encode</span></span><br><span class="line">        data = json.encode(raw_data)</span><br><span class="line"></span><br><span class="line">        file:<span class="built_in">write</span>(data .. <span class="string">"\n"</span>)</span><br><span class="line">        file:<span class="built_in">flush</span>()</span><br><span class="line"></span><br><span class="line">        http = http + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deinit</span> <span class="params">(args)</span></span></span><br><span class="line">    SCLogInfo (<span class="string">"app_login_audit transactions logged: "</span> .. http);</span><br><span class="line">    file:<span class="built_in">close</span>(file)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>ç®€å•è¯´ä¸‹ä»¥ä¸Šè„šæœ¬çš„åŠŸèƒ½:</strong></p>
<ol>
<li>ç™»å½•æ¥å£çš„ç”¨æˆ·åå®¡è®¡(åºŸè¯â€¦); </li>
<li>é€šè¿‡è¯·æ±‚<strong>Redis</strong>æ¯”å¯¹å½“å‰ç”¨æˆ·æ˜¯å¦åœ¨é»‘åå•ä¸­, å¹¶è¿›è¡Œç›¸åº”çš„æ‰“åˆ†ã€æ ‡ç­¾å¤„ç†;</li>
<li>æ ¹æ®è‡ªå®šä¹‰çš„éœ€æ±‚è·å–çš„http headers, è¿™ä¸ªå¯¹äºä¸šåŠ¡å®‰å…¨ä¸Šè¿˜æ˜¯æœ‰ç‚¹ç”¨çš„;</li>
<li>é’ˆå¯¹<strong>CDN</strong>æˆ–è€…Nginxè¿™ç§åœºæ™¯ä¸‹, å¯ä»¥ç›´æ¥å¯¹ xff æˆ–è€… true_client_ip è¿›è¡Œå››å…ƒç»„çš„hash, å¾—åˆ°<strong>session_id</strong>, è¿™æ ·æº¯æºçš„æ—¶å€™ä¼šæ¯”è¾ƒæ–¹ä¾¿ã€‚å› ä¸ºåœ¨è¿™ç§åœºæ™¯ä¸‹ä¼ ç»Ÿçš„å››å±‚<strong>flow_id</strong>å°±ä¸æ˜¯é‚£ä¹ˆæœ‰ç”¨äº†ã€‚</li>
<li>åç»­å¯ä»¥è¿½åŠ ä¸€äº›ç®€å•çš„æ£€æµ‹æ–¹æ³•, ä¾‹å¦‚:<ol>
<li>æ£€æŸ¥è¯·æ±‚å¤´ä¸­çš„å­—æ®µæ˜¯å¦å®Œæˆ;</li>
<li>æ£€æŸ¥è¯·æ±‚å¤´ä¸­çš„æŸä¸ªå­—æ®µé•¿åº¦æ˜¯å¦ç¬¦åˆåˆè§„;</li>
<li>â€¦â€¦</li>
</ol>
</li>
</ol>
<p><strong>é…ç½®Suricataå¯ç”¨Luaè„šæœ¬</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">- lua:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    scripts-dir:</span> <span class="string">/etc/suricata/lua-output/</span></span><br><span class="line"><span class="attr">    scripts:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">login_audit.lua</span></span><br></pre></td></tr></table></figure>

<p><strong>å¯ç”¨Suricata</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ suricata -vvv --pfring -k none -c /etc/suricata/suricata.yaml</span><br></pre></td></tr></table></figure>

<p><strong><em>æ³¨: è¿™é‡Œ<code>-vvv</code> å‚æ•°å»ºè®®åŠ ä¸Š. å¦‚æœä½ çš„Luaè„šæœ¬æœ‰ä¸€äº›é—®é¢˜, å¦‚æœåŠ ä¸Šäº†è¿™ä¸ªå‚æ•°, å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ—¥å¿—çœ‹å‡ºã€‚</em></strong></p>
<h1 id="æ—¥å¿—æ ·ä¾‹"><a href="#æ—¥å¿—æ ·ä¾‹" class="headerlink" title="æ—¥å¿—æ ·ä¾‹"></a>æ—¥å¿—æ ·ä¾‹</h1><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">62722</span>,</span><br><span class="line">    <span class="attr">"score"</span>: <span class="number">65</span>,</span><br><span class="line">    <span class="attr">"session_id"</span>: <span class="string">"c863aeb2ef8d1b37f3257f8c210bf440"</span>,</span><br><span class="line">    <span class="attr">"ti"</span>: &#123;</span><br><span class="line">        <span class="attr">"tags"</span>: [</span><br><span class="line">            <span class="string">"account in blacklist"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"provider"</span>: <span class="string">"Canon"</span>,</span><br><span class="line">        <span class="attr">"producer"</span>: <span class="string">"NTA"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"alert"</span>: &#123;</span><br><span class="line">        <span class="attr">"alerted"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"rules"</span>: &#123;</span><br><span class="line">            <span class="attr">"è¯·æ±‚å¤´æ ¡éªŒ"</span>: <span class="string">"dev-id"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="string">"1064295903559076"</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-25T08:33:55.585519+0000"</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"lua"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"1.1.1.1"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">80</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"response_content_length"</span>: <span class="string">"96"</span>,</span><br><span class="line">        <span class="attr">"response_content_type"</span>: <span class="string">"application/json; charset=UTF-8"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">        <span class="attr">"results_code"</span>: <span class="number">400504</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"nginx"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Fri, 25 Oct 2019 08:33:55 GMT"</span>,</span><br><span class="line">        <span class="attr">"app_version"</span>: <span class="string">"6.6.0"</span>,</span><br><span class="line">        <span class="attr">"request_content_type"</span>: <span class="string">"application/x-www-form-urlencoded"</span>,</span><br><span class="line">        <span class="attr">"user_agent"</span>: <span class="string">"okhttp/3.12.0"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/login"</span>,</span><br><span class="line">        <span class="attr">"email"</span>: <span class="string">"canon@gmail.com"</span>,</span><br><span class="line">        <span class="attr">"results"</span>: <span class="string">"failed"</span>,</span><br><span class="line">        "pragma": "no-cache",-</span><br><span class="line">        "cache_control": "no-cache, max-age=0, no-store",</span><br><span class="line">        "connection": "keep-alive",</span><br><span class="line">        "status": 200,</span><br><span class="line">        "protocol": "HTTP/1.1",</span><br><span class="line">        "hostname": "x.x.x.x",</span><br><span class="line">        "url_path": "/login",</span><br><span class="line">        "method": "POST",</span><br><span class="line">        "device": "RMX1920 Android8.0.0",</span><br><span class="line">        "device_type": "Android",</span><br><span class="line">        "request_content_length": "39"</span><br><span class="line">    &#125;,</span><br><span class="line">    "event_name": "login_audit",</span><br><span class="line">    "dest_ip": "2.2.2.2"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>Wazuh - é»‘åå•åŒ¹é…å‘Šè­¦(CDB list)</title>
    <url>/2019/10/18/Wazuh-Using-CDB-lists/</url>
    <content><![CDATA[<p><strong>éœ€æ±‚:</strong></p>
<p>â€‹        ç°æœ‰ä¸€æ‰¹é«˜å±ç”¨æˆ·, éœ€è¦å®æ—¶å…³æ³¨è¯¥è´¦å·çš„ç™»å½•æƒ…å†µã€‚ç”±äºä¹‹å‰å·²ç»å†™å¥½äº†ä¸€ä¸ªé’ˆå¯¹ç”¨æˆ·ç™»å½•è´¦å·çš„å®¡è®¡è§„åˆ™, å› æ­¤, è¿™é‡Œéœ€è¦ç”¨åˆ°<strong><a href="https://documentation.wazuh.com/3.10/user-manual/ruleset/cdb-list.html" target="_blank" rel="noopener">Wazuh CDB list</a></strong>è¿™ä¸ªåŠŸèƒ½(<em>æ­¤åŠŸèƒ½ä¸»è¦ç”¨ä¾‹æ˜¯åˆ›å»ºç”¨æˆ·ï¼ŒIPæˆ–åŸŸåçš„ç™½/é»‘åˆ—è¡¨ã€‚</em>)æ¶ˆè´¹å®¡è®¡è§„åˆ™æ•°æ®å³å¯ã€‚</p>
<hr>
<ol>
<li><strong>æ–°å»ºåˆ—è¡¨</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ more blacklist</span><br><span class="line"></span><br><span class="line">admin:</span><br><span class="line">root:</span><br><span class="line">administrator:</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>å°†åˆ—è¡¨æ–‡ä»¶æ·»åŠ åˆ°<code>ossec.conf</code></strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ more ossec.conf</span><br><span class="line"></span><br><span class="line">&lt;ossec_config&gt;</span><br><span class="line">	&lt;ruleset&gt;</span><br><span class="line">    &lt;!-- User-defined CDB list --&gt;</span><br><span class="line">    &lt;list&gt;etc/lists/blacklist&lt;/list&gt;</span><br><span class="line">	&lt;/ruleset&gt;</span><br><span class="line">&lt;/ossec_config&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>ç¼–è¯‘åˆ—è¡¨</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ /var/ossec/bin/ossec-makelists</span><br><span class="line"></span><br><span class="line"> * File etc/lists/blacklist.cdb needs to be updated</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>é‡å¯è¿›ç¨‹</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl restart wazuh-manager</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><strong>é…ç½®è§„åˆ™</strong></li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">"local,blacklist,"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Defind blacklist Rules --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ID: 100150 - 100199 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">"100163"</span> <span class="attr">level</span>=<span class="string">"12"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_sid</span>&gt;</span>100303<span class="tag">&lt;/<span class="name">if_sid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span> <span class="attr">field</span>=<span class="string">"http.email"</span> <span class="attr">lookup</span>=<span class="string">"match_key"</span>&gt;</span>etc/lists/blacklist<span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Wazuh Rules - High-risk user login detected. $(src_ip) -&gt; $(http.email) -&gt; $(http.hostname) -&gt; $(http.url) = $(http.results).<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span>blacklist,<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li><strong>æµ‹è¯•è§„åˆ™</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./ossec-logtest</span><br><span class="line">2019/10/18 15:06:47 ossec-testrule: INFO: Started (pid: 2184).</span><br><span class="line">ossec-testrule: Type one <span class="built_in">log</span> per line.</span><br><span class="line"></span><br><span class="line">**Phase 3: Completed filtering (rules).</span><br><span class="line">       Rule id: <span class="string">'100163'</span></span><br><span class="line">       Level: <span class="string">'12'</span></span><br><span class="line">       Description: <span class="string">'Wazuh Rules - High-risk user login detected. 1.1.1.1 -&gt; admin -&gt; canon88.github.io -&gt; /user/login = success.'</span></span><br><span class="line">**Alert to be generated.</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>HIDS</category>
      </categories>
      <tags>
        <tag>Wazuh</tag>
      </tags>
  </entry>
  <entry>
    <title>æˆ‘åœ¨'äº‘'ä¸Šçš„æ—¥å­ - AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘</title>
    <url>/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/</url>
    <content><![CDATA[<p>â€‹    </p>
<p>â€‹        è‡ªä»AWSåœ¨6æœˆä»½æ–°å‡ºäº†<strong>Traffic Mirroring</strong>åŠŸèƒ½å, æˆ‘ä¹Ÿç®—æ˜¯ç¬¬ä¸€æ—¶é—´ä½¿ç”¨äº†è¿™ä¸ªåŠŸèƒ½ã€‚ä¸ä¼ ç»Ÿçš„äº¤æ¢æœºæµé‡é•œåƒä¸åŒçš„æ˜¯, AWSä¸Šæ˜¯å°†æµé‡é•œåƒåçš„æ•°æ®é€šè¿‡<strong>VXLAN</strong>åè®®å‘é€è‡³æµé‡åˆ†æå¼•æ“(<strong>Suricata</strong>ã€<strong>Zeek</strong>)ã€‚æ­£æ˜¯ç”±äºè¿™ä¸€ç‚¹è®©æˆ‘ç¢°åˆ°äº†ä»¥ä¸‹å‡ ä¸ªé—®é¢˜, è¿™é‡Œå†™å‡ºæ¥å¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚</p>
<ol>
<li>æ¥æ”¶æµé‡é•œåƒçš„ç›®æ ‡ç«¯, ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„æµé‡åˆ†æå¼•æ“ç«¯æ˜¯æœ‰æ¥æ”¶é™åˆ¶çš„ã€‚</li>
</ol>
<p>â€‹       å¦‚æœä½ æ˜¯åœ¨ä¸€ä¸ªéä¸“ç”¨å®ä¾‹ä¸Šéƒ¨ç½²çš„Suricataã€Zeekã€‚é‚£ä¹ˆä½ åªèƒ½æœ€å¤šåŒæ—¶æ¥æ”¶10ä¸ªæºçš„æµé‡é•œåƒ, ä¹Ÿå°±æ˜¯ä½ åªèƒ½æ¥æ”¶10ä¸ªç½‘å¡çš„æ•°æ®ã€‚å¾ˆä¸å·§çš„æ˜¯æˆ‘ä»¬ç¢°ä¸Šäº†è¿™ä¸ªé—®é¢˜, è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•, ä½¿ç”¨ä¸“ç”¨å®ä¾‹(<strong>Dedicated instance</strong>) æˆ–è€… ä½¿ç”¨AWSçš„ç½‘ç»œè´Ÿè½½å‡è¡¡(<strong>Network Load Balancer</strong>)ã€‚å‰è€…å¯ä»¥å°†Limitæå‡åˆ°<strong>100</strong>, åè€…å°†<strong>ä¸å—é™</strong>ã€‚å¦‚å›¾:</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016164935291.png" alt="image-20191016164935291"></p>
<hr>
<ol start="2">
<li>C5ä¸C4å®ä¾‹çš„å·®å¼‚</li>
</ol>
<p>â€‹        å°±æˆ‘ç›®å‰ä½¿ç”¨çš„å®ä¾‹è€Œè¨€, åˆ†åˆ«æµ‹è¯•è¿‡C5 ä¸ C4ä¸¤ç§å®ä¾‹ã€‚ä»–ä»¬çš„ç½‘å¡é©±åŠ¨æœ‰æ‰€åŒºåˆ«çš„, å¦‚å›¾:</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016160923628.png" alt="image-20191016160923628"></p>
<p>â€‹        æˆ‘è¿™ä½¿ç”¨ä¸‹æ¥æœ€ç›´è§‚çš„åŒºåˆ«, åœ¨C4å®ä¾‹ä¸Šè‹¥ä¸ä½¿ç”¨PF_RINGæ•åŒ…æ¨¡å¼çš„è¯, Suricataä¸¢åŒ…ç‡æ„Ÿäºº, 0.5 Gbpså°±å¼€å§‹ä¸¢åŒ…ã€‚æµ‹è¯•çš„æœºå™¨é…ç½®: 32C 60Gçš„æœºå™¨, åˆ‡æ¢åˆ°PF_RINGæ•åŒ…æ¨¡å¼æ— æ­¤é—®é¢˜ã€‚åä¹‹C5å®ä¾‹å°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜, AF-PACKETç›´æ¥ä¸Šåˆ°2 Gbpsçš„çº¯HTTPæµé‡éƒ½æ²¡æœ‰ä¸¢åŒ…ã€‚ç¡¬ä»¶é…ç½®: 16C 32Gçš„æœºå™¨ã€‚</p>
<hr>
<ol start="3">
<li>è¶…è¿‡<strong>MTU: 9001</strong>æ•°æ®åŒ…è¢«æˆªæ–­</li>
</ol>
<p>â€‹      è¿™å‡ å¤©åœ¨æ’æŸ¥å®‰å…¨äº‹ä»¶æ—¶, å‘ç°ç›‘æ§çš„åŒä¸€å°Nginxä¸Šè§£æå‡ºçš„æµé‡(HTTPäº‹ä»¶)ä¸æ—¥å¿—(HTTPäº‹ä»¶)æ•°é‡ç›¸å·®è¾ƒå¤§ã€‚ç»è¿‡ä¸¤å¤©çš„æ’æŸ¥ç»ˆäºå®šä½äº†é—®é¢˜, Suricata kernel å¹¶æ²¡æœ‰ä¸¢åŒ…, æ‰€ä»¥æ€€ç–‘æ˜¯ä¸æ˜¯Suricata HTTPè§£æå‡ºé”™å¯¼è‡´ã€‚æœ€ç»ˆé€šè¿‡æŠ“åŒ…å‘ç°å¯¼è‡´è¯¥é—®é¢˜çš„â€ç½ªé­ç¥¸é¦–â€å°±æ˜¯<strong>VXLAN</strong>, ç”±äºAWSåœ¨æµé‡é•œåƒæ—¶é‡‡ç”¨äº†<strong>VXLAN</strong>åè®®è¿›è¡Œå°è£…, å¯¼è‡´åœ¨åŸæœ‰<strong>MTU</strong>çš„åŸºç¡€ä¸Š<strong>å¢åŠ äº†50ä¸ªå­—èŠ‚</strong>, é€ æˆæ•°æ®åŒ…è¢«æˆªæ–­, æ— æ³•è¿˜åŸå‡ºHTTPäº‹ä»¶ã€‚ä»¥ä¸‹æˆªå›¾å°±æ˜¯ä¸€ä¸ªæ— æ³•è¢«æ­£ç¡®è¿˜åŸHTTPäº‹ä»¶çš„æ•°æ®åŒ…, æˆ‘ç”¨Suricataè½½å…¥æ•°æ®åŒ…å, åªè¿˜åŸå‡ºäº†é•¿åº¦<strong>9015</strong>æ•°æ®åŒ…ä¹‹å‰çš„HTTPä¿¡æ¯, é•¿åº¦<strong>9015</strong>æ•°æ®åŒ…ä¹‹åçš„æ‰€æœ‰äº‹ä»¶å‡æ— æ³•è¢«è¿˜åŸã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191014095249725.png" alt="image-20191014095249725"></p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191014094741753.png" alt="image-20191014094741753"></p>
<p><strong>å®˜æ–¹æè¿°:</strong></p>
<p>â€‹        For example, if an 8996 byte packet is mirrored, and the traffic mirror target MTU value is 9001 bytes, the mirror encapsulation results in the mirrored packet being greater than the MTU value. In this case, the mirror packet is truncated. To prevent mirror packets from being truncated, set the traffic mirror source interface MTU value to 54 bytes less than the traffic mirror target MTU value. For more information about configuring the network MTU value, see Network Maximum Transmission Unit (MTU) for Your EC2 Instance in the <em>Amazon EC2 User Guide for Linux Instances</em>.</p>
<p>â€‹        ä¾‹å¦‚ï¼Œå¦‚æœå¯¹8996å­—èŠ‚çš„æ•°æ®åŒ…è¿›è¡Œäº†é•œåƒï¼Œå¹¶ä¸”æµé‡é•œåƒç›®æ ‡MTUå€¼ä¸º9001å­—èŠ‚ï¼Œåˆ™é•œåƒå°è£…ä¼šå¯¼è‡´é•œåƒçš„æ•°æ®åŒ…å¤§äºMTUå€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé•œåƒæ•°æ®åŒ…å°†è¢«æˆªæ–­ã€‚ä¸ºé˜²æ­¢é•œåƒæ•°æ®åŒ…è¢«æˆªæ–­ï¼Œè¯·å°†æµé‡é•œåƒæºæ¥å£çš„MTUå€¼è®¾ç½®ä¸ºæ¯”æµé‡é•œåƒç›®æ ‡MTUå€¼å°54ä¸ªå­—èŠ‚ã€‚æœ‰å…³é…ç½®ç½‘ç»œMTUå€¼çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…Amazon EC2 Linuxå®ä¾‹ç”¨æˆ·æŒ‡å—ä¸­çš„EC2å®ä¾‹çš„ç½‘ç»œæœ€å¤§ä¼ è¾“å•ä½ï¼ˆMTUï¼‰ã€‚</p>
<hr>
<p><strong>å…³äºVXLANå¯¼è‡´Suricataæ— æ³•æ­£å¸¸è§£ææ•°æ®çš„é—®é¢˜, ç‰¹åœ°è¿›è¡Œäº†æµ‹è¯•:</strong></p>
<p>å‡†å¤‡å·¥ä½œ:</p>
<ul>
<li>æ–°å»ºäº†<strong>test_files</strong>æ–‡ä»¶, è¯¥æ–‡ä»¶åªåŒ…å«å†…å®¹â€™<strong>hello, world!</strong>â€˜;</li>
<li>ä¸ºäº†ä½¿æ•°æ®åŒ…åœ¨ä¼ è¾“æ—¶æ»¡è¶³<strong>MTU: 9001</strong>, æ‰‹åŠ¨ç”Ÿæˆäº†ä¸€ä¸ª10MBç©ºæ–‡ä»¶<strong>10mb_exist_files</strong>. </li>
</ul>
<p>å…±è®¡è®¿é—®: 14æ¬¡</p>
<p>è®¿é—®é¡ºåº:</p>
<ol>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (æ¬¡)</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (æ¬¡)</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (æ¬¡)</li>
</ol>
<p>æ­£å¸¸æƒ…å†µ:</p>
<ul>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (æ¬¡) - æ­£å¸¸</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (æ¬¡) - æ­£å¸¸</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (æ¬¡) - æ­£å¸¸</li>
</ul>
<p>å¼‚å¸¸æƒ…å†µ:</p>
<ul>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (æ¬¡) - æ­£å¸¸</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (æ¬¡) - å¼‚å¸¸</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (æ¬¡) - ä¸¢å¤±</li>
</ul>
<p><strong>MTU: 9001</strong></p>
<ul>
<li>éé•œåƒæµé‡çš„æ•°æ®åŒ…è¯¦æƒ…:</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°ä»æ•°æ®åŒ…<strong>20</strong>åˆ°æ•°æ®åŒ…<strong>6126</strong>ä¹‹é—´éƒ½æ˜¯åœ¨è¿›è¡Œ<strong>10MB</strong>æ–‡ä»¶(<strong>10mb_exist_files</strong>)çš„ä¼ è¾“è¿‡ç¨‹ã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016103409831.png" alt="image-20191016103409831"></p>
<hr>
<p>ä»httpæ•°æ®åŒ…ä¸­å¯ä»¥çœ‹å‡º, è¿™é‡Œè¯·æ±‚åŒ…ä¸å“åº”åŒ…éƒ½å¯ä»¥æ­£å¸¸è¢«è¿˜åŸå‡ºæ¥ã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016104502919.png" alt="image-20191016104502919"></p>
<hr>
<p>æ•°æ®åŒ…åœ¨Suricataä¸Šçš„è§£æç»“æœ:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-15T22:52:10.180505+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">415026399241324</span>,</span><br><span class="line">    <span class="attr">"pcap_cnt"</span>: <span class="number">6127</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43418</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"http_content_type"</span>: <span class="string">"text/html"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress"</span>,</span><br><span class="line">        <span class="attr">"content_length"</span>: <span class="string">"41943044"</span>,</span><br><span class="line">        <span class="attr">"content_type"</span>: <span class="string">"text/html; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Tue, 15 Oct 2019 14:52:10 GMT"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"Werkzeug/0.16.0 Python/2.7.16"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">41943044</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>é•œåƒæµé‡çš„æ•°æ®åŒ…è¯¦æƒ…:</strong>(ä¹Ÿå°±æ˜¯<strong>VXLAN</strong>å°è£…åçš„æ•°æ®åŒ…)</li>
</ul>
<p>åŒæ ·å¯ä»¥çœ‹åˆ°ä»æ•°æ®åŒ…<strong>26</strong>åˆ°æ•°æ®åŒ…<strong>6170</strong>ä¹‹é—´éƒ½æ˜¯åœ¨è¿›è¡Œ<strong>10MB</strong>æ–‡ä»¶(<strong>10mb_exist_files</strong>)çš„ä¼ è¾“è¿‡ç¨‹ã€‚ä½†æ˜¯åœ¨ç¬¬<strong>34</strong>ä¸ªæ•°æ®åŒ…ä¸­å¯ä»¥çœ‹åˆ°, å·²ç»æ ‡æ³¨äº†æ•°æ®è¶…å‡ºäº†æœ€å¤§é•¿åº¦ã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016105636906.png" alt="image-20191016105636906"></p>
<hr>
<p>è¶…å‡ºé•¿åº¦çš„æ•°æ®å°†ä¼šè¢«æˆªæ–­, æ ‡æ³¨: <strong>50 bytes missing in capture file</strong>ã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016150322620.png" alt="image-20191016150322620"></p>
<p>ä»HTTPæ•°æ®åŒ…ä¸­å¯ä»¥çœ‹å‡º, è¿™é‡Œåªæœ‰è¯·æ±‚åŒ…, ç”±äºåç»­çš„å“åº”åŒ…è¶…å‡ºäº†<strong>MTU: 9001</strong>,  å› æ­¤å¹¶æ²¡æœ‰å“åº”åŒ…ã€‚</p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016105948606.png" alt="image-20191016105948606"></p>
<hr>
<p>æ•°æ®åŒ…åœ¨Suricataä¸Šçš„è§£æç»“æœ:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-15T22:52:48.295823+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">1746715371266426</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43420</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç»“è®º:</strong></p>
<p>â€‹        ç›¸æ¯”éé•œåƒæµé‡çš„æ•°æ®åŒ…, Suricata å°‘äº†åç»­10æ¡httpè¯·æ±‚çš„æ•°æ®è§£æã€‚é’ˆå¯¹è®¿é—®<strong>10mb_exist_files</strong>çš„è¯·æ±‚, ç”±äºè¶…è¿‡äº†MTU, æ•°æ®åŒ…è¢«é˜¶æ®µäº†, httpçš„è§£ææ•°æ®ä¹Ÿæ˜¯ä¸å®Œæ•´çš„ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ:</strong></p>
<p>â€‹        è¿™é‡Œç›´æ¥å¼•ç”¨AWSçš„å®˜æ–¹æ–‡æ¡£æè¿°ã€‚å¦‚æœå¯¹8996å­—èŠ‚çš„æ•°æ®åŒ…è¿›è¡Œäº†é•œåƒï¼Œå¹¶ä¸”æµé‡é•œåƒç›®æ ‡MTUå€¼ä¸º9001å­—èŠ‚ï¼Œåˆ™é•œåƒå°è£…ä¼šå¯¼è‡´é•œåƒçš„æ•°æ®åŒ…å¤§äºMTUå€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé•œåƒæ•°æ®åŒ…å°†è¢«æˆªæ–­ã€‚ä¸ºé˜²æ­¢é•œåƒæ•°æ®åŒ…è¢«æˆªæ–­ï¼Œè¯·å°†æµé‡é•œåƒæºæ¥å£çš„MTUå€¼è®¾ç½®ä¸ºæ¯”æµé‡é•œåƒç›®æ ‡MTUå€¼å°54ä¸ªå­—èŠ‚ã€‚æœ‰å…³é…ç½®ç½‘ç»œMTUå€¼çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…Amazon EC2 Linuxå®ä¾‹ç”¨æˆ·æŒ‡å—ä¸­çš„EC2å®ä¾‹çš„ç½‘ç»œæœ€å¤§ä¼ è¾“å•ä½ï¼ˆMTUï¼‰ã€‚</p>
<p>â€‹        ä¸€èˆ¬æ¥è¯´ï¼Œé™ä½ MTU çš„è¯ï¼Œæœ‰å¯èƒ½å‘ç°ç½‘è·¯ä¼ è¾“æ•ˆèƒ½æœ‰ä¸‹é™ï¼Œè¿™æ˜¯å› ä¸ºæ¯ä¸ªå°åŒ… size å˜å°ï¼Œæ‰€ä»¥ä¼ é€åŒæ ·çš„èµ„æ–™é‡ï¼Œå°åŒ…æ•°å°±ä¼šå˜å¤šï¼Œé€ æˆ overhead å˜å¤šã€‚ä½†æ˜¯å¯¹äºä¼ è¾“æ˜¯ä¸ä¼šäº§ç”Ÿé”™è¯¯çš„çŠ¶å†µçš„ã€‚</p>
<hr>
<p><strong>MTU:1500</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br><span class="line"></span><br><span class="line">$ sudo ip link <span class="built_in">set</span> dev eth0 mtu 1500</span><br><span class="line"></span><br><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016154823748.png" alt="image-20191016154823748"></p>
<p><img src="/2019/10/16/æˆ‘åœ¨äº‘ä¸Šçš„æ—¥å­-AWSä¸Šæµé‡é•œåƒé‡åˆ°çš„å‘/image-20191016155112376.png" alt="image-20191016155112376"></p>
<p>æ•°æ®åŒ…åœ¨Suricataä¸Šçš„è§£æç»“æœ:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-16T15:14:15.576656+0800"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="number">1135596924232203</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"http"</span>,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"y.y.y.y"</span>,</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">43554</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"tx_id"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"x.x.x.x"</span>,</span><br><span class="line">        <span class="attr">"http_port"</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/file/10mb_exist_files"</span>,</span><br><span class="line">        <span class="attr">"http_user_agent"</span>: <span class="string">"python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64"</span>,</span><br><span class="line">        <span class="attr">"http_content_type"</span>: <span class="string">"text/html"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip, deflate, compress\n"</span>,</span><br><span class="line">        <span class="attr">"content_length"</span>: <span class="string">"41943044"</span>,</span><br><span class="line">        <span class="attr">"content_type"</span>: <span class="string">"text/html; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Wed, 16 Oct 2019 07:14:15 GMT"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"Werkzeug/0.16.0 Python/2.7.16"</span>,</span><br><span class="line">        <span class="attr">"http_method"</span>: <span class="string">"GET"</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"length"</span>: <span class="number">41943044</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹        ç»“è®º: <strong>MTUå‡å°åˆ°1500æ—¶</strong>, æ— è®ºä»WireSharkæ¥æŸ¥çœ‹æˆ–è€…Suricataåè®®è¿˜åŸçš„è§’åº¦æ¥è¯´, éƒ½æ˜¯å¯ä»¥çš„ã€‚</p>
<hr>
<p>â€‹        å†™åœ¨æœ€å, è¯´å®è¯AWSæä¾›äº†åœ¨äº‘ä¸Šçš„æµé‡é•œåƒç¡®å®å¾ˆä¸é”™, è‡³å°‘æ¯”ä¼ ç»Ÿåœ¨äº‘ä¸Šæ¯ä¸€å°æœºå™¨é€šè¿‡å®‰è£…agentæŠŠæµé‡å¤–å‘çš„å½¢å¼å¼º, ä¼¼ä¹<strong>å›½å†…</strong>çš„äº‘å‚å•†ç°åœ¨ä¹Ÿæ²¡æœ‰è¿™ä¸ªåŠŸèƒ½! </p>
<p>â€‹        ä¸è¿‡é€šè¿‡VXLANå°†æ•°æ®åŒ…å°è£…åå¯¼è‡´MTUè¶…è¿‡æœ€å¤§å€¼è¿™é—®é¢˜ä¹Ÿç¡®å®æœ‰ç‚¹å‘ã€‚ä½ è®©å·²ç»æˆå‹çš„æ¶æ„å»è°ƒæ•´MTUå€¼, è™½ç„¶ç†è®ºä¸Šæ˜¯å¯è¡Œ, ä½†å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ç½‘ç»œçš„è°ƒæ•´éƒ½æ˜¯æ¯”è¾ƒæ…é‡çš„, é™¤éä¼ä¸šç°åœ¨å¿…é¡»å¾—ä¸Šæµé‡é•œåƒ, å¦åˆ™ä¸å¤ªèƒ½è¯´æœè¿ç»´çš„å°ä¼™ä¼´å»è°ƒæ•´, è¦æ˜¯çœŸå‡ºäº†ä»€ä¹ˆé—®é¢˜, éƒ½æ˜¯å¤§é—®é¢˜ã€‚</p>
<p><strong>å‚è€ƒ</strong></p>
<ul>
<li><a href="https://docs.aws.amazon.com/vpc/latest/mirroring/vpc-tm.pdf" target="_blank" rel="noopener">Amazon Virtual Private Cloud Traffic Mirroring</a></li>
<li><a href="https://community.emc.com/community/support/chinese/teamblog/blog/2016/05/12/å¤§å’–è®²ç½‘ç»œ-mtuå¯¼è‡´çš„æ‚²å‰§" target="_blank" rel="noopener">å¤§å’–è®²ç½‘ç»œ-mtuå¯¼è‡´çš„æ‚²å‰§</a></li>
<li><a href="https://www.cnblogs.com/sammyliu/p/5079898.html" target="_blank" rel="noopener">Neutron VxLAN + Linux Bridge ç¯å¢ƒä¸­çš„ç½‘ç»œ MTU</a></li>
</ul>
]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>Suricata - Lua Output Script</title>
    <url>/2019/10/14/Suricata%20-%20Lua%20Output/</url>
    <content><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>â€‹    ç”±äºè¿‘æœŸç½‘ç«™é­å—å¤§é‡æ’åº“æ”»å‡», æƒ³ç›‘æ§ä¸€ä¸‹ç™»å½•æ¥å£ä¸­çš„å¼‚å¸¸è¡Œä¸ºã€‚é€šè¿‡<strong>alert</strong>å¹¶ä¸èƒ½èµ·åˆ°å¾ˆå¥½çš„æ•ˆæœ, æ‰€ä»¥é‡‡ç”¨<strong>Lua</strong>è„šæœ¬è¿›è¡Œæ‰©å±•, å†™äº†ä¸€ä¸ªå®¡è®¡ç™»å½•æ¥å£çš„è„šæœ¬ã€‚é€šè¿‡ç™»å½•æ¥å£äº‹ä»¶, å†é…åˆ<strong>Wazuh</strong>è¿›è¡Œä¸€äº›ç®€å•çš„å…³è”å‘Šè­¦,  æ•ˆæœè¿˜æ˜¯ä¸é”™çš„ã€‚</p>
<h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><ul>
<li>ç”±äºå®¡è®¡å†…å®¹æ¶‰åŠåˆ°ç”¨æˆ·æ•æ„Ÿä¿¡æ¯, å› æ­¤éœ€è¦å¯¹æ•æ„Ÿä¿¡æ¯è¿›è¡Œ<strong>Hash</strong>ä¹‹åå†è¾“å‡º;</li>
<li>é™¤é€šç”¨<strong>HTTP Header</strong>å­—æ®µå¤–æ”¯æŒå¯¹è‡ªå®šä¹‰å­—æ®µè¿›è¡Œé€‰æ‹©æ€§è¾“å‡º;</li>
</ul>
<h1 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h1><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">json = <span class="built_in">require</span> <span class="string">"json"</span></span><br><span class="line">md5 = <span class="built_in">require</span> <span class="string">"md5"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç™»å½•æ¥å£</span></span><br><span class="line">login_url = <span class="string">"/login"</span></span><br><span class="line"><span class="comment">-- ç™»å½•çŠ¶æ€ç </span></span><br><span class="line">success_code = <span class="number">0</span></span><br><span class="line"><span class="comment">-- event_name</span></span><br><span class="line">event_name = <span class="string">"login_audit"</span></span><br><span class="line"><span class="comment">-- event_type</span></span><br><span class="line">event_type = <span class="string">"lua"</span></span><br><span class="line"><span class="comment">-- app_type</span></span><br><span class="line">app_type = <span class="string">"web"</span></span><br><span class="line"><span class="comment">-- logs</span></span><br><span class="line">name = <span class="string">"web_login_audit.json"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- common_mapping</span></span><br><span class="line">http_common_mapping = <span class="string">'&#123;"accept":"accept","accept-charset":"accept_charset","accept-encoding":"accept_encoding","accept-language":"accept_language","accept-datetime":"accept_datetime","authorization":"authorization","cache-control":"cache_control","from":"from","max-forwards":"max_forwards","origin":"origin","pragma":"pragma","proxy-authorization":"proxy_authorization","via":"via","vary":"vary","x-requested-with":"x_requested_with","x-forwarded-proto":"x_forwarded_proto","accept-range":"accept_range","allow":"allow","connection":"connection","content-encoding":"content_encoding","content-language":"content_language","content-location":"content_location","content-md5":"content_md5","content-range":"content_range","date":"date","last-modified":"last_modified","location":"location","proxy-authenticate":"proxy_authenticate","referrer":"refer","retry-after":"retry_after","server":"server","transfer-encoding":"transfer_encoding","upgrade":"upgrade","www-authenticate":"www_authenticate","x-authenticated-user":"x_authenticated_user","user-agent":"user_agent"&#125;'</span></span><br><span class="line">common_mapping_table = json.decode(http_common_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- request_mapping</span></span><br><span class="line">http_request_mapping = <span class="string">'&#123;"content-length":"request_content_length","content-type":"request_content_type"&#125;'</span></span><br><span class="line">request_mapping_table = json.decode(http_request_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- response_mapping</span></span><br><span class="line">http_response_mapping = <span class="string">'&#123;"content-length":"response_content_length","content-type":"response_content_type"&#125;'</span></span><br><span class="line">response_mapping_table = json.decode(http_response_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- defind functioin</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5Encode</span><span class="params">(args)</span></span></span><br><span class="line">    m = md5.new()</span><br><span class="line">    m:update(args)</span><br><span class="line">    <span class="keyword">return</span> md5.tohex(m:finish())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlDecode</span><span class="params">(args)</span></span></span><br><span class="line">    s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(args, <span class="string">"%%(%x%x)"</span>, <span class="function"><span class="keyword">function</span><span class="params">(h)</span></span> <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="built_in">tonumber</span>(h, <span class="number">16</span>)) <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- email=xxx@yyy.com&amp;password=zzz</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStr</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    data = <span class="built_in">string</span>.split(args, <span class="string">'&amp;'</span>)</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">        d = <span class="built_in">string</span>.split(v, <span class="string">'='</span>)</span><br><span class="line">        t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.split</span><span class="params">(s, p)</span></span></span><br><span class="line">    <span class="keyword">local</span> rt = &#123;&#125;</span><br><span class="line">    <span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">'[^'</span>..p..<span class="string">']+'</span>, <span class="function"><span class="keyword">function</span><span class="params">(w)</span></span> <span class="built_in">table</span>.<span class="built_in">insert</span>(rt, w) <span class="keyword">end</span> )</span><br><span class="line">    <span class="keyword">return</span> rt</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trim</span><span class="params">(s)</span></span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">"^%s*(.-)%s*$"</span>, <span class="string">"%1"</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatCookie</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    data = <span class="built_in">string</span>.split(args, <span class="string">";"</span>)</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">        v = trim(v)</span><br><span class="line">        d = <span class="built_in">string</span>.split(v, <span class="string">"="</span>)</span><br><span class="line">        t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- default function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(args)</span></span></span><br><span class="line">    <span class="keyword">local</span> needs = &#123;&#125;</span><br><span class="line">    needs[<span class="string">"protocol"</span>] = <span class="string">"http"</span></span><br><span class="line">    <span class="keyword">return</span> needs</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span> <span class="params">(args)</span></span></span><br><span class="line">    filename = SCLogPath() .. <span class="string">"/"</span> .. name</span><br><span class="line">    file = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">"a"</span>))</span><br><span class="line">    SCLogInfo(<span class="string">"Web Login Log Filename "</span> .. filename)</span><br><span class="line">    http = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(args)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- init tables</span></span><br><span class="line">    http_table = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_hostname</span></span><br><span class="line">    http_hostname = HttpGetRequestHost()</span><br><span class="line">    http_table[<span class="string">"hostname"</span>] = http_hostname</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_url</span></span><br><span class="line">    http_url = HttpGetRequestUriNormalized()</span><br><span class="line">    <span class="keyword">if</span> http_url ~= login_url <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"url"</span>] = login_url</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_url_path</span></span><br><span class="line">    http_table[<span class="string">"url_path"</span>] = http_url</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_method</span></span><br><span class="line">    rl = HttpGetRequestLine()</span><br><span class="line">    http_method = <span class="built_in">string</span>.<span class="built_in">match</span>(rl, <span class="string">"%w+"</span>)</span><br><span class="line">    http_table[<span class="string">"method"</span>] = http_method</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_status</span></span><br><span class="line">    rsl = HttpGetResponseLine()</span><br><span class="line">    status_code = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"%s(%d+)%s"</span>)</span><br><span class="line">    http_status = <span class="built_in">tonumber</span>(status_code)</span><br><span class="line">    http_table[<span class="string">"status"</span>] = http_status</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_protocol</span></span><br><span class="line">    http_protocol = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">"(.-)%s"</span>)</span><br><span class="line">    http_table[<span class="string">"protocol"</span>] = http_protocol</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- request_token</span></span><br><span class="line">    cookie = HttpGetRequestHeader(<span class="string">"Cookie"</span>)</span><br><span class="line">    <span class="keyword">if</span> cookie ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        session_id = <span class="built_in">string</span>.<span class="built_in">match</span>(cookie, <span class="string">"sessionID=(.-);"</span>)</span><br><span class="line">        <span class="keyword">if</span> session_id ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[<span class="string">"request_token"</span>] = md5Encode(session_id)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            http_table[<span class="string">"request_token"</span>]  = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- response_token &amp;&amp; member_id</span></span><br><span class="line">    set_cookie = HttpGetResponseHeader(<span class="string">"Set-Cookie"</span>)</span><br><span class="line">    <span class="keyword">if</span> set_cookie ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        session_id = <span class="built_in">string</span>.<span class="built_in">match</span>(set_cookie, <span class="string">"sessionID=(.-);"</span>)</span><br><span class="line">        http_table[<span class="string">"response_token"</span>]  = md5Encode(session_id)</span><br><span class="line">        member_id = <span class="built_in">string</span>.<span class="built_in">match</span>(set_cookie, <span class="string">"memberId=(.-);"</span>)</span><br><span class="line">        http_table[<span class="string">"member_id"</span>] = <span class="built_in">tonumber</span>(member_id)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- login_results</span></span><br><span class="line">    a, o, e = HttpGetResponseBody()</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        body = json.decode(v)</span><br><span class="line">        results_code = <span class="built_in">tonumber</span>(body[<span class="string">"code"</span>])</span><br><span class="line">        <span class="keyword">if</span> results_code == success_code <span class="keyword">then</span></span><br><span class="line">            results = <span class="string">"success"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            results = <span class="string">"failed"</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"results"</span>] = results</span><br><span class="line">    http_table[<span class="string">"results_code"</span>] = results_code</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- email &amp; password</span></span><br><span class="line">    a, o, e = HttpGetRequestBody()</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        res = formatStr(v)</span><br><span class="line">        mail = urlDecode(res[<span class="string">'email'</span>])</span><br><span class="line">        pass = md5Encode(res[<span class="string">'password'</span>])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">"email"</span>] = mail</span><br><span class="line">    http_table[<span class="string">"password"</span>] = pass</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- RequestHeaders</span></span><br><span class="line">    rh = HttpGetRequestHeaders()</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rh) <span class="keyword">do</span></span><br><span class="line">        key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line"></span><br><span class="line">        common_var = common_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> common_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[common_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        request_var = request_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> request_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[request_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- ResponseHeaders</span></span><br><span class="line">    rsh = HttpGetResponseHeaders()</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rsh) <span class="keyword">do</span></span><br><span class="line">        key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line"></span><br><span class="line">        common_var = common_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> common_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[common_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        response_var = response_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> response_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[response_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- timestring = SCPacketTimeString() 2019-09-10T06:08:35.582449+0000</span></span><br><span class="line">    sec, usec = SCPacketTimestamp()</span><br><span class="line">    timestring = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">"!%Y-%m-%dT%T"</span>, sec) .. <span class="string">"."</span> .. usec .. <span class="string">"+0000"</span></span><br><span class="line">    </span><br><span class="line">    ip_version, src_ip, dst_ip, protocol, src_port, dst_port = SCFlowTuple()</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- flow_id</span></span><br><span class="line">    id = SCFlowId()</span><br><span class="line">    flow_id = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%.0f"</span>, id)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- true_ip</span></span><br><span class="line">    true_client_ip = HttpGetRequestHeader(<span class="string">"True-Client-IP"</span>)</span><br><span class="line">    <span class="keyword">if</span> true_client_ip ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        src_ip = true_client_ip</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- table</span></span><br><span class="line">    raw_data = &#123;</span><br><span class="line">        timestamp = timestring,</span><br><span class="line">        flow_id = flow_id,</span><br><span class="line">        src_ip = src_ip,</span><br><span class="line">        src_port = src_port,</span><br><span class="line">        dest_ip = dst_ip,</span><br><span class="line">        dest_port = dst_port,</span><br><span class="line">        event_name = event_name,</span><br><span class="line">        event_type = event_type,</span><br><span class="line">        app_type = app_type,</span><br><span class="line">        http = http_table,</span><br><span class="line">        proto = <span class="string">"TCP"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- json encode</span></span><br><span class="line">    data = json.encode(raw_data)</span><br><span class="line"></span><br><span class="line">    file:<span class="built_in">write</span>(data .. <span class="string">"\n"</span>)</span><br><span class="line">    file:<span class="built_in">flush</span>()</span><br><span class="line"></span><br><span class="line">    http = http + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deinit</span> <span class="params">(args)</span></span></span><br><span class="line">    SCLogInfo (<span class="string">"HTTP transactions logged: "</span> .. http);</span><br><span class="line">    file:<span class="built_in">close</span>(file)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h1><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"src_port"</span>: <span class="number">34963</span>,</span><br><span class="line">    <span class="attr">"event_type"</span>: <span class="string">"lua"</span>,</span><br><span class="line">    <span class="attr">"proto"</span>: <span class="string">"TCP"</span>,</span><br><span class="line">    <span class="attr">"flow_id"</span>: <span class="string">"471693756052529"</span>,</span><br><span class="line">    <span class="attr">"timestamp"</span>: <span class="string">"2019-10-07T13:51:01.560556+0000"</span>,</span><br><span class="line">    <span class="attr">"event_name"</span>: <span class="string">"login_audit"</span>,</span><br><span class="line">    <span class="attr">"dest_port"</span>: <span class="number">3007</span>,</span><br><span class="line">    <span class="attr">"http"</span>: &#123;</span><br><span class="line">        <span class="attr">"response_content_length"</span>: <span class="string">"446"</span>,</span><br><span class="line">        <span class="attr">"response_content_type"</span>: <span class="string">"application/json; charset=utf-8"</span>,</span><br><span class="line">        <span class="attr">"accept_encoding"</span>: <span class="string">"gzip"</span>,</span><br><span class="line">        <span class="attr">"accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="attr">"server"</span>: <span class="string">"nginx"</span>,</span><br><span class="line">        <span class="attr">"results_code"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"vary"</span>: <span class="string">"Accept-Encoding"</span>,</span><br><span class="line">        <span class="attr">"password"</span>: <span class="string">"420ce28ef813a2dc05e52a7e24eb0d5c"</span>,</span><br><span class="line">        <span class="attr">"date"</span>: <span class="string">"Mon, 07 Oct 2019 13:51:01 GMT"</span>,</span><br><span class="line">        <span class="attr">"request_content_type"</span>: <span class="string">"application/x-www-form-urlencoded; charset=UTF-8"</span>,</span><br><span class="line">        <span class="attr">"accept_language"</span>: <span class="string">"en-US,en;q=0.9"</span>,</span><br><span class="line">        <span class="attr">"url"</span>: <span class="string">"/login"</span>,</span><br><span class="line">        <span class="attr">"x_requested_with"</span>: <span class="string">"XMLHttpRequest"</span>,</span><br><span class="line">        <span class="attr">"x_forwarded_proto"</span>: <span class="string">"https"</span>,</span><br><span class="line">        <span class="attr">"user_agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36"</span>,</span><br><span class="line">        <span class="attr">"origin"</span>: <span class="string">"https://www.canon.com"</span>,</span><br><span class="line">        <span class="attr">"response_token"</span>: <span class="string">"4f5f386aec34e877ce63fce7ddd3f15f"</span>,</span><br><span class="line">        <span class="attr">"pragma"</span>: <span class="string">"no-cache"</span>,</span><br><span class="line">        <span class="attr">"connection"</span>: <span class="string">"close"</span>,</span><br><span class="line">        <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"HTTP/1.1"</span>,</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"www.canon.com"</span>,</span><br><span class="line">        <span class="attr">"url_path"</span>: <span class="string">"/login"</span>,</span><br><span class="line">        <span class="attr">"cache_control"</span>: <span class="string">"no-cache, max-age=0, no-store, must-revalidate"</span>,</span><br><span class="line">        <span class="attr">"method"</span>: <span class="string">"POST"</span>,</span><br><span class="line">        <span class="attr">"email"</span>: <span class="string">"admin@canon.com"</span>,</span><br><span class="line">        <span class="attr">"request_token"</span>: <span class="string">"109464370570b23fa9768078ab1ac8a9"</span>,</span><br><span class="line">        <span class="attr">"member_id"</span>: <span class="number">123456</span>,</span><br><span class="line">        <span class="attr">"results"</span>: <span class="string">"success"</span>,</span><br><span class="line">        <span class="attr">"request_content_length"</span>: <span class="string">"49"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"src_ip"</span>: <span class="string">"77.99.22.17"</span>,</span><br><span class="line">    <span class="attr">"dest_ip"</span>: <span class="string">"1.1.1.1"</span>,</span><br><span class="line">    <span class="attr">"app_type"</span>: <span class="string">"web"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>æˆ‘åœ¨'äº‘'ä¸Šçš„æ—¥å­ - Zeek(éƒ¨ç½²)</title>
    <url>/2019/10/14/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90%20-%20Zeek%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<p><a href="https://holdmybeersecurity.com/2019/04/03/part-1-install-setup-zeek-pf_ring-on-ubuntu-18-04-on-proxmox-5-3-openvswitch/" target="_blank" rel="noopener"><strong>PART 1: INSTALL/SETUP ZEEK + PF_RING ON UBUNTU 18.04 ON PROXMOX 5.3 + OPENVSWITCH</strong></a></p>
<h1 id="Zeek"><a href="#Zeek" class="headerlink" title="Zeek"></a>Zeek</h1><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><strong><a href="https://docs.zeek.org/en/stable/install/install.html" target="_blank" rel="noopener">Installing Zeek</a></strong></li>
</ul>
<p><strong>Required Dependencies</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install cmake make gcc g++ flex bison libpcap-dev libssl-dev python-dev swig zlib1g-dev</span><br></pre></td></tr></table></figure>

<p><em>If your system uses Python 2.7, then you will also need to install the <code>python-ipaddres</code> package.</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install python-ipaddress</span><br></pre></td></tr></table></figure>

<p><strong>Optional Dependencies</strong></p>
<ul>
<li>libmaxminddb (for geolocating IP addresses)</li>
<li>sendmail (enables Bro and BroControl to send mail)</li>
<li>curl (used by a Bro script that implements active HTTP)</li>
<li>gperftools (tcmalloc is used to improve memory and CPU usage)</li>
<li>jemalloc (<a href="http://www.canonware.com/jemalloc/" target="_blank" rel="noopener">http://www.canonware.com/jemalloc/</a>)</li>
<li>PF_RING (Linux only, see <a href="https://docs.zeek.org/en/stable/configuration/index.html" target="_blank" rel="noopener">Cluster Configuration</a>)</li>
<li>krb5 libraries and headers</li>
<li>ipsumdump (for trace-summary; <a href="http://www.cs.ucla.edu/~kohler/ipsumdump" target="_blank" rel="noopener">http://www.cs.ucla.edu/~kohler/ipsumdump</a>)</li>
</ul>
<p><strong>Installing Bro</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> --recursive https://github.com/zeek/zeek</span><br><span class="line">$ ./configure --with-pcap=/usr/<span class="built_in">local</span>/include --with-geoip=/usr/share/GeoIP</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>Add PATH</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/zeek/bin:<span class="variable">$PATH</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo vim ~/.bashrc</span><br><span class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/zeek/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p><strong>Enable Json</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /usr/<span class="built_in">local</span>/zeek/share/zeek/site/local.zeek</span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line to enable logging of link-layer addresses. Enabling</span></span><br><span class="line"><span class="comment"># this adds the link-layer address for each connection endpoint to the conn.log file.</span></span><br><span class="line"><span class="comment"># @load policy/protocols/conn/mac-logging</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">@load policy/tuning/json-logs.zeek</span><br></pre></td></tr></table></figure>

<p><strong>Using PF_RING</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /usr/<span class="built_in">local</span>/zeek/etc/node.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example ZeekControl node configuration.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This example has a standalone node ready to go except for possibly changing</span></span><br><span class="line"><span class="comment"># the sniffing interface.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is a complete standalone configuration.  Most likely you will</span></span><br><span class="line"><span class="comment"># only need to change the interface.</span></span><br><span class="line"><span class="comment"># [zeek]</span></span><br><span class="line"><span class="comment"># type=standalone</span></span><br><span class="line"><span class="comment"># host=localhost</span></span><br><span class="line"><span class="comment"># interface=ens33</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Below is an example clustered configuration. If you use this,</span></span><br><span class="line"><span class="comment">## remove the [zeek] node above.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[logger]</span></span><br><span class="line"><span class="comment">#type=logger</span></span><br><span class="line"><span class="comment">#host=localhost</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[manager]</span><br><span class="line"><span class="built_in">type</span>=manager</span><br><span class="line">host=localhost</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[proxy-1]</span><br><span class="line"><span class="built_in">type</span>=proxy</span><br><span class="line">host=localhost</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[worker-1]</span><br><span class="line"><span class="built_in">type</span>=worker</span><br><span class="line">host=localhost</span><br><span class="line">interface=ens33</span><br><span class="line">lb_method=pf_ring</span><br><span class="line">lb_procs=1</span><br><span class="line">pin_cpus=1</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#[worker-2]</span></span><br><span class="line"><span class="comment">#type=worker</span></span><br><span class="line"><span class="comment">#host=localhost</span></span><br><span class="line"><span class="comment">#interface=eth0</span></span><br></pre></td></tr></table></figure>

<h1 id="Optional-Dependencies"><a href="#Optional-Dependencies" class="headerlink" title="Optional Dependencies"></a>Optional Dependencies</h1><h2 id="PF-RING"><a href="#PF-RING" class="headerlink" title="PF_RING"></a>PF_RING</h2><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><strong><a href="https://www.zeek.org/documentation/load-balancing.html" target="_blank" rel="noopener">Installing PF_RING</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/ntop/PF_RING.git</span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo insmod ./pf_ring.ko</span><br><span class="line">$ <span class="built_in">cd</span> ../userland</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p><strong>pfring</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/src</span><br><span class="line">$ tar xvzf PF_RING-6.2.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> PF_RING-6.2.0/userland/lib</span><br><span class="line">$ ./configure --prefix=/opt/pfring</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>libpcap</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../libpcap</span><br><span class="line">$ ./configure --prefix=/opt/pfring</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>tcpdump</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../tcpdump</span><br><span class="line">$ ./configure --prefix=/opt/pfring</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ../../kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<p><strong>Load pf_ring at boot</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'pf_ring'</span> &gt;&gt; /etc/modules</span><br><span class="line">$ sudo reboot</span><br><span class="line"></span><br><span class="line">root@ubuntu:~<span class="comment"># lsmod | grep pf_ring</span></span><br><span class="line">pf_ring              1245184  0</span><br></pre></td></tr></table></figure>

<p><em>ç¡®ä¿Zeekæ­£ç¡®é“¾æ¥åˆ°æ‰€éœ€çš„libpcapåº“:</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:/usr/<span class="built_in">local</span>/zeek/etc<span class="comment"># ldd /usr/local/zeek/bin/zeek | grep pcap</span></span><br><span class="line">	libpcap.so.1 =&gt; /opt/pfring/lib/libpcap.so.1 (0x00007fc3c199d000)</span><br></pre></td></tr></table></figure>

<h2 id="GeoLocation"><a href="#GeoLocation" class="headerlink" title="GeoLocation"></a>GeoLocation</h2><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><strong><a href="https://docs.zeek.org/en/stable/frameworks/geoip.html#geolocation" target="_blank" rel="noopener">Installing LibgeoIP</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install libmaxminddb-dev</span><br><span class="line">$ wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz</span><br><span class="line">$ tar zxf GeoLite2-City.tar.gz</span><br><span class="line">$ mkdir -p /usr/share/GeoIP</span><br><span class="line">$ mv GeoLite2-City_20190702/GeoLite2-City.mmdb /usr/share/GeoIP/</span><br></pre></td></tr></table></figure>

<p><strong>Testing</strong></p>
<p><em>å¦‚æœæœªæ‰¾åˆ°ä»»ä½•å†…å®¹æˆ–æœªè®¾ç½®<code>mmdb_dir</code>ï¼Œåˆ™BroæŒ‰ä»¥ä¸‹é¡ºåºæŸ¥æ‰¾ä½ç½®æ•°æ®åº“æ–‡ä»¶ï¼š</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ bro -e <span class="string">"print lookup_location(8.8.8.8);"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>/usr/share/GeoIP/GeoLite2-City.mmdb</li>
<li>/var/lib/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/local/share/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/local/var/GeoIP/GeoLite2-City.mmdb</li>
<li>/usr/share/GeoIP/GeoLite2-Country.mmdb</li>
<li>/var/lib/GeoIP/GeoLite2-Country.mmdb</li>
<li>/usr/local/share/GeoIP/GeoLite2-Country.mmdb</li>
<li>/usr/local/var/GeoIP/GeoLite2-Country.mmdb</li>
</ul>
<p><em>å¦‚æœå‡ºç° â€œBro was not configured for GeoIP supportâ€, æºç å®‰è£…æ—¶éœ€è¦æŒ‡å®š<code>./configure --with-geoip=/usr/share/GeoIP</code></em></p>
<h2 id="Gperftools"><a href="#Gperftools" class="headerlink" title="Gperftools"></a>Gperftools</h2><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><strong><a href="http://pkxpp.github.io/2017/03/30/gperftools%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener">Installing Gperftools</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/gperftools/gperftools.git</span><br><span class="line">$ sudo apt-get install libunwind-dev autoconf automake libtool</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<h2 id="IPsumdump"><a href="#IPsumdump" class="headerlink" title="IPsumdump"></a>IPsumdump</h2><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><a href="http://www.read.seas.harvard.edu/~kohler/ipsumdump/" target="_blank" rel="noopener"><strong>Installing IPsumdump</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -O http://www.read.seas.harvard.edu/~kohler/ipsumdump/ipsumdump-1.86.tar.gz</span><br><span class="line">$ tar -xzf ipsumdump-1.86.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> ipsumdump-1.86</span><br><span class="line">$ ./configure --prefix=/usr/</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line">$ sudo make clean</span><br></pre></td></tr></table></figure>

<h2 id="Krb5"><a href="#Krb5" class="headerlink" title="Krb5"></a>Krb5</h2><p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><strong><a href="http://computing.help.inf.ed.ac.uk/kerberos-ubuntu" target="_blank" rel="noopener">Installing Krb5</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install krb5-user</span><br></pre></td></tr></table></figure>

<h2 id="Jemalloc"><a href="#Jemalloc" class="headerlink" title="Jemalloc"></a>Jemalloc</h2><p>å‚è€ƒ:</p>
<ul>
<li><a href="https://blog.csdn.net/u013224233/article/details/87930772" target="_blank" rel="noopener"><strong>Installing Jemalloc</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo git <span class="built_in">clone</span> https://github.com/jemalloc/jemalloc.git</span><br><span class="line">$ ./autogen.sh</span><br><span class="line">$ make -j2</span><br><span class="line">$ sudo make install</span><br><span class="line">$ sudo ldconfig</span><br></pre></td></tr></table></figure>

<h1 id="å‹æµ‹"><a href="#å‹æµ‹" class="headerlink" title="å‹æµ‹"></a>å‹æµ‹</h1><ol>
<li><strong>æŸ¥çœ‹æ˜¯å¦ä¸¢åŒ…</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ zeekctl netstats; date</span><br><span class="line"> worker-1-1: 1565971837.137228 recvd=2834922 dropped=0 link=2834922</span><br><span class="line"> worker-1-2: 1565971837.147334 recvd=2550230 dropped=0 link=2550230</span><br><span class="line"> worker-1-3: 1565971837.162362 recvd=5180417 dropped=0 link=5180417</span><br><span class="line"> worker-1-4: 1565971837.170347 recvd=3235356 dropped=0 link=3235356</span><br><span class="line"> worker-1-5: 1565971837.186545 recvd=1916826 dropped=0 link=1916826</span><br><span class="line"> worker-1-6: 1565971837.201416 recvd=2944762 dropped=0 link=2944762</span><br><span class="line"> worker-1-7: 1565971837.214975 recvd=2279448 dropped=0 link=2279448</span><br><span class="line"> worker-1-8: 1565971837.229167 recvd=1896171 dropped=0 link=1896171</span><br><span class="line"> worker-1-9: 1565971837.249430 recvd=2550968 dropped=0 link=2550968</span><br><span class="line">worker-1-10: 1565971837.246513 recvd=3339864 dropped=0 link=3339864</span><br><span class="line">worker-1-11: 1565971837.260010 recvd=3080981 dropped=0 link=3080981</span><br><span class="line">worker-1-12: 1565971837.274447 recvd=2410030 dropped=0 link=2410030</span><br><span class="line">worker-1-13: 1565971837.282654 recvd=2188787 dropped=0 link=2188787</span><br><span class="line">worker-1-14: 1565971837.294684 recvd=3103014 dropped=0 link=3103014</span><br><span class="line">Fri Aug 16 16:10:37 UTC 2019</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>æŸ¥çœ‹èµ„æºå ç”¨</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ zeekctl top; date</span><br><span class="line">Name         Type    Host             Pid     VSize  Rss  Cpu   Cmd</span><br><span class="line">logger       logger  localhost        8808      1G    99M   5%  zeek</span><br><span class="line">manager      manager localhost        8855    568M    97M  23%  zeek</span><br><span class="line">proxy-1      proxy   localhost        8901    566M    92M   5%  zeek</span><br><span class="line">worker-1-1   worker  localhost        9086      1G   697M  11%  zeek</span><br><span class="line">worker-1-2   worker  localhost        9093      1G   699M  23%  zeek</span><br><span class="line">worker-1-3   worker  localhost        9105      1G   700M  17%  zeek</span><br><span class="line">worker-1-4   worker  localhost        9111      1G   696M  17%  zeek</span><br><span class="line">worker-1-5   worker  localhost        9114      1G   699M  17%  zeek</span><br><span class="line">worker-1-6   worker  localhost        9120      1G   699M  11%  zeek</span><br><span class="line">worker-1-7   worker  localhost        9121      1G   699M  11%  zeek</span><br><span class="line">worker-1-8   worker  localhost        9132      1G   701M  11%  zeek</span><br><span class="line">worker-1-9   worker  localhost        9140      1G   699M  11%  zeek</span><br><span class="line">worker-1-10  worker  localhost        9142      1G   700M  11%  zeek</span><br><span class="line">worker-1-11  worker  localhost        9151      1G   696M  23%  zeek</span><br><span class="line">worker-1-12  worker  localhost        9155      1G   698M  17%  zeek</span><br><span class="line">worker-1-13  worker  localhost        9154      1G   701M  11%  zeek</span><br><span class="line">worker-1-14  worker  localhost        9157      1G   698M  17%  zeek</span><br><span class="line">Fri Aug 16 16:11:25 UTC 2019</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>æŸ¥çœ‹æµé‡å¤§å°(10ç§’)</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ zeekctl capstats; date</span><br><span class="line">Interface             kpps       mbps       (10s average)</span><br><span class="line">----------------------------------------</span><br><span class="line">localhost/ens5        37.8       375.2</span><br><span class="line">Fri Aug 16 16:12:47 UTC 2019</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Zeek</tag>
      </tags>
  </entry>
  <entry>
    <title>æˆ‘åœ¨'äº‘'ä¸Šçš„æ—¥å­ - Suricata(éƒ¨ç½²)</title>
    <url>/2019/10/14/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90%20-%20Suricata%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><h2 id="PF-RING"><a href="#PF-RING" class="headerlink" title="PF_RING"></a>PF_RING</h2><p><strong>1. pf_ring</strong></p>
<ul>
<li><strong>äºŒè¿›åˆ¶å®‰è£…</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 18.04 LTS</span></span><br><span class="line">$ apt-get install software-properties-common wget</span><br><span class="line">$ add-apt-repository universe [ unless you have <span class="keyword">done</span> it previously ]</span><br><span class="line">$ wget http://apt-stable.ntop.org/18.04/all/apt-ntop-stable.deb</span><br><span class="line">$ apt install ./apt-ntop-stable.deb</span><br><span class="line"></span><br><span class="line">$ apt-get clean all</span><br><span class="line">$ apt-get update</span><br><span class="line">$ apt-get install pfring</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>ç¼–è¯‘å®‰è£…</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¾èµ–</span></span><br><span class="line">$ apt install git make gcc libelf-dev build-essential subversion flex libnuma-dev bison pkg-config libtool rustc cargo libjansson-dev ethtool autoconf autogen liblzma-dev libpcre3-dev libyaml-dev libpcap-dev zlib1g-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/ntop/PF_RING.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ pf_ring.ko</span></span><br><span class="line">$ sudo insmod pf_ring.ko min_num_slots=65536 transparent_mode=2 enable_tx_capture=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ pf_ring ä¿¡æ¯</span></span><br><span class="line">$ cat /proc/net/pf_ring/info</span><br><span class="line">PF_RING Version          : 7.5.0 (dev:14f62e0edb2b54cd614ab9d1f6467ccb8c6c9c32)</span><br><span class="line">Total rings              : 0</span><br><span class="line"></span><br><span class="line">Standard (non ZC) Options</span><br><span class="line">Ring slots               : 65536</span><br><span class="line">Slot version             : 17</span><br><span class="line">Capture TX               : No [RX only]</span><br><span class="line">IP Defragment            : No</span><br><span class="line">Socket Mode              : Standard</span><br><span class="line">Cluster Fragment Queue   : 0</span><br><span class="line">Cluster Fragment Discard : 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸è½½ pf_ring.ko</span></span><br><span class="line">$ sudo rmmod pf_ring</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>2. libpfringã€libpcap</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> PF_RING/userland/lib</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure &amp;&amp; make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ../libpcap</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure &amp;&amp; make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo make install</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> éªŒè¯</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> PF_RING/userland/examples</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¥æ”¶æ•°æ®åŒ…</span></span><br><span class="line">root@ubuntu:/opt/PF_RING/userland/examples# ./pfcount -i ens33</span><br><span class="line">Using PF_RING v.7.5.0</span><br><span class="line">Capturing from ens33 [mac: 00:0C:29:D5:B9:8F][if_index: 2][speed: 0Mb/s]</span><br><span class="line"><span class="meta">#</span><span class="bash"> Device RX channels: 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Polling threads:    1</span></span><br><span class="line">Dumping statistics on /proc/net/pf_ring/stats/51441-ens33.3</span><br><span class="line">=========================</span><br><span class="line">Absolute Stats: [2 pkts total][0 pkts dropped][0.0% dropped]</span><br><span class="line">[2 pkts rcvd][424 bytes rcvd]</span><br><span class="line">=========================</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å‘é€æ•°æ®åŒ…</span></span><br><span class="line">root@ubuntu:/opt/PF_RING/userland/examples# sudo ./pfsend -f 64byte_packets.pcap -n 0 -i ens33 -r 5</span><br><span class="line">Sending packets on ens33</span><br><span class="line">Using PF_RING v.7.5.0</span><br><span class="line">Estimated CPU freq: 2429795000 Hz</span><br><span class="line">Unable to open file 64byte_packets.pcap</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>3. tcpdump</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/userland/tcpdump/</span><br><span class="line">$ ./configure &amp;&amp; make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><p><strong><a href="https://www.ntop.org/guides/pf_ring/get_started/git_installation.html" target="_blank" rel="noopener">PF_RING</a></strong></p>
</li>
<li><p><a href="http://packages.ntop.org/apt-stable/" target="_blank" rel="noopener">http://packages.ntop.org/apt-stable/</a></p>
</li>
<li><p><a href="https://www.ntop.org/guides/pf_ring/get_started/packages_installation.html" target="_blank" rel="noopener">https://www.ntop.org/guides/pf_ring/get_started/packages_installation.html</a></p>
</li>
<li><p><a href="https://www.ntop.org/guides/pf_ring/thirdparty/suricata.html" target="_blank" rel="noopener">https://www.ntop.org/guides/pf_ring/thirdparty/suricata.html</a></p>
</li>
</ul>
<h2 id="LuaJIT"><a href="#LuaJIT" class="headerlink" title="LuaJIT"></a>LuaJIT</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget http://luajit.org/download/LuaJIT-2.0.5.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -zxf LuaJIT-2.0.5.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> LuaJIT-2.0.5/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make &amp;&amp; make install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> éªŒè¯</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig -p | grep lua</span></span><br><span class="line">	liblua5.1.so.0 (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1.so.0</span><br><span class="line">	liblua5.1.so (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1.so</span><br><span class="line">	liblua5.1-c++.so.0 (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1-c++.so.0</span><br><span class="line">	liblua5.1-c++.so (libc6,x86-64) =&gt; /usr/lib/x86_64-linux-gnu/liblua5.1-c++.so</span><br></pre></td></tr></table></figure>

<h2 id="Hyperscan"><a href="#Hyperscan" class="headerlink" title="Hyperscan"></a>Hyperscan</h2><p><strong>1. boost</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä¾èµ–</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> apt install cmake</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸‹è½½</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://dl.bintray.com/boostorg/release/1.69.0/<span class="built_in">source</span>/boost_1_69_0.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -xvf boost_1_69_0.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> boost_1_69_0/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./bootstrap.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo ./b2 --with-iostreams --with-random install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig</span></span><br></pre></td></tr></table></figure>

<p><strong>2. ragle</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¾èµ–</span></span><br><span class="line">$ sudo apt-get install autoconf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½</span></span><br><span class="line">$ wget http://www.colm.net/files/ragel/ragel-6.10.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">$ tar zxvf ragel-6.10.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> ragel-6.10</span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>

<p><strong>3. hyperscan</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¾èµ–</span></span><br><span class="line">$ sudo apt install libpcap-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½</span></span><br><span class="line">$ wget https://github.com/intel/hyperscan/archive/v5.1.0.tar.gz -O hyperscan-5.1.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">$ tar -zxvf hyperscan-5.1.0.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> hyperscan-5.1.0</span><br><span class="line">$ mkdir cmake-build</span><br><span class="line">$ <span class="built_in">cd</span> cmake-build</span><br><span class="line">$ cmake -DBUILD_SHARED_LIBS=on -DCMAKE_BUILD_TYPE=Release ..</span><br><span class="line">$ make -j8</span><br><span class="line">$ sudo make install</span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>

<p><strong>4. éªŒè¯</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ldconfig -p | grep hs</span></span><br><span class="line">	libhs_runtime.so.5 (libc6,x86-64) =&gt; /usr/local/lib/libhs_runtime.so.5</span><br><span class="line">	libhs_runtime.so (libc6,x86-64) =&gt; /usr/local/lib/libhs_runtime.so</span><br><span class="line">	libhs.so.5 (libc6,x86-64) =&gt; /usr/local/lib/libhs.so.5</span><br><span class="line">	libhs.so (libc6,x86-64) =&gt; /usr/local/lib/libhs.so</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>å‚è€ƒ:</strong></p>
<ul>
<li><a href="http://www.manongjc.com/article/110977.html" target="_blank" rel="noopener"><strong>Hyperscan - 5.1.0 å®‰è£…</strong></a></li>
</ul>
<h2 id="Suricata"><a href="#Suricata" class="headerlink" title="Suricata"></a><strong>Suricata</strong></h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä¾èµ–</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> apt-get install libpcre3 libpcre3-dbg libpcre3-dev build-essential libpcap-dev   \</span></span><br><span class="line">                libnet1-dev libyaml-0-2 libyaml-dev pkg-config zlib1g zlib1g-dev \</span><br><span class="line">                libcap-ng-dev libcap-ng0 make libmagic-dev libjansson-dev        \</span><br><span class="line">                libnss3-dev libgeoip-dev libhiredis-dev libevent-dev \</span><br><span class="line">                python-yaml rustc cargo libmaxminddb-dev liblzma-dev \</span><br><span class="line">                python3-distutils liblz4-dev</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Suricata 5.0.2</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://www.openinfosecfoundation.org/download/suricata-5.0.2.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¼–è¯‘</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir suricata</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> suricata</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> git://phalanx.openinfosecfoundation.org/oisf.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> oisf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/OISF/libhtp.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./autogen.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var --<span class="built_in">enable</span>-pfring --with-libpfring-includes=/usr/<span class="built_in">local</span>/include --with-libpfring-libraries=/usr/<span class="built_in">local</span>/lib --<span class="built_in">enable</span>-geoip  --<span class="built_in">enable</span>-luajit --with-libluajit-includes=/usr/<span class="built_in">local</span>/include/luajit-2.0/ --with-libluajit-libraries=/usr/<span class="built_in">local</span>/lib/ --with-libhs-includes=/usr/<span class="built_in">local</span>/include/hs/ --with-libhs-libraries=/usr/<span class="built_in">local</span>/lib/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make &amp;&amp; make install-full</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ldconfig</span></span><br></pre></td></tr></table></figure>

<h1 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h1><p><strong>1. PF_RING</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep PF_RING</span></span><br><span class="line">Features: PCAP_SET_BUFF PF_RING AF_PACKET HAVE_PACKET_FANOUT LIBCAP_NG LIBNET1.1 HAVE_HTP_URI_NORMALIZE_HOOK PCRE_JIT HAVE_NSS HAVE_LUA HAVE_LUAJIT HAVE_LIBJANSSON PROFILING TLS MAGIC RUST</span><br><span class="line">  PF_RING support:                         yes</span><br></pre></td></tr></table></figure>

<p><strong>2. LuaJit</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep lua</span></span><br><span class="line">  LUA support:                             yes, through luajit</span><br><span class="line">  libluajit:                               yes</span><br></pre></td></tr></table></figure>

<p><strong>3. Hyperscan</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --build-info | grep Hyperscan</span></span><br><span class="line">  Hyperscan support:                       yes</span><br></pre></td></tr></table></figure>

<h1 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a><strong>å¯åŠ¨</strong></h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> suricata --pfring-int=ens6 --pfring-cluster-id=99 --pfring-cluster-type=cluster_flow -c /etc/suricata/suricata.yaml</span></span><br></pre></td></tr></table></figure>

<h1 id="è§„åˆ™ç®¡ç†"><a href="#è§„åˆ™ç®¡ç†" class="headerlink" title="è§„åˆ™ç®¡ç†"></a>è§„åˆ™ç®¡ç†</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install --upgrade suricata-update</span><br></pre></td></tr></table></figure>

<p><strong>å®šæ—¶æ›´æ–°</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> crontab -l</span></span><br><span class="line">10 0 * * * /usr/bin/suricata-update --no-test &amp;&amp; /usr/bin/suricatasc -c reload-rules</span><br></pre></td></tr></table></figure>

<h1 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h1><p><a href="https://www.jianshu.com/p/9348e211a6a2" target="_blank" rel="noopener">https://www.jianshu.com/p/9348e211a6a2</a></p>
]]></content>
      <categories>
        <category>NIDS</category>
      </categories>
      <tags>
        <tag>Suricata</tag>
      </tags>
  </entry>
  <entry>
    <title>Scrapy + Splash å®ç°åŠ¨æ€ç½‘é¡µçˆ¬å–</title>
    <url>/2019/10/08/Scrapy%20+%20Splash%20%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E7%BD%91%E9%A1%B5%E7%88%AC%E5%8F%96/</url>
    <content><![CDATA[<h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><p>â€‹        è¿™æ˜¯ä¸€ä¸ªæ’åº“äº‹ä»¶çš„åç»­, é€šè¿‡ä¹‹å‰ç¼–å†™çš„è„šæœ¬<strong>Suricata - login_audit</strong>è„šæœ¬æˆåŠŸå®¡è®¡åˆ°äº†æ‰€æœ‰ç™»å½•ç½‘ç«™çš„è´¦å·ã€‚è¿™é‡Œéœ€è¦å¯¹ç»è¿‡åˆ†æåå­˜åœ¨å¯ç–‘è¡Œä¸ºçš„è´¦å·è¿›è¡Œåå‘æŸ¥è¯¢, ä¸»è¦åˆ¤æ–­è¯¥è´¦å·æ˜¯å¦å·²è¢«æ ‡è®°ä¸ºæ³„éœ²è´¦å·ã€‚</p>
<h2 id="å‘ç‚¹"><a href="#å‘ç‚¹" class="headerlink" title="å‘ç‚¹"></a>å‘ç‚¹</h2><p>â€‹        ç”±äº<strong>Scrapy</strong>æ²¡æœ‰<strong>JS Eengine</strong>åªèƒ½çˆ¬å–é™æ€é¡µé¢çš„, å¯¹äºJSç”Ÿæˆçš„åŠ¨æ€é¡µé¢æ˜¯ä¸æ”¯æŒçš„ã€‚ä½†æ˜¯å¯ä»¥å€ŸåŠ©<a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener"><strong>Scrapy-Splash</strong></a>æ¥å®ç°åŠ¨æ€é¡µé¢çš„çˆ¬å–ã€‚</p>
<h1 id="éƒ¨ç½²æ–¹æ³•"><a href="#éƒ¨ç½²æ–¹æ³•" class="headerlink" title="éƒ¨ç½²æ–¹æ³•"></a>éƒ¨ç½²æ–¹æ³•</h1><h2 id="1-Scrapy-Splash"><a href="#1-Scrapy-Splash" class="headerlink" title="1. Scrapy-Splash"></a>1. Scrapy-Splash</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install scrapy-splash --user</span><br></pre></td></tr></table></figure>

<h2 id="2-Splash-Instance"><a href="#2-Splash-Instance" class="headerlink" title="2. Splash Instance"></a>2. Splash Instance</h2><p>ç”±äº<strong>Scrapy-Splash</strong>ä½¿ç”¨çš„æ˜¯<strong>Splash HTTP API</strong>ï¼Œ æ‰€ä»¥éœ€è¦ä¸€ä¸ª<strong><a href="https://splash.readthedocs.io/en/stable/install.html" target="_blank" rel="noopener">Splash Instance</a></strong>ï¼Œä¸€èˆ¬é‡‡ç”¨<strong><a href="https://hub.docker.com/r/scrapinghub/splash" target="_blank" rel="noopener">Docker</a></strong>è¿è¡Œ<strong>Splash</strong>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ more docker-compose.yml</span><br><span class="line">version: <span class="string">"2.0"</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  splash:</span><br><span class="line">    restart: always</span><br><span class="line">    image: scrapinghub/splash</span><br><span class="line">    tty: <span class="literal">true</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8050:8050"</span></span><br><span class="line">    network_mode: <span class="string">"bridge"</span></span><br><span class="line">    container_name: <span class="string">"Splash"</span></span><br><span class="line">    hostname: <span class="string">"Splash"</span></span><br></pre></td></tr></table></figure>

<h2 id="3-é…ç½®SplashæœåŠ¡ï¼ˆä»¥ä¸‹æ“ä½œå…¨éƒ¨åœ¨settings-pyï¼‰"><a href="#3-é…ç½®SplashæœåŠ¡ï¼ˆä»¥ä¸‹æ“ä½œå…¨éƒ¨åœ¨settings-pyï¼‰" class="headerlink" title="3. é…ç½®SplashæœåŠ¡ï¼ˆä»¥ä¸‹æ“ä½œå…¨éƒ¨åœ¨settings.pyï¼‰"></a>3. é…ç½®<a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener"><strong>Splash</strong></a>æœåŠ¡ï¼ˆä»¥ä¸‹æ“ä½œå…¨éƒ¨åœ¨<strong>settings.py</strong>ï¼‰</h2><p><strong>3.1    æ·»åŠ SplashæœåŠ¡å™¨åœ°å€</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SPLASH_URL = <span class="string">'http://localhost:8050'</span></span><br></pre></td></tr></table></figure>

<p><strong>3.2    å¯ç”¨Splash middleware</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line">    <span class="string">'scrapy_splash.SplashCookiesMiddleware'</span>: 723,</span><br><span class="line">    <span class="string">'scrapy_splash.SplashMiddleware'</span>: 725,</span><br><span class="line">    <span class="string">'scrapy.downloadermiddlewares.httpcompression.HttpCompressionMiddleware'</span>: 810,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>Order 723 is just before HttpProxyMiddleware (750) in default scrapy settings.</em></p>
<p><strong>3.3    å¯ç”¨SplashDeduplicateArgsMiddleware</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SPIDER_MIDDLEWARES = &#123;</span><br><span class="line">    <span class="string">'scrapy_splash.SplashDeduplicateArgsMiddleware'</span>: 100,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.4  è‡ªå®šä¹‰ DUPEFILTER_CLASS</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DUPEFILTER_CLASS = <span class="string">'scrapy_splash.SplashAwareDupeFilter'</span></span><br></pre></td></tr></table></figure>

<p><strong>3.5 ä½¿ç”¨Scrapy HTTPç¼“å­˜</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HTTPCACHE_STORAGE = <span class="string">'scrapy_splash.SplashAwareFSCacheStorage'</span></span><br></pre></td></tr></table></figure>

<h2 id="4-ä»£ç "><a href="#4-ä»£ç " class="headerlink" title="4. ä»£ç "></a>4. ä»£ç </h2><p>æ³¨:  å½“ä½¿ç”¨<strong>Scrapy-Splash</strong>ä¹‹å, å°†æ— æ³•ç›´æ¥ä½¿ç”¨<strong>crawlera middleware</strong>ã€‚éœ€è¦æ‰‹åŠ¨å¼•ç”¨å¤–éƒ¨luaè„šæœ¬ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> haveibeenpwned.items <span class="keyword">import</span> feed</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> scrapy_splash <span class="keyword">import</span> SplashRequest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">from redis crawl haveibeenpwned</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">LUA_SOURCE = <span class="string">"""</span></span><br><span class="line"><span class="string">    function main(splash)</span></span><br><span class="line"><span class="string">        local host = "proxy.crawlera.com"</span></span><br><span class="line"><span class="string">        local port = 8010</span></span><br><span class="line"><span class="string">        local user = "api_key"</span></span><br><span class="line"><span class="string">        local password = ""</span></span><br><span class="line"><span class="string">        local session_header = "X-Crawlera-Session"</span></span><br><span class="line"><span class="string">        local session_id = "create"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:on_request(function (request)</span></span><br><span class="line"><span class="string">            request:set_header("X-Crawlera-UA", "desktop")</span></span><br><span class="line"><span class="string">            request:set_header(session_header, session_id)</span></span><br><span class="line"><span class="string">            request:set_proxy&#123;host, port, username=user, password=password&#125;</span></span><br><span class="line"><span class="string">        end)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:on_response_headers(function (response)</span></span><br><span class="line"><span class="string">            if response.headers[session_header] ~= nil then</span></span><br><span class="line"><span class="string">                session_id = response.headers[session_header]</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">        end)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        splash:go(splash.args.url)</span></span><br><span class="line"><span class="string">        return splash:html()</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CheckSpider</span><span class="params">(scrapy.Spider)</span>:</span></span><br><span class="line">    name = <span class="string">'scrapy_demo'</span></span><br><span class="line">    start_urls = <span class="string">'https://httpbin.org/get'</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">yield</span> SplashRequest(self.start_urls, self.parse, endpoint=<span class="string">'execute'</span>,  args=&#123;<span class="string">'wait'</span>: <span class="number">3</span>, <span class="string">'lua_source'</span>: LUA_SOURCE&#125;)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        print(response.text)</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒ:</p>
<ul>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash/issues/117" target="_blank" rel="noopener">https://github.com/scrapy-plugins/scrapy-splash/issues/117</a></li>
</ul>
<p>å‚è€ƒ:</p>
<ul>
<li><a href="https://splash.readthedocs.io/en/stable/search.html?q=splash%3Ahtml&check_keywords=yes&area=default" target="_blank" rel="noopener">Splash</a></li>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash" target="_blank" rel="noopener">Scrapy-Splash</a></li>
<li><a href="https://doc.scrapinghub.com/crawlera.html#using-crawlera-with-splash" target="_blank" rel="noopener">Scrapinghub API Reference</a></li>
<li><a href="https://stackoverflow.com/questions/43646438/using-proxy-with-scrapy-splash" target="_blank" rel="noopener">using proxy with scrapy-splash</a></li>
<li><a href="http://stackoverflow.com/questions/43090352/proxy-servers-with-scrapy-splash" target="_blank" rel="noopener"><strong>Proxy servers with Scrapy-Splash</strong></a></li>
<li><a href="https://github.com/scrapy-plugins/scrapy-splash/issues/97" target="_blank" rel="noopener">Crawlera integration</a></li>
<li><a href="https://blog.csdn.net/zhengxiangwen/article/details/55227368" target="_blank" rel="noopener"><strong>åˆ©ç”¨scrapy-splashçˆ¬å–JSç”Ÿæˆçš„åŠ¨æ€é¡µé¢</strong></a></li>
</ul>
]]></content>
      <categories>
        <category>Spider</category>
      </categories>
      <tags>
        <tag>Scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2019/10/04/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
  </entry>
</search>
